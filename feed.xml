<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>LAB</title>
    <link href="https://www.k8s.it/feed.xml" rel="self" />
    <link href="https://www.k8s.it" />
    <updated>2020-12-14T21:12:58+01:00</updated>
    <author>
        <name>lgirardi</name>
    </author>
    <id>https://www.k8s.it</id>

    <entry>
        <title>Kubernetes destroyed the virtualization... or NOT</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/kubernetes-destroyed-the-virtualization-or-not.html"/>
        <id>https://www.k8s.it/kubernetes-destroyed-the-virtualization-or-not.html</id>

        <updated>2020-12-14T21:12:58+01:00</updated>
            <summary>
                <![CDATA[
                    Well ... NO! Ok maybe are missing some context I started this topic looking around the data center world compared with the cloud providers, the advantage of manage services , the mindset infrastructure as a code and so on ... In the last 4y we saw&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <p>Well ... <strong>NO!</strong></p>
<p>Ok maybe are missing some context</p>
<p> </p>
<p>I started this topic looking around the data center world compared with the cloud providers,<br>the advantage of manage services , the mindset infrastructure as a code and so on ...</p>
<p>In the last 4y we saw a kubernetes rush , a lot of company are sharing the advantages and the perfect picture create into kubernetes, how they save money or scale fast ... but is always true what we see?<br>Most of the times we are saw only builded success case.</p>
<p>Today we will take in consideration those topics :</p>
<ul>
<li>Virtual machines</li>
<li>Data center</li>
<li>Kubernetes</li>
</ul>
<p>I know that the Data center topic should be covered more in deep, maybe talking about the entire ecosystem (db, vertical services , corporate usage , LEGACY!!!!) however today i'd like to explore only the kubernetes and virtualization rather than lose the discussion in thousand of concepts.</p>
<h3>Long story short</h3>
<p>A long time ago Borg was born in Google .. now formally named kubernetes,<br>in the first period the main evaluation was:<br>"<em>why the virtualization overhead if we will use kubernetes</em>".<br><br>This concept was justified in some way for <em>overlapping</em> of duties,<br>if i migrate a vm as a kubernetes pod this means i can remove the vm <br><br></p>
<figure class="post__image">                      <img loading="lazy"  src="https://res.cloudinary.com/ethzero/image/upload/v1607974463/misc/vm_vs_pod.png" data-is-external-image="true"  alt="" width="337" height="181"></figure>
<p> </p>
<p> </p>
<p>We can imagine a picture like this looking back of some years ago</p>
<figure class="post__image"><img loading="lazy"  src="https://res.cloudinary.com/ethzero/image/upload/v1607963386/misc/vm_1.png" data-is-external-image="true"  alt="" width="745" height="386"></figure>
<figure class="post__image">The introduction was good , almost all declared this could be a new way.<br>Moving faster, all companies changed a bit this picture with an expansion of kubernetes </figure>
<figure class="post__image"><img loading="lazy"  src="https://res.cloudinary.com/ethzero/image/upload/v1607963386/misc/vm_2.png" data-is-external-image="true"  alt="" width="745" height="386"></figure><figure class="is-loaded"><img loading="lazy"  src="Kubernetes destroyed the virtualization... or NOT - LAB_files/vm_2.png" data-is-external-image="true"  alt="" width="745" height="386" data-is-external-image="true"></figure>
<p>Like an infection (good this time, not the 20covid ones) kubernetes come as a main platform for most of the online company...<br>In a datacenter , you know, there no something eternal:</p>
<ul>
<li>hardware in EOL</li>
<li>generation refresh</li>
<li>brand change</li>
<li>good is ok but cheaper is better (usually from finance)</li>
</ul>
<p>Is also true , that sometimes this encouraged a forced/incorrect usage of kubernetes node labeling in order to bend the infrastructure to better fit the products migrated or the existing hardware availability</p>
<figure class="post__image"><img loading="lazy"  src="https://res.cloudinary.com/ethzero/image/upload/v1607959262/misc/vm_3.png" data-is-external-image="true"  alt="" width="748" height="389"></figure>
<figure class="post__image"><figure class="is-loaded"><img loading="lazy"  src="Kubernetes destroyed the virtualization... or NOT - LAB_files/vm_3.png" data-is-external-image="true"  alt="" data-is-external-image="true"></figure></figure>
<h3>Houston we have a problem...</h3>
<p>Working in this way, the environment could be fragmented ,<br>even if the technology is the same there are some logical segmentations that create some problems in the day by day activities.</p>
<ul>
<li>isolate some workloads with labels can create an hw lock-in (better approach a multi-cluster with unique controlplane)</li>
<li>updates require to be managed in a different way looking for the label/role</li>
<li>please do not touch the storage nodes now (fiber channel with external storage)</li>
<li>please do not touch the storage nodes tomorrow (fiber channel with external storage)</li>
<li>omg we lost a storage nodes (fiber channel with external storage)</li>
<li>and so on ...</li>
</ul>
<p>Moreover an hardware fault could create problems .... <br>YES i know in a infrastructure as a code , with puppet foreman chef salt ansible terraform etc, this will be recovered fast ... but this is not always true ... you know... some machines/roles in a mid/ent company are still fragile.</p>
<ul>
<li>legacy with no ownership</li>
<li>legacy with wrong ownership</li>
<li>single point of failure ... (yes also in 2020)</li>
</ul>
<p> </p>
<p>Other problems are related with new hardware...</p>
<ul>
<li>is the provisioning working as expected with new generations ?</li>
<li>and if we change the hardware vendor ?</li>
<li>etc etc when you have to handle new preseed/ks because the layout is changed ☠️</li>
</ul>
<p> </p>
<p>Last but not least ... what about the bare metal density ?</p>
<p><code>Allocated resources:</code><br><code> (<span class="il">Total</span> <span class="il">limits</span> <span class="il">may</span> be <span class="il">over</span> <span class="il">100</span> <span class="il">percent</span>, i.e., <span class="il">overcommitted</span>.</code><br><code> CPU Requests CPU <span class="il">Limits</span> Memory Requests Memory <span class="il">Limits</span></code><br><code> ------------ ---------- --------------- -------------</code><br><code> 55 (98%) 101300m (180%) 86376Mi (44%) 121672Mi (62%)</code></p>
<p>This HW has 56 core with HT , we reached the 98% but this number is high <br>because some pods needs a default cpu just to fit the nodes and start, while the running cost is really low. </p>
<p> </p>
<h3>So why not kubernetes hosted in virtual machines ?</h3>
<ul>
<li>Having an abstraction layer, is quite simple tune the provisioning based on this , rather than the bare metal, it's just a metter of roles not to the entire provisioning.</li>
<li>Hardware fault could be easily covered by live migration</li>
<li>Maintenance and update can be manage creating a blue green approach and rolling updates</li>
<li>Density could be increased with mode nodes in the same hw</li>
<li>Flexibility to scale up and to upset a new datacenter in case of migration will be higher</li>
<li>Team at the and is also able to scale , working from the vmware and not from bare metal</li>
</ul>
<figure class="post__image"><figure class="post__image"><img loading="lazy"  src="https://res.cloudinary.com/ethzero/image/upload/v1607961166/misc/team_scale.png" data-is-external-image="true"  alt="" width="718" height="353"></figure></figure>
<h3> </h3>
<h3>Conclusions</h3>
<p>Virtualization and kubernetes are not antagonist, the first one has just change the scope to better cooperate with kubernetes</p>
<p>Instead a layer for microservices , virtualization is now the layer that guarantee an homogeneous platform were a team can work on top to create the infrastructure having the advantage of a fully consolidated technology that is able to promote the right abstraction </p>
<p>Last but not least , we don't need to reinvent something , we can just copy from the major competitors for the kubernetes topic<br>How is working GKE , AKS , EKS ? .... virtual machines :)</p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Kubernetes api gateway</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/kubernetes-apigw.html"/>
        <id>https://www.k8s.it/kubernetes-apigw.html</id>
            <category term="token"/>
            <category term="rate limit"/>
            <category term="kubernetes"/>
            <category term="konga"/>
            <category term="kong"/>
            <category term="auth"/>
            <category term="apigw"/>
            <category term="api-gateway"/>
            <category term="api key"/>

        <updated>2020-12-07T15:22:46+01:00</updated>
            <summary>
                <![CDATA[
                        <img src="https://www.k8s.it/media/posts/16/Screenshot-2020-11-20-at-22.20.25-2.png" alt="" />
                    It's time to talk about the api gateway In a modern infrastructure , especially in a microservices environment you probably know what i'm referring to ,however it's better to clarify some points. An API gateway takes all API calls from clients, then routes them to&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                    <img src="https://www.k8s.it/media/posts/16/Screenshot-2020-11-20-at-22.20.25-2.png" alt="" />
                <p>It's time to talk about the api gateway</p>
<p>In a modern infrastructure , especially in a microservices environment you probably know what i'm referring to ,however it's better to clarify some points.</p>
<p><em>An API gateway takes all API calls from clients, then routes them to the appropriate microservice with request routing, composition, and protocol translation. Typically it handles a request by invoking multiple microservices and aggregating the results, to determine the best path. It can translate between web protocols and web‑unfriendly protocols that are used internally.</em></p>
<p><em>An e‑commerce site might use an API gateway to provide mobile clients with an endpoint for retrieving all product details with a single request. It invokes various services, like product info and reviews, and combines the results</em></p>
<p><br><br></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/70d257f92412994f23cfce0b702ca359556a2b64b7835f8f3ef9b58a493a4d60/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343833393633312f6d6973632f61706967772e706e67"><img loading="lazy" title="apigw" src="https://camo.githubusercontent.com/70d257f92412994f23cfce0b702ca359556a2b64b7835f8f3ef9b58a493a4d60/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343833393633312f6d6973632f61706967772e706e67" data-is-external-image="true"  alt="apigw" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1604839631/misc/apigw.png"></a></p>
<p><br><br></p>
<p>Some months ago i discussed about the service mesh<br><a href="https://github.com/lorenzogirardi/kubernetes-servicemesh">https://github.com/lorenzogirardi/kubernetes-servicemesh</a></p>
<p>To better understand the differences on those products it is better to summarize the common areas</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/43086b5aea0afa64170f3dac4261da1ad4a2ae2645d428fee16b7ce2eb6484f1/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343730333838302f6d6973632f61706967775f76735f736572766963656d6573682e706e67"><img loading="lazy" title="apigw_vs_servicemesh" src="https://camo.githubusercontent.com/43086b5aea0afa64170f3dac4261da1ad4a2ae2645d428fee16b7ce2eb6484f1/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343730333838302f6d6973632f61706967775f76735f736572766963656d6573682e706e67" data-is-external-image="true"  alt="apigw_vs_servicemesh" width="491" height="328" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1604703880/misc/apigw_vs_servicemesh.png"></a></p>
<p>So forget about service mesh and have the focus only on the apigw.</p>
<p><br><br></p>
<h2><a id="user-content-goal" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#goal"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>GOAL</h2>
<p>Needed:</p>
<ul>
<li>Api must be public</li>
<li>Users needs to have authentication</li>
<li>An user could be rate limited</li>
<li>A service could be rate limited</li>
<li>Backend applications should not be changed</li>
<li>We need to interact as a code with the apigw<br><br><br></li>
</ul>
<p>Important:</p>
<ul>
<li>Analytics</li>
<li>Transformation</li>
<li>Versioning</li>
<li>Circuit Breaker</li>
<li>gRPC support</li>
<li>Caching</li>
<li>Documentation</li>
</ul>
<p><br><br></p>
<h2><a id="user-content-software-opportunity" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#software-opportunity"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Software opportunity</h2>
<p>Around the api gateway world we have some possibility, some of those are onprem, some other in cloud or hybrid.</p>
<p>The onprem scenario we have some historycal software and a "new generation" born in a kubernetes architecture, howevere here we will check for a tool that could work in kubernetes (with a plus for supporting vm)</p>
<p>From the most knew i'd like to mention:</p>
<ul>
<li>Kong</li>
<li>Tyk</li>
<li>Nginx</li>
<li>Ambassador</li>
<li>3scale</li>
</ul>
<p>On the other side on the cloud scenario we have:</p>
<ul>
<li>Aws api gateway</li>
<li>Mashery (from Tibco)</li>
<li>Google apigee</li>
<li>Akana (hybrid)</li>
<li>Azure api management</li>
</ul>
<table style="border-collapse: collapse; width: 100%;" border="1">
<tbody>
<tr>
<th style="width: 16.932%;"> </th>
<th style="width: 15.3401%;">nginx</th>
<th style="width: 16.2084%;">kong</th>
<th style="width: 13.1693%;">tyk</th>
<th style="width: 15.3401%;">ambassador</th>
<th style="width: 36.4688%;">aws api gw</th>
</tr>
<tr>
<td style="width: 16.932%;">basic</td>
<td style="width: 15.3401%;">yes</td>
<td style="width: 16.2084%;">yes</td>
<td style="width: 13.1693%;">yes</td>
<td style="width: 15.3401%;">yes</td>
<td style="width: 36.4688%;">pay</td>
</tr>
<tr>
<td style="width: 16.932%;">oauth</td>
<td style="width: 15.3401%;">pay</td>
<td style="width: 16.2084%;">yes</td>
<td style="width: 13.1693%;">yes</td>
<td style="width: 15.3401%;">pay</td>
<td style="width: 36.4688%;">pay</td>
</tr>
<tr>
<td style="width: 16.932%;">jwt</td>
<td style="width: 15.3401%;">pay</td>
<td style="width: 16.2084%;">yes</td>
<td style="width: 13.1693%;">yes</td>
<td style="width: 15.3401%;">pay</td>
<td style="width: 36.4688%;">pay</td>
</tr>
<tr>
<td style="width: 16.932%;">ip listing</td>
<td style="width: 15.3401%;">yes</td>
<td style="width: 16.2084%;">yes</td>
<td style="width: 13.1693%;">yes</td>
<td style="width: 15.3401%;">no</td>
<td style="width: 36.4688%;">pay</td>
</tr>
<tr>
<td style="width: 16.932%;">analytics</td>
<td style="width: 15.3401%;">yes</td>
<td style="width: 16.2084%;">yes</td>
<td style="width: 13.1693%;">yes</td>
<td style="width: 15.3401%;">yes</td>
<td style="width: 36.4688%;">pay</td>
</tr>
<tr>
<td style="width: 16.932%;">rate limiting</td>
<td style="width: 15.3401%;">yes</td>
<td style="width: 16.2084%;">yes</td>
<td style="width: 13.1693%;">yes</td>
<td style="width: 15.3401%;">yes</td>
<td style="width: 36.4688%;">pay</td>
</tr>
<tr>
<td style="width: 16.932%;">transformation</td>
<td style="width: 15.3401%;">pay</td>
<td style="width: 16.2084%;">yes</td>
<td style="width: 13.1693%;">yes</td>
<td style="width: 15.3401%;">yes</td>
<td style="width: 36.4688%;">pay</td>
</tr>
<tr>
<td style="width: 16.932%;">grpc</td>
<td style="width: 15.3401%;">yes</td>
<td style="width: 16.2084%;">yes</td>
<td style="width: 13.1693%;">yes</td>
<td style="width: 15.3401%;">yes</td>
<td style="width: 36.4688%;">no</td>
</tr>
<tr>
<td style="width: 16.932%;">websocket</td>
<td style="width: 15.3401%;">yes</td>
<td style="width: 16.2084%;">yes</td>
<td style="width: 13.1693%;">yes</td>
<td style="width: 15.3401%;">yes</td>
<td style="width: 36.4688%;">pay</td>
</tr>
<tr>
<td style="width: 16.932%;">service mesh</td>
<td style="width: 15.3401%;">no</td>
<td style="width: 16.2084%;">yes</td>
<td style="width: 13.1693%;">yes</td>
<td style="width: 15.3401%;">pay</td>
<td style="width: 36.4688%;">no</td>
</tr>
<tr>
<td style="width: 16.932%;">k8s ingress</td>
<td style="width: 15.3401%;">yes</td>
<td style="width: 16.2084%;">yes</td>
<td style="width: 13.1693%;">yes</td>
<td style="width: 15.3401%;">yes</td>
<td style="width: 36.4688%;">no</td>
</tr>
<tr>
<td style="width: 16.932%;">caching</td>
<td style="width: 15.3401%;">yes</td>
<td style="width: 16.2084%;">pay</td>
<td style="width: 13.1693%;">yes</td>
<td style="width: 15.3401%;">no</td>
<td style="width: 36.4688%;">pay</td>
</tr>
<tr>
<td style="width: 16.932%;">documentation</td>
<td style="width: 15.3401%;">pay</td>
<td style="width: 16.2084%;">yes</td>
<td style="width: 13.1693%;">yes</td>
<td style="width: 15.3401%;">no</td>
<td style="width: 36.4688%;">pay</td>
</tr>
<tr>
<td style="width: 16.932%;">admin ui</td>
<td style="width: 15.3401%;">pay</td>
<td style="width: 16.2084%;">trd party</td>
<td style="width: 13.1693%;">yes</td>
<td style="width: 15.3401%;">no</td>
<td style="width: 36.4688%;">pay</td>
</tr>
<tr>
<td style="width: 16.932%;">ease to setup</td>
<td style="width: 15.3401%;">3.5</td>
<td style="width: 16.2084%;">4</td>
<td style="width: 13.1693%;">2.5</td>
<td style="width: 15.3401%;">3</td>
<td style="width: 36.4688%;">5</td>
</tr>
</tbody>
</table>
<p> </p>
<p>Cloud</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/6f7e05d1971da2d537452717a8571e3fc13ac8a7471428550e0cf065ca2997e1/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343736363830322f6d6973632f61706967775f636c6f75642e706e67"><img loading="lazy" title="apigw_cloud" src="https://camo.githubusercontent.com/6f7e05d1971da2d537452717a8571e3fc13ac8a7471428550e0cf065ca2997e1/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343736363830322f6d6973632f61706967775f636c6f75642e706e67" data-is-external-image="true"  alt="apigw_cloud" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1604766802/misc/apigw_cloud.png"></a></p>
<p>The advantage/disadvantage of cloud solution is the pay per use, you don't need to manage the infrastrcture but only the configuration and you have the support that can drive you on the right configuration.<br>Another valid point of view is the <em>DDOS</em> attack that will not land to your platform but to a cloud infrastructure that is supposed was designed to manage this scenario.</p>
<p>PRO:</p>
<ul>
<li>managed infrastructure</li>
<li>support</li>
<li>attacks mitigation</li>
</ul>
<p>CONS:</p>
<ul>
<li>pricing</li>
<li>often not customizable<br><br></li>
</ul>
<p>Onprem</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/f650f08e78f1fa640565179fa79ccedcb5928fc85554118e8b2cbb720bbea6e6/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343736363830322f6d6973632f61706967775f64632e706e67"><img loading="lazy" title="apigw_dc" src="https://camo.githubusercontent.com/f650f08e78f1fa640565179fa79ccedcb5928fc85554118e8b2cbb720bbea6e6/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343736363830322f6d6973632f61706967775f64632e706e67" data-is-external-image="true"  alt="apigw_dc" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1604766802/misc/apigw_dc.png"></a></p>
<p>Those solutions should be hosted on your platform or in a cloud to let the datacenter <em>unknown</em> (anyway you have to pay per traffic "*" ).<br>Your engineer team need to know how it's working the infrastructure but they can also improve the process with automations</p>
<p>PRO:</p>
<ul>
<li>open source</li>
<li>customizable</li>
<li>awareness on the complete funnel</li>
</ul>
<p>CONS:</p>
<ul>
<li>you have to take care about attacks</li>
<li>infrastructure knowhow</li>
</ul>
<p><br><br>"*" you can easly have the apigw hosted onprem combined with a cdn/waf with ip lockdown , however you still have to pay the traffic towards it.</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/e66b9fb512155cc277683660dd1ab517d7e9b9e50f023d3fc53f2b7e06a9f5e7/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343736363830322f6d6973632f61706967775f7761662e706e67"><img loading="lazy" title="apigw_waf" src="https://camo.githubusercontent.com/e66b9fb512155cc277683660dd1ab517d7e9b9e50f023d3fc53f2b7e06a9f5e7/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343736363830322f6d6973632f61706967775f7761662e706e67" data-is-external-image="true"  alt="apigw_waf" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1604766802/misc/apigw_waf.png"></a></p>
<p><br><br></p>
<h2><a id="user-content-scenario" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#scenario"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Scenario</h2>
<p>I tried some cloud solution like Aws and Mashery,<br>i played also with some onprem solution, anyway i found out the right compromise with <a href="https://konghq.com/kong/" rel="nofollow">Kong</a></p>
<p>where compromise is :</p>
<ul>
<li><strong>Kubernetes ingress</strong></li>
<li><strong>Api managed</strong></li>
<li><strong>Documentation</strong></li>
<li>Admin UI (konga for the open source)</li>
<li>Basic auth</li>
<li><strong>Apikey</strong></li>
<li><strong>Oauth</strong></li>
<li><strong>JWT</strong></li>
<li>ip listing</li>
<li><strong>Analytics</strong></li>
<li><strong>Rate limiting</strong></li>
<li><strong>Transformation</strong></li>
<li>gRPC</li>
<li>Websockets</li>
<li>Service mesh (~ nice to have)</li>
<li><strong>Easy to use</strong></li>
</ul>
<p><br><br></p>
<h2><a id="user-content-infrastructure" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#infrastructure"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Infrastructure</h2>
<ul>
<li>kubernetes</li>
<li>backend application</li>
<li>kong api gateway</li>
<li>konga admin ui</li>
<li>waf (free cloudflare service)</li>
</ul>
<p><br><br></p>
<p>What we need for this test is a backend api application, i created a prototype just to simulate different applications behind the apigw.</p>
<p>Here you can find out more details</p>
<p><a href="https://github.com/lorenzogirardi/py-test-backend">https://github.com/lorenzogirardi/py-test-backend</a></p>
<p>briefly recap the application answer on /api/ with the main html page with methods</p>
<table>
<thead>
<tr>
<th>HTTP Method</th>
<th align="center">URI</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td align="center">http://[hostname]/api/get/context</td>
<td>Retrieve list of context</td>
</tr>
<tr>
<td>GET</td>
<td align="center">http://[hostname]/api/get/context/[context_id]</td>
<td>Retrieve a context</td>
</tr>
<tr>
<td>POST</td>
<td align="center">http://[hostname]/api/post/context</td>
<td>Create a new context</td>
</tr>
<tr>
<td>PUT</td>
<td align="center">http://[hostname]/api/put/context/[context_id]</td>
<td>Update an existing context</td>
</tr>
<tr>
<td>DELETE</td>
<td align="center">http://[hostname]/api/delete/context/[context_id]</td>
<td>Delete acontext</td>
</tr>
</tbody>
</table>
<p><br><br></p>
<h2><a id="user-content-configuration" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#configuration"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Configuration</h2>
<div>
<div>git repo --&gt; <a href="https://github.com/lorenzogirardi/Kubernetes-apigw" target="_blank" rel="noopener noreferrer">https://github.com/lorenzogirardi/Kubernetes-apigw</a></div>
</div>
<p>Let's start to work...<br>I've used the public kong deployment with some changes to have the database where store the configurations.</p>
<p>Another trick is create it as a secondary <em>ingress</em> , since i've already and ingress in my infrastructure , kong is done to answer on different ports</p>
<p>All the yaml are subdivided per role</p>
<pre><code>kong
|-- 01-kong-ns.yaml
|-- 02-kong-cr.yaml
|-- 03-kong-sa.yaml
|-- 04-kong-rbac.yaml
|-- 05-kong-crb.yaml
|-- 06-kong-svc.yaml
|-- 07-kong-dpl.yaml
|-- 08-kong-ss.yaml
`-- 09-kong-job.yaml
</code></pre>
<p>some differences are related to the services node ports, deployment binding host and the database is now hosted with a volumeClaimTemplates</p>
<pre><code>  ports:
  - name: proxy
    nodePort: 30080
    port: 80
    protocol: TCP
    targetPort: 8000
  - name: proxy-ssl
    nodePort: 30443
    port: 443
    protocol: TCP
    targetPort: 8443
  - name: admin
    port: 8100
    protocol: TCP
    targetPort: 8100
  - name: admin-ssl
    port: 8444
    protocol: TCP
    targetPort: 8444
  selector:
    app: ingress-kong
  type: LoadBalancer
</code></pre>
<pre><code>      containers:
      - env:
        - name: KONG_DATABASE
          value: postgres
        - name: KONG_PG_HOST
          value: postgres
        - name: KONG_PG_PASSWORD
          value: kong
        - name: KONG_PROXY_LISTEN
          value: 0.0.0.0:8000, 0.0.0.0:8443 ssl http2
        - name: KONG_PORT_MAPS
          value: 80:8000, 443:8443
        - name: KONG_ADMIN_LISTEN
          value: 0.0.0.0:8444 ssl
        - name: KONG_STATUS_LISTEN
          value: 0.0.0.0:8100
</code></pre>
<pre><code>  volumeClaimTemplates:
  - metadata:
      name: datadir
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 250Mi
</code></pre>
<p>Here what is expected to see</p>
<pre><code>$ kubectl get svc -n kong
NAME                      TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                    AGE
kong-proxy                LoadBalancer   10.152.183.55    &lt;pending&gt;     80:30080/TCP,443:30443/TCP,8100:32588/TCP,8444:31793/TCP   7d
kong-validation-webhook   ClusterIP      10.152.183.190   &lt;none&gt;        443/TCP                                                    7d
postgres                  ClusterIP      10.152.183.177   &lt;none&gt;        5432/TCP
</code></pre>
<p>and the pods needed to have it online</p>
<pre><code>kong           ingress-kong-686b4bc5df-nm7zk              2/2     Running     4          7d
kong           kong-migrations-ftgdv                      0/1     Completed   0          7d
kong           postgres-0                                 1/1     Running     2          7d
kube-system    hostpath-provisioner-5c65fbdb4f-f5qsb      1/1     Running     6          40d
</code></pre>
<pre><code>NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS        AGE
datadir-postgres-0   Bound    pvc-8c5791c3-939f-4457-b5fb-74ac417ca3d7   250Mi        RWO                 k8s-hostpath   7d
</code></pre>
<p><br><br></p>
<p>Now i'd like to have also an Admin UI, i'm not fan of web ui ,<br>however i need to know if this interface could be shared outside IT<br>to delegate some business ownership and so on.</p>
<p>Kong Enterprise has it's own web ui instead the community one needs a third party tool... <a href="https://github.com/pantsel/konga">Konga</a></p>
<p>In the same way of kong, konga needs a database , and in the same way i elaborated a bit the default deployment</p>
<pre><code>konga
|-- 01-ns-konga.yaml
|-- 02-svc-konga.yaml
|-- 03-ing-konga.yaml
`-- 04-dpl-konga.yaml
</code></pre>
<p>just a couple of TIPS</p>
<p>postgres persistent storage</p>
<pre><code>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  namespace: konga
  name: konga-pv-claim
  labels:
    app: konga-storage-claim
spec:
  storageClassName: microk8s-hostpath
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 200Mi
</code></pre>
<p>and on deployment ...</p>
<pre><code>        env:
        - name: NODE_TLS_REJECT_UNAUTHORIZED
          value: "0"
        - name: NODE_ENV
          value: "production"
</code></pre>
<p>where NODE_TLS_REJECT_UNAUTHORIZED is the option to not verify the kong api certificate and</p>
<p><br>NODE_ENV is way to enable production or development , if you are not using production, the other two option enables the debug model and increase the cpu usage, i suggest to use production anyway <strong>during the first deploy you should enable development in order to bootstrap the sql schema</strong> that production is not able to do ... or create an init container to deploy the schema</p>
<p><code>konga konga-stable-8957b9d85-tq72z 2/2 Running 2 6d3h</code></p>
<p>since is now up and running it will be available on the standard infrastructure ingress</p>
<pre><code>  - host: konga.ing.h4x0r3d.lan
</code></pre>
<p>Konga Home </p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/0f76d690a796607e512cffaaf5f1405516e613575ecdf562d91399e1c646b05b/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737373233372f6d6973632f6b6f6e67615f75692e706e67"><img loading="lazy" title="konga_home" src="https://camo.githubusercontent.com/0f76d690a796607e512cffaaf5f1405516e613575ecdf562d91399e1c646b05b/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737373233372f6d6973632f6b6f6e67615f75692e706e67" data-is-external-image="true"  alt="konga_home" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1604777237/misc/konga_ui.png"></a></p>
<p>Konga node configuration </p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/cda833f675290b3538fa9b4e4d49f8c91ea586bae71505e705d7646646b30fa8/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737373233382f6d6973632f6b6f6e67615f75695f6b6f6e676e6f64652e706e67"><img loading="lazy" title="konga_node" src="https://camo.githubusercontent.com/cda833f675290b3538fa9b4e4d49f8c91ea586bae71505e705d7646646b30fa8/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737373233382f6d6973632f6b6f6e67615f75695f6b6f6e676e6f64652e706e67" data-is-external-image="true"  alt="konga_node" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1604777238/misc/konga_ui_kongnode.png"></a></p>
<p><br><br></p>
<ul>
<li>kong [INSTALLED]</li>
<li>konga [INSTALLED]</li>
<li>backend [INSTALLED]</li>
</ul>
<p>First of all we need to expose the backend with Kong in this example i created an ingress configuration dedicated for this porpose</p>
<pre><code>apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/ingress.class: "kong"
  name: api
  namespace: pytbak
  labels:
    app: api
spec:
  rules:
    - host: api.ing.h4x0r3d.lan
      http:
        paths:
          - path: /api/
            backend:
              serviceName: pytbak-svc
              servicePort: 5000
          - path: /api/get/
            backend:
              serviceName: pytbak-svc
              servicePort: 5000
          - path: /api/post/
            backend:
              serviceName: pytbak-svc
              servicePort: 5000
          - path: /api/put/
            backend:
              serviceName: pytbak-svc
              servicePort: 5000
          - path: /api/delete/
            backend:
              serviceName: pytbak-svc
              servicePort: 5000
</code></pre>
<p><code>kubernetes.io/ingress.class: "kong" </code>to match the kong ingress on the backend application <code>namespace: pytbak</code>.<br>As you can see i created mutiple paths to simulate different applications behind and create different ruls per path/application/context.</p>
<p>The kong configuration could be applied with</p>
<ul>
<li>kubernetes yaml</li>
<li>kong api</li>
<li>konga ui (only if you have the database)</li>
</ul>
<p>In the repo you will see some in kubernetes and some other not present , i tested the three option and the <strong>kong api</strong> is the best one</p>
<p><br><br>Create api user</p>
<p><code>curl -k -i -X POST --url https://192.168.1.14:31793/consumers/ --data "username=slow_user"</code></p>
<pre><code>HTTP/1.1 201 Created
Date: Sat, 07 Nov 2020 19:46:05 GMT
Content-Type: application/json; charset=utf-8
Connection: keep-alive
Access-Control-Allow-Origin: *
Server: kong/2.1.4
Content-Length: 121
X-Kong-Admin-Latency: 16
</code></pre>
<p><code>{"custom_id":null,"created_at":1604778365,"id":"3d45a73d-4024-4813-b356-43a14ecea702","tags":null,"username":"slow_user"}</code> <a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/34bd577bcb080782018378247fac228663f6c4508bfc1191f173a07d9f731e28/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737383930332f6d6973632f6b6f6e67615f636f6e73756d65722e706e67"><img loading="lazy" title="konga_consumer" src="https://camo.githubusercontent.com/34bd577bcb080782018378247fac228663f6c4508bfc1191f173a07d9f731e28/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737383930332f6d6973632f6b6f6e67615f636f6e73756d65722e706e67" data-is-external-image="true"  alt="konga_consumer" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1604778903/misc/konga_consumer.png"></a></p>
<p><br><br>add a key token with key-auth plugin</p>
<p><code>curl -k -i -X POST --url https://192.168.1.14:31793/consumers/slow_user/key-auth/ --data 'key=332d05445a560ee65a76aeaa372d8904'</code></p>
<pre><code>HTTP/1.1 201 Created
Date: Sat, 07 Nov 2020 19:51:03 GMT
Content-Type: application/json; charset=utf-8
Connection: keep-alive
Access-Control-Allow-Origin: *
Server: kong/2.1.4
Content-Length: 190
X-Kong-Admin-Latency: 10
</code></pre>
<p><code>{"created_at":1604778663,"id":"52970ca8-848d-49b5-a16f-a235fe0e9ceb","tags":null,"ttl":null,"key":"332d05445a560ee65a76aeaa372d8904","consumer":{"id":"3d45a73d-4024-4813-b356-43a14ecea702"}}</code> <a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/2a45dbea6ede1ac159c1950a65f518aa347650b73efa3539a0edc11f8dbee793/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737383930332f6d6973632f6b6f6e67615f636f6e73756d65725f63726564656e7469616c2e706e67"><img loading="lazy" title="konga_consumer_cred" src="https://camo.githubusercontent.com/2a45dbea6ede1ac159c1950a65f518aa347650b73efa3539a0edc11f8dbee793/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737383930332f6d6973632f6b6f6e67615f636f6e73756d65725f63726564656e7469616c2e706e67" data-is-external-image="true"  alt="konga_consumer_cred" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1604778903/misc/konga_consumer_credential.png"></a></p>
<p><br><br></p>
<p>routes.id where created when we created the kong ingress configuration for pytbak <code>curl -k -i -X GET <a href="https://192.168.1.14:31793/routes/">https://192.168.1.14:31793/routes/</a></code></p>
<p> </p>
<table style="border-collapse: collapse; width: 93.4879%; height: 294px;" border="1">
<tbody>
<tr style="height: 49px;">
<td style="width: 19.2341%; height: 49px;">ROUTE NAME</td>
<td style="width: 19.7563%; height: 49px;">PATH </td>
<td style="width: 55.5885%; height: 49px;">ROUTE.ID</td>
</tr>
<tr style="height: 49px;">
<td style="width: 19.2341%; height: 49px;">pytbak.api.00</td>
<td style="width: 19.7563%; height: 49px;">/api/</td>
<td style="width: 55.5885%; height: 49px;">0a78b572-cfe0-4228-bdfe-639ef04b5117</td>
</tr>
<tr style="height: 49px;">
<td style="width: 19.2341%; height: 49px;">pytbak.api.01</td>
<td style="width: 19.7563%; height: 49px;">/api/get/</td>
<td style="width: 55.5885%; height: 49px;">8d2a24aa-636d-43ee-b0aa-b0fd1d3643fd</td>
</tr>
<tr style="height: 49px;">
<td style="width: 19.2341%; height: 49px;">pytbak.api.02</td>
<td style="width: 19.7563%; height: 49px;">/api/post/</td>
<td style="width: 55.5885%; height: 49px;">f75ed3b6-07c3-4293-932b-4f53d0c38f74</td>
</tr>
<tr style="height: 49px;">
<td style="width: 19.2341%; height: 49px;">pytbak.api.03</td>
<td style="width: 19.7563%; height: 49px;">/api/put  </td>
<td style="width: 55.5885%; height: 49px;">f4823063-04e4-4da8-9c11-21977a93b1ba</td>
</tr>
<tr style="height: 49px;">
<td style="width: 19.2341%; height: 49px;">pytbak.api.04</td>
<td style="width: 19.7563%; height: 49px;">/api/delete</td>
<td style="width: 55.5885%; height: 49px;">e396750c-9158-4a96-8d79-047197669cff</td>
</tr>
</tbody>
</table>
<p> </p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/c17c8b10cdcbb8526fdb448c903c6dad6090e4e460de537185e6a04be663c3e4/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737393732302f6d6973632f6b6f6e67615f726f757465732e706e67"><img loading="lazy" title="konga_routes" src="https://camo.githubusercontent.com/c17c8b10cdcbb8526fdb448c903c6dad6090e4e460de537185e6a04be663c3e4/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737393732302f6d6973632f6b6f6e67615f726f757465732e706e67" data-is-external-image="true"  alt="konga_routes" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1604779720/misc/konga_routes.png"></a></p>
<p><br><br>now i'd like to limit the user slow_user to perform only 4 request per sec on /api/<br>and 2 on /api/get/</p>
<pre><code>$ curl -k -X POST https://192.168.1.14:31793/plugins/ \
&gt;             --data "name=rate-limiting"  \
&gt;             --data "config.second=4" \
&gt;             --data "config.hour=1200" \
&gt;             --data "config.policy=local" \
&gt;             --data "consumer.id=3d45a73d-4024-4813-b356-43a14ecea702" \
&gt;             --data "route.id=0a78b572-cfe0-4228-bdfe-639ef04b5117"
</code></pre>
<p><code>{"created_at":1604780031,"id":"cfd3d752-7864-493c-a3b7-3970ab6eca86","tags":null,"enabled":true,"protocols":["grpc","grpcs","http","https"],"name":"rate-limiting","consumer":{"id":"3d45a73d-4024-4813-b356-43a14ecea702"},"service":null,"route":{"id":"0a78b572-cfe0-4228-bdfe-639ef04b5117"},"config":{"hide_client_headers":false,"minute":null,"policy":"local",</code><code>"month":null,"redis_timeout":2000,"limit_by":"consumer","redis_password":null,"second":4,"day":null,"redis_database":0,"year":null,"hour":1200,"redis_host":null,"redis_port":6379,"header_name":null,"fault_tolerant":true}}</code></p>
<pre><code>curl -k -X POST https://192.168.1.14:31793/plugins/ \
                --data "name=rate-limiting"  \
                --data "config.second=2" \
                --data "config.hour=600" \
                --data "config.policy=local" \
                --data "consumer.id=3d45a73d-4024-4813-b356-43a14ecea702" \
                --data "route.id=8d2a24aa-636d-43ee-b0aa-b0fd1d3643fd" 
</code></pre>
<p><code>{"created_at":1604780101,"id":"33bfc138-776a-4116-a2a9-8c70ab9d7a2a","tags":null,"enabled":true,"protocols":["grpc","grpcs","http","https"],"name":"rate-limiting","consumer":{"id":"3d45a73d-4024-4813-b356-43a14ecea702"},"service":null,"route":{"id":"8d2a24aa-636d-43ee-b0aa-b0fd1d3643fd"},"config":{"hide_client_headers":false,"minute":null,"policy":"local","month":null,"redis_timeout":2000,"limit_by":"consumer","redis_password":null,"second":2,"day":null,"redis_database":0,"year":null,"hour":600,"redis_host":null,"redis_port":6379,"header_name":null,"fault_tolerant":true}}</code></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/31f166746c62aae6fda1d4e1bdb7a85ec1683afd6bdf2d859baf6150883e302e/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343738303230302f6d6973632f6b6f6e67615f726174655f6c696d69745f726f757465732e706e67"><img loading="lazy" title="konga_rate_routes" src="https://camo.githubusercontent.com/31f166746c62aae6fda1d4e1bdb7a85ec1683afd6bdf2d859baf6150883e302e/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343738303230302f6d6973632f6b6f6e67615f726174655f6c696d69745f726f757465732e706e67" data-is-external-image="true"  alt="konga_rate_routes" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1604780200/misc/konga_rate_limit_routes.png"></a></p>
<p><br><br></p>
<h2><a id="user-content-use-cases" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#use-cases"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Use cases</h2>
<p>I created 3 users , one on the example above and a new one with a double of requests per second</p>
<table>
<thead>
<tr>
<th>route</th>
<th align="center">slow_user rate/s</th>
<th>fast_user rate/s</th>
</tr>
</thead>
<tbody>
<tr>
<td>/api/</td>
<td align="center">4</td>
<td>8</td>
</tr>
<tr>
<td>/api/get/</td>
<td align="center">2</td>
<td>4</td>
</tr>
<tr>
<td>/api/post/</td>
<td align="center">1</td>
<td>2</td>
</tr>
<tr>
<td>/api/put/</td>
<td align="center">1</td>
<td>2</td>
</tr>
<tr>
<td>/api/delete/</td>
<td align="center">1</td>
<td>2</td>
</tr>
</tbody>
</table>
<p><br><br>slow_user has apikey: 332d05445a560ee65a76aeaa372d8904<br>fast_user has apikey: 695aa0b18c6dbd1b387ee7c32c72c513<br>admin has a apikey: admin</p>
<p><br><br>i've also created a global rules on the service with max 9 reqquest per second for all other users with no specific rate limit rule applied (ex admin.)</p>
<p><code>$ curl -k -X POST https://192.168.1.14:31793/plugins --data "name=rate-limiting" --data "config.second=9" --data "config.policy=local" --data "service.id=53d35e73-b285-4eb2-ad24-853d82563ca4"</code></p>
<pre><code>{"created_at":1604786501,"id":"34182311-ecbf-49a3-bdcf-bdc1c9c58706",<br>"tags":null,"enabled":true,"protocols":["grpc","grpcs","http","https"],<br>"name":"rate-limiting","consumer":null,<br>"service":{"id":"53d35e73-b285-4eb2-ad24-853d82563ca4"},<br>"route":null,"config":{"hide_client_headers":false,"minute":null,"policy":"local",<br>"month":null,"redis_timeout":2000,"limit_by":"consumer",<br>"redis_password":null,"second":9,"day":null,"redis_database":0,"year":null,<br>"hour":null,"redis_host":null,"redis_port":6379,"header_name":null,<br>"fault_tolerant":true}}
</code></pre>
<p>Using siege i've benchmarked the users</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/ee42763f67ce2c6a3e6f97b945740f70bf12d80bc251a6fd1266b07cf10d68f9/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343738373237302f6d6973632f73696567655f75736572732e706e67"><img loading="lazy" title="siege_users" src="https://camo.githubusercontent.com/ee42763f67ce2c6a3e6f97b945740f70bf12d80bc251a6fd1266b07cf10d68f9/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343738373237302f6d6973632f73696567655f75736572732e706e67" data-is-external-image="true"  alt="siege_users" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1604787270/misc/siege_users.png"></a></p>
<p>You can check the headers with curl<br><code>$ while true; do curl -I -H "apikey:332d05445a560ee65a76aeaa372d8904" http://api.ing.h4x0r3d.lan:30080/api/ &amp;&amp; sleep 0.2; done</code></p>
<pre><code>HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Content-Length: 658
Connection: keep-alive
Server: Werkzeug/1.0.1 Python/3.9.0
Date: Sat, 07 Nov 2020 22:21:34 GMT
X-RateLimit-Limit-Second: 4
X-RateLimit-Remaining-Second: 3
X-RateLimit-Limit-Hour: 1000000
RateLimit-Limit: 4
X-RateLimit-Remaining-Hour: 999755
RateLimit-Remaining: 3
RateLimit-Reset: 1
X-Kong-Upstream-Latency: 3
X-Kong-Proxy-Latency: 1
Via: kong/2.1.4

HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Content-Length: 658
Connection: keep-alive
Server: Werkzeug/1.0.1 Python/3.9.0
Date: Sat, 07 Nov 2020 22:21:34 GMT
X-RateLimit-Limit-Second: 4
X-RateLimit-Remaining-Second: 2
X-RateLimit-Limit-Hour: 1000000
RateLimit-Limit: 4
X-RateLimit-Remaining-Hour: 999754
RateLimit-Remaining: 2
RateLimit-Reset: 1
X-Kong-Upstream-Latency: 3
X-Kong-Proxy-Latency: 0
Via: kong/2.1.4

HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Content-Length: 658
Connection: keep-alive
Server: Werkzeug/1.0.1 Python/3.9.0
Date: Sat, 07 Nov 2020 22:21:34 GMT
X-RateLimit-Limit-Second: 4
X-RateLimit-Remaining-Second: 1
X-RateLimit-Limit-Hour: 1000000
RateLimit-Limit: 4
X-RateLimit-Remaining-Hour: 999753
RateLimit-Remaining: 1
RateLimit-Reset: 1
X-Kong-Upstream-Latency: 3
X-Kong-Proxy-Latency: 1
Via: kong/2.1.4

HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Content-Length: 658
Connection: keep-alive
Server: Werkzeug/1.0.1 Python/3.9.0
Date: Sat, 07 Nov 2020 22:21:34 GMT
X-RateLimit-Limit-Second: 4
X-RateLimit-Remaining-Second: 0
X-RateLimit-Limit-Hour: 1000000
RateLimit-Limit: 4
X-RateLimit-Remaining-Hour: 999752
RateLimit-Remaining: 0
RateLimit-Reset: 1
X-Kong-Upstream-Latency: 3
X-Kong-Proxy-Latency: 1
Via: kong/2.1.4

HTTP/1.1 429 Too Many Requests
Date: Sat, 07 Nov 2020 22:21:34 GMT
Content-Type: application/json; charset=utf-8
Connection: keep-alive
Retry-After: 1
Content-Length: 41
X-RateLimit-Limit-Second: 4
X-RateLimit-Remaining-Second: 0
X-RateLimit-Limit-Hour: 1000000
RateLimit-Limit: 4
X-RateLimit-Remaining-Hour: 999752
RateLimit-Remaining: 0
RateLimit-Reset: 1
X-Kong-Response-Latency: 1
Server: kong/2.1.4
</code></pre>
<p><br><br></p>
<h3><a id="user-content-rules-precedence" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#rules-precedence"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Rules Precedence</h3>
<p>A plugin will always be run once and only once per request. But the configuration with which it will run depends on the entities it has been configured for.</p>
<p>Plugins can be configured for various entities, combination of entities, or even globally. This is useful, for example, when you wish to configure a plugin a certain way for most requests, but make authenticated requests behave slightly differently.</p>
<p>Therefore, there exists an order of precedence for running a plugin when it has been applied to different entities with different configurations. The rule of thumb is: the more specific a plugin is with regards to how many entities it has been configured on, the higher its priority.</p>
<p>The complete order of precedence when a plugin has been configured multiple times is:</p>
<ol>
<li>Plugins configured on a combination of: a Route, a Service, and a Consumer. (Consumer means the request must be authenticated).</li>
<li>Plugins configured on a combination of a Route and a Consumer. (Consumer means the request must be authenticated).</li>
<li>Plugins configured on a combination of a Service and a Consumer. (Consumer means the request must be authenticated).</li>
<li>Plugins configured on a combination of a Route and a Service.</li>
<li>Plugins configured on a Consumer. (Consumer means the request must be authenticated).</li>
<li>Plugins configured on a Route.</li>
<li>Plugins configured on a Service.</li>
<li>Plugins configured to run globally.</li>
</ol>
<p>Example: if the rate-limiting plugin is applied twice (with different configurations): for a Service (Plugin config A), and for a Consumer (Plugin config B), then requests authenticating this Consumer will run Plugin config B and ignore A. However, requests that do not authenticate this Consumer will fallback to running Plugin config A. Note that if config B is disabled (its enabled flag is set to false), config A will apply to requests that would have otherwise matched config B.</p>
<p><br><br></p>
<h3><a id="user-content-waf" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#waf"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>WAF</h3>
<p>Last but not lease , the api is configured behind Cloudflare,</p>
<p>the users <code>slow_user fast_user</code> are available in case you want to test directly the service.</p>
<p>Endpoint: <code>https://services.k8s.it/api/</code></p>
<p><br><br></p>
<p><code>$ curl -I -H "apikey:332d05445a560ee65a76aeaa372d8904" https://services.k8s.it/api/</code></p>
<pre><code>HTTP/2 200
date: Sun, 08 Nov 2020 10:14:21 GMT
content-type: text/html; charset=utf-8
set-cookie: __cfduid=dab5b88be5427314b7b17a1a65d3178a41604830461; <br>expires=Tue, 08-Dec-20 10:14:21 GMT; path=/; domain=.k8s.it; HttpOnly; <br>SameSite=Lax
vary: Accept-Encoding
x-ratelimit-limit-second: 4
x-ratelimit-remaining-second: 3
x-ratelimit-limit-hour: 1000000
ratelimit-limit: 4
x-ratelimit-remaining-hour: 999995
ratelimit-remaining: 3
ratelimit-reset: 1
x-kong-upstream-latency: 3
x-kong-proxy-latency: 4
via: kong/2.1.4
cf-cache-status: DYNAMIC
cf-request-id: 0648f2980000000f72931c2000000001
expect-ct: max-age=604800, <br>report-uri="https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct"
report-to: {"endpoints":[{"url":"https:\/\/a.nel.cloudflare.com\/report?s=z4j%2FU3og%2FT2jBByhUKZtShDNLfLMWncExIy3EowJ2hOPJ17oCB0oeyY1GVaXirT%2BgWpTEEu<br>U%2F03gx%2F91uOy3mGD%2BFE4FhBGqFt7iC2bhaPc%3D"}],"group":"cf-nel","max_age":604800}
nel: {"report_to":"cf-nel","max_age":604800}
server: cloudflare
cf-ray: 5eee86d319770f72-MXP
</code></pre>
<p><br><br></p>
<h2><a id="user-content-conclusion" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#conclusion"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Conclusion</h2>
<p>Kong is a scalable, open source API Gateway.<br>Kong runs in front of any RESTful API and is extended through Plugins, which provide extra functionality and services beyond the core platform.</p>
<p>The architecture is quite simple to understand and is made up of a few components…</p>
<ul>
<li>Kong base-module which wraps OpenResty and Nginx and is the engine which does the actual work</li>
<li>Database layer with choice of Cassandra or Postgres to store all the configuration so it can be retrieved easily in case of failures</li>
<li>Dashboard which provides User-Interface for API administration and viewing analytics (embedded in th Enerprise, third party for the community <em>Konga</em>)</li>
</ul>
<p>The Powerful of Kong is also supported by plugins from authentication, security, traffic control, logging, and etc…<br><br></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/d2a4de6795889077f983473c7575a12036254ec671f5440c6e63b68889926d65/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3438302f76313630373333323133302f6d6973632f554d4c5f6170695f67772e706e67"><img loading="lazy" title="uml_api_gw" src="https://camo.githubusercontent.com/d2a4de6795889077f983473c7575a12036254ec671f5440c6e63b68889926d65/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3438302f76313630373333323133302f6d6973632f554d4c5f6170695f67772e706e67" data-is-external-image="true"  alt="uml_api_gw" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_480/v1607332130/misc/UML_api_gw.png"></a></p>
<p> </p>
<p> </p>
<p>Monitoring is also covered well by default kong official prometheus available here <a href="https://github.com/Kong/kong-plugin-prometheus">https://github.com/Kong/kong-plugin-prometheus</a></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/28dedd2eae334443bd6e668838f06caedc99f3c5cbd95e5b8d12869015cad8e9/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630353732333433362f6d6973632f6b6f6e665f6d6f6e69746f722e706e67"><img loading="lazy" title="kong_monitor" src="https://camo.githubusercontent.com/28dedd2eae334443bd6e668838f06caedc99f3c5cbd95e5b8d12869015cad8e9/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630353732333433362f6d6973632f6b6f6e665f6d6f6e69746f722e706e67" data-is-external-image="true"  alt="kong_monitor" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1605723436/misc/konf_monitor.png"></a></p>
<p>Live: <a href="https://services.k8s.it/grafana/d/mY9p7dQmz/kong?orgId=2&amp;refresh=1m" rel="nofollow">https://services.k8s.it/grafana/d/mY9p7dQmz/kong?orgId=2&amp;refresh=1m</a></p>
<p> </p>
<p><strong>If your business exposes APIs, the API GATEWAY is a requirement to handle the third party.</strong></p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Python rest api test application</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/python-rest-api-test-application.html"/>
        <id>https://www.k8s.it/python-rest-api-test-application.html</id>
            <category term="test"/>
            <category term="restapi"/>
            <category term="rest-api"/>
            <category term="rest"/>
            <category term="python"/>
            <category term="kubernetes"/>
            <category term="docker"/>
            <category term="backend"/>
            <category term="api"/>
            <category term="PUT"/>
            <category term="POST"/>
            <category term="GET"/>
            <category term="DELETE"/>

        <updated>2020-11-20T23:08:55+01:00</updated>
            <summary>
                <![CDATA[
                        <img src="https://www.k8s.it/media/posts/15/Screenshot-2020-11-20-at-23.08.36.png" alt="" />
                    Working most of the times (always) in Platform i'm usually play with the infrastructure, however sometimes to create prototype i need backends that are done for the specific purpose. GOALS:The application must be a REST apiRun in kubernetes Docker and kubernetesThe application is working with&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                    <img src="https://www.k8s.it/media/posts/15/Screenshot-2020-11-20-at-23.08.36.png" alt="" />
                <p>Working most of the times (always) in Platform i'm usually play with the infrastructure, however sometimes to create prototype i need backends that are done for the specific purpose.</p>
<h2><a id="user-content-goals" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/py-test-backend#goals"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>GOALS:</h2>
<ul>
<li>The application must be a REST api</li>
<li>Run in kubernetes<br><br><br><br></li>
</ul>
<h3><a id="user-content-docker-and-kubernetes" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/py-test-backend#docker-and-kubernetes"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Docker and kubernetes</h3>
<p>The application is working with GET, POST, PUT, DELETE<br>enouth to cover most of the usages based on rest api.</p>
<p>Inside the docker path you can run easly as local docker</p>
<p><code>docker build --tag pytbak:0.1 .</code><br><code>docker run -t -p 5000:5000 pytbak:0.1</code><br>and access on it with <code>locahost:5000/api/</code></p>
<p>instead if you want to run it in kubernetes ,<br>starting from the main folder you can apply the kubernetes folder on your environment<br><code>kubectl apply -f kubernetes/</code></p>
<pre><code>$ kubectl  get pods -n pytbak
NAME                             READY   STATUS    RESTARTS   AGE
pytbak-stable-5dfb4fbfd4-n64kx   1/1     Running   0          40m
</code></pre>
<p>Remember to change the host in the ingress file configuration</p>
<pre><code>$ cat 03-ing-pytbak.yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: pytbak-ingress
  namespace: pytbak
  annotations:
    ingress.kubernetes.io/proxy-connect-timeout: "10"
    ingress.kubernetes.io/proxy-read-timeout: "30"
    ingress.kubernetes.io/proxy-send-timeout: "30"
spec:
  rules:
  - host: pytbak.ing.h4x0r3d.lan
    http:
      paths:
      - path: /
        backend:
          serviceName: pytbak-svc
          servicePort: 5000
</code></pre>
<p><em>host: pytbak.ing.h4x0r3d.lan</em> this is my ingress dns resolution</p>
<p>TIPS: for ingress endpoints you can manage multiple namespace creating an A record in your DNS (as a subdomain) with a wildcard dedicated only for ingress matching the namespace and the host created</p>
<p>in my case i have the home dns as <code>h4x0r3d.lan</code><br>and <code>*.ing.h4x0r3d.lan</code> as a record A of my kubernetes ingress<br>in this way if i create a namespace <em>pippo</em> the dns that i have to call to reach it out will be <em>pippo.ing.4x0r3d.lan</em> with no change on DNS.<br><br><br><br></p>
<h3><a id="user-content-usage" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/py-test-backend#usage"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Usage</h3>
<p>The application answer on /api/ with the main html page with methods</p>
<table>
<thead>
<tr>
<th>HTTP Method</th>
<th align="center">URI</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td align="center">http://[hostname]/api/get/context</td>
<td>Retrieve list of context</td>
</tr>
<tr>
<td>GET</td>
<td align="center">http://[hostname]/api/get/context/[context_id]</td>
<td>Retrieve a context</td>
</tr>
<tr>
<td>POST</td>
<td align="center">http://[hostname]/api/post/context</td>
<td>Create a new context</td>
</tr>
<tr>
<td>PUT</td>
<td align="center">http://[hostname]/api/put/context/[context_id]</td>
<td>Update an existing context</td>
</tr>
<tr>
<td>DELETE</td>
<td align="center">http://[hostname]/api/delete/context/[context_id]</td>
<td>Delete acontext</td>
</tr>
</tbody>
</table>
<p>Following the methods example</p>
<pre><code>$ curl -i http://pytbak.ing.h4x0r3d.lan/api/get/context
HTTP/1.1 200 OK
Server: openresty/1.15.8.1
Date: Wed, 28 Oct 2020 20:02:02 GMT
Content-Type: application/json
Content-Length: 696
Connection: keep-alive
Vary: Accept-Encoding

{
  "context": [
    {
      "description": "RHEL 6 based",
      "done": false,
      "title": "Cento 6",
      "uri": "http://pytbak.ing.h4x0r3d.lan/api/get/context/1"
    },
    {
      "description": "RHEL 7 based",
      "done": false,
      "title": "Centos 7",
      "uri": "http://pytbak.ing.h4x0r3d.lan/api/get/context/2"
    },
    {
      "description": "RHEL 8 based",
      "done": false,
      "title": "Centos 8",
      "uri": "http://pytbak.ing.h4x0r3d.lan/api/get/context/3"
    },
    {
      "description": "Fedora + RHEL based",
      "done": false,
      "title": "Centos stream",
      "uri": "http://pytbak.ing.h4x0r3d.lan/api/get/context/4"
    }
  ]
</code></pre>
<p><br><br></p>
<pre><code>$ curl -i -H "Content-Type: application/json" -X POST -d '{"title":"Ubuntu 20.04 LTS", "description":"focal"}' http://pytbak.ing.h4x0r3d.lan/api/post/context
HTTP/1.1 201 CREATED
Server: openresty/1.15.8.1
Date: Wed, 28 Oct 2020 19:49:31 GMT
Content-Type: application/json
Content-Length: 165
Connection: keep-alive

{
  "task": {
    "description": "focal",
    "done": false,
    "title": "Ubuntu 20.04 LTS",
    "uri": "http://pytbak.ing.h4x0r3d.lan/api/get/context/5"
  }
}
</code></pre>
<p><br><br></p>
<pre><code>$ curl -i -H "Content-Type: application/json" -X PUT -d '{"description":"Focal Fossa"}' http://pytbak.ing.h4x0r3d.lan/api/put/context/5
HTTP/1.1 200 OK
Server: openresty/1.15.8.1
Date: Wed, 28 Oct 2020 20:02:43 GMT
Content-Type: application/json
Content-Length: 171
Connection: keep-alive

{
  "task": {
    "description": "Focal Fossa",
    "done": false,
    "title": "Ubuntu 20.04 LTS",
    "uri": "http://pytbak.ing.h4x0r3d.lan/api/get/context/5"
  }
}
</code></pre>
<p><br><br></p>
<pre><code>$ curl -i -H "Content-Type: application/json" -X DELETE http://pytbak.ing.h4x0r3d.lan/api/delete/context/5
HTTP/1.1 200 OK
Server: openresty/1.15.8.1
Date: Wed, 28 Oct 2020 20:04:47 GMT
Content-Type: application/json
Content-Length: 21
Connection: keep-alive

{
  "result": true
}
$ curl -i http://pytbak.ing.h4x0r3d.lan/api/get/context/5
HTTP/1.1 404 NOT FOUND
Server: openresty/1.15.8.1
Date: Wed, 28 Oct 2020 20:04:54 GMT
Content-Type: application/json
Content-Length: 27
Connection: keep-alive

{
  "error": "Not found"
}</code><code></code></pre>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Kubernetes sitespeed.io</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/kubernetes-sitespeedio.html"/>
        <id>https://www.k8s.it/kubernetes-sitespeedio.html</id>
            <category term="workflow"/>
            <category term="sitespeed.io"/>
            <category term="sitespeed"/>
            <category term="observability"/>
            <category term="metrics"/>
            <category term="kubernetes"/>
            <category term="grafana"/>
            <category term="customer-view"/>
            <category term="argo"/>

        <updated>2020-11-14T22:55:02+01:00</updated>
            <summary>
                <![CDATA[
                    Hello First of all, this is a thought around a website metrics management, is not the only way, but is one way for a high level overview. How to read this ... However you can reach the GOAL just using docker and crontab for example&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <p>Hello</p>
<p>First of all, this is a thought around a website metrics management, is not the only way, but is one way for a high level overview.</p>
<p>How to read this ...</p>
<ul>
<li>i'm focused to share some concept about website monitoring</li>
<li>i'm sharing a possible way to manage in kubernetes</li>
<li>i'm using some other tools in kubernetes just because i'm evaluating this for other purpose</li>
</ul>
<p>However you can reach the GOAL just using docker and crontab for example<br><br><br><br></p>
<h2><a id="user-content-motivations" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-sitespeed.io#motivations"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Motivations</h2>
<p>Well ... a website is a product itself,<br>it could be a Wordpress, a Magento ecommerce or a structured multiple applications that owns each ones a different section of the website.</p>
<p>However if running a business on top, you should move your evolution as a customer perspective:</p>
<ul>
<li>how long does is take the website asnwer ?</li>
<li>is the response time common for all sections ?</li>
<li>new versions/deployments are better than before for the customer ?</li>
</ul>
<p>You know, if the response time is more than X seconds ... and you are selling a common gadgets that could be retrieved elsewhere , you are losing money and customer affiliation.</p>
<p>There are also some others problems... when someone in your company or a customer will say ... the website il slow</p>
<ul>
<li>Faster from my fiber home connection</li>
<li>Faster from my mobile premium plus SIM</li>
<li>Slow from wireless</li>
<li>Fast from wireless</li>
<li>No idea</li>
<li>Faster than … ?!?! compared to ... ?!?!</li>
</ul>
<p>No, look how it's slow (2g connection in the sahara desert)<br><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/3251fd1e9ec686be58b3f6c8669b185187843283/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3238362f76313630313533343536332f6d6973632f53637265656e73686f745f323032302d31302d30315f61745f30382e34302e30362e706e67"><img loading="lazy" title="reaction" src="https://camo.githubusercontent.com/3251fd1e9ec686be58b3f6c8669b185187843283/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3238362f76313630313533343536332f6d6973632f53637265656e73686f745f323032302d31302d30315f61745f30382e34302e30362e706e67" data-is-external-image="true"  alt="reaction" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_286/v1601534563/misc/Screenshot_2020-10-01_at_08.40.06.png"></a><br><br><br></p>
<p>Now, we know what we need ... DATA<br>Evaluate those during a long therm periode looking for performance</p>
<ul>
<li>release by release</li>
<li>feature by feature</li>
<li>etc etc</li>
</ul>
<p>First of all we have to test our websites on the customer position... so no 1gbit inline connection with 0.00001 roundtrip :)</p>
<p>From the multitude of products , webtest , lighthouse , selenium and so on i really like sitespeed.io<br><br><br></p>
<h3><a id="user-content-goal" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-sitespeed.io#goal"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>GOAL</h3>
<ul>
<li>be able to have an objective trend</li>
<li>check the goodness of releases</li>
</ul>
<p><br><br><br><br></p>
<h2><a id="user-content-the-customer-point-of-view" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-sitespeed.io#the-customer-point-of-view"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>The customer point of view</h2>
<p>You have to know your product and your customer ...</p>
<p>If you own the product you know that the customer is "forced" to buy by you. Immgine to are Apple, you know that customers are affiliated to you... so if something is slow, probably even if the device is available in other websites the customer will wait the answer.</p>
<p>On the opposite side if you are a retailer , and the product is quite common with no brandlove etc etc ... if the website is slow the user will change immediatly the website to land to somewhere else.<br><br></p>
<h3><a id="user-content-speed" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-sitespeed.io#speed"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Speed</h3>
<p>we usually define a <em>slowness</em> by a perception.</p>
<p>However , in 2020 you know the Data that comes from GA and understand when people leave a page , after some amount of time.</p>
<p>Consider those, rate and the timing to tune the threadshold</p>
<ul>
<li>Bounce</li>
<li>Leave/Exit</li>
</ul>
<p>and <ins>create the awareness</ins> about the limits and improvements you can achieve.</p>
<p>Example. If a search take more than 10seconds, say <em>ciao ciao</em> to the customer.</p>
<p>As said, when you mesure the speed you have to move yourself in the customer side ... so not all people has 1gbit connection , maybe the major are using mobile , maybe your host is in US and the customer in KR.<br>So ... internet connection should reflect the avg/wrost scenario Believe me that those data <a href="https://www.speedtest.net/global-index" rel="nofollow">https://www.speedtest.net/global-index</a> are quite optimistic :) i appreciate instead the documentation of sitespeed that has classified 4 networks</p>
<p><a href="https://www.sitespeed.io/documentation/sitespeed.io/connectivity/" rel="nofollow">https://www.sitespeed.io/documentation/sitespeed.io/connectivity/</a></p>
<ul>
<li>3g</li>
<li>3gfast</li>
<li>3gslow</li>
<li>cable</li>
</ul>
<p>I'd like to say that in 2020 <em>cable</em> and <em>3gfast</em> cover perfectly the wrost scenario</p>
<p>Even if you don't agree with the speed category, remember to look the graphs and the metrics considering the DELTA<br><br><br><br></p>
<h2><a id="user-content-sitespeedio" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-sitespeed.io#sitespeedio"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Sitespeed.io</h2>
<p>This tool is open source , has a huge extension , in this scenario<br>i'll use only parts of that since i don't need the video recording, or HAR files and so on.</p>
<p>A full report could be useful to check all feature and you can find here<br><a href="https://lorenzogirardi.github.io/sitespeedio-results/" rel="nofollow">https://lorenzogirardi.github.io/sitespeedio-results/</a></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/48cabf3aeb609d823d3b407a2eede60b8039c554/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630313338373533332f6d6973632f7369746573706565642d726573756c74732e706e67"><img loading="lazy" title="sitespeed-results" src="https://camo.githubusercontent.com/48cabf3aeb609d823d3b407a2eede60b8039c554/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630313338373533332f6d6973632f7369746573706565642d726573756c74732e706e67" data-is-external-image="true"  alt="sitespeed-results" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1601387533/misc/sitespeed-results.png"></a></p>
<p>and you can have those results only with using the docker image</p>
<p><code>docker run --rm -v "$(pwd):/sitespeed.io" sitespeedio/sitespeed.io:15.2.0 https://www.k8s.it/</code></p>
<p>is know easy understand that you can extend in crontab this code and add some other option to store metrics and results files in s3 for example</p>
<p><code>/usr/bin/docker run --privileged --shm-size=1g --rm --network=cable sitespeedio/sitespeed.io httos://www.example.com -v -b chrome --video --speedIndex -c cable --browsertime.iterations 1 --s3.key S3_KEY --s3.secret S3_SECRET --s3.bucketname S3_BUCKET --s3.removeLocalResult true --s3.path S3_PATH www.ecample.com --graphite.host GRAPHITE_HOST --graphite.port GRAPHITE_PORT --graphite.namespace GRAPHITE_PREFIX</code></p>
<p><br><br><br><br></p>
<h3><a id="user-content-case-of-study" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-sitespeed.io#case-of-study"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Case of study</h3>
<p>Since we have identified the tool i have to specify the use case</p>
<ul>
<li>I need only metrics in this example because, so i don't need to store the output artifact</li>
<li>I want to store the metrics in influxdb</li>
<li>I want to run it not as a docker but inside kubernetes</li>
<li>TBD i'd like to orchestrate actions</li>
</ul>
<p>The sitespeed.io docker fit perfectly in a kubernetes cronjob vision<br><a href="https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/" rel="nofollow">https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/</a><br>is done to start, execute an action and exit</p>
<p>However i'd like to explore a workflow manager ... not just for this case but also to exend some other <em>jobs</em><br><br><br></p>
<h4><a id="user-content-argo" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-sitespeed.io#argo"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Argo</h4>
<p>I chose this product because i was interested to have something similar to Rundeck , but with more extended capability in order to be possible build a ci/cd without spinnaker<br><a href="https://argoproj.github.io/" rel="nofollow">https://argoproj.github.io/</a></p>
<p>The installation is quite easy , i've just trick a configmap due to volume mount problem genereted by my small kubernetes installation</p>
<p>For a basic installation you need to create a dedicated namespace<br><code>kubectl create namespace argo</code></p>
<p>and than deploy the argo infrastructure (server and workflow)<br><code>kubectl apply -n argo -f https://raw.githubusercontent.com/argoproj/argo/stable/manifests/install.yaml</code></p>
<pre><code>NAMESPACE      NAME                                       READY   STATUS      RESTARTS   AGE
argo           argo-server-6c886c5b77-l8jfv               1/1     Running     1          2d13h
argo           workflow-controller-65948977d-zc9vt        1/1     Running     0          2d14h
</code></pre>
<p>As mentioned before i discover a <em>bug</em> (just because i use containerd instead docker in microk8s) , running the firt job<br><code>MountVolume.SetUp failed for volume "docker-lib" : hostPath type check failed: /var/lib/docker is not a directory</code><br>However adding</p>
<pre><code>data:
  config: |
    containerRuntimeExecutor: pns
</code></pre>
<p>in <code>workflow-controller-configmap</code></p>
<p>i fixed the issue.</p>
<p><br><br></p>
<p>Well now Argo is running and you can interact with the web UI or creating a services and a ingress configuration or with the port forwarding.<br>Since i'm now experimenting the solution i'm just using the second option.</p>
<pre><code>$ kubectl -n argo port-forward deployment/argo-server 2746:2746
Forwarding from 127.0.0.1:2746 -&gt; 2746
Forwarding from [::1]:2746 -&gt; 2746
</code></pre>
<p>The UI interface is pretty clean and the authentication model follow the RBAC policy</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/c71a2d41217a3e5ddd0f1f0f5d8be257c5837273/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313535393038372f6d6973632f6172676f5f342e706e67"><img loading="lazy" title="argo_4" src="https://camo.githubusercontent.com/c71a2d41217a3e5ddd0f1f0f5d8be257c5837273/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313535393038372f6d6973632f6172676f5f342e706e67" data-is-external-image="true"  alt="argo_4" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1080/v1601559087/misc/argo_4.png"></a></p>
<p>The editor as well is really good and if i have to think about a solution to share to other teams/depts , this has a good level of abstraction (at least you need to know what is contab)</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/8018d2f4ee3abd5e64fab8b04a8a8942cd5be16f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313535393038372f6d6973632f6172676f5f312e706e67"><img loading="lazy" title="argo_1" src="https://camo.githubusercontent.com/8018d2f4ee3abd5e64fab8b04a8a8942cd5be16f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313535393038372f6d6973632f6172676f5f312e706e67" data-is-external-image="true"  alt="argo_1" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1080/v1601559087/misc/argo_1.png"></a></p>
<p>All informations are shared with the most relevant needs<br><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/edbf1e994dd7efc315e1d356c7222b3829b36891/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313535393038382f6d6973632f6172676f5f332e706e67"><img loading="lazy" title="argo_3" src="https://camo.githubusercontent.com/edbf1e994dd7efc315e1d356c7222b3829b36891/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313535393038382f6d6973632f6172676f5f332e706e67" data-is-external-image="true"  alt="argo_3" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1080/v1601559088/misc/argo_3.png"></a></p>
<p>Events could be retrieved and evaluated as well<br><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/a472dbd7228b9b098ad942a92a2f336a228f32d0/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3432302f76313630313535393038372f6d6973632f6172676f5f362e706e67"><img loading="lazy" title="argo_6" src="https://camo.githubusercontent.com/a472dbd7228b9b098ad942a92a2f336a228f32d0/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3432302f76313630313535393038372f6d6973632f6172676f5f362e706e67" data-is-external-image="true"  alt="argo_6" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_420/v1601559087/misc/argo_6.png"></a></p>
<p>Last but not least .... logs are in the UI <a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/75169652516669d95b5549e5791198c3a937b5cc/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313535393038372f6d6973632f6172676f5f352e706e67"><img loading="lazy" title="argo_5" src="https://camo.githubusercontent.com/75169652516669d95b5549e5791198c3a937b5cc/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313535393038372f6d6973632f6172676f5f352e706e67" data-is-external-image="true"  alt="argo_5" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1080/v1601559087/misc/argo_5.png"></a></p>
<p><br><br></p>
<h3><a id="user-content-results" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-sitespeed.io#results"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Results</h3>
<p>We are now able to see the metrics in grafana...</p>
<p>you have 2 option , what is used in the<br><code>001-argo-job-sitespeedio.yaml</code><br>is the <em>influxdb</em> backend that could be rendered using</p>
<p><a href="https://github.com/sitespeedio/grafana-bootstrap-docker/blob/main/dashboards/influxdb/pageSummary.json">https://github.com/sitespeedio/grafana-bootstrap-docker/blob/main/dashboards/influxdb/pageSummary.json</a></p>
<p>LIVE VIEW <a href="https://services.k8s.it/grafana/d/000000053/pagesummary-influxdb?orgId=2&amp;refresh=15m" rel="nofollow">https://services.k8s.it/grafana/d/000000053/pagesummary-influxdb?orgId=2&amp;refresh=15m</a></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/db62aefc87c98b7a8ded25c187d55e255a412a62/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313636313234342f6d6973632f67726166616e615f312e706e67"><img loading="lazy" title="grafana_1" src="https://camo.githubusercontent.com/db62aefc87c98b7a8ded25c187d55e255a412a62/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313636313234342f6d6973632f67726166616e615f312e706e67" data-is-external-image="true"  alt="grafana_1" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1080/v1601661244/misc/grafana_1.png"></a></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/3eebdf9d9e19c08aa1a4f21dfd711c20ecce1c6a/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313636313234332f6d6973632f67726166616e615f322e706e67"><img loading="lazy" title="grafana_2" src="https://camo.githubusercontent.com/3eebdf9d9e19c08aa1a4f21dfd711c20ecce1c6a/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313636313234332f6d6973632f67726166616e615f322e706e67" data-is-external-image="true"  alt="grafana_2" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1080/v1601661243/misc/grafana_2.png"></a></p>
<p>However you can also use <em>graphite</em> backend with the same metrics (even more with provided dashboards)</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/cfd27795ad1dfe9a29dd6658313cb044de1b8a80/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313636313832382f6d6973632f67726170686974655f312e706e67"><img loading="lazy" title="graphite_1" src="https://camo.githubusercontent.com/cfd27795ad1dfe9a29dd6658313cb044de1b8a80/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313636313832382f6d6973632f67726170686974655f312e706e67" data-is-external-image="true"  alt="graphite_1" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1080/v1601661828/misc/graphite_1.png"></a></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/f9f4a443bf3d57412c65f77a94bc1eb149ba0d4e/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313636313832382f6d6973632f67726170686974655f322e706e67"><img loading="lazy" title="graphite_2" src="https://camo.githubusercontent.com/f9f4a443bf3d57412c65f77a94bc1eb149ba0d4e/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313636313832382f6d6973632f67726170686974655f322e706e67" data-is-external-image="true"  alt="graphite_2" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1080/v1601661828/misc/graphite_2.png"></a></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/7e56609ce946b33a53517c01bd7ab7e0f5516334/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313636313832382f6d6973632f67726170686974655f332e706e67"><img loading="lazy" title="graphite_3" src="https://camo.githubusercontent.com/7e56609ce946b33a53517c01bd7ab7e0f5516334/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313636313832382f6d6973632f67726170686974655f332e706e67" data-is-external-image="true"  alt="graphite_3" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1080/v1601661828/misc/graphite_3.png"></a></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/c6079d0125e7cc38de67e40345b234313a3bf107/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313636313832392f6d6973632f67726170686974655f342e706e67"><img loading="lazy" title="graphite_4" src="https://camo.githubusercontent.com/c6079d0125e7cc38de67e40345b234313a3bf107/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313038302f76313630313636313832392f6d6973632f67726170686974655f342e706e67" data-is-external-image="true"  alt="graphite_4" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1080/v1601661829/misc/graphite_4.png"></a></p>
<p><br><br><br><br></p>
<h2><a id="user-content-whats-next" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-sitespeed.io#whats-next"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>WHAT'S NEXT</h2>
<p>Sitespeed is really good to have an high level view but also details that probably could save load time.</p>
<p>The introduction of Argo can orchestrate multiple checks on all pages/application you need to monitor without a specific crontab time for each job but considering a producer/consumer workflow.</p>
            ]]>
        </content>
    </entry>
    <entry>
        <title> Kubernetes postfix</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/kubernetes-postfix.html"/>
        <id>https://www.k8s.it/kubernetes-postfix.html</id>
            <category term="tls"/>
            <category term="spf"/>
            <category term="postfix"/>
            <category term="kubernetes"/>
            <category term="dmarc"/>
            <category term="dkim"/>

        <updated>2020-11-14T22:55:07+01:00</updated>
            <summary>
                <![CDATA[
                     Long story short my vps provider changed tha ammount for the small instance from 1$ to 3$ so i took the advantage to switch my postfix service from cloud to onprem. Why, since the world is moving to cloud ? Because my own domain is&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <h1> </h1>
<p>Long story short my vps provider changed tha ammount for the small instance from 1$ to 3$<br>so i took the advantage to switch my postfix service from cloud to onprem.</p>
<p>Why, since the world is moving to cloud ?<br>Because my own domain is used just for alerting and small other stuff and 3$ month is creazy :)<br>Anyway i'll lost some good stuff like static ip and possibility ti have a ptr dns.<br>Shit happens it's just for my stuff.</p>
<p>However we have 3 different topics to describe in this project</p>
<ul>
<li>what is an email</li>
<li>postfix configuration</li>
<li>postfix in kubernetes</li>
</ul>
<h2><a id="user-content-what-is-an-email" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-postfix#what-is-an-email"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>what is an email</h2>
<p>send email sometimes is a dedicated work in an enterprise company.<br>There are many aspect to consider , not only infrastructure , like che segmentation of domains strategy,<br>email answer engagement and each isp is using a different threashold to mark your email as a spam,<br>however now we will focus only on the generic configuration with some minimum requirements.</p>
<p>Here some topic that you probably know:</p>
<ul>
<li>TLS (add an encrypted connection in delivery)</li>
<li>Sender-Id (mostly used for microsoft ecosystem)</li>
<li>PTR record (used to check the corrispondence of a real smtp)</li>
<li>SPF record (used on TXT level to define an whitelist of "smtp allowed to ...")</li>
<li>Dkim (a private and public certificate to match the smtp and emails)</li>
<li>Dmarc (a mix with SPF and Dkim to protect the domain from unauthorized use )</li>
</ul>
<h2><a id="user-content-postfix-configuration" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-postfix#postfix-configuration"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>postfix configuration</h2>
<p>The second one is more related to middleware behaviour<br>i have a domain "example.com" and i'd like to</p>
<ul>
<li>receive email from and to this domain</li>
<li>have catchall system to do not configure any email account but using everything <a href="mailto:a@example.com">a@example.com</a>, <a href="mailto:b@example.com">b@example.com</a>, <a href="mailto:whatever@example.com">whatever@example.com</a></li>
<li>relay all the emails to my gmail account</li>
<li>reject the email that are tried to sent outside my chosed domains</li>
</ul>
<p>For all those topics the main configuration is in virtual and transport map in <em>postfix</em><br>There are some articles in internet, i'll avoid to reinvent hot water with the explanation.</p>
<h2><a id="user-content-postfix-in-kubernetes" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-postfix#postfix-in-kubernetes"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>postfix in kubernetes</h2>
<p>just as recap this was the configuration in the cloud vps</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/66d40f312601abf8ba03699a66366d6455c0805f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539383336363436332f6d6973632f7670732e706e67"><img loading="lazy" title="vps" src="https://camo.githubusercontent.com/66d40f312601abf8ba03699a66366d6455c0805f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539383336363436332f6d6973632f7670732e706e67" data-is-external-image="true"  alt="vps" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1598366463/misc/vps.png"></a></p>
<p>now i just whitched the MX to my own microk8s lab</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/fd6de4c35300c6596ca2eafcfde2d501bd4c9576/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539383336363436352f6d6973632f6d6963726f6b38732e706e67"><img loading="lazy" title="microk8s" src="https://camo.githubusercontent.com/fd6de4c35300c6596ca2eafcfde2d501bd4c9576/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539383336363436352f6d6973632f6d6963726f6b38732e706e67" data-is-external-image="true"  alt="microk8s" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1598366465/misc/microk8s.png"></a></p>
<p>However , inside the box a lot of implementation way can be taken</p>
<h3><a id="user-content-scenario-1" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-postfix#scenario-1"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Scenario 1:</h3>
<p>you can build an image for each dedicate purpose</p>
<ul>
<li>postfix</li>
<li>rsyslog</li>
<li>opendkim</li>
<li>tls</li>
</ul>
<h3><a id="user-content-scenario-2" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-postfix#scenario-2"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Scenario 2:</h3>
<p>looking the configuration adopted in <em>Scenario 1</em> , you can add an ingress tcp forward where<br>you can also add a tls layer with cert-manager (the new kube-lego).</p>
<h3><a id="user-content-scenario-3" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-postfix#scenario-3"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Scenario 3:</h3>
<p><em>Scenario 2</em> plus external storage for logs<br>etc etc</p>
<h3><a id="user-content-scenario-lazy" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-postfix#scenario-lazy"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Scenario Lazy:</h3>
<p>Embedded docker images with all you need with a node port (used only because i have a standalone kubernetes node).</p>
<p>Well having everything in one single container the docker image reflect the pachage used in a virtual machine</p>
<pre><code>FROM debian:buster
MAINTAINER lgirardi &lt;l@k8s.it&gt;

EXPOSE 25/tcp

RUN apt-get -y update &amp;&amp; apt-get -yq install \
	postfix \
	bsd-mailx \
	opendkim \
	opendkim-tools \
	sasl2-bin \
	rsyslog \
        supervisor


# Add files
ADD run.sh /opt/run.sh

# Run
CMD /opt/run.sh;/usr/bin/supervisord -c /etc/supervisor/supervisord.conf
</code></pre>
<p>where the <code>run.sh</code> is the supervisord daemon managing the process.</p>
<ul>
<li>postfix</li>
<li>rsyslog</li>
<li>opendkim</li>
</ul>
<p>The structure used is done to leave the configuration as a configmap and secrets<br>this will help in case you have to tune your system whiout regenerate the images that honestly make no sense to be build each deploy.</p>
<p>As you see the deployment files has a huge number of volumes</p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: postfix
  namespace: postfix
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: postfix
  template:
    metadata:
      labels:
        app: postfix
    spec:
      containers:
      - name: postfix
        image: lgirardi/kubernetes-postfix:v0.2
        lifecycle:
          postStart:
            exec:
              command: [ "bin/bash", "-c", "postmap /etc/postfix/virtual &amp;&amp; postmap /etc/postfix/transport &amp;&amp; supervisorctl restart postfix" ]
        securityContext:
          capabilities:
            add:
            - NET_ADMIN
        ports:
        - name: smtp
          containerPort: 25
        volumeMounts:
        - name: opendkim-key
          mountPath: /etc/mail/dkim-k8s/keys/YOUR_DOMAIN/YOUR_DOMAIN.private
          subPath: opendkim-key
        - name: ca-crt
          mountPath: /etc/postfix/tls/ca.crt
          subPath: ca-crt
        - name: ca-key
          mountPath: /etc/postfix/tls/ca.key
          subPath: ca-key
        - name: postfix-transport
          mountPath: /etc/postfix/transport
          subPath: transport
        - name: postfix-virtual
          mountPath: /etc/postfix/virtual
          subPath: virtual
        - name: postfix-headerchecks
          mountPath: /etc/postfix/header_checks
          subPath: header_checks
        - name: postfix-maincf
          mountPath: /etc/postfix/main.cf
          subPath: main.cf
        - name: postfix-opendkimconf
          mountPath: /etc/opendkim.conf
          subPath: opendkim.conf
        - name: postfix-keytable
          mountPath: /etc/opendkim/KeyTable
          subPath: KeyTable
        - name: postfix-signingtable
          mountPath: /etc/opendkim/SigningTable
          subPath: SigningTable
        - name: postfix-trustedhosts
          mountPath: /etc/opendkim/TrustedHosts
          subPath: TrustedHosts
      volumes:
        - name: postfix-transport
          configMap:
            name: postfix-conf
            items:
            - key: transport
              path: transport
        - name: postfix-virtual
          configMap:
            name: postfix-conf
            items:
            - key: virtual
              path: virtual
        - name: postfix-headerchecks
          configMap:
            name: postfix-conf
            items:
            - key: header_checks
              path: header_checks
        - name: postfix-maincf
          configMap:
            name: postfix-conf
            items:
            - key: main.cf
              path: main.cf
        - name: postfix-opendkimconf
          configMap:
            name: postfix-conf
            items:
            - key: opendkim.conf
              path: opendkim.conf
        - name: postfix-keytable
          configMap:
            name: postfix-conf
            items:
            - key: KeyTable
              path: KeyTable
        - name: postfix-signingtable
          configMap:
            name: postfix-conf
            items:
            - key: SigningTable
              path: SigningTable
        - name: postfix-trustedhosts
          configMap:
            name: postfix-conf
            items:
            - key: TrustedHosts
              path: TrustedHosts
        - name: opendkim-key
          secret:
            secretName: postfix-secret
        - name: ca-crt
          secret:
            secretName: postfix-secret
        - name: ca-key
          secret:
            secretName: postfix-secret
</code></pre>
<p>Here we have the configuration for:</p>
<ul>
<li>main.cf</li>
<li>transport</li>
<li>virtual</li>
<li>header_checks</li>
<li>opendkim.conf</li>
<li>KeyTable</li>
<li>SigningTable</li>
<li>TrustedHosts</li>
</ul>
<p>You can change this aspect , is mostly related to the infrastructure where you fit the pod<br>and the company CI/CD</p>
<p><strong>Remember to ADD your right values inside secrets and configmap where you have CAPS like <code>YOUR_DOMAIN</code></strong></p>
<p>running the <em>apply</em> on kubernetes folder you will have the pod running<br><code>postfix postfix-7d664f786c-rmf54 1/1 Running 0 29m</code></p>
<p>and loogking the logs i can see</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/694d0f364b26c0474b15921ff1ff8a4135190933/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539383336393033322f6d6973632f706f73746669786c6f672e706e67"><img loading="lazy" title="postfixlog" src="https://camo.githubusercontent.com/694d0f364b26c0474b15921ff1ff8a4135190933/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539383336393033322f6d6973632f706f73746669786c6f672e706e67" data-is-external-image="true"  alt="postfixlog" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1598369032/misc/postfixlog.png"></a></p>
<p>The <code>key data is not secure</code> just a working because i've enabled this option in the configmap <code>RequireSafeKeys false</code><br>but the certificate is applied <code>opendkim[22]: 91E522A000C: DKIM-Signature field added</code></p>
<p>Last one is the check on the client side with the righ option enabled</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/66fffe878e76dbeff1853c4abaf19f846af46529/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539383336383833352f6d6973632f656d61696c6f7074696f6e2e706e67"><img loading="lazy" title="clientemail" src="https://camo.githubusercontent.com/66fffe878e76dbeff1853c4abaf19f846af46529/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539383336383833352f6d6973632f656d61696c6f7074696f6e2e706e67" data-is-external-image="true"  alt="clientemail" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1598368835/misc/emailoption.png"></a></p>
<h2><a id="user-content-conclusion" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-postfix#conclusion"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Conclusion</h2>
<p>You can add postfix infrastructure to kubernetes with no problems at all ,<br>this project is a <em>prototype</em> , in a production infrastructure you can work around this to let it rock solid and scalable</p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Kubernetes servicemesh</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/kubernetes-servicemesh.html"/>
        <id>https://www.k8s.it/kubernetes-servicemesh.html</id>
            <category term="service mesh"/>
            <category term="rate limit"/>
            <category term="observability"/>
            <category term="metrics"/>
            <category term="linkerd"/>
            <category term="kubernetes"/>
            <category term="kiali"/>
            <category term="istio"/>
            <category term="cilium"/>
            <category term="api"/>

        <updated>2020-11-14T22:55:12+01:00</updated>
            <summary>
                <![CDATA[
                    Do we need a service mesh ?few years ago i started to evaluate this feature fitting in an existing infrastructure There are many concept to consider and many mistake the people usually think Better to start with what is NOT a work for a service mesh So&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <h2>Do we need a service mesh ?</h2>
<p>few years ago i started to evaluate this feature fitting in an existing infrastructure</p>
<p>There are many concept to consider and many mistake the people usually think<br>Better to start with what is <em>NOT</em> a work for a service mesh</p>
<ul>
<li>is not an apigw (even if could share some components)</li>
<li>is not the place to put firewall rules</li>
<li>is not something magic that boost the applications</li>
<li>is something that if not used with a know scope could generate a mess</li>
</ul>
<p>So what is ...<br>well short answer</p>
<ul>
<li>is the missing link in the infrastructure observability</li>
<li>is a way to handle in a structured way the application routing</li>
<li>is an internal ratelimit / anti ddos / infrastructure layer (be careful)</li>
<li>could be a clever way to improve some application limits (expanded next)</li>
</ul>
<p>Anyway is this something that we can add in our infrastructure ?</p>
<p>There no YES/NO , however we can evaluate the company and the maturity of microservices<br>internal rate limit , is usually a feature that could safe the infrastructure during snowball effects<br>however means that if the infrastructure is SYNC (no decoupling) have the rate limit can just<br>stop the application to serve requests , and this will propagated to the others below.</p>
<p>result: no answer<br>threads safe</p>
<p>Sometimes it's better to have a strategic business login using the a circuit breaker that bring a huge complexity in configuration.</p>
<p>The other point related to rate limit is .. who will maintain those values ?<br>Should be part of deployment pipeline and directly correlated with the application scope<br>In a 200+ micro services infrastructure this could be a huge problem:</p>
<ul>
<li>project that lost ownership</li>
<li>projects not well maintained</li>
<li>new legacy projects</li>
</ul>
<p>So my idea about rate limit is to use it in a specific "strategic" applications and should not indiscriminately added to the whole infrastructure</p>
<p>About the routing feature, we can consider as a more detailed and customized blue green deployment , this specific case it's really useful when we have to deploy new features in production and <em>canary</em> deployment is not enough to cover the business measurement we need.</p>
<p>This feature could be used to keep a specific affinity within the microservices and this is the real feature that some of you can consider, imagine a strict dependencies between application an cache (as usual)<br>So the application <em>Pippo</em> is using the cache <em>Paperino</em></p>
<p>Pippo is a namespace composed by 10 pods<br>Paperino is a cache composed by 6 pods</p>
<p>Imagine that we have the cache as a replication/sharded and we have 2 availability zones</p>
<p>With service mesh we can use labels to say to Pippo to use the cache Paperino only in the availability zone where the call start from Pippo av, this will reduce dramatically the roundtrip and the answer</p>
<p>I played a bit with service mesh in order to answer some questions,<br>however related to firewall rules the right answer is Cilium :-)</p>
<p>With this, I'd like to say that service mash give you a great value only<br>if your infrastructure is able to embrace it and only if you know what you are doing with this infrastructure.</p>
<ul>
<li>observability</li>
<li>routing purpose (this is strictly related to the microservice architecture)</li>
<li>rate limitng</li>
</ul>
<h2><a id="user-content-service-mesh-sample-lab" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-servicemesh#service-mesh-sample-lab"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Service Mesh sample lab</h2>
<p>This lab is provided to discover and test the functionality w'd like to implement in our environment</p>
<h3><a id="user-content-basic-setup" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-servicemesh#basic-setup"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Basic setup</h3>
<ul>
<li>minikube v1.6.2</li>
<li>Kubernetes v1.17.0 on Docker '19.03.5'</li>
</ul>
<p><code>curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64</code> <code>chmod +x minikube</code><br><code>sudo install minikube /usr/local/bin/</code><br><code>minikube start --memory=3000 --cpus=3</code></p>
<ul>
<li>network (since in production we are using flannel that is not able to manage network policy we can start using no CNI to have the environment as much as close to lmn environment)</li>
</ul>
<h4><a id="user-content-namespaces" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-servicemesh#namespaces"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Namespaces</h4>
<p>a → traefik (ingress)<br>b → apache<br>c → application<br>d → redis</p>
<p>b is a namespaces that manage an apache used for some rewrite rules<br>c is a python application that is connected to a redis database, provide some function to set a time, get a time with /set context and /get context<br>d is the redis database</p>
<p>c code</p>
<pre><code>"""
    Example app that integrates with redis and save/get timing
"""
from os import environ
from datetime import datetime
import json
import redis
from flask import Flask, redirect

VERSION = "1.1.1"
REDIS_ENDPOINT = environ.get("REDIS_ENDPOINT", "redis-svc.d-redis.svc.cluster.local")
REDIS_PORT = int(environ.get("REDIS_PORT", "6379"))


APP = Flask(__name__)


@APP.route("/")
def redisapp():
    """Main redirect"""
    return redirect("/get", code=302)


@APP.route("/set")
def set_var():
    """Set the time"""
    red = redis.StrictRedis(host=REDIS_ENDPOINT, port=REDIS_PORT, db=0)
    red.set("time", str(datetime.now()))
    return json.dumps({"time": str(red.get("time"))})


@APP.route("/get")
def get_var():
    """Get the time"""
    red = redis.StrictRedis(host=REDIS_ENDPOINT, port=REDIS_PORT, db=0)
    return json.dumps({"time": str(red.get("time"))})


@APP.route("/reset")
def reset():
    """Reset the time"""
    red = redis.StrictRedis(host=REDIS_ENDPOINT, port=REDIS_PORT, db=0)
    red.delete("time")
    return json.dumps({"time": str(red.get("time"))})


@APP.route("/version")
def version():
    """Get the app version"""
    return json.dumps({"version": VERSION})


@APP.route("/healthz")
def health():
    """Check the app health"""
    try:
        red = redis.StrictRedis(host=REDIS_ENDPOINT, port=REDIS_PORT, db=0)
        red.ping()
    except redis.exceptions.ConnectionError:
        return json.dumps({"ping": "FAIL"})

    return json.dumps({"ping": red.ping()})


@APP.route("/readyz")
def ready():
    """Check the app readiness"""
    return health()


if __name__ == "__main__":
    APP.run(debug=True, host="0.0.0.0")
</code></pre>
<p>Dokerfile</p>
<pre><code>FROM python:3.6-alpine
COPY . /app
WORKDIR /app
RUN pip install -r requirements.txt
ENTRYPOINT ["python"]
CMD ["app.py"]
</code></pre>
<p>requirements.txt</p>
<pre><code>Flask
redis
pytest
pytest-flask
</code></pre>
<h3><a id="user-content-folders-structure" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-servicemesh#folders-structure"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Folders structure</h3>
<pre><code>kubernetes/
├── 00-traefik
│   ├── A-00-traefik-ns.yaml
│   ├── A-01-traefik-rbac.yaml
│   └── A-02-traefik-ds.yaml
├── 01-apache
│   ├── B-00-k8s-apacherr-ns.yaml
│   ├── B-01-k8s-apacherr-svc.yaml
│   ├── B-02-k8s-apacherr-ing.yaml
│   ├── B-03-k8s-apacherr-dpl.yaml
│   └── B-04-k8s-apacherr-cfm.yaml
├── 02-redis
│   ├── D-00-lab-redis-ns.yaml
│   ├── D-01-lab-redis-svc.yaml
│   └── D-02-lab-redis-dpl.yaml
└── 03-app
    ├── C-00-app-ns.yaml
    ├── C-01-app-svc.yaml
    └── C-02-app-dpl.yaml
</code></pre>
<h3><a id="user-content-startup" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-servicemesh#startup"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Startup</h3>
<p>kubernetes$ kubectl apply -f 00-traefik/</p>
<pre><code>namespace/a-ingress-traefik created  
clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller created    
serviceaccount/traefik-ingress-controller created  
clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller created
serviceaccount/traefik-ingress-controller created
daemonset.apps/traefik-ingress-controller created
service/traefik-ingress-service created
</code></pre>
<p>kubernetes$ kubectl apply -f 01-apache/</p>
<pre><code>namespace/b-apacherr created
service/apacherr-svc created
ingress.extensions/apacherr-ingress created
deployment.apps/apacherr created
configmap/apacherr-80-config created
</code></pre>
<p>kubernetes$ kubectl apply -f 02-redis/</p>
<pre><code>namespace/d-redis created
service/redis-svc created
deployment.apps/redis created
</code></pre>
<p>kubernetes$ kubectl apply -f 03-app/</p>
<pre><code>namespace/c-app-count created    
service/app-count-svc created  
deployment.apps/pythonapp created  
</code></pre>
<p>kubectl get po --all-namespaces</p>
<pre><code>NAMESPACE           NAME                               READY   STATUS    RESTARTS   AGE
a-ingress-traefik   traefik-ingress-controller-jkppg   1/1     Running   0          5m29s
b-apacherr          apacherr-8b786b45d-g9vcl           1/1     Running   0          5m19s
c-app-count         pythonapp-555d6d88cd-slhfb         1/1     Running   0          4m55s
d-redis             redis-b869b89d-pf6ms               1/1     Running   0          5m12s
kube-system         coredns-6955765f44-6nrdr           1/1     Running   1          74m
kube-system         coredns-6955765f44-9fbgt           1/1     Running   1          74m
kube-system         etcd-minikube                      1/1     Running   1          74m
kube-system         kube-addon-manager-minikube        1/1     Running   1          74m
kube-system         kube-apiserver-minikube            1/1     Running   1          74m
kube-system         kube-controller-manager-minikube   1/1     Running   1          74m
kube-system         kube-proxy-cchls                   1/1     Running   1          74m
kube-system         kube-scheduler-minikube            1/1     Running   1          74m
kube-system         storage-provisioner                1/1     Running   2          74m
</code></pre>
<p>make sure virtualbox 8081 port should be available</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/f303afac85505ee6e02651c55518f1eb809a6f97/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539343537333731352f6d6973632f696d675f7669727475616c626f782d706f7274666f7277617264696e672e706e67"><img loading="lazy" title="Virtualbox port forwarding" src="https://camo.githubusercontent.com/f303afac85505ee6e02651c55518f1eb809a6f97/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539343537333731352f6d6973632f696d675f7669727475616c626f782d706f7274666f7277617264696e672e706e67" data-is-external-image="true"  alt="Virtualbox port forwarding" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1594573715/misc/img_virtualbox-portforwarding.png"></a></p>
<h2><a id="user-content-flow" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-servicemesh#flow"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>flow</h2>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/70a420864968278b8940023ba6aa95dd7bf932a6/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539343537333731342f6d6973632f696d675f666c6f772e706e67"><img loading="lazy" title="flow" src="https://camo.githubusercontent.com/70a420864968278b8940023ba6aa95dd7bf932a6/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539343537333731342f6d6973632f696d675f666c6f772e706e67" data-is-external-image="true"  alt="flow" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1594573714/misc/img_flow.png"></a></p>
<h5><a id="user-content-inizialize-the-redis-database" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-servicemesh#inizialize-the-redis-database"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>inizialize the redis database</h5>
<p><code>$ curl http://pippo.lan/count/set</code><br>{"time": "b'2019-12-28 20:06:33.919059'"}</p>
<h5><a id="user-content-test-from-apache-to-application-case-1" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-servicemesh#test-from-apache-to-application-case-1"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>test from apache to application (case 1)</h5>
<p><code>$ curl http://pippo.lan/count/get</code><br>{"time": "b'2019-12-28 20:06:33.919059'"}</p>
<h5><a id="user-content-test-from-apache-to-redis-case-2" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-servicemesh#test-from-apache-to-redis-case-2"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>test from apache to redis (case 2)</h5>
<p><code>$ curl http://pippo.lan/redis/GET/time</code><br>{"GET":"2019-12-28 20:06:33.919059"}</p>
<h5><a id="user-content-network-rule-example" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-servicemesh#network-rule-example"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>network rule example</h5>
<p>cilium labels</p>
<pre><code>ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                           IPv6   IPv4            STATUS   
           ENFORCEMENT        ENFORCEMENT                                                                                               
201        Disabled           Disabled          32580      k8s:app=redis                                                10.15.182.193   ready   
                                                           k8s:io.cilium.k8s.namespace.labels.name=d-redis                                      
                                                           k8s:io.cilium.k8s.policy.cluster=default                                             
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                      
                                                           k8s:io.kubernetes.pod.namespace=d-redis                                              
                                                           k8s:track=redis                                                                      
1257       Disabled           Disabled          4          reserved:health                                              10.15.197.106   ready   
1663       Disabled           Disabled          54130      k8s:app=apacherr                                             10.15.192.41    ready   
                                                           k8s:io.cilium.k8s.namespace.labels.name=b-apacherr                                   
                                                           k8s:io.cilium.k8s.policy.cluster=default                                             
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                      
                                                           k8s:io.kubernetes.pod.namespace=b-apacherr                                           
3167       Disabled           Disabled          33702      k8s:app=pythonapp                                            10.15.247.186   ready   
                                                           k8s:io.cilium.k8s.namespace.labels.name=c-app-count                                  
                                                           k8s:io.cilium.k8s.namespace.labels.purpose=app                                       
                                                           k8s:io.cilium.k8s.policy.cluster=default                                             
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                      
                                                           k8s:io.kubernetes.pod.namespace=c-app-count                                          
                                                           k8s:track=pythonapp-stable         
</code></pre>
<p>network rule</p>
<pre><code>apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: isolate-namespace
  namespace: d-redis
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: c-app-count
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: c-app-count

</code></pre>
<p>   </p>
<p>cilium/hubble <a href="https://github.com/cilium/hubble">https://github.com/cilium/hubble</a> <a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/70234ad4768db6537d28a417f0e73061ce2e51b4/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539343537343036392f6d6973632f687562626c652d64726f702e706e67"><img loading="lazy" title="hubble" src="https://camo.githubusercontent.com/70234ad4768db6537d28a417f0e73061ce2e51b4/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539343537343036392f6d6973632f687562626c652d64726f702e706e67" data-is-external-image="true"  alt="hubble" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1594574069/misc/hubble-drop.png"></a></p>
<p> </p>
<p>istio/kiali <a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/79a5b07227e5651705810596cef972d074ed201f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539343537343036392f6d6973632f697374696f2d6b69616c692e706e67"><img loading="lazy" title="kiali" src="https://camo.githubusercontent.com/79a5b07227e5651705810596cef972d074ed201f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313539343537343036392f6d6973632f697374696f2d6b69616c692e706e67" data-is-external-image="true"  alt="kiali" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1594574069/misc/istio-kiali.png"></a></p>
<p> </p>
<p>video Cilium example --&gt; <a href="https://res.cloudinary.com/ethzero/video/upload/v1594574074/misc/cilium.mkv" rel="nofollow">img/cilium.mkv</a></p>
<p>video Istio + Cilium example --&gt; <a href="https://res.cloudinary.com/ethzero/video/upload/v1594574090/misc/istio.mkv" rel="nofollow">img/istio.mkv</a><br> </p>
<h2><a id="user-content-requirements" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-servicemesh#requirements"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>requirements</h2>
<ul>
<li>use service mesh to segregate redis "d" to accept connections only from application "c"<br>expected "case 1" still working, "case 2" stop working and receive an error</li>
</ul>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Kubernetes apache httpd</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/kubernetes-apacherr.html"/>
        <id>https://www.k8s.it/kubernetes-apacherr.html</id>
            <category term="rewrite rules"/>
            <category term="kubernetes"/>
            <category term="httpd"/>
            <category term="front controller"/>
            <category term="apache"/>

        <updated>2020-11-14T22:55:32+01:00</updated>
            <summary>
                <![CDATA[
                    The semi-unuseful apache implementation in kubernetesWell , why we are talking about apache httpd in kubernetes ? We have ingress resources , we have ambassador and we are using microservices... True but internet was not built yesterday and for some reasons out of my knowledge&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <h2>The semi-unuseful apache implementation in kubernetes</h2>
<p>Well , why we are talking about apache httpd in kubernetes ?<br>We have ingress resources , we have ambassador and we are using microservices...<br>True but internet was not built yesterday and for some reasons out of my knowledge ,<br>people are ostinated to manage rewrite rules in apache instead to use a dedicated router application (react, zuul .. database!?!?! etc etc)<br>However sometimes we have to balance between the academic vision and the reality.</p>
<h2><a id="user-content-digression" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-apacherr#digression"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>digression</h2>
<p>Talking about apache https , nginx , haproxy ... i'm referring to the idea behind manage a complex website.<br>A website could be composed my hundreds of microservices but the domain it's usually one<br><a href="http://www.example.com/" rel="nofollow">www.example.com</a></p>
<p><a href="http://www.example.com/" rel="nofollow">www.example.com</a> has the root path /<br>/it/ managed by cms<br>/it/offerte managed by cms<br>/uk/ managed by cms<br>/uk/offers managed by cms<br>/../ whatever<br>/it/clienti/ managed by customer-app<br>/uk/customers/ managed by customers-app<br>/../somethingelse<br>/secure/ managey by payment-app<br>...<br>omg path clash ... so we need to exclude in apache /uk/customers/ from cms proxypass but<br>meantime enable a dedicated proxy pass to a specific application endpoint.<br>and we are mannually manage all language , all applications with static configurations...<br>and if tomorrow we will open APAC ... what we have to do ?<br>and if we need to cover a former third parti company and acquire his seo ranking we should create<br>thousands of redirects ? and how we can can validate avoiding loops ?</p>
<p>A better design start giving the right responsability , that could be managed using a business layer<br>that we can call "front controller" where we can apply all rules.</p>
<p>In terms of responsability all applaction behind this layer should be working by selfcontained logic<br>example... if i have a seo application this should be working without this layer , removing direct dependency<br>same concept for cms application , customers application and so on.<br>So what this layer will do ?</p>
<p>A front controller should be the owner of root path of our websites "/"<br>Should be also responsible to handle all the others paths after the root ones.</p>
<p>Main duties:</p>
<ul>
<li>handle all requests and manage the backend application with business logic</li>
<li>provide dynamic path based on business rules (language + brand + something else)</li>
<li>provide the AB test logic</li>
<li>provide a validation logic</li>
<li>expose a company backoffice to trim the website layout</li>
</ul>
<p>Examples</p>
<p>Having a global websites spread with multiple countris with differents domains/brands and languages we can immagine</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/184bca691d84bf02cd01d06642b3aac6f582d28f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313538323238393238352f6d6973632f66726f6e742d636f6e74726f6c6c65722e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/184bca691d84bf02cd01d06642b3aac6f582d28f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313538323238393238352f6d6973632f66726f6e742d636f6e74726f6c6c65722e706e67" data-is-external-image="true"  alt="frontcontroller" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_640/v1582289285/misc/front-controller.png"></a></p>
<p>Where the microservice/application CMS is responsible to hangle all domains and all languages and the<br>front controller take the ownership to match brand plus .tld (or paths "/fr/")<br>in order to dinamically generate the right url with canonical pages.</p>
<p>Many and many others assumptions can be covered by this componet, however we have to stay grounded<br>and check how we can manage an apache responsible to redirects proxypass an rewrite rules.</p>
<h2><a id="user-content-some-concepts-about-this-project" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-apacherr#some-concepts-about-this-project"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Some concepts about this project</h2>
<p>Even if we are working in a dynamic environment it's no rare to have the traditional layers</p>
<p>DMZ --&gt; layer 1<br>Application --&gt; layer 2<br>Database --&gt;layer 3</p>
<p>In this picture apache httpd should usually placed on layer 1 ,<br>but consider apache not for the common web server but like a "product" ,<br>something that could be managed not by SRE , but Product Engeneer.<br>A product that own a dedicated business, like seo, sem , vanity urls etc etc.</p>
<p>Having those considerations, we can "downgrade" apache httpd in layer 2 like any application<br>and honor the DMZ (if needed ?!?!) on top by ingress/haproxy/bigf5 (where maybe we can terminate the TLS).</p>
<h2><a id="user-content-implementation" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-apacherr#implementation"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Implementation</h2>
<p>The code in this project is designet to manage apache configuration by configmap,<br>however some websites are really complex and there are some limits implication with ectd max object size.</p>
<p>In this scenario it's higly raccomended to deploy the release with a standard pipeline with compiled<br>container on the source.</p>
<h2><a id="user-content-deploy" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-apacherr#deploy"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>deploy</h2>
<p><code>kubectl apply -f apacherr/deployment/</code></p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Kubernetes guacamole</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/kubernetes-guacamole.html"/>
        <id>https://www.k8s.it/kubernetes-guacamole.html</id>
            <category term="ssh"/>
            <category term="rdp"/>
            <category term="kubernetes"/>
            <category term="guacd"/>
            <category term="guacamole"/>
            <category term="bastion host"/>
            <category term="bastion"/>

        <updated>2020-11-14T22:55:40+01:00</updated>
            <summary>
                <![CDATA[
                    Here we are , another apache guacamole implementation in kubernetesThis service is designed to avoid the usage of mysql and create a standalone project The main idea is to use the user-mapping.xml as a config map For production environment i suggest to add the ldap auth (ad.openldap,freeipa),&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <div class="flex-shrink-0 col-12 col-md-9 mb-4 mb-md-0">
<div id="readme" class="Box md js-code-block-container Box--responsive">
<div class="Box-body px-5 pb-5">
<article class="markdown-body entry-content container-lg">
<h2>Here we are , another apache guacamole implementation in kubernetes</h2>
<p>This service is designed to avoid the usage of mysql and create a standalone project</p>
<p>The main idea is to use the <strong>user-mapping.xml</strong> as a config map</p>
<p>For production environment i suggest to add the ldap auth (ad.openldap,freeipa),<br>mysql database should be managed with a dedicated instances and mantained in case of "exit"</p>
<h2><a id="user-content-what-is-a-bastion-host" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-guacamole#what-is-a-bastion-host"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>what is a bastion host</h2>
<p>On the Internet, a bastion host is the only host computer that a company allows to be addressed<br>directly from the public network and that is designed to screen the rest of its network from security exposure.</p>
<h2><a id="user-content-how-this-tool-can-be-used" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-guacamole#how-this-tool-can-be-used"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>how this tool can be used</h2>
<p>The tool is designed to be used when you have some dedicated service in production and you have to keep<br>the control of access and account used , guacamole has the ability to manage the most used platforms (windows and linux)<br>as host in backend to be reached from developers ... contractors ...</p>
<h2><a id="user-content-why-in-kubernetes" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-guacamole#why-in-kubernetes"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>why in kubernetes</h2>
<p>Since the auth method could scale by configmap or ldap or mysql , is designed to scale<br>we have also the benefits to have a low footprint compared to a traditional vm.</p>
<h2><a id="user-content-config-to-change" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-guacamole#config-to-change"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>config to change</h2>
<p>Before deploy you need to specify the following parameters in guacamole folder</p>
<ul>
<li>YOUR_DOMAIN to reflect your domain url in 03-guacamole-ing.yaml</li>
<li>user YOUR_USERNAME / YOUR_MD5_PWD and hosts xml configuration in 04-guacamole-cfm.yaml following <a href="https://guacamole.apache.org/doc/gug/configuring-guacamole.html#user-mapping" rel="nofollow">https://guacamole.apache.org/doc/gug/configuring-guacamole.html#user-mapping</a></li>
</ul>
<p>screenshots</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/905e74d0ce81c8b239f67d405567100a3f181292/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313538303835303535322f6d6973632f67756163616d6f6c652d77696e2e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/905e74d0ce81c8b239f67d405567100a3f181292/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313538303835303535322f6d6973632f67756163616d6f6c652d77696e2e706e67" data-is-external-image="true"  alt="windows" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1580850552/misc/guacamole-win.png"></a><br><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/fd53b1991cd9693679aae9aadf72bc75d025c2ad/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313538303835303535322f6d6973632f67756163616d6f6c652d6c696e75782e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/fd53b1991cd9693679aae9aadf72bc75d025c2ad/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313538303835303535322f6d6973632f67756163616d6f6c652d6c696e75782e706e67" data-is-external-image="true"  alt="linux" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1580850552/misc/guacamole-linux.png"></a></p>
<h2><a id="user-content-deploy" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-guacamole#deploy"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>deploy</h2>
<p><code>kubectl apply -f guacd</code></p>
<p><code>kubectl apply -f guacamole</code></p>
<p>You can secure the connection with kube-lego and use cillium to add network rules </p>
</article>
</div>
</div>
</div>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Kubernetes vpn strongswan</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/kubernetes-strongswan.html"/>
        <id>https://www.k8s.it/kubernetes-strongswan.html</id>
            <category term="vpn"/>
            <category term="strongswan"/>
            <category term="ldap"/>
            <category term="kubernetes"/>
            <category term="ipsec"/>
            <category term="active directory"/>

        <updated>2020-11-14T22:55:59+01:00</updated>
            <summary>
                <![CDATA[
                    How we can manage vpn in kubernetes environmentHi there , this project is to cover the vpn ipsec-xauth topic in a kubernetes evironment, the goal of this is to have the less effort possible when we have to manage users. Architecture Requirements: WHYThe traditional ipsec-xauth&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <div class="flex-shrink-0 col-12 col-md-9 mb-4 mb-md-0">
<div id="readme" class="Box md js-code-block-container Box--responsive">
<div class="Box-body px-5 pb-5">
<article class="markdown-body entry-content container-lg">
<h2>How we can manage vpn in kubernetes environment</h2>
<p>Hi there , this project is to cover the vpn ipsec-xauth topic in a kubernetes evironment,<br>the goal of this is to have the less effort possible when we have to manage users.</p>
<p>Architecture<br><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/ee7bbe0fe8e2f17b0bda45b6b92d585105d9adcc/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313538343733313733352f6d6973632f76706e5f6469616772616d2e6a7067"><img loading="lazy" src="https://camo.githubusercontent.com/ee7bbe0fe8e2f17b0bda45b6b92d585105d9adcc/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313538343733313733352f6d6973632f76706e5f6469616772616d2e6a7067" data-is-external-image="true"  alt="architecture" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1584731735/misc/vpn_diagram.jpg"></a></p>
<p>Requirements:</p>
<ul>
<li>Kubernetes</li>
<li>Strongswan</li>
<li>Microsoft Acrive Directory / openldap / freeipa etc etc LDAP (i'll use ldap instead the software name)</li>
</ul>
<h2><a id="user-content-why" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-strongswan#why"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>WHY</h2>
<p>The traditional ipsec-xauth vpn with ikev1 is based on PSK<br>and a client username/password , this is a problem when the credential are stored in a file<br>in kubernetes update a file always mean rollout a new deploy or create a procedure to<br>make effective the changes.<br>So the idea is to deploy something that doesn't need any interaction<br>after the deploy and manage the clients, with the company standards,<br>like password expiration, password complexity, groups attributions and so on.</p>
<h2><a id="user-content-how" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/kubernetes-strongswan#how"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>HOW</h2>
<p>In order to have a fully managed services we can leverage the usage of ldap procedures (that all company has).<br>Strongswan (a fork of *swan ipsec software) could be integrated with ldap with pam.<br>pam is ... well --&gt; <a href="https://tldp.org/HOWTO/User-Authentication-HOWTO/x115.html" rel="nofollow">https://tldp.org/HOWTO/User-Authentication-HOWTO/x115.html</a></p>
<p>So what we need in ldap ?<br>We need:</p>
<ul>
<li>a technical user that is a low level profile that will be used only to check the users inside the ldap tree and the groups associated</li>
<li>a group to associate to people who need/granted the vpn access</li>
</ul>
<p>in this scenario tech users is --&gt; <em>ldapbind</em><br>group is --&gt; <em>vpn</em></p>
<p>here some screen related</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/48427e34136d63b4b7348ba8c2148e178665cdf0/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313538343733303832382f6d6973632f7374726f6e677377616e5f62696e645f757365722e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/48427e34136d63b4b7348ba8c2148e178665cdf0/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313538343733303832382f6d6973632f7374726f6e677377616e5f62696e645f757365722e706e67" data-is-external-image="true"  alt="ldapbind" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_640/v1584730828/misc/strongswan_bind_user.png"></a></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/141e29aaed92e477719b517dd704c815b18c23bc/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313538343733303832382f6d6973632f7374726f6e677377616e5f757365725f76706e5f67726f75702e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/141e29aaed92e477719b517dd704c815b18c23bc/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313538343733303832382f6d6973632f7374726f6e677377616e5f757365725f76706e5f67726f75702e706e67" data-is-external-image="true"  alt="vpn group" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_640/v1584730828/misc/strongswan_user_vpn_group.png"></a></p>
<p>Then... now we have to configure configure the Docker image in order to support pam ldap.</p>
<p>Dockerfile</p>
<pre><code>FROM debian:stretch
MAINTAINER lgirardi &lt;l@k8s.it&gt;


RUN apt-get -y update &amp;&amp; apt-get -yq install \
        strongswan \
        libcharon-extra-plugins \
        iptables \
        kmod \
        libpam-ldap \
        vim

EXPOSE 500/udp 4500/udp

CMD /usr/sbin/ipsec start --nofork
</code></pre>
<p>libpam-ldap and libcharon-extra-plugins are what we need to perform this kind of integration.</p>
<p>Since strongswan is not traditionally used in kubernetes , has some files that needs a configuration.<br>ENV variables are the most useful to configure it,<br>unfortunately the process is not able to share the env this the child process,<br>so we will work with 2 concepts,<br>use the configmap for all files we need to configure use the secrets for all sensitive data we need to add</p>
<p>files configured:</p>
<ul>
<li>ipsec.conf (the strongswan main configuration)</li>
<li>xauth-pam.conf (strongswan configuration to enable pam)</li>
<li>attr.conf (strongswan configuration file for split-tunnel)<br><em>split-tunnel is when you want to move in vpn only the company subnet and use the home gateway for all the other usages</em></li>
<li>ipsec (pam configuration in /etc/pam.d)</li>
</ul>
<p>secrets:</p>
<ul>
<li>ipsec.secrets (file with the ipsec PSK) rif. 003-configmap.yaml</li>
<li>pam_ldap.conf (configuration used by pam module to connect to ldap) rif. 002-secrets.yaml</li>
</ul>
<p><em>remember that all secrets files are managed using base64 encoding</em></p>
<p>When we have multiple files to spread in different locations we have to create some tricks,<br>one is to create symlink in the Dockerfile , however we have to keep the configuration<br>as much as possible agnostic from the Dockerfile.</p>
<p><em>volume</em> and <em>volumeMounts</em> can help on this topic</p>
<pre><code>volumeMounts:
- name: psk
  mountPath: /etc/ipsec.secrets
  subPath: psk
  readOnly: true
- name: pamldap
  mountPath: /etc/pam_ldap.conf
  subPath: pamldap
- name: strongswan-attr
  mountPath: /etc/strongswan.d/charon/attr.conf
  subPath: attr.conf
- name: strongswan-xauth-pam
  mountPath: /etc/strongswan.d/charon/xauth-pam.conf
  subPath: xauth-pam.conf
- name: strongswan-ipsec
  mountPath: /etc/pam.d/ipsec
  subPath: ipsec
- name: strongswan-ipseconf
  mountPath: /etc/ipsec.conf
  subPath: ipsec.conf
volumes:
- name: strongswan-attr
  configMap:
    name: strongswanconfigmap
    items:
    - key: attr.conf
      path: attr.conf
- name: strongswan-xauth-pam
  configMap:
    name: strongswanconfigmap
    items:
    - key: xauth-pam.conf
      path: xauth-pam.conf
- name: strongswan-ipsec
  configMap:
    name: strongswanconfigmap
    items:
    - key: ipsec
      path: ipsec
- name: strongswan-ipseconf
  configMap:
    name: strongswanconfigmap
    items:
    - key: ipsec.conf
      path: ipsec.conf
- name: psk
  secret:
    secretName: strongswan-secret
- name: pamldap
  secret:
    secretName: strongswan-secret
</code></pre>
<p>Now we have all configured, we can just run<br><code>kubectl apply -f deploy</code></p>
<p>We will have soon a pod into strongswan namespace</p>
<pre><code># kubectl get pods -n strongswan
NAME                          READY   STATUS    RESTARTS   AGE
strongswan-77bfbb9f9f-57hmz   1/1     Running   0          22h
</code></pre>
<p>Since the service is configured with nodport we need to enable the default 500 and 4500<br>in our firewall , matching the kubernetes ports 30000-32767, in this this service are</p>
<pre><code>ports:
- name: isakmp-udp
  protocol: UDP
  nodePort: 30500
  port: 500
  targetPort: 500
- name: ipsec-nat-t
  protocol: UDP
  nodePort: 30450
  port: 4500
  targetPort: 4500
type: NodePort
</code></pre>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/9a42ba23f208fb8562105b7b19d240bc5e495426/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313538343733303832372f6d6973632f7374726f6e677377616e5f6669726577616c6c5f6e61742e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/9a42ba23f208fb8562105b7b19d240bc5e495426/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313538343733303832372f6d6973632f7374726f6e677377616e5f6669726577616c6c5f6e61742e706e67" data-is-external-image="true"  alt="firewall configuration" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_640/v1584730827/misc/strongswan_firewall_nat.png"></a></p>
<p>We can configure our standard client (cisco ipsec client is enough)</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/ace3ff6a96cf31968f11209b7b05fce4ea5487a8/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3332302f76313538343733353439332f6d6973632f7374726f6e677377616e5f616e64726f69645f636c69656e742e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/ace3ff6a96cf31968f11209b7b05fce4ea5487a8/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3332302f76313538343733353439332f6d6973632f7374726f6e677377616e5f616e64726f69645f636c69656e742e706e67" data-is-external-image="true"  alt="android configuration" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_320/v1584735493/misc/strongswan_android_client.png"></a></p>
<pre><code># kubectl logs strongswan-77bfbb9f9f-57hmz -n strongswan
Starting strongSwan 5.5.1 IPsec [starter]...
no netkey IPsec stack detected
no KLIPS IPsec stack detected
no known IPsec stack detected, ignoring!
charon (13) started after 80 ms
00[DMN] Starting IKE charon daemon (strongSwan 5.5.1, Linux 4.15.0-70-generic, x86_64)
00[CFG] mapping attribute type split-exclpude failed
00[CFG] loading ca certificates from '/etc/ipsec.d/cacerts'
00[CFG] loading aa certificates from '/etc/ipsec.d/aacerts'
00[CFG] loading ocsp signer certificates from '/etc/ipsec.d/ocspcerts'
00[CFG] loading attribute certificates from '/etc/ipsec.d/acerts'
00[CFG] loading crls from '/etc/ipsec.d/crls'
00[CFG] loading secrets from '/etc/ipsec.secrets'
00[CFG]   loaded IKE secret for %any
00[CFG] loaded 0 RADIUS server configurations
00[CFG] HA config misses local/remote address
00[LIB] loaded plugins: charon aes rc2 sha2 sha1 md5 random nonce x509 revocation constraints pubkey pkcs1 pkcs7 pkcs8 pkcs12 pgp dnskey sshkey pem openssl fips-prf gmp agent xcbc hmac gcm attr kernel-netlink resolve socket-default connmark farp stroke updown eap-identity eap-aka eap-md5 eap-gtc eap-mschapv2 eap-radius eap-tls eap-ttls eap-tnc xauth-generic xauth-eap xauth-pam tnc-tnccs dhcp lookip error-notify certexpire led addrblock unity
00[LIB] dropped capabilities, running as uid 0, gid 0
00[JOB] spawning 16 worker threads
05[CFG] received stroke: add connection 'roadw'
05[CFG] adding virtual IP address pool 172.16.17.0/29
05[CFG] added configuration 'roadw'
08[NET] received packet: from 10.1.1.1[36312] to 10.1.1.84[500] (756 bytes)
08[ENC] parsed ID_PROT request 0 [ SA V V V V V V V V ]
08[IKE] received NAT-T (RFC 3947) vendor ID
08[IKE] received draft-ietf-ipsec-nat-t-ike-02 vendor ID
08[IKE] received draft-ietf-ipsec-nat-t-ike-02\n vendor ID
08[IKE] received draft-ietf-ipsec-nat-t-ike-00 vendor ID
08[IKE] received XAuth vendor ID
08[IKE] received Cisco Unity vendor ID
08[IKE] received FRAGMENTATION vendor ID
08[IKE] received DPD vendor ID
08[IKE] 10.1.1.1 is initiating a Main Mode IKE_SA
08[ENC] generating ID_PROT response 0 [ SA V V V V ]
08[NET] sending packet: from 10.1.1.84[500] to 10.1.1.1[36312] (160 bytes)
05[NET] received packet: from 10.1.1.1[36312] to 10.1.1.84[500] (228 bytes)
05[ENC] parsed ID_PROT request 0 [ KE No NAT-D NAT-D ]
05[IKE] local host is behind NAT, sending keep alives
05[IKE] remote host is behind NAT
05[ENC] generating ID_PROT response 0 [ KE No NAT-D NAT-D ]
05[NET] sending packet: from 10.1.1.84[500] to 10.1.1.1[36312] (244 bytes)
09[NET] received packet: from 10.1.1.1[40011] to 10.1.1.84[4500] (92 bytes)
09[ENC] parsed ID_PROT request 0 [ ID HASH ]
09[CFG] looking for XAuthInitPSK peer configs matching 10.1.1.84...10.1.1.1[100.106.113.62]
09[CFG] selected peer config "roadw"
09[ENC] generating ID_PROT response 0 [ ID HASH ]
09[NET] sending packet: from 10.1.1.84[4500] to 10.1.1.1[40011] (92 bytes)
09[ENC] generating TRANSACTION request 3276308191 [ HASH CPRQ(X_USER X_PWD) ]
09[NET] sending packet: from 10.1.1.84[4500] to 10.1.1.1[40011] (76 bytes)
11[NET] received packet: from 10.1.1.1[40011] to 10.1.1.84[4500] (108 bytes)
11[ENC] parsed TRANSACTION response 3276308191 [ HASH CPRP(X_USER X_PWD) ]
11[IKE] PAM authentication of 'lgirardi' successful
11[IKE] XAuth authentication of 'lgirardi' successful
11[ENC] generating TRANSACTION request 1380277626 [ HASH CPS(X_STATUS) ]
11[NET] sending packet: from 10.1.1.84[4500] to 10.1.1.1[40011] (76 bytes)
10[NET] received packet: from 10.1.1.1[40011] to 10.1.1.84[4500] (108 bytes)
10[ENC] parsed INFORMATIONAL_V1 request 4006980307 [ HASH N(INITIAL_CONTACT) ]
12[NET] received packet: from 10.1.1.1[40011] to 10.1.1.84[4500] (92 bytes)
12[ENC] parsed TRANSACTION response 1380277626 [ HASH CPA(X_STATUS) ]
12[IKE] IKE_SA roadw[1] established between 10.1.1.84[ETHZERO_HOME_VPN]...10.1.1.1[100.106.113.62]
12[IKE] scheduling rekeying in 86047s
12[IKE] maximum IKE_SA lifetime 86227s
</code></pre>
<p>ok now i'm connected and i can see my network in tun0</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/0ec58f59178a15278c87059d926b2a8b7b2938a8/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3332302f76313538343733303936302f6d6973632f7374726f6e677377616e5f636c69656e745f616e64726f69642e6a7067"><img loading="lazy" src="https://camo.githubusercontent.com/0ec58f59178a15278c87059d926b2a8b7b2938a8/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3332302f76313538343733303936302f6d6973632f7374726f6e677377616e5f636c69656e745f616e64726f69642e6a7067" data-is-external-image="true"  alt="android ip" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_320/v1584730960/misc/strongswan_client_android.jpg"></a></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/89492159c8fb5380197b4ecd266dce5c4068a9a0/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3332302f76313538343733363033342f6d6973632f7374726f6e677377616e5f616e64726f69645f70696e672e6a7067"><img loading="lazy" src="https://camo.githubusercontent.com/89492159c8fb5380197b4ecd266dce5c4068a9a0/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3332302f76313538343733363033342f6d6973632f7374726f6e677377616e5f616e64726f69645f70696e672e6a7067" data-is-external-image="true"  alt="android ping" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_320/v1584736034/misc/strongswan_android_ping.jpg"></a></p>
<p>Thats all ... here my connection</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/b702d2df92e56ffae8f754aed08e84ebd4d0595f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313538343733363332382f6d6973632f7374726f6e677377616e5f7374726f6b655f737461747573616c6c2e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/b702d2df92e56ffae8f754aed08e84ebd4d0595f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313538343733363332382f6d6973632f7374726f6e677377616e5f7374726f6b655f737461747573616c6c2e706e67" data-is-external-image="true"  alt="strongswan connection" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_640/v1584736328/misc/strongswan_stroke_statusall.png"></a></p>
</article>
</div>
</div>
</div>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Docker-latency</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/docker-latency.html"/>
        <id>https://www.k8s.it/docker-latency.html</id>

        <updated>2020-08-11T20:49:02+02:00</updated>
            <summary>
                <![CDATA[
                    aka the network blaming toolSo again another grafana stack with docker Well yes but with a precise scope In this period we are almost all working from home, the blaming topic is usually the connection with our offices or the datacenters. Is not so rare&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <h2><a id="user-content-aka-the-network-blaming-tool" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/docker-latency#aka-the-network-blaming-tool"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>aka the network blaming tool</h2>
<p>So again another grafana stack with docker<br>Well yes but with a precise scope</p>
<p>In this period we are almost all working from home,<br>the blaming topic is usually the connection with our offices or the datacenters.</p>
<p>Is not so rare for a network Administrator hear people that sais ,<br><em>the vpn is slow</em> , <em>i cannot connect to ... $something</em> , bla bla bla</p>
<p>In my experience this is usually due to the quality of the provider,<br>sometimes is also a problem on route path on T2/T3 providers</p>
<h3><a id="user-content-how-we-can-undestand-if-our-network-is-really-slow-" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/docker-latency#how-we-can-undestand-if-our-network-is-really-slow-"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>HOW we can undestand if our network is really slow ?</h3>
<p>The idea is to start a grafana stack ready-made to handle the basics statistics of our internet connection.<br>We need to choose some endpoints to monitor, example , your vpn endpoint , your datacenter/office public ip , the main dns servers and so on</p>
<h4><a id="user-content-requirements" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/docker-latency#requirements"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Requirements</h4>
<ul>
<li>Docker</li>
<li>Docker Compose</li>
</ul>
<h4><a id="user-content-stack" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/docker-latency#stack"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Stack</h4>
<ul>
<li>Influxdb</li>
<li>Grafana</li>
<li>Telegraf</li>
</ul>
<h4><a id="user-content-tree" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/docker-latency#tree"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Tree</h4>
<pre><code>├── .env
├── Makefile
├── README.md
├── docker
│   ├── grafana
│   │   ├── Dashboard-PING.json
│   │   ├── dashboard.yaml
│   │   └── datasource.yaml
│   ├── influxdb
│   │   ├── influxdb.conf
│   │   
│   └── telegraf
│       └── telegraf.conf
├── docker-compose.yml
</code></pre>
<p>Makefile is ... well a makefile , commands allowed<br><em>up , down, dev, down, logs, clean</em><br>up is to startup the stack<br>down to shutdown clean is done to remove also the storage saved for influxdb and grafana</p>
<p>.env contains the grafana and influxdb credentials (yes the default password is quite complicated)<br>Since this tool is hosted in your laptop (could be everywhere), never mind the <em>security</em></p>
<pre><code>GRAFANA_USER=admin
GRAFANA_PASSWORD=EQyFJpjxvJG8k2K8
INFLUXDB_DOMAIN=influxdb
INFLUXDB_DATABASE=ping
</code></pre>
<h3><a id="user-content-configuration" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/docker-latency#configuration"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Configuration</h3>
<p>We just need to choose the endpoints we'd like to monitor from our internet connection This could be done editing <em>telegraf.conf</em></p>
<pre><code>[global_tags]
[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  hostname = "local-telegraf"
  omit_hostname = false
[[outputs.influxdb]]
   urls = ["http://127.0.0.1:8086"]
   database = "ping"
[[inputs.ping]]
urls = ["1.1.1.1", "8.8.8.8", "208.67.222.222", "test1.velocable.com"]
count = 7
ping_interval = 1.0
</code></pre>
<p>Edit <em>urls =</em> adding / modify the endpoints<br>(in this example, Cloudflare dns , Google dns, opendns, and a server in Madrid used for speedtest)</p>
<p>The configuration is collecting information every 10 seconds , and run a ping command 7 time each with 1 second delay.</p>
<h3><a id="user-content-startup" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/docker-latency#startup"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Startup</h3>
<p>Inside the main folder run</p>
<p><code>make up</code></p>
<p>output:</p>
<pre><code>docker-latency$ make up
docker-compose -f docker-compose.yml up -d
Creating network "docker-latency_default" with the default driver
Creating grafana  ... done
Creating influxdb ... done
Creating telegraf ... done
</code></pre>
<p>login to:<br><code>http://localhost:3000/ </code>admin/EQyFJpjxvJG8k2K8</p>
<p>you will see</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/56bea14df7a89b07f4e319b45ad4d27c39ad865f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313538353634313235322f6d6973632f67726166616e615f686f6d652e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/56bea14df7a89b07f4e319b45ad4d27c39ad865f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313538353634313235322f6d6973632f67726166616e615f686f6d652e706e67" data-is-external-image="true"  alt="grafana_home" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1585641252/misc/grafana_home.png"></a></p>
<p>than , checking for the only board present --&gt; <em>internet latency</em></p>
<p>you will have all details about the endpoint chosen , packet loss especially</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/5fd87b371e34b4497018003fcd41cd2e09d23c72/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313538353539353832342f6d6973632f67726166616e615f70696e672e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/5fd87b371e34b4497018003fcd41cd2e09d23c72/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313538353539353832342f6d6973632f67726166616e615f70696e672e706e67" data-is-external-image="true"  alt="grafana_ping" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1585595824/misc/grafana_ping.png"></a></p>
<p>100% packet loss simulated disabling network card for few seconds.<br>The dashboard is using variables in order to create 1 row for each endpoint.</p>
<h3><a id="user-content-conclusion" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/docker-latency#conclusion"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Conclusion</h3>
<p>Now we have data, so we know what is going on in our internet connection and we can probably<br>have more details about the <em>infomagic</em> words like ... <em>is slow</em></p>
            ]]>
        </content>
    </entry>
</feed>
