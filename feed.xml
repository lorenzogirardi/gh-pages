<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xmlns:media="http://search.yahoo.com/mrss/">
    <title>LAB</title>
    <link href="https://www.k8s.it/feed.xml" rel="self" />
    <link href="https://www.k8s.it" />
    <updated>2023-02-11T13:23:20+01:00</updated>
    <author>
        <name>lgirardi</name>
    </author>
    <id>https://www.k8s.it</id>

    <entry>
        <title>application rate limit </title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/application-rate-limiting.html"/>
        <id>https://www.k8s.it/application-rate-limiting.html</id>
        <media:content url="https://www.k8s.it/media/posts/42/Screenshot-2023-02-11-at-13.18.48.png" medium="image" />
            <category term="standalone"/>
            <category term="sidecar conatiner"/>
            <category term="sidecar"/>
            <category term="service mesh"/>
            <category term="rate-limiting"/>
            <category term="rate limit"/>
            <category term="python"/>
            <category term="kubernetes"/>
            <category term="flask"/>
            <category term="envoy"/>
            <category term="api-gateway"/>

        <updated>2023-02-11T13:23:20+01:00</updated>
            <summary>
                <![CDATA[
                        <img src="https://www.k8s.it/media/posts/42/Screenshot-2023-02-11-at-13.18.48.png" alt="" />
                    For some reasons that i will share later on in a dedicated discussion, i had the need to create a rate limit inside the application. For this scenario we have 2 greddy options: the code way This is the simplest one but has some side&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                    <p><img src="https://www.k8s.it/media/posts/42/Screenshot-2023-02-11-at-13.18.48.png" class="type:primaryImage" alt="" /></p>
                <p dir="auto">For some reasons that i will share later on in a dedicated discussion, i had the need to create a rate limit inside the application.<br><br></p>
<p dir="auto">For this scenario we have 2 greddy options:</p>
<ul dir="auto">
<li>have the logic inside the app , in a <em>code</em> way</li>
<li>have a sidecar container that has this role</li>
</ul>
<p><br><br></p>
<h2 dir="auto"><a id="user-content-the-code-way" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-sidecar-ratelimit#the-code-way"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>the code way</h2>
<p dir="auto">This is the simplest one but has some side effects,<br>first of all can be reaused just for the same language apps.<br>Same as before , having this rate inside the app , we are creating a role inside this app<br>that can be good or bad depending of the strategy applied,<br>imagine the request interceptor for example will consume cpu and may <em>false</em> metrics if we are not aware of it.<br><br>But anyway , it can be a solution , so in a simple python code you have to add the following for example<br>(i will use the usual <a href="https://github.com/lorenzogirardi/py-test-backend/tree/ratelimit/docker">app</a> i'm using for labs stuff)<br>I'ts Flask so you just have to add the following:<br>in requirements.txt --&gt; <code>Flask-Limiter</code></p>
<p dir="auto">Inside your code , import the libraries</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>from flask_limiter import Limiter
from flask_limiter.util import get_remote_address
</code></pre>
</div>
<p dir="auto">Enable the <em>limiter</em></p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>limiter = Limiter(
	get_remote_address,
	app=app,
	storage_uri="memory://",
)
</code></pre>
</div>
<p dir="auto">And add the limiting option in the route u'd like to rate</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>@limiter.limit("28 per second")
</code></pre>
</div>
<p> </p>
<h3 dir="auto"><a id="user-content-handson" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-sidecar-ratelimit#handson"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Handson</h3>
<p dir="auto">Just moved from <code>@limiter.limit("28 per second")</code> to <code>@limiter.limit("2 per second")</code></p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>$ docker build -t lgirardi/pytbakrated .
[+] Building 11.1s (9/9) FINISHED
 =&gt; [internal] load build definition from Dockerfile                                                                                                                                                                                     0.0s
 =&gt; =&gt; transferring dockerfile: 34B                                                                                                                                                                                                      0.0s
 =&gt; [internal] load .dockerignore                                                                                                                                                                                                        0.0s
 =&gt; =&gt; transferring context: 2B                                                                                                                                                                                                          0.0s
 =&gt; [internal] load metadata for docker.io/library/python:3.9-alpine                                                                                                                                                                     0.6s
 =&gt; [internal] load build context                                                                                                                                                                                                        0.0s
 =&gt; =&gt; transferring context: 4.47kB                                                                                                                                                                                                      0.0s
 =&gt; CACHED [1/4] FROM docker.io/library/python:3.9-alpine@sha256:8bda1e9a98fa4e87ff6e3a7682f496532b06fcbae10326a59c8656126051d4df                                                                                                        0.0s
 =&gt; [2/4] COPY . /app                                                                                                                                                                                                                    0.0s
 =&gt; [3/4] WORKDIR /app                                                                                                                                                                                                                   0.0s
 =&gt; [4/4] RUN pip install -r requirements.txt                                                                                                                                                                                            9.9s
 =&gt; exporting to image                                                                                                                                                                                                                   0.4s
 =&gt; =&gt; exporting layers                                                                                                                                                                                                                  0.4s
 =&gt; =&gt; writing image sha256:583ec19905662414ad6bdb3b0da1042ec799ec46f8a676fac6553364cd02bf1e                                                                                                                                             0.0s
 =&gt; =&gt; naming to docker.io/lgirardi/pytbakrated
</code></pre>
</div>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>$ docker run -p 5000:5000 lgirardi/pytbakrated
 * Serving Flask app 'app'
 * Debug mode: off
2023-02-11 10:36:06,264 INFO werkzeug MainThread : WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5000
 * Running on http://172.17.0.2:5000
2023-02-11 10:36:06,264 INFO werkzeug MainThread : Press CTRL+C to quit
</code></pre>
</div>
<p dir="auto">With a simple curl you can check if it's working , so the rate will be triggered if u go over 2 req/sec</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>$ while true; do curl -I localhost:5000/api/fib/1 &amp;&amp; sleep 0.4;done
HTTP/1.1 200 OK
Server: Werkzeug/2.2.2 Python/3.9.16
Date: Sat, 11 Feb 2023 10:37:54 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 1
Vary: Accept-Encoding
Connection: close

HTTP/1.1 200 OK
Server: Werkzeug/2.2.2 Python/3.9.16
Date: Sat, 11 Feb 2023 10:37:54 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 1
Vary: Accept-Encoding
Connection: close

HTTP/1.1 429 TOO MANY REQUESTS
Server: Werkzeug/2.2.2 Python/3.9.16
Date: Sat, 11 Feb 2023 10:37:55 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 117
Vary: Accept-Encoding
Connection: close

HTTP/1.1 200 OK
Server: Werkzeug/2.2.2 Python/3.9.16
Date: Sat, 11 Feb 2023 10:37:55 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 1
Vary: Accept-Encoding
Connection: close

HTTP/1.1 200 OK
Server: Werkzeug/2.2.2 Python/3.9.16
Date: Sat, 11 Feb 2023 10:37:56 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 1
Vary: Accept-Encoding
Connection: close

HTTP/1.1 429 TOO MANY REQUESTS
Server: Werkzeug/2.2.2 Python/3.9.16
Date: Sat, 11 Feb 2023 10:37:56 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 117
</code></pre>
</div>
<p dir="auto">in the same way the contrainer logs are showing the same</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>2023-02-11 10:37:54,359 INFO werkzeug Thread-34 : 172.17.0.1 - - [11/Feb/2023 10:37:54] "HEAD /api/fib/1 HTTP/1.1" 200 -
2023-02-11 10:37:54,778 INFO werkzeug Thread-36 : 172.17.0.1 - - [11/Feb/2023 10:37:54] "HEAD /api/fib/1 HTTP/1.1" 200 -
2023-02-11 10:37:55,196 INFO flask-limiter Thread-38 : ratelimit 2 per 1 second (172.17.0.1) exceeded at endpoint: fib
2023-02-11 10:37:55,197 INFO werkzeug Thread-38 : 172.17.0.1 - - [11/Feb/2023 10:37:55] "HEAD /api/fib/1 HTTP/1.1" 429 -
2023-02-11 10:37:55,616 INFO werkzeug Thread-40 : 172.17.0.1 - - [11/Feb/2023 10:37:55] "HEAD /api/fib/1 HTTP/1.1" 200 -
2023-02-11 10:37:56,035 INFO werkzeug Thread-42 : 172.17.0.1 - - [11/Feb/2023 10:37:56] "HEAD /api/fib/1 HTTP/1.1" 200 -
2023-02-11 10:37:56,455 INFO flask-limiter Thread-44 : ratelimit 2 per 1 second (172.17.0.1) exceeded at endpoint: fib
2023-02-11 10:37:56,456 INFO werkzeug Thread-44 : 172.17.0.1 - - [11/Feb/2023 10:37:56] "HEAD /api/fib/1 HTTP/1.1" 429 -
</code></pre>
</div>
<p dir="auto">Honestly there are few pro and cons ... but i'd like to enter in those details with a more practical exmaple ...<br>just few concepts anyway are:</p>
<ul dir="auto">
<li>is using the same pool of connections</li>
<li>it's impacting the same metric that i'm using for autoscaling</li>
<li>is stealing resources from app</li>
<li>is really simple rate limit that can fight with others stuff</li>
</ul>
<p><br><br></p>
<h2 dir="auto"><a id="user-content-the-sidecar-way" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-sidecar-ratelimit#the-sidecar-way"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>the sidecar way</h2>
<p dir="auto">Yes i know , this is a <em>stretch</em>, since we have service mesh , gateway etc etc that embrace this concept.<br>However, for a specific reason, i created just a sidecar container that can be reused without the needs to implement the infrastructure mentioned before</p>
<p dir="auto">First of all the choice, tons of possibility, from nginx reverse proxy , to haproxy to <em>whatever</em> proxy ...<br>in this scenario i took the opportunity to use <strong>envoy</strong> , i've already used it with istio , and is really really flexible<br>(sometimes too much, in a way to be confused :-)</p>
<p dir="auto">Anyway ... it's just a sidecar<br>In an existing app you have to add the following to add envoy</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>      - name: sidecar
        image: envoyproxy/envoy:v1.22-latest
        resources:
          limits:
            cpu: 100m
            memory: 150Mi
          requests:
            cpu: 30m
            memory: 55Mi
        ports:
          - name: http
            containerPort: 5002
            protocol: TCP
        volumeMounts:
          - name: sidecar-config
            mountPath: "/etc/envoy"
            readOnly: true
      volumes:
        - name: sidecar-config
          configMap:
            name: pytbakt-configmap
</code></pre>
</div>
<p dir="auto">(great fantasy for the name :-)</p>
<p dir="auto">and ... well the most important configuration is the <code>pytbakt-configmap</code> that is the envoy configuration</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: pytbakt-configmap
  labels:
    app: pytbak
  namespace: pytbak
data:
  envoy.yaml: |
    static_resources:
      listeners:
      - name: listener_0
        address:
          socket_address:
            address: 0.0.0.0
            port_value: 5002
        filter_chains:
        - filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              stat_prefix: ingress_http
              route_config:
                name: local_route
                virtual_hosts:
                - name: local_service
                  domains: ["*"]
                  routes:
                  - match:
                      prefix: "/"
                    route:
                      cluster: pytbak
              http_filters:
              - name: envoy.filters.http.local_ratelimit
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                  stat_prefix: http_local_rate_limiter
                  token_bucket:
                    max_tokens: 29
                    tokens_per_fill: 29
                    fill_interval: 1s
                  filter_enabled:
                    runtime_key: local_rate_limit_enabled
                    default_value:
                      numerator: 100
                      denominator: HUNDRED
                  filter_enforced:
                    runtime_key: local_rate_limit_enforced
                    default_value:
                      numerator: 100
                      denominator: HUNDRED
                  response_headers_to_add:
                  - append_action: OVERWRITE_IF_EXISTS_OR_ADD
                    header:
                      key: x-local-rate-limit
                      value: 'true'
                  local_rate_limit_per_downstream_connection: false

              - name: envoy.filters.http.router
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

      clusters:
      - name: pytbak
        connect_timeout: 0.25s
        type: LOGICAL_DNS
        dns_lookup_family: V4_ONLY
        lb_policy: ROUND_ROBIN
        load_assignment:
          cluster_name: service_a
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: localhost
                    port_value: 5000
</code></pre>
</div>
<p dir="auto">in a Human readable way ...</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>      - name: listener_0
        address:
          socket_address:
            address: 0.0.0.0
            port_value: 5002
</code></pre>
</div>
<p dir="auto">envoy proxy is listening on port 5002</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>                - name: local_service
                  domains: ["*"]
                  routes:
                  - match:
                      prefix: "/"
                    route:
                      cluster: pytbak
</code></pre>
</div>
<p dir="auto">no path or domain configuration , just handle all after <code>/</code></p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>      clusters:
      - name: pytbak
        connect_timeout: 0.25s
        type: LOGICAL_DNS
        dns_lookup_family: V4_ONLY
        lb_policy: ROUND_ROBIN
        load_assignment:
          cluster_name: service_a
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: localhost
                    port_value: 5000
</code></pre>
</div>
<p dir="auto">something like <em>reverse proxy</em> configuration since the app is listening on port 5000</p>
<p dir="auto">And now the Rate limiting section</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>              http_filters:
              - name: envoy.filters.http.local_ratelimit
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                  stat_prefix: http_local_rate_limiter
                  token_bucket:
                    max_tokens: 29
                    tokens_per_fill: 29
                    fill_interval: 1s
                  filter_enabled:
                    runtime_key: local_rate_limit_enabled
                    default_value:
                      numerator: 100
                      denominator: HUNDRED
                  filter_enforced:
                    runtime_key: local_rate_limit_enforced
                    default_value:
                      numerator: 100
                      denominator: HUNDRED
                  response_headers_to_add:
                  - append_action: OVERWRITE_IF_EXISTS_OR_ADD
                    header:
                      key: x-local-rate-limit
                      value: 'true'
                  local_rate_limit_per_downstream_connection: false
</code></pre>
</div>
<p dir="auto">we have a bucket of 29 token , and every second it re-enable the 29 token in the bucket ... i mean ... 29req/second <em>almost</em> :-)</p>
<h3 dir="auto"><a id="user-content-handson-1" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-sidecar-ratelimit#handson-1"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Handson</h3>
<p dir="auto">Again i changed the rate limit to 2req/second</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>                  token_bucket:
                    max_tokens: 2
                    tokens_per_fill: 2
                    fill_interval: 1s
</code></pre>
</div>
<p dir="auto">in kubernetes <code>pytbak              pytbak-stable-bd648fd46-nj95m              2/2     Running       0                 13s</code></p>
<p dir="auto">kubectl describe pod pytbak-stable-bd648fd46-nj95m -n pytbak</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>Name:         pytbak-stable-bd648fd46-nj95m
Namespace:    pytbak
Priority:     0
Node:         instance-20220215-1853/10.0.254.135
Start Time:   Sat, 11 Feb 2023 11:19:45 +0000
Labels:       app=pytbak
              pod-template-hash=bd648fd46
              track=pytbak-stable
Annotations:  cni.projectcalico.org/podIP: 10.1.156.173/32
              cni.projectcalico.org/podIPs: 10.1.156.173/32
              prometheus.io/path: /metrics
              prometheus.io/port: 5000
              prometheus.io/scrape: true
Status:       Running
IP:           10.1.156.173
IPs:
  IP:           10.1.156.173
Controlled By:  ReplicaSet/pytbak-stable-bd648fd46
Containers:
  pytbak:
    Container ID:   containerd://9a54504e73a14746299366e2941b51f7069b6649208329a3f87708b053ef1eaf
    Image:          lgirardi/rest-test-multip:0.6
    Image ID:       docker.io/lgirardi/rest-test-multip@sha256:c94695a04fb3b862bfb576ead460aba3528bd098327f88122d087f48380506dd
    Port:           5000/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Sat, 11 Feb 2023 11:19:46 +0000
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     300m
      memory:  250Mi
    Requests:
      cpu:        30m
      memory:     125Mi
    Liveness:     http-get http://:5000/api/ delay=40s timeout=10s period=10s #success=1 #failure=3
    Readiness:    http-get http://:5000/api/ delay=5s timeout=15s period=10s #success=1 #failure=3
    Environment:  &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-xrr7c (ro)
  sidecar:
    Container ID:   containerd://a0d45982aa56704983a89bacd664e5cbb8b38b1df943df92ad879e7c66986c22
    Image:          envoyproxy/envoy:v1.22-latest
    Image ID:       docker.io/envoyproxy/envoy@sha256:3b1e0114dbead3fbd9f561994f3894f5d113a815e023065cabdf0c48d55396ce
    Port:           5002/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Sat, 11 Feb 2023 11:19:47 +0000
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     100m
      memory:  150Mi
    Requests:
      cpu:        30m
      memory:     55Mi
    Environment:  &lt;none&gt;
    Mounts:
      /etc/envoy from sidecar-config (ro)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-xrr7c (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  sidecar-config:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      pytbakt-configmap
    Optional:  false
  kube-api-access-xrr7c:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       &lt;nil&gt;
    DownwardAPI:             true
QoS Class:                   Burstable
Node-Selectors:              &lt;none&gt;
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  3m53s  default-scheduler  Successfully assigned pytbak/pytbak-stable-bd648fd46-nj95m to instance-20220215-1853
  Normal  Pulled     3m53s  kubelet            Container image "lgirardi/rest-test-multip:0.6" already present on machine
  Normal  Created    3m53s  kubelet            Created container pytbak
  Normal  Started    3m53s  kubelet            Started container pytbak
  Normal  Pulled     3m53s  kubelet            Container image "envoyproxy/envoy:v1.22-latest" already present on machine
  Normal  Created    3m53s  kubelet            Created container sidecar
  Normal  Started    3m52s  kubelet            Started container sidecar
</code></pre>
</div>
<p dir="auto">With curl</p>
<p dir="auto">$ while true;do curl -I <a href="http://oracolo.k8s.it/api/fib/1" rel="nofollow">http://oracolo.k8s.it/api/fib/1</a> &amp;&amp; sleep 0.4;done</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>HTTP/1.1 200 OK
Date: Sat, 11 Feb 2023 11:29:48 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 1
Connection: keep-alive
vary: Accept-Encoding
x-envoy-upstream-service-time: 2

HTTP/1.1 200 OK
Date: Sat, 11 Feb 2023 11:29:49 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 1
Connection: keep-alive
vary: Accept-Encoding
x-envoy-upstream-service-time: 2

HTTP/1.1 429 Too Many Requests
Date: Sat, 11 Feb 2023 11:29:49 GMT
Content-Type: text/plain
Content-Length: 18
Connection: keep-alive
x-local-rate-limit: true

HTTP/1.1 200 OK
Date: Sat, 11 Feb 2023 11:29:50 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 1
Connection: keep-alive
vary: Accept-Encoding
x-envoy-upstream-service-time: 2

HTTP/1.1 200 OK
Date: Sat, 11 Feb 2023 11:29:50 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 1
Connection: keep-alive
vary: Accept-Encoding
x-envoy-upstream-service-time: 2

HTTP/1.1 429 Too Many Requests
Date: Sat, 11 Feb 2023 11:29:50 GMT
Content-Type: text/plain
Content-Length: 18
Connection: keep-alive
x-local-rate-limit: true

HTTP/1.1 200 OK
Date: Sat, 11 Feb 2023 11:29:51 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 1
Connection: keep-alive
vary: Accept-Encoding
x-envoy-upstream-service-time: 2

HTTP/1.1 200 OK
Date: Sat, 11 Feb 2023 11:29:51 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 1
Connection: keep-alive
vary: Accept-Encoding
x-envoy-upstream-service-time: 2

HTTP/1.1 429 Too Many Requests
Date: Sat, 11 Feb 2023 11:29:51 GMT
Content-Type: text/plain
Content-Length: 18
Connection: keep-alive
x-local-rate-limit: true</code></pre>
<p>Both solution are working, different ways and different impacts on the app. In the next episode i will explain why i did this job , however, now in case u need a simple way to rate limit you app you can have a sidecar container out of the box.</p>
</div>
            ]]>
        </content>
    </entry>
    <entry>
        <title>YA vpn service in kubernetes</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/ya-vpn-service-in-kubernetes.html"/>
        <id>https://www.k8s.it/ya-vpn-service-in-kubernetes.html</id>
            <category term="wireguard"/>
            <category term="vpn"/>
            <category term="system metrics"/>
            <category term="performances"/>
            <category term="kubernetes"/>

        <updated>2022-07-27T07:58:34+02:00</updated>
            <summary>
                <![CDATA[
                    Table of contents Why Key generation Kubernetes deployment Test and results Why Honestly i was scared to dismiss my beloved ipsec based on strongswan, however on of my colleagues shared me how low is the overhead of wireguard, so i was interested to check myself. First&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <h2 dir="auto">Table of contents</h2>
<ol dir="auto">
<li>Why</li>
<li>Key generation</li>
<li>Kubernetes deployment</li>
<li>Test and results</li>
</ol>
<h2 dir="auto">Why</h2>
<p dir="auto">Honestly i was scared to dismiss my beloved ipsec based on <a href="https://github.com/lorenzogirardi/kubernetes-strongswan">strongswan</a>,<br>however on of my colleagues shared me how low is the overhead of wireguard, so i was interested to check myself.</p>
<p dir="auto"><br><br></p>
<h2 dir="auto">Key generation</h2>
<p dir="auto">First you have to install wg somewhere , however if u are using a mac , it's enough<br><code>brew install wireguard-tools</code></p>
<p dir="auto">Second step is generate the keys</p>
<p dir="auto">Server:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>wg genkey &gt; server_privatekey  
wg pubkey &lt; server_privatekey &gt; server_publickey_me
</code></pre>
</div>
<p dir="auto">Client:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>wg genkey | tee me_privatekey | wg pubkey &gt; me_publickey   
</code></pre>
</div>
<p dir="auto"><br><span style="color: var(--headings-color); font-family: var(--font-base); font-size: 1.60181em; font-weight: var(--font-weight-bold); letter-spacing: var(--letter-spacing);">Kubernetes deployment</span></p>
<p dir="auto">Let's create a dedicated namespace , i'm not a fan of default</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>apiVersion: v1
kind: Namespace
metadata:
  name: wireguard
  labels:
    name: wireguard
</code></pre>
</div>
<p dir="auto">Since i'm under a vps i will use the nodePort</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>apiVersion: v1
kind: Service
metadata:
  name: wireguard
  namespace: wireguard
spec:
  type: NodePort
  ports:
    - port: 51820
      nodePort: 31820
      protocol: UDP
      targetPort: 51820
  selector:
    name: wireguard
</code></pre>
</div>
<p dir="auto">in this example the udp will be shown on public_ip:31820</p>
<p dir="auto">Now ... we have multiple options , mount a persisten volume , use secrets , use configmaps etc etc<br>here just for a test purpose i've used the secrets</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>apiVersion: v1
kind: Secret
metadata:
  name: wireguard
  namespace: wireguard
type: Opaque
stringData:
  wg0.conf.template: |
    [Interface]
    Address = 172.16.18.0/20
    ListenPort = 51820
    PrivateKey = &lt;server_privatekey&gt;
    PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o ENI -j MASQUERADE
    PostUp = sysctl -w -q net.ipv4.ip_forward=1
    PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o ENI -j MASQUERADE
    PostDown = sysctl -w -q net.ipv4.ip_forward=0

    [Peer]
    #me
    PublicKey = &lt;me_publickey&gt;
    AllowedIPs = 172.16.18.10
</code></pre>
</div>
<p dir="auto">where <code>72.16.18.0/20</code> is the road warrior tunnel and<br><code>172.16.18.10</code> is the client ip assigned to me.</p>
<p dir="auto">Last the deployment</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: wireguard
  namespace: wireguard
spec:
  selector:
    matchLabels:
      name: wireguard
  template:
    metadata:
      labels:
        name: wireguard
    spec:
      initContainers:
        - name: "wireguard-template-replacement"
          image: "busybox"
          command: ["sh", "-c", "ENI=$(ip route get 8.8.8.8 | grep 8.8.8.8 | awk '{print $5}'); sed \"s/ENI/$ENI/g\" /etc/wireguard-secret/wg0.conf.template &gt; /etc/wireguard/wg0.conf; chmod 400 /etc/wireguard/wg0.conf"]
          volumeMounts:
            - name: wireguard-config
              mountPath: /etc/wireguard/
            - name: wireguard-secret
              mountPath: /etc/wireguard-secret/
      containers:
        - name: "wireguard"
          image: "linuxserver/wireguard:latest"
          ports:
            - containerPort: 51820
          env:
            - name: "TZ"
              value: "Europe/Rome"
            - name: "PEERS"
              value: "example"
          volumeMounts:
            - name: wireguard-config
              mountPath: /etc/wireguard/
              readOnly: true
          securityContext:
            privileged: true
            capabilities:
              add:
                - NET_ADMIN
      volumes:
        - name: wireguard-config
          emptyDir: {}
        - name: wireguard-secret
          secret:
            secretName: wireguard
      imagePullSecrets:
        - name: docker-registry
</code></pre>
</div>
<p dir="auto">if everithing is done correctly you will se the following<br><code>kubectl get pods -n wireguard</code></p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>NAME                         READY   STATUS    RESTARTS   AGE
wireguard-74ff66988d-ltwkq   1/1     Running   0          108m
</code></pre>
</div>
<p dir="auto">and</p>
<p dir="auto"><code># kubectl exec -n wireguard -it deployment/wireguard -- bash</code></p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>root@wireguard-74ff66988d-ltwkq:/# wg show
interface: wg0
  public key: Er7V4vxMEVBNZbqbDzHgXlYnZjSwrJYtwds86oOLLEg=
  private key: (hidden)
  listening port: 51820

peer: dfJjw5rdVNhmcIlDyFAXZI0rBQydsw9uqlh4kFJxBa0I=
  endpoint: 10.0.254.135:33851
  allowed ips: 172.16.18.10/32
  latest handshake: 5 minutes, 16 seconds ago
  transfer: 30.63 MiB received, 6.55 MiB sent
</code></pre>
</div>
<p dir="auto">For the client i strongly ... STRONGLY suggest to import a configuration</p>
<p dir="auto"><code>$ cat wireconf.conf</code></p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>[Interface]
Address = 172.16.18.10/32
PrivateKey = &lt;me_privatekey&gt;
DNS = 1.1.1.1

[Peer]
PublicKey = &lt;server_publickey_me&gt;
AllowedIPs = 0.0.0.0/0, ::/0
Endpoint = &lt;your-public-ip&gt;:31820
</code></pre>
</div>
<h2 dir="auto"> </h2>
<h2 dir="auto">Test and results</h2>
<p dir="auto">From mobile<br><a href="https://res.cloudinary.com/ethzero/video/upload/v1658175554/misc/wireguard-mobile.mp4" title="wirecardmobile" rel="nofollow"><img loading="lazy" src="https://camo.githubusercontent.com/6ce79561a4eab7bc80d169a5c3f3f184d6f14642fe06fa6de0d72b0be062285f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3234302f76313635383137353835372f6d6973632f77697265636172646d6f62696c652e706e67" alt="wirecardmobile" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_240/v1658175857/misc/wirecardmobile.png" data-is-external-image="true"></a></p>
<p dir="auto">And what about the resources usage with 1g file download...<br><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/8b842d08f4e0858968e44bb161c194c426e7eb624e1f22dcab7a61cf28eb58b1/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313635383137363737332f6d6973632f77697265677561726465736b746f702e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/8b842d08f4e0858968e44bb161c194c426e7eb624e1f22dcab7a61cf28eb58b1/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313635383137363737332f6d6973632f77697265677561726465736b746f702e706e67" alt="" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1658176773/misc/wireguardesktop.png" data-is-external-image="true"></a></p>
<p dir="auto"><br><br></p>
<p dir="auto">So i'm really impressed by the efficiency of this tool ... i was reading a lot of good mention about it,<br>however today i discovered another tool for my swiss army knife</p>
<p dir="auto"> </p>
<h3 dir="auto">UPDATE</h3>
<p dir="auto">Added a monitoring service as a sidecar container based on prometheus exporter <a href="https://github.com/MindFlavor/prometheus_wireguard_exporter">https://github.com/MindFlavor/prometheus_wireguard_exporter</a></p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: "/metrics"
        prometheus.io/port: "9586"
</code></pre>
</div>
<p dir="auto">this annotation is based of kubernetes service discovery in prometheus server</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto">
<pre class="notranslate"><code>        - name: "wg-exporter"
          image: "mindflavor/prometheus-wireguard-exporter:3.6.3"
          args: ["--prepend_sudo=true"]
          ports:
            - containerPort: 9586
          securityContext:
            privileged: true
            capabilities:
              add:
                - NET_ADMIN
                - NET_BIND_SERVICE
</code></pre>
</div>
<p dir="auto">configuration file available in monitoring branch <a href="https://github.com/lorenzogirardi/kubernetes-wireguard/blob/monitoring/deploy/wireguard-dpl.yaml">https://github.com/lorenzogirardi/kubernetes-wireguard/blob/monitoring/deploy/wireguard-dpl.yaml</a></p>
<p dir="auto">Grafana</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/28a65e4b0102d5eac3718ca9130f124b934a57eee7c959621da22e44ac153081/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313635383930313235322f6d6973632f67726166616e612d7769726567756172642e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/28a65e4b0102d5eac3718ca9130f124b934a57eee7c959621da22e44ac153081/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313635383930313235322f6d6973632f67726166616e612d7769726567756172642e706e67" alt="" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1658901252/misc/grafana-wireguard.png" data-is-external-image="true"></a></p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>/etc/shadow</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/etcshadow.html"/>
        <id>https://www.k8s.it/etcshadow.html</id>

        <updated>2022-08-13T06:46:59+02:00</updated>
            <summary></summary>
        <content type="html">
            <![CDATA[
                <figure class="post__image"><img loading="lazy"  src="https://www.k8s.it/media/posts/36/Flow-3.gif"></figure>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Lazy people do it better</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/lazy-people-do-it-better.html"/>
        <id>https://www.k8s.it/lazy-people-do-it-better.html</id>
        <media:content url="https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-16.32.46.png" medium="image" />
            <category term="performances"/>
            <category term="metrics"/>
            <category term="kubernetes"/>
            <category term="kpi"/>
            <category term="hpa"/>
            <category term="dynamic infrastructure"/>
            <category term="autoscaling"/>
            <category term="application metrics"/>

        <updated>2022-03-05T12:56:45+01:00</updated>
            <summary>
                <![CDATA[
                        <img src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-16.32.46.png" alt="" />
                    We are usually habit, sometimes, to react to some events with predefined actions If we increase the traffic then we increase the resources That is true and in some scenario is still the procedure , however i think we need to better understand what we have&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                    <p><img src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-16.32.46.png" class="type:primaryImage" alt="" /></p>
                <figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/35/lazy.gif" alt="" width="480" height="270"></figure>
<p> </p>
<p>We are usually habit, sometimes, to react to some events with predefined actions </p>
<p><strong>If</strong> we increase the traffic <strong>then </strong>we increase the resources <br>That is true and in some scenario is still the procedure , however i think we need to better understand what we have behind and the goal that we want to reach.<br><br>Since <span style="text-decoration: underline;">I'm lazy</span> i prefer to work one time , rather than be event driven </p>
<p>First of all the <strong>KPI </strong><br>This is not only related if the service is up and down , or if it's degraded or not ... is mostly focused on the service expectation <br><br>Answer in 3ms ?<br>Answer in 30ms ?<br>Answer in 300ms ?<br>Answer in 3000ms ?</p>
<p>In all the above question the service is running but the impact can be really different</p>
<p>So let's talk a bit about <strong>ONE </strong>of the possible infrastructure helpful trick ... the autoscaling.<br>This concept is already present since some years , aws has embraced it as first with the autoscaling solution for ec2 instances , now (since few years) kubernetes as introduced the HPA<br><br>How can help ?<br>There are many answer , but it's better to test with a lab some of those<br><br></p>
<h4>Environment settings</h4>
<p>Imagine an application that is managing a service<br>In this example is a <a href="https://github.com/lorenzogirardi/py-test-backend">python api</a> that answer for a fibonacci serie</p>
<p><code>$ curl -i https://oracolo.k8s.it/api/fiHTTP/1.1 200 OK</code><br><code>Date: Mon, 21 Feb 2022 15:18:50 GMT</code><br><code>Content-Type: text/html; charset=utf-8</code><br><code>Content-Length: 21</code><br><code>Connection: keep-alive</code><br><br><code>354224848179261915075</code></p>
<p>The idea was to have a function to slowdown the requests with the increase of cpu usage but to have a response time within 300ms (the <strong>KPI</strong>)</p>
<p>The application is installed on kubernetes with the following deployment</p>
<p><code>apiVersion: apps/v1</code><br><code>kind: Deployment</code><br><code>metadata:</code><br><code>  labels:</code><br><code>    app: pytbak</code><br><code>    track: pytbak-stable</code><br><code>  name: pytbak-stable</code><br><code>  namespace: pytbak</code><br><code>spec:</code><br><code>  minReadySeconds: 10</code><br><code>  replicas: 3</code><br><code>  revisionHistoryLimit: 5</code><br><code>  selector:</code><br><code>    matchLabels:</code><br><code>      app: pytbak</code><br><code>      track: pytbak-stable</code><br><code>  strategy:</code><br><code>    rollingUpdate:</code><br><code>      maxSurge: 50%</code><br><code>      maxUnavailable: 0</code><br><code>    type: RollingUpdate</code><br><code>  template:</code><br><code>    metadata:</code><br><code>      annotations:</code><br><code>        prometheus.io/scrape: "true"</code><br><code>        prometheus.io/path: "/metrics"</code><br><code>        prometheus.io/port: "5000"</code><br><code>      labels:</code><br><code>        app: pytbak</code><br><code>        track: pytbak-stable</code><br><code>    spec:</code><br><code>      containers:</code><br><code>      - name: pytbak</code><br><code>        image: lgirardi/rest-test-multip:0.3</code><br><code>        resources:</code><br><code>          limits:</code><br><code>            cpu: 300m</code><br><code>            memory: 250Mi</code><br><code>          requests:</code><br><code>            cpu: 30m</code><br><code>            memory: 125Mi</code><br><code>        ports:</code><br><code>        - name: http</code><br><code>          containerPort: 5000</code><br><code>        livenessProbe:</code><br><code>          httpGet:</code><br><code>            path: /api/</code><br><code>            port: 5000</code><br><code>          initialDelaySeconds: 40</code><br><code>          timeoutSeconds: 10</code><br><code>        readinessProbe:</code><br><code>          httpGet:</code><br><code>            path: /api/</code><br><code>            port: 5000</code><br><code>          initialDelaySeconds: 5</code><br><code>          timeoutSeconds: 15</code></p>
<p>Now we have how 3 pods ready to handle requests</p>
<p>In an unrealistic use cases we have a constant usage, instead in the real world, the usage is impacted by peak of traffic, scrapes , new feature , promotion , regional distribution etc etc </p>
<p>I know , it's a stretch using this gatling configuration but it's useful to share the idea<br><code>  setUp(</code><br><code>      scn.inject(</code><br><code>    nothingFor(1.seconds), // do nothing for 1 sec</code><br><code>    atOnceUsers(1), // have 1 call for 1 sec</code><br><code>    rampUsers(10).during(20.seconds), // increase users to 10 in 20 sec</code><br><code>    constantUsersPerSec(10).during(15.seconds), // keep 10 users for 15 sec</code><br><code>    rampUsersPerSec(10).to(100).during(3.minutes), // increase users to 100 in 3 min</code><br><code>    constantUsersPerSec(100).during(60.seconds), // keep 100 users for 1 min</code><br><code>    rampUsersPerSec(100).to(10).during(3.minutes).randomized, // decrease users to 10 in 3 min</code><br><code>    constantUsersPerSec(10).during(30.seconds), // keep 10 users for 30 sec</code><br><code>    rampUsersPerSec(10).to(1).during(10.seconds).randomized, // decrease users to 1 in 10 sec</code><br><code>  ).protocols(httpProtocol)</code><br><code>)</code></p>
<p> </p>
<p>and the url tested was</p>
<p><code>$ curl -i https://oracolo.k8s.it/api/fib/18500<br>HTTP/1.1 200 OK<br>Date: Mon, 21 Feb 2022 15:46:02 GMT<br>Content-Type: text/html; charset=utf-8<br>Content-Length: 3866<br>Connection: keep-alive<br>Vary: Accept-Encoding</code></p>
<p><code>83533296884435624867798531585140565339442079861725087204086868538470047335735<br>43822749284012562109156072993926836560850582712240843325537682043365082110610<br>74026311291800113704704348249392230730803891751617970900168446982968243007736<br>51197815341736702893065750384164322487072420946350671608236528336490734320752<br>15766217894062662319153446190938791478882600888720832141034382665639025753273<br>30750839228343101989644891936468903562404233796143208624300662188211844387971<br>12866863645098425877607285194374927111578752851305578221078133055618856142572<br>55524813028556809618441843877627693663784558866751538817238272015121741425393<br>99049964805007884503362484550579798684692431918631521197439158243117538949606<br>37155643851292040158395873383975165892212817619455430033494636143410239812404<br>80529547905260319321739870888187908535609149526797446231747889061304445725815<br>63419312476001987112390317255585462630499726624943926108760315984710835726791<br>64604969656765499209392211865567181332414241748115992393468455078857640503788<br>18491664670055330318299320987588212834680593778419314796246160245694639311623<br>45963069508719454819599551852953998681323163667721305365938646262462463653426<br>03120490907728272394316733945290936238595191234306195169403527451189150944412<br>55734943613733388177050741716869683215360508942821849631632473401081464418614<br>88129911023030514034348960453039999292198017445266482693060747698164480133895<br>42107812053775651030682262614149238225324860891787622323532546655762387576106<br>16744230275914963410655344193109686235699009316258222627309839038398946965798<br>93288112545157969932414111834814316569339369657297666636164718674805983154767<br>82716375582052616490320939205226143196168442740492338964903461454065891061788<br>24914385318462704330186677169214346572575320087900214462474550701206183564981<br>67940149169727266071833671192220852019181820327868422609361307508447137372952<br>70741193765954124906216947802897539084895498757041969867186546875822187085826<br>51268178561205184593600199506688874949513005414185093510082888499893907289670<br>60694081358868925846231023994576416351401218579760341994807107707262673164628<br>93989847554183605689726587752375584972993275839904589589079161246680599376961<br>46522822317563050982509757869699803683290147662057482039180565933217050406411<br>63613334575670225316495894808773628497941926683531555239853003061300649659051<br>80663038779126115354211249859182852080094185399771594786495630198172605116654<br>36484876158120241561970086240965134946001448112627411711997627120355963199768<br>37453968472163446367339200530252903452374910026941922776248397460043788137117<br>03792457930019057411962758264853807991677322585740303176087173311737493675814<br>97785846553584211669490948369627378763409533632607628189347167959335358534179<br>14936021275618379596024302703059923780925579890415606776752696469049010540674<br>16762272554571834669670185083416940001269702457012387259986804993721400659735<br>98402981836433913009273334871164379864504944274151763420867965690836123620164<br>71052527907012070090155568723470808988725230762895495242080853258248938503812<br>92377624996414841905746084025711457998759036082766019389458672225594149040894<br>25339957409692717694606288768279530280880496597818894383696651292555863738105<br>42519877809534106427059668587274469061728503718737115492047330320710617418343<br>36509845478020766819148991938613184822854393146963871218131954000091828603844<br>30710696936075943284582450858926759953941330918016364297470882233548644972398<br>02671169604082172661201779291650562320255581897779891571992387794168420428875<br>01665380594740126434308738080451514239759906771130514871814286159379595046723<br>96787175930658277115296525324844486906484486308261475140105238542837827794788<br>42270482292915032600476652997028797988664978676168344677300636439380532376130<br>50531301554510586963399762243280359072814214224506146343965459717217720978975<br>50897175029897270621313926837122497590225684346650930922871186632985491270868<br>6598493717570125</code></p>
<p> </p>
<h4>Results </h4>
<p> </p>
<h5>fixed pods number</h5>
<p>... what happened ?</p>
<p>Gatling results: <a href="https://lorenzogirardi.github.io/gatling-k8s-fixed-3-pods/">https://lorenzogirardi.github.io/gatling-k8s-fixed-3-pods/</a></p>
<figure class="post__image"><img loading="lazy"  src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-16.48.10.png" alt="" width="1024" height="409" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-xs.webp 300w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-sm.webp 480w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-md.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-lg.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-xl.webp 1360w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-2xl.webp 1600w"></figure>
<p><span style="color: #236fa1;">Big cluster of huge response time <br><span style="color: #e03e2d;">Closing to 100 rps , service unavailable</span><br></span></p>
<figure class="post__image"><img loading="lazy"  src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-17.18.34.png" alt="" width="1024" height="408" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-xs.webp 300w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-sm.webp 480w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-md.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-lg.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-xl.webp 1360w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-2xl.webp 1600w"></figure>
<p><span style="color: #000000;">huge active users ... more than the requests (slowdown ... queue.... failures)</span></p>
<p><span style="color: #000000;">And the application status ?</span></p>
<figure class="post__image"><img loading="lazy"  src="https://www.k8s.it/media/posts/35/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02.png" alt="" width="2880" height="3340" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-xs.webp 300w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-sm.webp 480w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-md.webp 768w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-lg.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-xl.webp 1360w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-2xl.webp 1600w"></figure>
<p> </p>
<p>Well now we know we know a bit our application ... we know the critical point but also that the <strong>KPI </strong>went to hell , high cpu and some pod crash</p>
<p class="align-center"> </p>
<p> </p>
<h5>dynamic pods number</h5>
<p>... what happened ?</p>
<p>Gatling results: <a href="https://lorenzogirardi.github.io/gatling-k8s-hpa/">https://lorenzogirardi.github.io/gatling-k8s-hpa/</a></p>
<figure class="post__image"><img loading="lazy"  src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-17.11.09.png" alt="" width="1024" height="404" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-xs.webp 300w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-sm.webp 480w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-md.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-lg.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-xl.webp 1360w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-2xl.webp 1600w"></figure>
<p>Some sporadic request over 300ms but 99% below</p>
<figure class="post__image"><img loading="lazy"  src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-17.19.57.png" alt="" width="1024" height="412" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-xs.webp 300w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-sm.webp 480w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-md.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-lg.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-xl.webp 1360w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-2xl.webp 1600w"></figure>
<p><span style="color: #000000;">active users inline with the requests</span></p>
<p><span style="color: #000000;">And the application status ?<br></span></p>
<figure class="post__image"><img loading="lazy"  src="https://www.k8s.it/media/posts/35/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02.png" alt="" width="2880" height="3340" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-xs.webp 300w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-sm.webp 480w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-md.webp 768w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-lg.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-xl.webp 1360w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-2xl.webp 1600w"></figure>
<p><span style="color: #000000;">cpu under control , response time ok , no crash and autoscaled from 3 to 10 pods<br></span></p>
<figure class="post__image"><img loading="lazy"  src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-17.16.38.png" alt="" width="2192" height="1096" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-xs.webp 300w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-sm.webp 480w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-md.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-lg.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-xl.webp 1360w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-2xl.webp 1600w"></figure>
<p><span style="color: #000000;"> </span></p>
<h4>HPA in pills</h4>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/35/cn-dyn-img-4.gif" alt="" width="480" height="336"></figure>
<p> </p>
<p>There are many how to and suggestions that explain this topic,</p>
<p>however what you need is: </p>
<ul>
<li>prometheus</li>
<li>kpi and application tolerance knowhow</li>
<li>keda.sh (i really hate the <em>prometheus adapter</em>)</li>
</ul>
<p>Let's skip prometheus and go directly to kpi, application tolerance and keda.sh<br><br>When i create the fibonacci code , i was able to test the impact on cpu and response time , having the fibonacci as 18500</p>
<ul>
<li>the max pod tolerance to be running without error was 30rps</li>
<li>to be within 300ms 15rps</li>
</ul>
<p>I know, is not real life scenario but the concept is the same ... just identify the correct rps in a case where this value can be a trigger for the autoscaling</p>
<p>In the python app is <code>flask_http_request_duration_seconds_count</code></p>
<p>the following configuration for keda use this value as a trigger</p>
<p><code>apiVersion: keda.sh/v1alpha1<br>kind: ScaledObject<br>metadata:<br>  name: rps-scaledobject<br>  namespace: pytbak<br>spec:<br>  minReplicaCount: 3<br>  maxReplicaCount: 10<br>  pollingInterval: 10  # Optional. Default: 30 seconds<br>  scaleTargetRef:<br>    name: pytbak-stable<br>  advanced:                                          # Optional. Section to specify advanced options<br>    horizontalPodAutoscalerConfig:                   # Optional. Section to specify HPA related options<br>      behavior:                                      # Optional. Use to modify HPA's scaling behavior<br>        scaleDown:<br>          stabilizationWindowSeconds: 45 #option from kubernetes hpa to force pod shutdown in 45 dec , default 5 min<br>  triggers:<br>  - type: prometheus<br>    metadata:<br>    # Required fields:<br>      serverAddress: <a href="http://10.152.183.99:9090">http://10.152.183.99:9090</a> # prometheus server<br>      metricName: flask_http_request_duration_seconds_count # Note: name to identify the metric<br>      query: sum(rate(flask_http_request_duration_seconds_count{status="200"}[60s])) # Note: query must return a vector/scalar single element response<br>      threshold: '10'<br></code></p>
<p> </p>
<p>An this is what happened during the gatling test with hpa</p>
<figure class="post__image"><img loading="lazy"  src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-20-at-14.47.57.png" alt="" width="720" height="104" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-xs.webp 300w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-sm.webp 480w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-md.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-lg.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-xl.webp 1360w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-2xl.webp 1600w"></figure>
<figure class="post__image"><img loading="lazy"  src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-20-at-14.48.36.png" alt="" width="720" height="81" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-xs.webp 300w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-sm.webp 480w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-md.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-lg.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-xl.webp 1360w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-2xl.webp 1600w"></figure>
<figure class="post__image"><img loading="lazy"  src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-20-at-14.49.07.png" alt="" width="720" height="94" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-xs.webp 300w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-sm.webp 480w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-md.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-lg.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-xl.webp 1360w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-2xl.webp 1600w"></figure>
<figure class="post__image"><img loading="lazy"  src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-20-at-14.49.22.png" alt="" width="720" height="79" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-xs.webp 300w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-sm.webp 480w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-md.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-lg.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-xl.webp 1360w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-2xl.webp 1600w"></figure>
<figure class="post__image"><img loading="lazy"  src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-20-at-14.50.36.png" alt="" width="720" height="79" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-xs.webp 300w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-sm.webp 480w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-md.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-lg.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-xl.webp 1360w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-2xl.webp 1600w"></figure>
<p> </p>
<h4>Conclusions</h4>
<p>HPA is an amazing solution not only in cloud there this feature is mandatory if you want to use the cloud in the right way and if you would like to remove overspending </p>
<p>but anyway...</p>
<p>It's the right model for lazy people in order to have a dynamic infrastructure to support the traffic, to reduce the monitoring and alerting alarms and be ready to scale :) </p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Kubernetes-nstats</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/kubernetes-nstats.html"/>
        <id>https://www.k8s.it/kubernetes-nstats.html</id>
        <media:content url="https://www.k8s.it/media/posts/25/Screenshot-2021-02-22-at-18.16.33.png" medium="image" />
            <category term="sidecar"/>
            <category term="pod"/>
            <category term="observability"/>
            <category term="network"/>
            <category term="kubernetes"/>
            <category term="influxdb"/>
            <category term="iftop"/>
            <category term="grafana"/>
            <category term="docker"/>

        <updated>2021-02-22T18:25:57+01:00</updated>
            <summary>
                <![CDATA[
                        <img src="https://www.k8s.it/media/posts/25/Screenshot-2021-02-22-at-18.16.33.png" alt="" />
                    Here we go ... another weird sidecar container Motivations I've always been interested in the observability area , there are many aspect that improve performances and fix bugs One of the most interested aspect is te network usage. This is not related to "network issue"&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                    <p><img src="https://www.k8s.it/media/posts/25/Screenshot-2021-02-22-at-18.16.33.png" class="type:primaryImage" alt="" /></p>
                <p>Here we go ... another weird sidecar container</p>
<h2><a id="user-content-motivations" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-nstats#motivations"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Motivations</h2>
<p><br><br>I've always been interested in the observability area , there are many aspect that improve performances and fix bugs<br>One of the most interested aspect is te network usage.</p>
<p>This is not related to "network issue"<br><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/2f639fd02add51a9e1529a68b56a830b12ea328791f0ae671771c5db650dcccd/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3234302f76313631333938303238392f6d6973632f6e6574776f726b69737375652e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/2f639fd02add51a9e1529a68b56a830b12ea328791f0ae671771c5db650dcccd/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3234302f76313631333938303238392f6d6973632f6e6574776f726b69737375652e706e67" alt="network_issue" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_240/v1613980289/misc/networkissue.png" data-is-external-image="true"></a><br><br></p>
<p>It's related to the usages</p>
<p>You are probably habit to see something like this for your vms<br><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/722f34ecd7e011074527d76ce43b8c3eb28dba06876c311d8900ae1d9f518a17/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938303835362f6d6973632f766d5f6e65742e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/722f34ecd7e011074527d76ce43b8c3eb28dba06876c311d8900ae1d9f518a17/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938303835362f6d6973632f766d5f6e65742e706e67" alt="vm_net" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_640/v1613980856/misc/vm_net.png" data-is-external-image="true"></a><br>That is showing the traditional IN and OUT<br><br><br></p>
<p>An now ... with kubernetes you can have the same related to your pod<br><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/7051fc44a11f2cc78bd547e91bfba0218d9dd7aba2082de32ddb8475cdb1ad0f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938313333382f6d6973632f706f645f6e65742e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/7051fc44a11f2cc78bd547e91bfba0218d9dd7aba2082de32ddb8475cdb1ad0f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938313333382f6d6973632f706f645f6e65742e706e67" alt="pod_net" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_640/v1613981338/misc/pod_net.png" data-is-external-image="true"></a><br>And again you have the IN and OUT<br><br><br></p>
<p>But <strong>where</strong> this bandwidth is be used ?</p>
<p>Answer is not easy , i mean</p>
<ul>
<li>you can profile the application</li>
<li>you can profile the vm/pod</li>
<li>you can have a dedicated APM</li>
<li>you can have installed a <a href="https://github.com/lorenzogirardi/kubernetes-servicemesh">service mesh</a><br><br></li>
</ul>
<p>Service mesh is a good tool but for the reasons explained in the link ... you should promote it in the right way ... it's able to cover my question but let's assume it's a overengineering for my porpose.</p>
<p>APM ... well it depends on your company/money capability</p>
<p>What is missing ?<br>Well even if we are in 2021 i'm habit to use <strong>iftop</strong> to understand the usage , the limit is that is working in rountime and i miss a long vision term.<br><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/72309f9a4ee7e1f4c6b64f784c375d764d6b73385ea107d01e132e55b1f7e7a9/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313631333938373038352f6d6973632f6966746f702e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/72309f9a4ee7e1f4c6b64f784c375d764d6b73385ea107d01e132e55b1f7e7a9/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313631333938373038352f6d6973632f6966746f702e706e67" alt="iftop" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1613987085/misc/iftop.png" data-is-external-image="true"></a></p>
<p><br><br><br><br></p>
<h2><a id="user-content-goals" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-nstats#goals"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>GOALs</h2>
<p><br><br></p>
<ul>
<li>Monitor a kubernetes pod network with a sidecar container</li>
<li>Be able to know src-dst of the pod connections</li>
<li>Use it as sidecar</li>
<li>Try to imagine a win-win solution (aka quick and dirty)</li>
</ul>
<p><br><br><br><br></p>
<h2><a id="user-content-implementation" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-nstats#implementation"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Implementation</h2>
<p> </p>
<p>Project https://github.com/lorenzogirardi/Kubernetes-nstats<br><br>My colleagues has done an amazing work with a GO container able to have this kind of observability.<br>I tried to imagine a prototype with a win-win solution and i started evaluation this interesting <a href="https://github.com/scottmsilver/iftop-telegraf-influx">project</a>,<br>where most the work as already done with the following steps:</p>
<ul>
<li>Create an iftop static dump</li>
<li>Filter the results in a matrix</li>
<li>Build an influxdb layout to POST directly to the database</li>
</ul>
<p>so ... let's share some evidence</p>
<p>Kubernetes-nstats<br>|-- Dockerfile<br>|-- README.md<br>|-- cron.sh<br>|-- crontab<br>|-- format.py<br>`-- parse.awk</p>
<h3><a id="user-content-dockerfile" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-nstats#dockerfile"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Dockerfile</h3>
<pre><code>FROM debian:stretch-slim
MAINTAINER lgirardi &lt;l@k8s.it&gt;

RUN apt-get -y update &amp;&amp; apt-get -yq install \
	iftop \
	python3 \
	cron \
	curl


RUN touch /var/log/cron.log
RUN mkdir /code
WORKDIR /code
ADD . /code/
RUN chmod +x /code/cron.sh
COPY crontab /etc/crontab
RUN crontab /etc/crontab
CMD env &gt; /code/env.sh ; cron -f
</code></pre>
<p>CRON ?!?!?! ... yes it's a prototype and for this scope k8s cronjob are not effective. The most interesting part is <code>env &gt; /code/env.sh</code> that is used to create an environment file based on the docker environment variables.</p>
<h3><a id="user-content-code" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-nstats#code"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Code</h3>
<p>cron.sh</p>
<pre><code>#!/bin/bash
/usr/sbin/iftop -nNb -i $(grep IFACE /code/env.sh |cut -d= -f2) -s 10 -o 10s -t -L 100 2&gt;/dev/null |/usr/bin/awk -f /code/parse.awk |/usr/bin/python3 /code/format.py |/usr/bin/curl -i -XPOST 'http://'"$(grep INFLUX /code/env.sh |cut -d= -f2)"'/write?db='"$(grep IDB /code/env.sh |cut -d= -f2)"'' --data-binary @-
</code></pre>
<p>parse.awk</p>
<pre><code>#!/bin/awk -f
BEGIN {
	numlist = 0
	nblines = 15
}
{
	if ( numlist == 1 &amp;&amp; $1 == "--------------------------------------------------------------------------------------------" ) {
		exit
	}

	if ( numlist == 0 &amp;&amp; $1 == "--------------------------------------------------------------------------------------------" ) {
		numlist = 1
		next
	}

	if ( numlist == 1 ) {
		if ( $0 ~ "=&gt;" &amp;&amp; nblines &gt; 0 ) {
			SENDER = $2
			STX = pfFormat($5)
			getline
			RECEIVER = $1
			RTX = pfFormat($4)
			printf "%s,%s,%s,%s\n", SENDER, RECEIVER, RTX, STX
			nblines--
			if ( nblines &lt; 1 ) {
				exit
			}
		}
		next
	}
}
END {
}

function pfFormat(str) {
 	sub("b","",str)
	return str
}
</code></pre>
<p>format.py</p>
<pre><code>#!/usr/local/bin/python3

import csv
import socket
import sys
import re

def getHostName(ipAddress):
	hostName = ipAddress

	try:
		hostName = socket.gethostbyaddr(ipAddress.strip())[0]
	except socket.herror:
		pass

	return hostName

def prefixToMultiplier(prefix):
	multiplier = {
		'K': 1000,
		'M': 1000000,
    'G': 1000000000
	}

	return multiplier.get(prefix, 1)


def expandBitRate(bitRate):
	groups = re.match(r"(\d+\.?\d*)(?:(K|M|G)?)", bitRate).groups()
	multiplier = 1.0
	if len(groups) &gt; 1:
		multiplier = prefixToMultiplier(groups[1])

	value = float(groups[0])
	return value * multiplier

host = socket.gethostname()

with sys.stdin as csvfile:
	csvReader = csv.reader(csvfile)
	for row in csvReader:
		(senderIp, receiverIp, receiveRate, sendRate) = (row[0], row[1], expandBitRate(row[2]), expandBitRate(row[3]))
		sender = getHostName(senderIp)
		receiver = getHostName(receiverIp)
		print("nstat,hosts=" + host +",sender=" + sender + ",receiver=" + receiver + " sendRate=" + str(sendRate) + ",receiveRate=" + str(receiveRate))
</code></pre>
<p>crontab</p>
<pre><code>SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
* * * * *  sh -x /code/cron.sh &gt;&gt; /var/log/cron.log 2&gt;&amp;1
#
</code></pre>
<p><br><br>So that this stuff is doing ?</p>
<p><code>/usr/sbin/iftop -nNb -i $(grep IFACE /code/env.sh |cut -d= -f2) -s 10 -o 10s -t -L 100 2&gt;/dev/null</code> on this part is defined a 10 second of dump sorted on the last 10second column.</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/ec94b65472cf70ce7e0e6024aa4433bee5eccb53f02c6a4c69554598958fa5cc/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938373739312f6d6973632f6966746f705f64756d702e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/ec94b65472cf70ce7e0e6024aa4433bee5eccb53f02c6a4c69554598958fa5cc/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938373739312f6d6973632f6966746f705f64756d702e706e67" alt="iftop_dump" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_640/v1613987791/misc/iftop_dump.png" data-is-external-image="true"></a></p>
<p>at this point the awk parsing <code>| /usr/bin/awk -f /code/parse.awk</code>   </p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/ca6cc436234b92705223f0d117a4b01a3bca8f109258e229b8bee0ceeced85fa/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938373739312f6d6973632f6966746f705f61776b2e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/ca6cc436234b92705223f0d117a4b01a3bca8f109258e229b8bee0ceeced85fa/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938373739312f6d6973632f6966746f705f61776b2e706e67" alt="iftop_awk" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_640/v1613987791/misc/iftop_awk.png" data-is-external-image="true"></a></p>
<p>the format part done by python script <code>| /usr/bin/python3 /code/format.py</code><br><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/2159b3ceb19d51de4e7a8cc95fc909cc9b3e65f7476129209e3a9f5c60b28784/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938373739312f6d6973632f6966746f705f666f726d61742e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/2159b3ceb19d51de4e7a8cc95fc909cc9b3e65f7476129209e3a9f5c60b28784/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938373739312f6d6973632f6966746f705f666f726d61742e706e67" alt="iftop_format" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_640/v1613987791/misc/iftop_format.png" data-is-external-image="true"></a></p>
<p>and finally we ship the metrics to influxdb with <code>| /usr/bin/curl -i -XPOST 'http://$IP/write?db=$DB' --data-binary @-</code></p>
<p><br><br><br><br></p>
<h2><a id="user-content-results" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-nstats#results"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Results</h2>
<p>You can build an run locally <code>docker build -t nstats .</code><br><code>docker run -d -e IFACE=eth0 -e INFLUX=192.168.1.28:8086 -e IDB=test nstats</code></p>
<p>or add into kubernetes in an existing pod<br>it is quite simple and doesn't need any refactoring</p>
<pre><code>      containers:
      - image: lgirardi/py-test-backend
        imagePullPolicy: Always
        name: pytbak
    etc etc etc ....
      - env:
        - name: IFACE
          value: eth0
        - name: INFLUX
          value: 192.168.1.28:8086
        - name: IDB
          value: test
        image: lgirardi/nstats
        imagePullPolicy: Always
        name: nstats
</code></pre>
<p><br><br>What you should have on your grafana reflect the network usages</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/4613ad0a5c58a0c87db124ead36ff00cad611599b58314fb61cea6442163bbf0/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313631343031333731352f6d6973632f6966746f705f67726166616e612e706e67"><img loading="lazy" src="https://camo.githubusercontent.com/4613ad0a5c58a0c87db124ead36ff00cad611599b58314fb61cea6442163bbf0/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313631343031333731352f6d6973632f6966746f705f67726166616e612e706e67" alt="iftop_grafana" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1614013715/misc/iftop_grafana.png" data-is-external-image="true"></a></p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Homelab , when small is big</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/homelab-when-small-is-big.html"/>
        <id>https://www.k8s.it/homelab-when-small-is-big.html</id>
        <media:content url="https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-18.06.38.png" medium="image" />
            <category term="vspehere"/>
            <category term="vmware"/>
            <category term="microk8s"/>
            <category term="kubernetes"/>
            <category term="k3s"/>
            <category term="homelab"/>
            <category term="ghettovcb"/>
            <category term="cluster"/>
            <category term="backup"/>

        <updated>2021-02-19T18:20:07+01:00</updated>
            <summary>
                <![CDATA[
                        <img src="https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-18.06.38.png" alt="" />
                    When I started getting interested on the IT world , i've usually kept all my devices on 24 h to 24. The first labs was an impressive tower in '99 with a huge amount of disk and memory banks, a good cpu cooled by a&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                    <p><img src="https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-18.06.38.png" class="type:primaryImage" alt="" /></p>
                <p>When I started getting interested on the IT world , i've usually kept all my devices on 24 h to 24.</p>
<p>The first labs was an impressive tower in '99 with a huge amount of disk and memory banks, a good cpu cooled by a giant copper heatsink combined with a 12cm fan.<br>All those components were quite similar to a helicopter noise during the night.</p>
<p>The evolution of the lab than , changed a lot year by year , not only reaching a good level of noise but mostly to be cost effective hardware that guarantee new a semplificate production environment.</p>
<p>Now some goals has changed compared with the '99 approach so let's summarize the lab expectations:</p>
<ul>
<li>Cheap hardware </li>
<li>Noiseless </li>
<li>TDP under 20w</li>
<li>24/24 uptime</li>
<li>Virtualization support </li>
<li>Enough to have a Kubernetes installation</li>
<li>Backup solution</li>
<li>Automation ready </li>
</ul>
<p> </p>
<p>Let's now explain the needs behind,<br>i'd like to have a solution that is able to cover all my needs in terms of hobby and experiments, i don't need power , since i take care to the goodness of the solution instead the absolute performance.</p>
<h3>Hardware</h3>
<p>Base: <a href="https://ark.intel.com/content/www/us/en/ark/products/126137/intel-nuc-kit-nuc7pjyh.html" target="_blank" rel="noopener noreferrer">Intel® NUC NUC7PJYH</a></p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-16.39.21-2.png" alt="" width="820" height="594" sizes="100vw" srcset="https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.21-2-xs.webp 300w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.21-2-sm.webp 480w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.21-2-md.webp 768w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.21-2-lg.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.21-2-xl.webp 1360w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.21-2-2xl.webp 1600w"></figure>
<p>RAM: even if the website is reporting 8gb max... this is not true<br>on my installation i have 16GB with G.Skill Ripjaws SO-DIMM 16GB DDR4-2400Mhz 2x8GB</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-16.39.50-2.png" alt="" width="820" height="743" sizes="100vw" srcset="https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.50-2-xs.webp 300w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.50-2-sm.webp 480w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.50-2-md.webp 768w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.50-2-lg.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.50-2-xl.webp 1360w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.50-2-2xl.webp 1600w"></figure>
<p>CPU: j5005 i thinks is the best tdp/performance (here compared to the old q6600 the first intel quadcore ever)</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/24/j5005vsq6600.png" alt="" width="820" height="1321" sizes="100vw" srcset="https://www.k8s.it/media/posts/24/responsive/j5005vsq6600-xs.webp 300w ,https://www.k8s.it/media/posts/24/responsive/j5005vsq6600-sm.webp 480w ,https://www.k8s.it/media/posts/24/responsive/j5005vsq6600-md.webp 768w ,https://www.k8s.it/media/posts/24/responsive/j5005vsq6600-lg.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/j5005vsq6600-xl.webp 1360w ,https://www.k8s.it/media/posts/24/responsive/j5005vsq6600-2xl.webp 1600w"></figure>
<p>DISK: 250gb with ocz vertex4 are a good starting point </p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-16.40.09.png" alt="" width="820" height="748" sizes="100vw" srcset="https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.40.09-xs.webp 300w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.40.09-sm.webp 480w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.40.09-md.webp 768w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.40.09-lg.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.40.09-xl.webp 1360w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.40.09-2xl.webp 1600w"></figure>
<p> </p>
<h3>Software</h3>
<p>Base os vmware esxi 6.7 (free/essential)</p>
<p>Now:</p>
<p><strong>Why</strong> vmware?<br>Because the virtualization stack is really important to have an abstraction layer ,<br>see this <a href="https://www.k8s.it/kubernetes-destroyed-the-virtualization-or-not.html">post</a> </p>
<p><strong>Why</strong> 6.7?<br>Because the vmkernel in 7.0 is changed and is not possible import external network driver (needed for this nuc model), even if there is a trick with usb network adapter and <a href="https://flings.vmware.com/usb-network-native-driver-for-esxi">https://flings.vmware.com/usb-network-native-driver-for-esxi</a> vmware labs usb drivers.</p>
<p><strong>How</strong> build the image with Realtek network card ?<br>First of all you need a windows :( , than you should need to identify your hardware driver , in my case <a href="https://vibsdepot.v-front.de/wiki/index.php/Net55-r8168">https://vibsdepot.v-front.de/wiki/index.php/Net55-r8168</a> and at the end you need to rebuild the image with <a href="https://www.v-front.de/p/esxi-customizer-ps.html" target="_blank" rel="noopener noreferrer">ESXi-Customizer-PS</a></p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-17.16.41.png" alt="" width="1024" height="497" sizes="100vw" srcset="https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.16.41-xs.webp 300w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.16.41-sm.webp 480w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.16.41-md.webp 768w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.16.41-lg.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.16.41-xl.webp 1360w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.16.41-2xl.webp 1600w"></figure>
<p><strong>What</strong> we can do with this "toy"?<br>Well more or less everything you are doing in your datacenter, using packer and ansible for the installation and vm configuration , you can boostrap a k3s cluster or a microk8s standalone kubernetes, few virtualmachines and so on.<br><br><strong>But</strong> is small compared to a server !1!1! <br>different needs , different size ( but same mindset in terms of reliability , flexibility , usability)... however this is my current usage</p>
<p>4 VMS:</p>
<ul>
<li>microk8s installation </li>
<li>monitoring infrastructure</li>
<li>windows active directory</li>
<li>console vm (usually used as ephemeral environment)</li>
</ul>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-17.26.10.png" alt="" width="1024" height="89" sizes="100vw" srcset="https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.26.10-xs.webp 300w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.26.10-sm.webp 480w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.26.10-md.webp 768w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.26.10-lg.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.26.10-xl.webp 1360w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.26.10-2xl.webp 1600w"></figure>
<p> </p>
<p>If you have some doubts about the possibility to run kubernetes in a <em>toy </em>, is the base that i used for all my posts</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-17.30.13.png" alt="" width="820" height="529" sizes="100vw" srcset="https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.30.13-xs.webp 300w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.30.13-sm.webp 480w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.30.13-md.webp 768w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.30.13-lg.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.30.13-xl.webp 1360w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.30.13-2xl.webp 1600w"></figure>
<p> </p>
<h3>Monitoring</h3>
<p>Well again grafana and influxdb are supporting me</p>
<p>HOST<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-17.34.04.png" alt="" width="1024" height="485" sizes="100vw" srcset="https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.34.04-xs.webp 300w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.34.04-sm.webp 480w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.34.04-md.webp 768w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.34.04-lg.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.34.04-xl.webp 1360w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.34.04-2xl.webp 1600w"></figure>
<p>VMS</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/24/vmsgrafana.png" alt="" width="1024" height="1601" sizes="100vw" srcset="https://www.k8s.it/media/posts/24/responsive/vmsgrafana-xs.webp 300w ,https://www.k8s.it/media/posts/24/responsive/vmsgrafana-sm.webp 480w ,https://www.k8s.it/media/posts/24/responsive/vmsgrafana-md.webp 768w ,https://www.k8s.it/media/posts/24/responsive/vmsgrafana-lg.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/vmsgrafana-xl.webp 1360w ,https://www.k8s.it/media/posts/24/responsive/vmsgrafana-2xl.webp 1600w"></figure>
<p> </p>
<h3>Backup</h3>
<p><strong>Why</strong> backup?<br>Because even if the env is automated, some data are inside the vms and i'd like to play with the env and if needed restore the previous snapshot.</p>
<p>Again another free tool is helping me <a href="https://github.com/lamw/ghettoVCB">https://github.com/lamw/ghettoVCB</a></p>
<p>It's a quite simple script that i used for non production environment since the beginning.</p>
<p>In the main path i've created a <em>script</em> folder with ghetto inside and other stuff like packer firewall rules</p>
<p><code>[root@amaterasu:/vmfs/volumes/5eafe677-1260d7e8-2521-94c691a54f7d/script] ls -la<br>total 2240<br>drwxr-xr-x    1 root     root         73728 May  6  2020 .<br>drwxr-xr-t    1 root     root         77824 Dec 28 10:51 ..<br>-rw-r--r--    1 root     root           577 May  4  2020 email.xml<br>-rwxr-xr-x    1 root     root         17207 May  4  2020 ghettoVCB-restore.sh<br>-rw-r--r--    1 root     root           309 May  4  2020 ghettoVCB-restore_vm_restore_configuration_template<br>-rw-r--r--    1 root     root           356 May  4  2020 ghettoVCB-vm_backup_configuration_template<br>-rw-r--r--    1 root     root           832 May 10  2020 ghettoVCB.conf<br>-rwxr-xr-x    1 root     root         72122 May  4  2020 ghettoVCB.sh<br>-rwxr-xr-x    1 root     root           404 May 12  2020 init.sh<br>-rw-r--r--    1 root     root           372 May  4  2020 packer.xml</code></p>
<p>The init.sh files should be added on local.sh to have it running on all machine startup <br><code>[root@amaterasu:/vmfs/volumes/5eafe677-1260d7e8-2521-94c691a54f7d/script] cat /etc/rc.local.d/local.sh<br>#!/bin/sh<br><br># local configuration options<br><br># Note: modify at your own risk!  If you do/use anything in this<br># script that is not part of a stable API (relying on files to be in<br># specific places, specific tools, specific output, etc) there is a<br># possibility you will end up with a broken system after patching or<br># upgrading.  Changes are not supported unless under direction of<br># VMware support.<br><br># Note: This script will not be run when UEFI secure boot is enabled.<br><br>sh -x /vmfs/volumes/amaterasu-datastore/script/init.sh<br><br>exit 0</code></p>
<p>... on the init file you need to apply all changes to have the ghetto running in crontab</p>
<p><code>[root@amaterasu:/vmfs/volumes/5eafe677-1260d7e8-2521-94c691a54f7d/script] cat init.sh<br>#!/bin/bash<br>cp /vmfs/volumes/amaterasu-datastore/script/email.xml /etc/vmware/firewall/<br>cp /vmfs/volumes/amaterasu-datastore/script/packer.xml /etc/vmware/firewall/<br>esxcli network firewall refresh<br>echo "0 22 * * 6 /vmfs/volumes/amaterasu-datastore/script/ghettoVCB.sh -a -g /vmfs/volumes/amaterasu-datastore/script/ghettoVCB.conf<br>" &gt;&gt;  /var/spool/cron/crontabs/root<br>kill $(cat /var/run/crond.pid)<br>crond</code></p>
<p>it is missing only the ghettoVCB.conf configuration that depends on your needs</p>
<p><code>[root@amaterasu:/vmfs/volumes/5eafe677-1260d7e8-2521-94c691a54f7d/script] cat ghettoVCB.conf<br>DISK_BACKUP_FORMAT=thin<br>VM_BACKUP_ROTATION_COUNT=3<br>POWER_VM_DOWN_BEFORE_BACKUP=0<br>ENABLE_HARD_POWER_OFF=0<br>ITER_TO_WAIT_SHUTDOWN=3<br>POWER_DOWN_TIMEOUT=5<br>ENABLE_COMPRESSION=0<br>VM_SNAPSHOT_MEMORY=0<br>VM_SNAPSHOT_QUIESCE=0<br>ALLOW_VMS_WITH_SNAPSHOTS_TO_BE_BACKEDUP=0<br>ENABLE_NON_PERSISTENT_NFS=1<br>UNMOUNT_NFS=1<br>NFS_SERVER=192.168.1.13<br>NFS_VERSION=nfs<br>NFS_MOUNT=/export/backup<br>NFS_LOCAL_NAME=nfs_storage_backup<br>NFS_VM_BACKUP_DIR=amaterasu<br>ENABLE_NFS_IO_HACK=1<br>NFS_IO_HACK_LOOP_MAX=10<br>NFS_IO_HACK_SLEEP_TIMER=60<br>SNAPSHOT_TIMEOUT=15<br>EMAIL_ALERT=0<br>EMAIL_LOG=1<br>EMAIL_SERVER=smtp.k8s.it<br>EMAIL_SERVER_PORT=25<br>EMAIL_DELAY_INTERVAL=1<br>EMAIL_USER_NAME=<br>EMAIL_USER_PASSWORD=<br>EMAIL_TO=backup@xxs.it<br>EMAIL_ERRORS_TO=backup@xxs.it<br>EMAIL_FROM=ghettoVCB-amaterasu@xxs.it<br>WORKDIR_DEBUG=0<br>VM_SHUTDOWN_ORDER=<br>VM_STARTUP_ORDER=</code></p>
<p>And ... well thats all ... you have your weekly snapshot <br><code>2021-02-13 22:00:00 -- info: ============================== ghettoVCB LOG START ==============================<br><br>2021-02-13 22:00:01 -- info: CONFIG - USING GLOBAL GHETTOVCB CONFIGURATION FILE = /vmfs/volumes/amaterasu-datast<wbr>ore/script/ghettoVCB.conf<br>2021-02-13 22:00:01 -- info: CONFIG - VERSION = 2019_01_06_4<br>2021-02-13 22:00:01 -- info: CONFIG - GHETTOVCB_PID = 2250208<br>2021-02-13 22:00:01 -- info: CONFIG - VM_BACKUP_VOLUME = /vmfs/volumes/nfs_storage_back<wbr>up/amaterasu<br>2021-02-13 22:00:01 -- info: CONFIG - ENABLE_NON_PERSISTENT_NFS = 1<br>2021-02-13 22:00:01 -- info: CONFIG - UNMOUNT_NFS = 1<br>2021-02-13 22:00:01 -- info: CONFIG - NFS_SERVER = 192.168.1.13<br>2021-02-13 22:00:01 -- info: CONFIG - NFS_VERSION = nfs<br>2021-02-13 22:00:01 -- info: CONFIG - NFS_MOUNT = /export/backup<br>2021-02-13 22:00:01 -- info: CONFIG - VM_BACKUP_ROTATION_COUNT = 3<br>2021-02-13 22:00:01 -- info: CONFIG - VM_BACKUP_DIR_NAMING_CONVENTIO<wbr>N = 2021-02-13_22-00-00<br>2021-02-13 22:00:01 -- info: CONFIG - DISK_BACKUP_FORMAT = thin<br>2021-02-13 22:00:01 -- info: CONFIG - POWER_VM_DOWN_BEFORE_BACKUP = 0<br>2021-02-13 22:00:01 -- info: CONFIG - ENABLE_HARD_POWER_OFF = 0<br>2021-02-13 22:00:01 -- info: CONFIG - ITER_TO_WAIT_SHUTDOWN = 3<br>2021-02-13 22:00:01 -- info: CONFIG - POWER_DOWN_TIMEOUT = 5<br>2021-02-13 22:00:01 -- info: CONFIG - SNAPSHOT_TIMEOUT = 15<br>2021-02-13 22:00:01 -- info: CONFIG - LOG_LEVEL = info<br>2021-02-13 22:00:01 -- info: CONFIG - BACKUP_LOG_OUTPUT = /tmp/ghettoVCB-2021-02-13_22-0<wbr>0-00-2250208.log<br>2021-02-13 22:00:01 -- info: CONFIG - ENABLE_COMPRESSION = 0<br>2021-02-13 22:00:01 -- info: CONFIG - VM_SNAPSHOT_MEMORY = 0<br>2021-02-13 22:00:01 -- info: CONFIG - VM_SNAPSHOT_QUIESCE = 0<br>2021-02-13 22:00:01 -- info: CONFIG - ALLOW_VMS_WITH_SNAPSHOTS_TO_BE<wbr>_BACKEDUP = 0<br>2021-02-13 22:00:01 -- info: CONFIG - VMDK_FILES_TO_BACKUP = all<br>2021-02-13 22:00:01 -- info: CONFIG - VM_SHUTDOWN_ORDER =<br>2021-02-13 22:00:01 -- info: CONFIG - VM_STARTUP_ORDER =<br>2021-02-13 22:00:01 -- info: CONFIG - RSYNC_LINK = 0<br>2021-02-13 22:00:01 -- info: CONFIG - BACKUP_FILES_CHMOD =<br>2021-02-13 22:00:01 -- info: CONFIG - EMAIL_LOG = 1<br>2021-02-13 22:00:01 -- info: CONFIG - EMAIL_SERVER = <a href="http://smtp.k8s.it/" rel="noopener noreferrer" target="_blank" data-saferedirecturl="https://www.google.com/url?q=http://smtp.k8s.it&amp;source=gmail&amp;ust=1613839933510000&amp;usg=AFQjCNFj5McYEepf6qWyQHkVKmgpikm1JQ">smtp.xxs.it</a><br>2021-02-13 22:00:01 -- info: CONFIG - EMAIL_SERVER_PORT = 25<br>2021-02-13 22:00:01 -- info: CONFIG - EMAIL_DELAY_INTERVAL = 1<br>2021-02-13 22:00:01 -- info: CONFIG - EMAIL_FROM = <a href="mailto:ghettoVCB-amaterasu@k8s.it" target="_blank" rel="noopener">ghettoVCB-amaterasu@xxs.it</a><br>2021-02-13 22:00:01 -- info: CONFIG - EMAIL_TO = <a href="mailto:backup@k8s.it" target="_blank" rel="noopener">backup@xxs.it</a><br>2021-02-13 22:00:01 -- info: CONFIG - WORKDIR_DEBUG = 0<br>2021-02-13 22:00:01 -- info: CONFIG - ENABLE NFS IO HACK = 1<br>2021-02-13 22:00:01 -- info: CONFIG - NFS IO HACK LOOP MAX = 10<br>2021-02-13 22:00:01 -- info: CONFIG - NFS IO HACK SLEEP TIMER = 60<br>2021-02-13 22:00:01 -- info: CONFIG - NFS BACKUP DELAY = 0<br><br>2021-02-13 22:00:06 -- info: Initiate backup for izanami<br>2021-02-13 22:00:06 -- info: Creating Snapshot "ghettoVCB-snapshot-2021-02-13<wbr>" for izanami<br>2021-02-13 22:09:55 -- info: Removing snapshot from izanami ...<br>2021-02-13 22:10:56 -- info: Slept 60 seconds to work around NFS I/O error<br>2021-02-13 22:10:56 -- info: Backup Duration: 10.83 Minutes<br>2021-02-13 22:10:56 -- info: Successfully completed backup for izanami!<br><br>2021-02-13 22:11:02 -- info: Initiate backup for izanagi<br>2021-02-13 22:11:02 -- info: Creating Snapshot "ghettoVCB-snapshot-2021-02-13<wbr>" for izanagi<br>2021-02-13 22:16:37 -- info: Removing snapshot from izanagi ...<br>2021-02-13 22:17:37 -- info: Slept 60 seconds to work around NFS I/O error<br>2021-02-13 22:17:37 -- info: Backup Duration: 6.58 Minutes<br>2021-02-13 22:17:37 -- info: Successfully completed backup for izanagi!<br><br>2021-02-13 22:17:43 -- info: Initiate backup for hiroito<br>2021-02-13 22:17:43 -- info: Creating Snapshot "ghettoVCB-snapshot-2021-02-13<wbr>" for hiroito<br>2021-02-13 22:23:55 -- info: Removing snapshot from hiroito ...<br>2021-02-13 22:24:56 -- info: Slept 60 seconds to work around NFS I/O error<br>2021-02-13 22:24:56 -- info: Backup Duration: 7.22 Minutes<br>2021-02-13 22:24:56 -- info: Successfully completed backup for hiroito!<br><br>2021-02-13 22:25:01 -- info: Initiate backup for raijin<br>2021-02-13 22:25:01 -- info: Creating Snapshot "ghettoVCB-snapshot-2021-02-13<wbr>" for raijin<br>2021-02-13 22:26:21 -- info: Removing snapshot from raijin ...<br>2021-02-13 22:27:21 -- info: Slept 60 seconds to work around NFS I/O error<br>2021-02-13 22:27:21 -- info: Backup Duration: 2.33 Minutes<br>2021-02-13 22:27:21 -- info: Successfully completed backup for raijin!<br><br>2021-02-13 22:27:54 -- info: ###### Final status: All VMs backed up OK! ######<br><br>2021-02-13 22:27:54 -- info: ============================== ghettoVCB LOG END ==============================<wbr>==</code><br><br></p>
<h3>Price </h3>
<p>nuc7PJYH ~ 160€<br>G.Skill Ripjaws SO-DIMM 16GB DDR4-2400Mhz 2x8GB ~ 60€<br>hard disk ssd 250db ~ 40€<br><br>Is not cheap as a raspberry 4 but it's 10 time more performant and guarantee a full server experience with the possibility to play and grow your skills and challenges</p>
<p> </p>
<p> </p>
<p> </p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Ambient sensor for mere mortal</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/ambient-sensor-for-mere-mortal.html"/>
        <id>https://www.k8s.it/ambient-sensor-for-mere-mortal.html</id>

        <updated>2021-01-29T12:47:26+01:00</updated>
            <summary>
                <![CDATA[
                    In the home automation era, I was quite curious to understand how is working a simple thermal sensor I tried this simple experiment following the suggestion of one of my colleagues, i was thinking to start with Arduino , however he suggested to try nodemcu&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <p>In the home automation era, I was quite curious to understand how is working a simple thermal sensor</p>
<h3>WHAT WE NEED ?</h3>
<ul>
<li>ESP8266</li>
<li>DHT22</li>
<li>usb power</li>
<li>Influxdb</li>
<li>Grafana</li>
</ul>
<p>I tried this simple experiment following the suggestion of one of my colleagues, i was thinking to start with Arduino , however he suggested to try nodemcu</p>
<p>So what is <em>nodemcu?<br></em>It's an open source platform developed for IoT , you can <em>compile</em> the firmware with the most used sensors available , but the main feature is the Lua support<br>When i starts with Arduino i created some C software really horrible 😇<br>with Lua instead it was quite simple create this kind of functionality.</p>
<p>The hardware platform is really nice and simple </p>
<h4>ESP8266</h4>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/23/Screenshot-2021-01-24-at-21.39.16.png" alt="" width="640" height="565" sizes="100vw" srcset="https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.39.16-xs.webp 300w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.39.16-sm.webp 480w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.39.16-md.webp 768w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.39.16-lg.webp 1024w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.39.16-xl.webp 1360w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.39.16-2xl.webp 1600w"></figure>
<p> </p>
<p>It's natively support wifi and with the sensor dht22 you are able to have the temperature, humidity ... and well also a dew point since is it a maths of previous values</p>
<h4>DHT22</h4>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/23/Screenshot-2021-01-24-at-21.42.27.png" alt="" width="640" height="602" sizes="100vw" srcset="https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.42.27-xs.webp 300w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.42.27-sm.webp 480w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.42.27-md.webp 768w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.42.27-lg.webp 1024w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.42.27-xl.webp 1360w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.42.27-2xl.webp 1600w"></figure>
<p> </p>
<p>Price for both is really cheaper (aliexpress)</p>
<p>esp8266    --&gt; 3$<br>dht22          --&gt; 1$</p>
<p>Once you receive the hardware you can start to work on it </p>
<p>With <a href="https://nodemcu-build.com/">https://nodemcu-build.com/</a> you can build the firmware that fit your needs (in the next screen what is needed to interact with the thermal sensor)</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/23/Screenshot-2021-01-24-at-21.46.37.png" alt="" width="640" height="484" sizes="100vw" srcset="https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.46.37-xs.webp 300w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.46.37-sm.webp 480w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.46.37-md.webp 768w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.46.37-lg.webp 1024w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.46.37-xl.webp 1360w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.46.37-2xl.webp 1600w"></figure>
<p> </p>
<p>To load the firmware you should need <a href="https://github.com/espressif/esptool">https://github.com/espressif/esptool</a></p>
<p>with a command like this<br><code>python esptool.py -b 115200 --port=/dev/cu.<wbr>wchusbserial1410 write_flash  -fm=dio -fs=32m 0x0000 <span class="il">nodemcu</span>-master-12-modules-<wbr>2016-01-09-18-51-26-float.bin</code></p>
<p>Now.... it's time to create the Lua script</p>
<h3>Configuration</h3>
<p>This is working since 2016 so i think we can consider stable 😁</p>
<pre><code>local SSID = "name wifi"
local SSID_PASSWORD = "password wifi"
local DEVICE = "name device"
local temperature = 20.0

wifi.setmode(wifi.STATION)
wifi.sta.config(SSID,SSID_PASSWORD)
wifi.sta.autoconnect(1)

local HOST = "server database"
local URI = "/write?db=collectd"

function build_post_request(host, uri, data_table)

     local data = data_table.Data_type .. ",device=" .. data_table.Device .. " " .. "value=" .. data_table.Value

     --for param,value in pairs(data_table) do
    --      data = data .. param.."="..value.."&amp;"
    -- end
    print(data)

     request = "POST "..uri.." HTTP/1.1\r\n"..
     "Host: "..host.."\r\n"..
     "Connection: close\r\n"..
     "Content-Type: application/x-www-form-urlencoded\r\n"..
     "Content-Length: "..string.len(data).."\r\n"..
     "\r\n"..
     data

     print(request)

     return request
end

local function display(sck,response)
     print(response)
end

-- When using send_sms: the "from" number HAS to be your twilio number.
-- If you have a free twilio account the "to" number HAS to be your twilio verified number.
-- The numbers MUST include the country code.
-- DO NOT add the "+" sign.
local function send_data(data_type,device,value)

     local data = {
      Data_type = data_type,
      Device = device,
      Value = value
     }

     socket = net.createConnection(net.TCP,0)
     socket:on("receive",display)
     socket:connect(8086,HOST)

     socket:on("connection",function(sck)

          local post_request = build_post_request(HOST,URI,data)
          sck:send(post_request)
     end)
end

function check_wifi()
 local ip = wifi.sta.getip()

 if(ip==nil) then
   print("Connecting...")
 else
  tmr.stop(0)
  print("Connected to AP!")
  print(ip)
  --send_data("15551234567","12223456789","Hello from your ESP8266")

  local t, h, d = getTempHumi()

  print("Temp:"..t .." C\n")
  print("Humi:"..h .." RH\n")
  print("Dew:"..d .." DP\n")

  send_data("temperature", DEVICE, t)
  send_data("humidity", DEVICE, h)
  send_data("dew_point", DEVICE, d)

  tmr.alarm(0,30000,1,check_wifi)

 end

end

tmr.alarm(0,5000,1,check_wifi)

function getTempHumi()
    pin = 4
    local status,temp,humi,temp_decimial,humi_decimial = dht.read(pin)
    if( status == dht.OK ) then
    -- Float firmware using this example
      print("DHT Temperature:"..temp..";".."Humidity:"..humi)
    elseif( status == dht.ERROR_CHECKSUM ) then
      print( "DHT Checksum error." );
    elseif( status == dht.ERROR_TIMEOUT ) then
      print( "DHT Time out." );
    end
    local dewpoint= (humi/100)^(1/8) * (112 + (0.9 * temp)) - 112 + (0.1 * temp)

    return temp, humi, (string.format("%.1f", dewpoint))
end</code></pre>
<h4>Customizations</h4>
<p>local SSID = "wifi name"  <br>local SSID_PASSWORD = "wifi password" <br>local DEVICE = "name device"        --&gt; name of you board/room </p>
<p>local HOST = "server database"     --&gt; your influxdb installation<br>local URI = "/write?db=collectd"     --&gt; your database name </p>
<p> </p>
<p>So we have the hardware , we loaded the firmware, we created the code, but how to interact with the platform... well there are many way however <a href="https://esp8266.ru/esplorer/" target="_blank" rel="noopener noreferrer">ESPlorer</a> has a nice gui even if it's java based ☠️</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/23/ESPlorer-panels.png" alt="" width="640" height="373" sizes="100vw" srcset="https://www.k8s.it/media/posts/23/responsive/ESPlorer-panels-xs.webp 300w ,https://www.k8s.it/media/posts/23/responsive/ESPlorer-panels-sm.webp 480w ,https://www.k8s.it/media/posts/23/responsive/ESPlorer-panels-md.webp 768w ,https://www.k8s.it/media/posts/23/responsive/ESPlorer-panels-lg.webp 1024w ,https://www.k8s.it/media/posts/23/responsive/ESPlorer-panels-xl.webp 1360w ,https://www.k8s.it/media/posts/23/responsive/ESPlorer-panels-2xl.webp 1600w"></figure>
<p> </p>
<h3>Results</h3>
<p><a href="https://services.k8s.it/grafana/d/000000079/temperature?viewPanel=5&amp;orgId=2&amp;refresh=1m">https://services.k8s.it/grafana/d/000000079/temperature?viewPanel=5&amp;orgId=2&amp;refresh=1m</a></p>
<p>above you can see the live results .... and on grafana we can create a graph like this</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/23/Screenshot-2021-01-24-at-22.11.01.png" alt="" width="1024" height="408" sizes="100vw" srcset="https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.11.01-xs.webp 300w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.11.01-sm.webp 480w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.11.01-md.webp 768w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.11.01-lg.webp 1024w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.11.01-xl.webp 1360w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.11.01-2xl.webp 1600w"></figure>
<p>The delta delta in the <em>Humidity is generated by an </em>humidifier</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/23/Screenshot-2021-01-24-at-22.06.50.png" alt="" width="640" height="738" sizes="100vw" srcset="https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.06.50-xs.webp 300w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.06.50-sm.webp 480w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.06.50-md.webp 768w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.06.50-lg.webp 1024w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.06.50-xl.webp 1360w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.06.50-2xl.webp 1600w"></figure>
<p> </p>
<p>I have one sensor for all rooms ... and also external </p>
<p>The external one should be replaced more or less every year because is not properly water proof and ... day by day the electrical contacts become oxidized </p>
<p> </p>
<p> </p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>The monitoring paper</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/the-monitoring-paper.html"/>
        <id>https://www.k8s.it/the-monitoring-paper.html</id>
        <media:content url="https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-17.47.24.png" medium="image" />
            <category term="system metrics"/>
            <category term="slo"/>
            <category term="sli"/>
            <category term="sla"/>
            <category term="observability"/>
            <category term="metrics"/>
            <category term="customer experience"/>
            <category term="conversion "/>
            <category term="business metrics"/>
            <category term="application metrics"/>
            <category term="alerting"/>

        <updated>2021-01-05T19:11:11+01:00</updated>
            <summary>
                <![CDATA[
                        <img src="https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-17.47.24.png" alt="" />
                    Contrary to popular belief, monitoring an infrastructure is the opposite to just have some metrics about applications and network There are many many documents the lead this topic, one of the most interesting it's just few pages from Google around the art of slos or&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                    <p><img src="https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-17.47.24.png" class="type:primaryImage" alt="" /></p>
                <p>Contrary to popular belief, monitoring an infrastructure is the opposite to just have some metrics about applications and network</p>
<p>There are many many documents the lead this topic,<br>one of the most interesting it's just few pages from Google around <a href="https://static.googleusercontent.com/media/sre.google/it//static/pdf/art-of-slos-slides.pdf" target="_blank" rel="noopener noreferrer">the art of slos</a><br>or the <a href="https://www.k8s.it/media/files/The Art of SLOs - Google.pdf" target="_blank" rel="noopener noreferrer">book</a> version i took from a google onsite deep dive. <a href="https://www.k8s.it/media/files/The Art of SLOs - Google.pdf" target="_blank" rel="noopener noreferrer"></a></p>
<p>To better details this topic i'd like to use simple statements:</p>
<ul>
<li>WHAT</li>
<li>WHY</li>
<li>WHO</li>
<li>HOW</li>
</ul>
<p> </p>
<h3>WHAT </h3>
<p>This is probably the main argument we will discuss on this thread </p>
<p>There no magic formulas or tools to use, if you expect to buy a tool that work with metrics out of the box, you're wrong. <br>Tools are the infrastructure to store and visualize data... but first of all you need to collect the right data.</p>
<p>What is the DATA you need ?<br>Those are you will record moving yourself on the <span style="text-decoration: underline;">customer position</span></p>
<p><strong>Customer position</strong> : i'm using this term because i suppose you are not an onlus so you have a customer, but customer is a overall word with the meaning of all people are using your product:</p>
<ul>
<li>people that buy something e-commerce (Amazon, Bestbuy, Aliexpress)</li>
<li>people that use website to learn something (Cnn, Bloomberg, Wikipedia)</li>
<li>people that work on finance and use finance applications (Navision, SAP, JD Edwards)</li>
<li>people that use energy from nuclear site </li>
</ul>
<p>So moving yourself on the customer position you can better understand the definition of data that you need to know to better monitor your application with the righe <strong>customer metrics </strong></p>
<p>Stupid example ... imagine an automatic gate</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/20/Screenshot-2021-01-03-at-16.31.43.png" alt="" width="1092" height="522" sizes="100vw" srcset="https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-03-at-16.31.43-xs.webp 300w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-03-at-16.31.43-sm.webp 480w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-03-at-16.31.43-md.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-03-at-16.31.43-lg.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-03-at-16.31.43-xl.webp 1360w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-03-at-16.31.43-2xl.webp 1600w"></figure>
<p>What is the definition of "it's working?"</p>
<ul>
<li>it opens</li>
</ul>
<p>Obviously YES , but not only</p>
<ul>
<li>what about if it's not closing ? </li>
<li>what about if it opens in 10 minutes , it's acceptable ?</li>
<li>what about if after X times the automation is broken ? </li>
<li>etc etc ...</li>
</ul>
<p>As you can imagine we can define not only the objective values (open/close), we can elaborate customer subjective frustration , if i have to buy an automatic gate, i will not choose the one that will take 10 minutes to open... because... because 10 minutes are too much , based on subjective value as a customer.</p>
<p>In the same way we cannot say that our application is working because it's answers.</p>
<p>So <span style="text-decoration: underline;">what</span> we have to consider when we start to monitor an application in production?</p>
<p>Let's start with 3 macro clusters:</p>
<ul>
<li style="font-weight: 400;"><span style="font-weight: 400;"><strong>system</strong> resources, so all metrics related to the pod (cpu,network,...)</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;"><strong>application</strong> standard metrics (thread, gc, errors per minute, requests per minute, ... )</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;"><strong>business</strong> metrics that are inherent from the application scope, if the application provides a checkout for goods, we need to know for example how many transactions were fine and how many rejected</span></li>
</ul>
<p> </p>
<h4><strong>System</strong></h4>
<p>Those are the most easiest and used metrics since you started to monitor services.<br>On this group we have the basis metrics related to the system usage,<br>considering the evolution of the platform those values are day by day less influential than before.<br>This is because as soon we are increasing the technology level from bare metal, to vm , to docker to serverless ... the evaluation of those numbers could raise some mistake on the interpretation , however we still need to start with the basis in order to have data to define a trend based on specific situations</p>
<p>Here an example about the bare metal used as vsphere 6.7</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-15.49.59.png" alt="" width="1024" height="371" sizes="100vw" srcset="https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.49.59-xs.webp 300w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.49.59-sm.webp 480w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.49.59-md.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.49.59-lg.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.49.59-xl.webp 1360w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.49.59-2xl.webp 1600w"></figure>
<p>always on the system metrics we can go more in deep checking a virtual machine inside this host, here the one i used to host my kubernetes lab</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-15.53.29.png" alt="" width="1024" height="371" sizes="100vw" srcset="https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.53.29-xs.webp 300w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.53.29-sm.webp 480w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.53.29-md.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.53.29-lg.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.53.29-xl.webp 1360w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.53.29-2xl.webp 1600w"></figure>
<p>In the 2 images for example we can assume that we have something that move the cpu close to 100% cyclically (it's a <a href="https://www.k8s.it/kubernetes-sitespeedio.html">crawler</a> to perform check on website pages every hours)</p>
<p> </p>
<h4><strong>Application</strong></h4>
<p>It's time now to move inside the kubernetes cluster and check how is going on the a web application inside the cluster<br>Since this application it is springboot based, we have the opportunity to understand how is going on from a framework side (java) and behavioural interactions.<br>Response time server to server, server errors, client errors, sql interactions, garbage collector, sidecars (is a pod with multiple images) usage, logs creation , metrics creation etc etc</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/20/app_metrics.png" alt="" width="1024" height="956" sizes="100vw" srcset="https://www.k8s.it/media/posts/20/responsive/app_metrics-xs.webp 300w ,https://www.k8s.it/media/posts/20/responsive/app_metrics-sm.webp 480w ,https://www.k8s.it/media/posts/20/responsive/app_metrics-md.webp 768w ,https://www.k8s.it/media/posts/20/responsive/app_metrics-lg.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/app_metrics-xl.webp 1360w ,https://www.k8s.it/media/posts/20/responsive/app_metrics-2xl.webp 1600w"></figure>
<p>Having those in place you can understand from an application point of view how is going on the performances release by release.. what happen in case of bugs and critical condition (unexpected huge traffic) , the area where you can put you effort on improvements.</p>
<p> </p>
<h4><span style="font-weight: 400;"><strong>Business</strong></span></h4>
<p>OK system is covered , application is covered ... what about the customer perception ?</p>
<p>This is the most critical topic , if your application is part of a microservices funnel or a monolithic application that manage the entire product, it's supposed that in some way you have benefits from its performances</p>
<p>So move yourself on the customer position monitoring your website from a customer point of view with business metrics , in this simple case i just monitor the cms page on top <br>It's a website:</p>
<ul>
<li>so how long does it take have the page ?</li>
<li>which are the most relevant data you need to know to improve?</li>
<li>do you have the same trends every time ?</li>
<li>etc etc</li>
</ul>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/20/screencapture-services-k8s-it-grafana-d-000000053-pagesummary-influxdb-2021-01-05-17_07_37.png" alt="" width="1024" height="3021" sizes="100vw" srcset="https://www.k8s.it/media/posts/20/responsive/screencapture-services-k8s-it-grafana-d-000000053-pagesummary-influxdb-2021-01-05-17_07_37-xs.webp 300w ,https://www.k8s.it/media/posts/20/responsive/screencapture-services-k8s-it-grafana-d-000000053-pagesummary-influxdb-2021-01-05-17_07_37-sm.webp 480w ,https://www.k8s.it/media/posts/20/responsive/screencapture-services-k8s-it-grafana-d-000000053-pagesummary-influxdb-2021-01-05-17_07_37-md.webp 768w ,https://www.k8s.it/media/posts/20/responsive/screencapture-services-k8s-it-grafana-d-000000053-pagesummary-influxdb-2021-01-05-17_07_37-lg.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/screencapture-services-k8s-it-grafana-d-000000053-pagesummary-influxdb-2021-01-05-17_07_37-xl.webp 1360w ,https://www.k8s.it/media/posts/20/responsive/screencapture-services-k8s-it-grafana-d-000000053-pagesummary-influxdb-2021-01-05-17_07_37-2xl.webp 1600w"></figure>
<p> </p>
<p> </p>
<h3>WHY</h3>
<p>With those cluster of metrics we can define and plan the architecture and the forecasting for the company ... remember that when something goes wrong with no metrics you will probably cascade to situation like this</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-17.41.07.png" alt="" width="1024" height="441" sizes="100vw" srcset="https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.41.07-xs.webp 300w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.41.07-sm.webp 480w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.41.07-md.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.41.07-lg.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.41.07-xl.webp 1360w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.41.07-2xl.webp 1600w"></figure>
<p> </p>
<p><strong>System</strong> metrics can share the usages and the density of you infrastructure creating the basis <span style="text-decoration: underline;">alerts</span> in case of suffering but also plan the evolution of the platform itself  </p>
<p><span style="font-weight: 400;"><strong>Application </strong>metrics share the framework behaviour and the evolution of your application day by day , <span style="text-decoration: underline;">alerts</span> are defined to monitor the scalability, bugs and application behaviour</span></p>
<p><strong>Business <span style="font-weight: 400;">metrics share the thresholds to use as alerts but not only... </span><br></strong>In this example we are talking about a web application <br>If you are selling something through it ,conversion is always the most relevant buzzword</p>
<p>From the 100 visitors , who will continue the navigation till the purchase, the remaining are really a small slice (e-commerce for example)</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/20/conversion-impact-score-funnel-NEW.png" alt="" width="800" height="647" sizes="100vw" srcset="https://www.k8s.it/media/posts/20/responsive/conversion-impact-score-funnel-NEW-xs.webp 300w ,https://www.k8s.it/media/posts/20/responsive/conversion-impact-score-funnel-NEW-sm.webp 480w ,https://www.k8s.it/media/posts/20/responsive/conversion-impact-score-funnel-NEW-md.webp 768w ,https://www.k8s.it/media/posts/20/responsive/conversion-impact-score-funnel-NEW-lg.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/conversion-impact-score-funnel-NEW-xl.webp 1360w ,https://www.k8s.it/media/posts/20/responsive/conversion-impact-score-funnel-NEW-2xl.webp 1600w"></figure>
<p>This images comes from an 2015 <a href="https://blogs.akamai.com/2015/07/conversion-impact-score-what-is-it-and-why-do-you-need-to-know-yours.html" target="_blank" rel="noopener noreferrer">article</a> from Akamai that is really still actual ...<br>Conversion is always impacted by page response time , more close you are in the first navigation phases like searching rather than checkout where you probably have more clear will to purchase<br><br>Now we know the data around the usage of our website and we can create <strong>GOALs</strong> and <strong>KPI</strong> to improve those values in order to better fit with the customer expectation.</p>
<p> </p>
<p> </p>
<h3>WHO</h3>
<p>Those actors could be different case by case, from a small company to an enterprise, even if you are a full stack whateverops, a developer or part of monitoring team, in this scope you should not be alone. </p>
<p><strong>System</strong> and <strong>Application</strong> are usually managed by <span style="text-decoration: underline;">sre/devops/sysadmin</span> with the help of architecture/developer to define the best framework metrics to monitor.</p>
<p>On the opposite side <strong>Business </strong>are more close with the product side, who will be better than the <span style="text-decoration: underline;">product dept</span> (developers) itself defining the kpi and goals used as a metrics with the cooperation of the <span style="text-decoration: underline;">business dept</span> to define the <strong><span style="font-weight: 400;">thresholds.</span></strong></p>
<p>This cooperation will be useful to define:</p>
<ul>
<li style="font-weight: 400;"><span style="font-weight: 400;">Right alerts to right people</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">Support granted by ownership</span></li>
<li style="font-weight: 400;"><span style="font-weight: 400;">No speculations, real data</span></li>
</ul>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-17.39.10.png" alt="" width="1024" height="346" sizes="100vw" srcset="https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.39.10-xs.webp 300w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.39.10-sm.webp 480w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.39.10-md.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.39.10-lg.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.39.10-xl.webp 1360w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.39.10-2xl.webp 1600w"></figure>
<p> </p>
<h3><strong>HOW</strong></h3>
<p> </p>
<h4>Infrastructure</h4>
<p>First of all you have to define the monitoring/alerting platform, <br>the suggestion is to have this platform scalable with a good UI (grafana) to work with backend storage (prometheus + cortex/thanos, graphite + carbonzipper, influxdb, etc etc)</p>
<p>Honestly if you are in a big environment and you make a mistake in metrics configuration with graphite (push model) you can saturate the space since every time you create a new metric you are creating whisper file with the dimension based on the retention schema.<br>I prefer prometheus (pull model) that could prevent those issues and better fit the kubernetes standars , will be also more easy create a /metrics page on your application rather than use sidecar pods to stream metrics with collectd/telegraf/statsd and so on.</p>
<h4> </h4>
<h4>Less is more</h4>
<p><span style="font-weight: 400;">How many metrics are enough to create a valid alert?</span></p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-17.48.07.png" alt="" width="1024" height="764" sizes="100vw" srcset="https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.48.07-xs.webp 300w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.48.07-sm.webp 480w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.48.07-md.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.48.07-lg.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.48.07-xl.webp 1360w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.48.07-2xl.webp 1600w"></figure>
<p>The more metrics identify the service behaviour the more we can create a dedicated alert...<br>anyway  ....<br>The anti-pattern model currently applied in some cases: <br>have tons of metrics that generate only <strong>noise</strong> without identifying the healthiness of a service</p>
<p><em>Keep it simple</em> and define the structure of your <span style="text-decoration: underline;">System,</span> <span style="text-decoration: underline;">Application</span> and <span style="text-decoration: underline;">Business</span> metrics .</p>
<p> </p>
<h4>Smart metrics</h4>
<p><span style="font-weight: 400;">It’s not only ONE value that show off the healthiness, but the combination of multiple metrics that guarantee the status</span></p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-17.46.34.png" alt="" width="1024" height="303" sizes="100vw" srcset="https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.34-xs.webp 300w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.34-sm.webp 480w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.34-md.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.34-lg.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.34-xl.webp 1360w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.34-2xl.webp 1600w"></figure>
<p>This concept is really important, imagine a dynamic infrastructure based on kubernetes <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank" rel="noopener noreferrer">HPA</a> </p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-18.22.01.png" alt="" width="1024" height="632" sizes="100vw" srcset="https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-18.22.01-xs.webp 300w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-18.22.01-sm.webp 480w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-18.22.01-md.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-18.22.01-lg.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-18.22.01-xl.webp 1360w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-18.22.01-2xl.webp 1600w"></figure>
<p>where you can probable have some value linear (like thread), mitigated by the horizontal autoscaling, you should combine multiple values to define the application status.</p>
<p>Create the metrics alert with <strong>trends</strong> not with the pure number <br>Ex. 70 threads value alone make no sense , different applications has different threads value , what is important is the <strong>delta , </strong>the percentage is useful to understand the behaviour, +50% threads make sense in all applications rather than the effective number.<br><br></p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-17.46.55.png" alt="" width="1024" height="656" sizes="100vw" srcset="https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.55-xs.webp 300w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.55-sm.webp 480w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.55-md.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.55-lg.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.55-xl.webp 1360w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.55-2xl.webp 1600w"></figure>
<p> </p>
<p>Be smart also on the evaluation with standard deviation and <strong>percentile</strong> ... mean is usually dropping the relevant value to evaluate performances under stress</p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Maximum yield with minimum expense for a static website</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/maximum-yield-with-minimum-expense.html"/>
        <id>https://www.k8s.it/maximum-yield-with-minimum-expense.html</id>
        <media:content url="https://www.k8s.it/media/posts/18/Screenshot-2020-12-26-at-16.43.11.png" medium="image" />
            <category term="workers"/>
            <category term="website"/>
            <category term="static cms"/>
            <category term="static"/>
            <category term="serverless"/>
            <category term="security"/>
            <category term="publii"/>
            <category term="minio"/>
            <category term="kubernetes"/>
            <category term="headers"/>
            <category term="cms"/>
            <category term="cloudflare"/>

        <updated>2020-12-28T09:58:59+01:00</updated>
            <summary>
                <![CDATA[
                        <img src="https://www.k8s.it/media/posts/18/Screenshot-2020-12-26-at-16.43.11.png" alt="" />
                    Great marketing quote, however i think we can better share a value that is always true... keep it simple, keep it safe. I would structure this article in few relevant topics Each of the above could be a specific topic that will fit others use&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                    <p><img src="https://www.k8s.it/media/posts/18/Screenshot-2020-12-26-at-16.43.11.png" class="type:primaryImage" alt="" /></p>
                <p>Great marketing quote, however i think we can better share a value that is always true... <br><em><span style="text-decoration: underline;">keep it simple, keep it safe.</span></em></p>
<p>I would structure this article in few relevant topics</p>
<ul>
<li>Static website</li>
<li>Tools</li>
<li>Security</li>
<li>Monitor</li>
</ul>
<p>Each of the above could be a specific topic that will fit others use cases</p>
<p><em>This is not a post about how to create a blog... this post will inspect into some technology that can simplify your life or your work with small but important concepts</em></p>
<p> </p>
<h3>Static website</h3>
<p>Among the famous open cms i tried probably all of those,  during my career.<br>Basically are a web application with sql database in most of the cases.</p>
<p>Now we can discuss about the meaning of content generation , that should be dynamic and be part of the user experience rather than a page generated, however today i will talk just about the usage of a cms for a static(tbd) reality.</p>
<p>If your goal is promote your company, your hobbies, your work ... you have already heard about wordpress, joomla, drupal etc etc ... that are good (if not directly exposed) but had a huge problem... since are open and used by a relevant number of people, are subjected of vulnerability, moreover , if you install plugins the situation could be dramatic.</p>
<p>As much you install <strong>plugins</strong> (and really some cms are not able to do anything with a plugin),<br>as much your website is bloat.<br>With the same ratio the <span style="text-decoration: underline;">performances will decrease.</span></p>
<p>On top of this, a <span style="text-decoration: underline;">huge</span> percentage of the plugins in the cms repository are old and out of date yet still available to install on your system.</p>
<p>So if you don't need something special (most of the blogs are wordpress only because it's easy to use) and you want to create a static website for your company, your business and so on , you can probably evaluate something different looking for , the first pillar mentioned, keep it simple.<br>Moreover the trend in a enterprise is moving from dynamic content to static as per the <strong>speed</strong> is the major KPI for a website</p>
<p>On a secondary binary in the last years the static cms are growth</p>
<ul>
<li>Jekyll</li>
<li>Gatsby</li>
<li>Siteleaf</li>
<li>Netlify</li>
<li>Hugo</li>
<li>$whatever-js (every day we have a new js framework)</li>
<li>etc etc</li>
</ul>
<p>However if you are not so nerd ... or your are tremendously lazy (like me)<br>a grate alternative is <a href="https://getpublii.com/">Publii</a></p>
<p>Publii includes a WYSIWYG (What You See Is What You Get) editor for content creation,<br>really easy to use , and the client is available for multiple platform (win,linux,mac)</p>
<p> </p>
<p> </p>
<p> </p>
<h3>Tools</h3>
<p>I mentioned Publii before, this tool is just a simple way for lazy people to create a static website, i'll not go in deep with this software since is well explained in its website however offer multiple possibility where store the files , the main ones are s3 bucket and github pages.<br>Publii is not a pretty collaborative tool but is not supposed to have this kind of interaction on a static website, is more close to a human interaction only.<br><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">On the opposite side Jekyll and the other families are more close to be collaborative based on a git project and part of a pipeline flow (runner/actions)</span></p>
<p> </p>
<p>Based on the backend for you html files, lets explore the <a href="https://pages.github.com/">github pages</a><br>This service is free with few limits<br><em>Published GitHub Pages sites may be no larger than 1 GB.</em><br><em>GitHub Pages sites have a soft bandwidth limit of 100GB per month.</em><br><em>GitHub Pages sites have a soft limit of 10 builds per hour.</em></p>
<p>It's really easy to use and demand the security on the github account (always 2fa)<br>They offer a dns based on your github account and you can manage paths,<br>moreover you have the TLS/SSL for free</p>
<p>With Publii configuration is quite easy and you can follow the instruction <a href="https://getpublii.com/docs/host-static-website-github-pages.html">here</a> </p>
<p> </p>
<p>Another solution is use s3 as a repository, this require a bit more stuff sometimes, however even if it's a cheeper option, why not use an s3 on-prem if it's available <br>(this is just an excuse to use kubernetes, i still suggest to use the github pages, however i like to have this kind of exercise)</p>
<p>So welcome <a href="https://min.io/">minio</a> , a kubernetes object storage<br>The configuration is quite simple, as usual you can start with the namespace creation<br><code>kind: "Namespace"<br>apiVersion: "v1"<br>metadata:<br>  name: "minio"<br>  labels:<br>    name: "minio"</code></p>
<p>The service (this is just a single instance so no StatefulSets set is needed)<br><code>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: minio-svc<br>  namespace: minio<br>  labels:<br>    app: minio<br>spec:<br>  ports:<br>  - port: 9000<br>    protocol: TCP<br>  selector:<br>    app: minio</code></p>
<p>PersistentVolumeClaim (from microk8s host provisioner)<br><code>apiVersion: v1<br>kind: PersistentVolumeClaim<br>metadata:<br>  namespace: minio<br>  name: minio-pv-claim<br>  labels:<br>    app: minio-storage-claim<br>spec:<br>  storageClassName: microk8s-hostpath<br>  accessModes:<br>    - ReadWriteOnce<br>  resources:<br>    requests:<br>      storage: 1Gi</code></p>
<p>Deployment (remember to use secrets instead write directly into deployment)<br><code>kind: Deployment<br>metadata:<br>  name: minio-deployment<br>  namespace: minio<br>spec:<br>  selector:<br>    matchLabels:<br>      app: minio<br>  strategy:<br>    type: Recreate<br>  template:<br>    metadata:<br>      labels:<br>        app: minio<br>    spec:<br>      volumes:<br>      - name: storage<br>        persistentVolumeClaim:<br>          claimName: minio-pv-claim<br>      containers:<br>      - name: minio<br>        image: minio/minio:latest<br>        args:<br>        - server<br>        - /storage<br>        env:<br>        - name: MINIO_ACCESS_KEY<br>          value: "$something"<br>        - name: MINIO_SECRET_KEY<br>          value: "$somethingsecret"<br>        - name: MINIO_DOMAIN<br>          value: minio.h4x0r3d.lan<br>        ports:<br>        - containerPort: 9000<br>          hostPort: 9000<br>        volumeMounts:<br>        - name: storage<br>          mountPath: "/storage"</code></p>
<p>Ingress resource<br><code>kind: Ingress<br>metadata:<br>  name: minio-ingress<br>  namespace: minio<br>  annotations:<br>    kubernetes.io/ingress.class: nginx<br>    nginx.org/client-max-body-size: 1000m<br>    ingress.kubernetes.io/proxy-body-size: 1000m<br>spec:<br>  rules:<br>  - host: minio.h4x0r3d.lan<br>    http:<br>      paths:<br>      - path: /<br>        backend:<br>          serviceName: minio-svc<br>          servicePort: 9000</code></p>
<p>And at the end you will have something like this</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/18/Screenshot-2020-12-26-at-13.55.38.png" alt="" width="1024" height="678" sizes="100vw" srcset="https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-13.55.38-xs.webp 300w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-13.55.38-sm.webp 480w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-13.55.38-md.webp 768w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-13.55.38-lg.webp 1024w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-13.55.38-xl.webp 1360w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-13.55.38-2xl.webp 1600w"></figure>
<p>you can configure Publii in this way</p>
<p>where bucket is the third level name of you dns and prefix "the bucket"</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/18/Screenshot-2020-12-26-at-13.56.43.png" alt="" width="1024" height="811" sizes="100vw" srcset="https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-13.56.43-xs.webp 300w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-13.56.43-sm.webp 480w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-13.56.43-md.webp 768w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-13.56.43-lg.webp 1024w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-13.56.43-xl.webp 1360w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-13.56.43-2xl.webp 1600w"></figure>
<p>Btw an object storage is <strong>NOT</strong> a web server so you need an apache or nginx configuration<br>to have the site ready to be used<br><code>&lt;VirtualHost *:80&gt;<br>    ServerAdmin l@k8s.it<br>    DocumentRoot /usr/local/apache2/htdocs/<br>    ServerName www.k8s.it<br>    ErrorLog logs/www.k8s-error_log<br>    CustomLog logs/www.k8s-access_log combined<br>    LoadModule rewrite_module modules/mod_rewrite.so<br>    ProxyRequests Off<br>    ProxyPass / http://minio-svc.minio.svc.cluster.local:9000/blog/<br>    RewriteEngine on<br>    RewriteRule ^(.*)/$ /$1/index.html [PT,L]<br> &lt;/VirtualHost&gt;</code></p>
<p> </p>
<p>Again ... <strong>keep it simple</strong>... there no right solutions overall , there is the right way for you needs, in my case i'm still using github pages because are free, enough to cover my needs and <em>serverless</em></p>
<h3> </h3>
<h3>Security</h3>
<p>Even if the security is demanded to github, why not extend a sort of protection on top of it</p>
<p>Second pillar , <strong>keep it safe</strong></p>
<p>In my case i really appreciate Cloudflare and the free plan that give me the possibility to test and explore the functionality offered</p>
<p>I've already shared how to configure a website with Cloudflare with terraform <a href="https://www.k8s.it/terraform-your-free-claudflare-account.html" target="_blank" rel="noopener noreferrer">https://www.k8s.it/terraform-your-free-claudflare-account.html</a></p>
<p>Even if we are covered by attacks since it's static webpage ... and we also added the Cloudflare protection we can have some <em>cosmetics</em> feature that will share a better compliance with the security in 2020</p>
<p>As i said github pages and s3 are not webserver so ... <br>how we can introduce the security headers ?</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/18/screencapture-securityheaders-2020-12-24-20_33_23.png" alt="" width="1024" height="1758" sizes="100vw" srcset="https://www.k8s.it/media/posts/18/responsive/screencapture-securityheaders-2020-12-24-20_33_23-xs.webp 300w ,https://www.k8s.it/media/posts/18/responsive/screencapture-securityheaders-2020-12-24-20_33_23-sm.webp 480w ,https://www.k8s.it/media/posts/18/responsive/screencapture-securityheaders-2020-12-24-20_33_23-md.webp 768w ,https://www.k8s.it/media/posts/18/responsive/screencapture-securityheaders-2020-12-24-20_33_23-lg.webp 1024w ,https://www.k8s.it/media/posts/18/responsive/screencapture-securityheaders-2020-12-24-20_33_23-xl.webp 1360w ,https://www.k8s.it/media/posts/18/responsive/screencapture-securityheaders-2020-12-24-20_33_23-2xl.webp 1600w"></figure>
<p> </p>
<p>Again Cloudflare help us with the <a href="https://blog.cloudflare.com/cloudflare-workers-unleashed/" target="_blank" rel="noopener noreferrer">Workers</a> feature</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/18/screencapture-dash-cloudflare-9fb3653b948e447567a30f6b83e51eaf-workers-edit-security-headers-2020-12-24-20_38_25-2.png" alt="" width="1024" height="516" sizes="100vw" srcset="https://www.k8s.it/media/posts/18/responsive/screencapture-dash-cloudflare-9fb3653b948e447567a30f6b83e51eaf-workers-edit-security-headers-2020-12-24-20_38_25-2-xs.webp 300w ,https://www.k8s.it/media/posts/18/responsive/screencapture-dash-cloudflare-9fb3653b948e447567a30f6b83e51eaf-workers-edit-security-headers-2020-12-24-20_38_25-2-sm.webp 480w ,https://www.k8s.it/media/posts/18/responsive/screencapture-dash-cloudflare-9fb3653b948e447567a30f6b83e51eaf-workers-edit-security-headers-2020-12-24-20_38_25-2-md.webp 768w ,https://www.k8s.it/media/posts/18/responsive/screencapture-dash-cloudflare-9fb3653b948e447567a30f6b83e51eaf-workers-edit-security-headers-2020-12-24-20_38_25-2-lg.webp 1024w ,https://www.k8s.it/media/posts/18/responsive/screencapture-dash-cloudflare-9fb3653b948e447567a30f6b83e51eaf-workers-edit-security-headers-2020-12-24-20_38_25-2-xl.webp 1360w ,https://www.k8s.it/media/posts/18/responsive/screencapture-dash-cloudflare-9fb3653b948e447567a30f6b83e51eaf-workers-edit-security-headers-2020-12-24-20_38_25-2-2xl.webp 1600w"></figure>
<p>The code (<a href="https://scotthelme.co.uk/security-headers-cloudflare-worker/" target="_blank" rel="noopener noreferrer">rif</a>.) is adding those headers with serverless function  for each request</p>
<p><code>const securityHeaders = {<br>        "Content-Security-Policy": "upgrade-insecure-requests",<br>        "Strict-Transport-Security": "max-age=3600",<br>        "X-Xss-Protection": "1; mode=block",<br>        "X-Frame-Options": "DENY",<br>        "X-Content-Type-Options": "nosniff",<br>        "Permissions-Policy": "geolocation=()",<br>        "Referrer-Policy": "strict-origin-when-cross-origin"<br>    };<br><br><br>async function addHeaders(req) {<br>    const response = await fetch(req),<br>        newHeaders = new Headers(response.headers),<br>        setHeaders = Object.assign({}, securityHeaders);<br><br>    if (newHeaders.has("Content-Type") &amp;&amp; !newHeaders.get("Content-Type").includes("text/html")) {<br>        return new Response(response.body, {<br>            status: response.status,<br>            statusText: response.statusText,<br>            headers: newHeaders<br>        });<br>    }<br><br>    Object.keys(setHeaders).forEach(name =&gt; newHeaders.set(name, setHeaders[name]));<br><br><br>    return new Response(response.body, {<br>        status: response.status,<br>        statusText: response.statusText,<br>        headers: newHeaders<br>    });<br>}<br><br>addEventListener("fetch", event =&gt; event.respondWith(addHeaders(event.request)));</code></p>
<p> </p>
<p>Now the website is better from this point of view, adding the worker to the main route</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/18/Screenshot-2020-12-27-at-13.41.47.png" alt="" width="1024" height="476" sizes="100vw" srcset="https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-27-at-13.41.47-xs.webp 300w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-27-at-13.41.47-sm.webp 480w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-27-at-13.41.47-md.webp 768w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-27-at-13.41.47-lg.webp 1024w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-27-at-13.41.47-xl.webp 1360w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-27-at-13.41.47-2xl.webp 1600w"></figure>
<p>Results</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/18/screencapture-securityheaders-2020-12-24-20_34_27.png" alt="" width="1024" height="1959" sizes="100vw" srcset="https://www.k8s.it/media/posts/18/responsive/screencapture-securityheaders-2020-12-24-20_34_27-xs.webp 300w ,https://www.k8s.it/media/posts/18/responsive/screencapture-securityheaders-2020-12-24-20_34_27-sm.webp 480w ,https://www.k8s.it/media/posts/18/responsive/screencapture-securityheaders-2020-12-24-20_34_27-md.webp 768w ,https://www.k8s.it/media/posts/18/responsive/screencapture-securityheaders-2020-12-24-20_34_27-lg.webp 1024w ,https://www.k8s.it/media/posts/18/responsive/screencapture-securityheaders-2020-12-24-20_34_27-xl.webp 1360w ,https://www.k8s.it/media/posts/18/responsive/screencapture-securityheaders-2020-12-24-20_34_27-2xl.webp 1600w"></figure>
<p>Just a warning because Strict-Transport-Security has a low value , but it's something acceptable to me</p>
<p>Cloudflare details the usage of workers that is limited in the free account for 100k req/day and 1k/min</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/18/screencapture-dash-cloudflare-9fb3653b948e447567a30f6b83e51eaf-workers-view-security-headers-2020-12-27-13_42_52.png" alt="" width="1024" height="1954" sizes="100vw" srcset="https://www.k8s.it/media/posts/18/responsive/screencapture-dash-cloudflare-9fb3653b948e447567a30f6b83e51eaf-workers-view-security-headers-2020-12-27-13_42_52-xs.webp 300w ,https://www.k8s.it/media/posts/18/responsive/screencapture-dash-cloudflare-9fb3653b948e447567a30f6b83e51eaf-workers-view-security-headers-2020-12-27-13_42_52-sm.webp 480w ,https://www.k8s.it/media/posts/18/responsive/screencapture-dash-cloudflare-9fb3653b948e447567a30f6b83e51eaf-workers-view-security-headers-2020-12-27-13_42_52-md.webp 768w ,https://www.k8s.it/media/posts/18/responsive/screencapture-dash-cloudflare-9fb3653b948e447567a30f6b83e51eaf-workers-view-security-headers-2020-12-27-13_42_52-lg.webp 1024w ,https://www.k8s.it/media/posts/18/responsive/screencapture-dash-cloudflare-9fb3653b948e447567a30f6b83e51eaf-workers-view-security-headers-2020-12-27-13_42_52-xl.webp 1360w ,https://www.k8s.it/media/posts/18/responsive/screencapture-dash-cloudflare-9fb3653b948e447567a30f6b83e51eaf-workers-view-security-headers-2020-12-27-13_42_52-2xl.webp 1600w"></figure>
<p>OKR </p>
<ul>
<li>website is managed with no database</li>
<li>we have serverless way to host it and with free options</li>
<li>overall protection from Cloudflare</li>
<li>security headers from Cloudflare workers, again another serveless option</li>
</ul>
<p> </p>
<p><code></code><code></code><code></code></p>
<div>
<div><code></code><code></code></div>
</div>
<h3>Monitor</h3>
<p>What is missing now ?</p>
<p>A bit of <strong>awareness</strong></p>
<p>Are we safe ? maybe but better an external opinion , around the online scanner there are multiple tools , however <a href="https://probely.com/" target="_blank" rel="noopener noreferrer">Probely</a> has a good free plan</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/18/Screenshot-2020-12-26-at-14.58.41.png" alt="" width="1024" height="434" sizes="100vw" srcset="https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-14.58.41-xs.webp 300w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-14.58.41-sm.webp 480w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-14.58.41-md.webp 768w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-14.58.41-lg.webp 1024w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-14.58.41-xl.webp 1360w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-14.58.41-2xl.webp 1600w"></figure>
<p>Here some hints about sensitive data shared with their crowler</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/18/Screenshot-2020-12-26-at-15.00.00.png" alt="" width="1024" height="512" sizes="100vw" srcset="https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.00.00-xs.webp 300w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.00.00-sm.webp 480w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.00.00-md.webp 768w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.00.00-lg.webp 1024w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.00.00-xl.webp 1360w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.00.00-2xl.webp 1600w"></figure>
<p>Nothing relevant in my case... but useful to know</p>
<p> </p>
<p>Is now time to know , how is performing the website to do this i already had a deepdive about website usability</p>
<p><a href="https://www.k8s.it/kubernetes-sitespeedio.html" target="_blank" rel="noopener noreferrer">https://www.k8s.it/kubernetes-sitespeedio.html</a></p>
<p>but again we have some other feature serverless style like <a href="https://github.com/upptime/upptime" target="_blank" rel="noopener noreferrer">upptime</a> ,with github actions you can create a monitoring system like this <a href="https://lorenzogirardi.github.io/status/" target="_blank" rel="noopener noreferrer">https://lorenzogirardi.github.io/status/</a></p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/18/Screenshot-2020-12-26-at-15.04.18.png" alt="" width="1024" height="774" sizes="100vw" srcset="https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.04.18-xs.webp 300w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.04.18-sm.webp 480w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.04.18-md.webp 768w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.04.18-lg.webp 1024w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.04.18-xl.webp 1360w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.04.18-2xl.webp 1600w"></figure>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/18/Screenshot-2020-12-27-at-13.36.35.png" alt="" width="1024" height="859" sizes="100vw" srcset="https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-27-at-13.36.35-xs.webp 300w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-27-at-13.36.35-sm.webp 480w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-27-at-13.36.35-md.webp 768w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-27-at-13.36.35-lg.webp 1024w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-27-at-13.36.35-xl.webp 1360w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-27-at-13.36.35-2xl.webp 1600w"></figure>
<p>Another alternative is <a href="https://hetrixtools.com/" target="_blank" rel="noopener noreferrer">hetrixtools</a> , free up top 15 probes that give you the possibility to monitor your websites and smtp, and have an alerting system out of the box with a telegram bot email and sms (up to 50)</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/18/screencapture-hetrixtools-report-uptime-c7596615176a822f81d67cfddc4aa179-2020-12-26-15_14_22.png" alt="" width="1024" height="1620" sizes="100vw" srcset="https://www.k8s.it/media/posts/18/responsive/screencapture-hetrixtools-report-uptime-c7596615176a822f81d67cfddc4aa179-2020-12-26-15_14_22-xs.webp 300w ,https://www.k8s.it/media/posts/18/responsive/screencapture-hetrixtools-report-uptime-c7596615176a822f81d67cfddc4aa179-2020-12-26-15_14_22-sm.webp 480w ,https://www.k8s.it/media/posts/18/responsive/screencapture-hetrixtools-report-uptime-c7596615176a822f81d67cfddc4aa179-2020-12-26-15_14_22-md.webp 768w ,https://www.k8s.it/media/posts/18/responsive/screencapture-hetrixtools-report-uptime-c7596615176a822f81d67cfddc4aa179-2020-12-26-15_14_22-lg.webp 1024w ,https://www.k8s.it/media/posts/18/responsive/screencapture-hetrixtools-report-uptime-c7596615176a822f81d67cfddc4aa179-2020-12-26-15_14_22-xl.webp 1360w ,https://www.k8s.it/media/posts/18/responsive/screencapture-hetrixtools-report-uptime-c7596615176a822f81d67cfddc4aa179-2020-12-26-15_14_22-2xl.webp 1600w"></figure>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://www.k8s.it/media/posts/18/Screenshot-2020-12-26-at-15.07.32.png" alt="" width="974" height="380" sizes="100vw" srcset="https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.07.32-xs.webp 300w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.07.32-sm.webp 480w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.07.32-md.webp 768w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.07.32-lg.webp 1024w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.07.32-xl.webp 1360w ,https://www.k8s.it/media/posts/18/responsive/Screenshot-2020-12-26-at-15.07.32-2xl.webp 1600w"></figure>
<p> </p>
<p> </p>
<p>Hope this post cover how the technology could be used as much as possible in a small and cheap scenario to reflect some hints to an enterprise scenario.</p>
<p> </p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Kubernetes has destroyed the virtualization... or NOT</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/kubernetes-destroyed-the-virtualization-or-not.html"/>
        <id>https://www.k8s.it/kubernetes-destroyed-the-virtualization-or-not.html</id>
            <category term="virtualization"/>
            <category term="virtual machines"/>
            <category term="scalability"/>
            <category term="pod"/>
            <category term="kubernetes"/>
            <category term="datacenter"/>
            <category term="cloud"/>

        <updated>2020-12-28T10:02:18+01:00</updated>
            <summary>
                <![CDATA[
                    Well ... NO! Ok maybe are missing some context I started this topic looking around the data center world compared with the cloud providers, the advantage of manage services , the mindset infrastructure as a code and so on ... In the last 4y we saw&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                <p>Well ... <strong>NO!</strong></p>
<p>Ok maybe are missing some context</p>
<p> </p>
<p>I started this topic looking around the data center world compared with the cloud providers,<br>the advantage of manage services , the mindset infrastructure as a code and so on ...</p>
<p>In the last 4y we saw a kubernetes rush , a lot of company are sharing the advantages and the perfect picture create into kubernetes, how they save money or scale fast ... but is always true what we see?<br>Most of the times we are saw only builded success case.</p>
<p>Today we will take in consideration those topics :</p>
<ul>
<li>Virtual machines</li>
<li>Data center</li>
<li>Kubernetes</li>
</ul>
<p>I know that the Data center topic should be covered more in deep, maybe talking about the entire ecosystem (db, vertical services , corporate usage , LEGACY!!!!) however today i'd like to explore only the kubernetes and virtualization rather than lose the discussion in thousand of concepts.</p>
<h3>Long story short</h3>
<p>A long time ago Borg was born in Google .. now formally named kubernetes,<br>in the first period the main evaluation was:<br>"<em>why the virtualization overhead if we will use kubernetes</em>".<br><br>This concept was justified in some way for <em>overlapping</em> of duties,<br>if i migrate a vm as a kubernetes pod this means i can remove the vm <br><br></p>
<figure class="post__image post__image--center">                      <img loading="lazy"  src="https://res.cloudinary.com/ethzero/image/upload/v1607974463/misc/vm_vs_pod.png" alt="" width="337" height="181" data-is-external-image="true"></figure>
<p> </p>
<p> </p>
<p>We can imagine a picture like this looking back of some years ago</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://res.cloudinary.com/ethzero/image/upload/v1607963386/misc/vm_1.png" alt="" width="745" height="386" data-is-external-image="true"></figure>
<figure class="post__image">The introduction was good , almost all declared this could be a new way.<br>Moving faster, all companies changed a bit this picture with an expansion of kubernetes </figure>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://res.cloudinary.com/ethzero/image/upload/v1607963386/misc/vm_2.png" alt="" width="745" height="386" data-is-external-image="true"></figure><figure class="is-loaded"><img loading="lazy"  src="Kubernetes destroyed the virtualization... or NOT - LAB_files/vm_2.png" alt="" width="745" height="386" data-is-external-image="true" data-is-external-image="true"></figure>
<p>Like an infection (good this time, not the 20covid ones) kubernetes come as a main platform for most of the online company...<br>In a datacenter , you know, there no something eternal:</p>
<ul>
<li>hardware in EOL</li>
<li>generation refresh</li>
<li>brand change</li>
<li>good is ok but cheaper is better (usually from finance)</li>
</ul>
<p>Is also true , that sometimes this encouraged a forced/incorrect usage of kubernetes node labeling in order to bend the infrastructure to better fit the products migrated or the existing hardware availability</p>
<figure class="post__image post__image--center"><img loading="lazy"  src="https://res.cloudinary.com/ethzero/image/upload/v1607959262/misc/vm_3.png" alt="" width="748" height="389" data-is-external-image="true"></figure>
<figure class="post__image"><figure class="is-loaded"><img loading="lazy"  src="Kubernetes destroyed the virtualization... or NOT - LAB_files/vm_3.png" alt="" data-is-external-image="true" data-is-external-image="true"></figure></figure>
<h3>Houston we have a problem...</h3>
<p>Working in this way, the environment could be fragmented ,<br>even if the technology is the same there are some logical segmentations that create some problems in the day by day activities.</p>
<ul>
<li>isolate some workloads with labels can create an hw lock-in (better approach a multi-cluster with unique controlplane)</li>
<li>updates require to be managed in a different way looking for the label/role</li>
<li>please do not touch the storage nodes now (fiber channel with external storage)</li>
<li>please do not touch the storage nodes tomorrow (fiber channel with external storage)</li>
<li>omg we lost a storage nodes (fiber channel with external storage)</li>
<li>and so on ...</li>
</ul>
<p>Moreover an hardware fault could create problems .... <br>YES i know in a infrastructure as a code , with puppet foreman chef salt ansible terraform etc, this will be recovered fast ... but this is not always true ... you know... some machines/roles in a mid/ent company are still fragile.</p>
<ul>
<li>legacy with no ownership</li>
<li>legacy with wrong ownership</li>
<li>single point of failure ... (yes also in 2020)</li>
</ul>
<p> </p>
<p>Other problems are related with new hardware...</p>
<ul>
<li>is the provisioning working as expected with new generations ?</li>
<li>and if we change the hardware vendor ?</li>
<li>etc etc when you have to handle new preseed/ks because the layout is changed ☠️</li>
</ul>
<p> </p>
<p>Last but not least ... what about the bare metal density ?</p>
<p><code>Allocated resources:</code><br><code> (<span class="il">Total</span> <span class="il">limits</span> <span class="il">may</span> be <span class="il">over</span> <span class="il">100</span> <span class="il">percent</span>, i.e., <span class="il">overcommitted</span>.</code><br><code> CPU Requests CPU <span class="il">Limits</span> Memory Requests Memory <span class="il">Limits</span></code><br><code> ------------ ---------- --------------- -------------</code><br><code> 55 (98%) 101300m (180%) 86376Mi (44%) 121672Mi (62%)</code></p>
<p>This HW has 56 core with HT , we reached the 98% but this number is high <br>because some pods needs a default cpu just to fit the nodes and start, while the running cost is really low. </p>
<p> </p>
<h3>So why not kubernetes hosted in virtual machines ?</h3>
<ul>
<li>Having an abstraction layer, is quite simple tune the provisioning based on this , rather than the bare metal, it's just a metter of roles not to the entire provisioning.</li>
<li>Hardware fault could be easily covered by live migration</li>
<li>Maintenance and update can be manage creating a blue green approach and rolling updates</li>
<li>Density could be increased with mode nodes in the same hw</li>
<li>Flexibility to scale up and to upset a new datacenter in case of migration will be higher</li>
<li>Team at the and is also able to scale , working from the vmware and not from bare metal</li>
</ul>
<figure class="post__image post__image--center"><figure class="post__image"><img loading="lazy"  src="https://res.cloudinary.com/ethzero/image/upload/v1607961166/misc/team_scale.png" alt="" width="718" height="353" data-is-external-image="true"></figure></figure>
<h3> </h3>
<h3>Conclusions</h3>
<p>Virtualization and kubernetes are not antagonist, must be in addition , the first one has just change the scope to better cooperate with kubernetes</p>
<p>Instead a layer for microservices , virtualization is now the layer that guarantee an homogeneous platform were a team can work on top to create the infrastructure having the advantage of a fully consolidated technology that is able to promote the right abstraction </p>
<p>Last but not least , we don't need to reinvent something , we can just copy from the major competitors for the kubernetes topic<br>How is working GKE , AKS , EKS ? .... virtual machines :)</p>
            ]]>
        </content>
    </entry>
</feed>
