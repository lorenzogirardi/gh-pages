<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>LAB</title>
    <link href="https://www.k8s.it/feed.xml" rel="self" />
    <link href="https://www.k8s.it" />
    <updated>2018-07-06T22:53:32+02:00</updated>
    <author>
        <name>lgirardi</name>
    </author>
    <id>https://www.k8s.it</id>

    <entry>
        <title>Terraform your free Claudflare account</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/terraform-your-free-claudflare-account.html"/>
        <id>https://www.k8s.it/terraform-your-free-claudflare-account.html</id>
            <category term="waf"/>
            <category term="terraform"/>
            <category term="gitlab"/>
            <category term="cloudflare"/>
            <category term="cdn"/>
            <category term="automation"/>

        <updated>2018-07-06T22:53:20+02:00</updated>
            <summary></summary>
        <content type="html">
            <![CDATA[
                    <img src="https://www.k8s.it/media/posts/5/" alt="" />
                <p>So...</p>
<p>after some experience with akamai </p>
<p><code><em>www.ethzero.it is an alias for aku-cs-akamaiflowers.com.edgesuite.net.</em></code><br><code><em>aku-cs-akamaiflowers.com.edgesuite.net is an alias for a169.dscksd.akamai.net.</em></code><br><code><em>a169.dscksd.akamai.net has address 193.45.15.98</em></code><br><code><em>a169.dscksd.akamai.net has address 193.45.15.122</em></code><br><code><em>a169.dscksd.akamai.net has IPv6 address 2001:2030:0:27::c12d:f62</em></code><br><code><em>a169.dscksd.akamai.net has IPv6 address 2001:2030:0:27::c12d:f7a</em></code></p>
<p>and some others with Incapsula</p>
<p><code><em>bunker.ethzero.it is an alias for ve7cu.x.incapdns.net.</em></code><br><code><em>ve7cu.x.incapdns.net has address 107.154.167.38</em></code></p>
<p>It's now the moment to talk about Cloudflare</p>
<p> </p>
<p> </p>
<p><a href="#INTERNAL_LINK#/post/null" title="https://www.cloudflare.com/">Claudflare</a> provide a good free account that allow you to hide your source ip or you want to discover how it's work the free waf protection or have a https certificate having your origin in http and so on ... but what is really cool and quickwin than the competitors is the API support and the native integration with <a href="#INTERNAL_LINK#/post/null" title="https://www.terraform.io/docs/providers/cloudflare/index.html">Terraform</a></p>
<p>Terraform is the most integrated tool for cloud (not only) automation and infrastructure as a code </p>
<p>Here some steps that can show how it's esay deploy a configuration</p>
<p>First of all , retrive the api key from Cloudflare portal</p>
<p><img src="https://www.k8s.it/media/posts/5/cloudflare-api-key.png" alt="" width="1922" height="556"></p>
<p><img src="https://www.k8s.it/media/posts/5/cloudflare-global-apikey.png" alt="" width="1910" height="396"> </p>
<p>then start the main terraform file in a dedicated folder (better in a <a href="#INTERNAL_LINK#/post/null" title="https://gitlab.com/">gitlab</a> repo)</p>
<p><code>$ cat cloudflare-auth.tf</code><br><code>provider "cloudflare" {</code><br><code> email = "cloudflare_registration_email"</code><br><code> token = "cloudflare_token_api_key"</code><br><code>}</code></p>
<p>make a $<code>terraform init</code> and now you can start to configure your account</p>
<p>manage your domain(s) $ <code>cat cloudflare_domains.tf</code><br><code>variable "domain" {</code><br><code> default = "k8s.it"</code><br><code>} </code></p>
<p>create dns configuration $ <code>cat cloudflare_dns.tf</code><br><code>resource "cloudflare_record" "www" {</code><br><code> domain = "${var.domain}"</code><br><code> name = "www"</code><br><code> value = "something.github.io"</code><br><code> type = "CNAME"</code><br><code> proxied = true</code><br><code>}</code><br><br><code>resource "cloudflare_record" "smtp" {</code><br><code> domain = "${var.domain}"</code><br><code> name = "smtp"</code><br><code> value = "IP.OF.PRIVATE.VPS"</code><br><code> type = "A"</code><br><code> proxied = false</code><br><code>}</code><br><br><code>resource "cloudflare_record" "services" {</code><br><code> domain = "${var.domain}"</code><br><code> name = "services"</code><br><code> value = "something.related.to.my.home"</code><br><code> type = "CNAME"</code><br><code> proxied = true</code><br><code>}</code><br><br><code>resource "cloudflare_record" "mx" {</code><br><code> domain = "${var.domain}"</code><br><code> name = "${var.domain}"</code><br><code> value = "smtp.k8s.it"</code><br><code> type = "MX"</code><br><code> priority = "1"</code><br><code>}</code><br><br><code>resource "cloudflare_record" "google-verification" {</code><br><code> domain = "${var.domain}"</code><br><code> name = "${var.domain}"</code><br><code> value = "google-site-verification=fdsfdssgfdg4teurtxh"</code><br><code> type = "TXT"</code><br><code>}</code><br><br><code>resource "cloudflare_record" "spf" {</code><br><code> domain = "${var.domain}"</code><br><code> name = "${var.domain}"</code><br><code> value = "v=spf1 ip4:IP.OF.PRIVATE.VPS mx ~all"</code><br><code> type = "TXT"</code><br><code>}</code></p>
<p>Force the HTTPS with page rules $ <code>cat cloudflare_rules.tf</code><br><code>resource "cloudflare_page_rule" "always_use_https_www" {</code><br><code> zone = "${var.domain}"</code><br><code> target = "http://www.${var.domain}/*"</code><br><code> priority = 1</code><br><br><code> actions = {</code><br><code> always_use_https = "true",</code><br><code> }</code><br><code>}</code><br><br><code>resource "cloudflare_page_rule" "always_use_https_services" {</code><br><code> zone = "${var.domain}"</code><br><code> target = "http://services.${var.domain}/*"</code><br><code> priority = 2</code><br><br><code> actions = {</code><br><code> always_use_https = "true",</code><br><code> }</code><br><code>}</code></p>
<p>And finally create the common zone settings  $ <code>cat cloudflare_zone.tf</code><br><code>resource "cloudflare_zone_settings_override" "k8s-settings" {</code><br><code> name = "${var.domain}"</code><br><br><code> settings {</code><br><code> tls_1_3 = "on"</code><br><code> ssl = "flexible"</code><br><code> opportunistic_encryption = "on"</code><br><code> brotli = "on"</code><br><code> automatic_https_rewrites = "on"</code><br><code> security_level = "medium"</code><br><code> minify {</code><br><code> css = "on"</code><br><code> js = "on"</code><br><code> html = "on"</code><br><code> }</code><br><code> browser_cache_ttl = "14400"</code><br><code> }</code><br><code>}</code></p>
<p>use the terraform plan to check if everything it's of and terrafom plan to apply the changes $ <code>terraform apply</code><br><code>cloudflare_record.mx: Refreshing state... (ID: c3624cc8fd163199ec082649a55f337a)</code><br><code>cloudflare_record.services: Refreshing state... (ID: 09041dfd16cbbf3b6915e79b14dc5466)</code><br><code>cloudflare_page_rule.always_use_https_services: Refreshing state... (ID: 92e196e6c7c8cba1f0759a60d713b0b9)</code><br><code>cloudflare_record.spf: Refreshing state... (ID: 3743b9f0be0a2c7a69245e169cf06ea5)</code><br><code>cloudflare_zone_settings_override.k8s-settings: Refreshing state... (ID: d4acc5e5713a0dede4f238b829f98947)</code><br><code>cloudflare_record.smtp: Refreshing state... (ID: 2d4628fc07c491d97e34b07da9ec60db)</code><br><code>cloudflare_page_rule.always_use_https_www: Refreshing state... (ID: 59c25cdd1096177a1019f834178de62f)</code><br><code>cloudflare_record.google-verification: Refreshing state... (ID: 131f35a9f8d2304a786a780db38b37e0)</code><br><code>cloudflare_record.www: Refreshing state... (ID: 76e3906f5ea172b627bed4922ebc1da7)</code><br><br><code>Apply complete! Resources: 0 added, 0 changed, 0 destroyed.</code></p>
<p> </p>
<p>$ <code>host www.k8s.it</code><br><code>www.k8s.it has address 104.27.164.146</code><br><code>www.k8s.it has address 104.27.165.146</code><br><code>www.k8s.it has IPv6 address 2400:cb00:2048:1::681b:a492</code><br><code>www.k8s.it has IPv6 address 2400:cb00:2048:1::681b:a592</code></p>
<p>$ <code>echo | openssl s_client -servername www.k8s.it -connect www.k8s.it:443</code><br><code>CONNECTED(00000003)</code><br><code>depth=2 C = GB, ST = Greater Manchester, L = Salford, O = COMODO CA Limited, CN = COMODO ECC Certification Authority</code><br><code>---</code><br><code>Certificate chain</code><br><code> 0 s:/OU=Domain Control Validated/OU=PositiveSSL Multi-Domain/CN=sni154797.cloudflaressl.com</code><br><code> i:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO ECC Domain Validation Secure Server CA 2</code><br><code> 1 s:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO ECC Domain Validation Secure Server CA 2</code><br><code> i:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO ECC Certification Authority</code><br><code> 2 s:/C=GB/ST=Greater Manchester/L=Salford/O=COMODO CA Limited/CN=COMODO ECC Certification Authority</code><br><code> i:/C=SE/O=AddTrust AB/OU=AddTrust External TTP Network/CN=AddTrust External CA Root</code></p>
            ]]>
        </content>
    </entry>
    <entry>
        <title>Kubernetes for mere mortals</title>
        <author>
            <name>lgirardi</name>
        </author>
        <link href="https://www.k8s.it/kubernetes-for-mere-mortals.html"/>
        <id>https://www.k8s.it/kubernetes-for-mere-mortals.html</id>
            <category term="traefik"/>
            <category term="orangepi"/>
            <category term="lab"/>
            <category term="kubernetes"/>
            <category term="k8s"/>
            <category term="armbian"/>
            <category term="arm"/>

        <updated>2018-04-10T23:52:47+02:00</updated>
            <summary></summary>
        <content type="html">
            <![CDATA[
                <p>Well, what do you need to build your homemade cluster?</p>
<p><img src="https://www.k8s.it/media/posts/3/k8s.arm-lg.jpeg" alt="" width="744" height="400"></p>
<p><img src="https://www.k8s.it/media/posts/3/IMG_20170605_150237.jpg" alt="" width="832" height="624"></p>
<ul>
<li>1x usb hub Anker 60W PowerPort 6</li>
<li>4x orangepi plus 2e</li>
</ul>
<p> armbian 4.10.1 </p>
<p>kubeadm and kubelet 1.6.4</p>
<p>traefik as a ingress controller</p>
<p>heapster, collectd, influxdb and grafana as a monitoring stack</p>
<div class="slate-resizable-image-embed slate-image-embed__resize-full-width"><img src="https://media.licdn.com/dms/image/C5612AQFJsWW1J0HYig/article-inline_image-shrink_1500_2232/0?e=2122596000&amp;v=beta&amp;t=O4agFAs9-5g0xGt6frAU-koLZROOeVmv2p7yhmZyEAY" data-media-urn="urn:li:digitalmediaAsset:C5612AQFJsWW1J0HYig" data-li-src="https://media.licdn.com/dms/image/C5612AQFJsWW1J0HYig/article-inline_image-shrink_1500_2232/0?e=2122596000&amp;v=beta&amp;t=O4agFAs9-5g0xGt6frAU-koLZROOeVmv2p7yhmZyEAY"></div>
<p> </p>
<div class="slate-resizable-image-embed slate-image-embed__resize-full-width"><img src="https://media.licdn.com/dms/image/C4E12AQFGmg6f2D2CcQ/article-inline_image-shrink_1000_1488/0?e=2122596000&amp;v=beta&amp;t=H2Sp0_RJzeKQLmbD7JiF6jW-bqdvqkgRzPTmXqhogpI" data-media-urn="urn:li:digitalmediaAsset:C4E12AQFGmg6f2D2CcQ" data-li-src="https://media.licdn.com/dms/image/C4E12AQFGmg6f2D2CcQ/article-inline_image-shrink_1000_1488/0?e=2122596000&amp;v=beta&amp;t=H2Sp0_RJzeKQLmbD7JiF6jW-bqdvqkgRzPTmXqhogpI"></div>
<pre spellcheck="false">NAMESPACE     NAME                                        READY     STATUS    RESTARTS   AGE
home-prd      k8s-helloworld<span class="hljs-number">-3468567185-2f</span>whb             <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">0</span>          <span class="hljs-number">10d</span>
home-prd      k8s-helloworld<span class="hljs-number">-3468567185</span>-lbgpk             <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">2</span>          <span class="hljs-number">73d</span>
home-prd      k8s-helloworld<span class="hljs-number">-3468567185</span>-vz9n5             <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">2</span>          <span class="hljs-number">73d</span>
kube-system   etcd-k8s-node001                            <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">19</span>         <span class="hljs-number">81d</span>
kube-system   heapster<span class="hljs-number">-3703175019-7f</span>z27                   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">2</span>          <span class="hljs-number">76d</span>
kube-system   kube-apiserver-k8s-node001                  <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">8</span>          <span class="hljs-number">81d</span>
kube-system   kube-controller-manager-k8s-node001         <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">22</span>         <span class="hljs-number">81d</span>
kube-system   kube-dns<span class="hljs-number">-279829092</span>-r8595                    <span class="hljs-number">3</span>/<span class="hljs-number">3</span>       Running   <span class="hljs-number">39</span>         <span class="hljs-number">81d</span>
kube-system   kube-flannel-ds<span class="hljs-number">-08</span>z1k                       <span class="hljs-number">2</span>/<span class="hljs-number">2</span>       Running   <span class="hljs-number">44</span>         <span class="hljs-number">81d</span>
kube-system   kube-flannel-ds<span class="hljs-number">-3</span>bqmf                       <span class="hljs-number">2</span>/<span class="hljs-number">2</span>       Running   <span class="hljs-number">0</span>          <span class="hljs-number">10d</span>
kube-system   kube-flannel-ds-f51rq                       <span class="hljs-number">2</span>/<span class="hljs-number">2</span>       Running   <span class="hljs-number">10</span>         <span class="hljs-number">81d</span>
kube-system   kube-flannel-ds-l5wjs                       <span class="hljs-number">2</span>/<span class="hljs-number">2</span>       Running   <span class="hljs-number">8</span>          <span class="hljs-number">81d</span>
kube-system   kube-proxy<span class="hljs-number">-3</span>gn3x                            <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">12</span>         <span class="hljs-number">81d</span>
kube-system   kube-proxy<span class="hljs-number">-88762</span>                            <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">2</span>          <span class="hljs-number">81d</span>
kube-system   kube-proxy-dghmh                            <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">0</span>          <span class="hljs-number">10d</span>
kube-system   kube-proxy-dtf9c                            <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">3</span>          <span class="hljs-number">81d</span>
kube-system   kube-scheduler-k8s-node001                  <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">29</span>         <span class="hljs-number">81d</span>
kube-system   kubernetes-dashboard<span class="hljs-number">-1707270776</span>-jgxbp       <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">2</span>          <span class="hljs-number">81d</span>
kube-system   traefik-ingress-controller<span class="hljs-number">-49053153</span>-kgb3p   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>       Running   <span class="hljs-number">1</span>          <span class="hljs-number">30d</span>
</pre>
<p> </p>
<p>backend docker example (nginx on arm) k8s-helloworld-arm</p>
<p><a href="https://services.k8s.it/hello/" target="_blank" rel="nofollow noopener noreferrer">live demo</a></p>
<p><a href="https://services.k8s.it/grafana/dashboard/db/all-k8s-nodes?refresh=1m&amp;orgId=2&amp;from=now-24h&amp;to=now" target="_blank" rel="nofollow noopener noreferrer">monitoring</a></p>
            ]]>
        </content>
    </entry>
</feed>
