<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Websocket, Cloudflare tunnel, apache httpd and a bit of security - LAB</title><meta name="description" content="Here we are In today's interconnected world, exposing your home lab or self-hosted services to the internet can be both necessary and risky. Traditional methods like port forwarding or VPNs come with their own set of challenges and security concerns. This is where Cloudflare Tunnel&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://www.k8s.it/websocket-cloudflare-tunnel-apache-and-irritation.html"><link rel="alternate" type="application/atom+xml" href="https://www.k8s.it/feed.xml" title="LAB - RSS"><link rel="alternate" type="application/json" href="https://www.k8s.it/feed.json" title="LAB - JSON"><meta property="og:title" content="Websocket, Cloudflare tunnel, apache httpd and a bit of security - LAB "><meta property="og:site_name" content="LAB"><meta property="og:description" content="Here we are In today's interconnected world, exposing your home lab or self-hosted services to the internet can be both necessary and risky. Traditional methods like port forwarding or VPNs come with their own set of challenges and security concerns. This is where Cloudflare Tunnel&hellip;"><meta property="og:url" content="https://www.k8s.it/websocket-cloudflare-tunnel-apache-and-irritation.html"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://www.k8s.it/media/website/eth0.ico" type="image/x-icon"><link rel="stylesheet" href="https://www.k8s.it/assets/css/style.css?v=2e68e69045021c18195a04b11567bdb4"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.k8s.it/websocket-cloudflare-tunnel-apache-and-irritation.html"},"headline":"Websocket, Cloudflare tunnel, apache httpd and a bit of security","datePublished":"2023-08-03T21:56+02:00","dateModified":"2025-04-24T19:21+02:00","description":"Here we are In today's interconnected world, exposing your home lab or self-hosted services to the internet can be both necessary and risky. Traditional methods like port forwarding or VPNs come with their own set of challenges and security concerns. This is where Cloudflare Tunnel&hellip;","author":{"@type":"Person","name":"lgirardi","url":"https://www.k8s.it/authors/lgirardi/"},"publisher":{"@type":"Organization","name":"lgirardi"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=UA-179496482-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-179496482-1');</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-5Q67F19PK4"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5Q67F19PK4');</script><script async defer="defer" src="https://analytics.umami.is/script.js" data-website-id="94a85eb9-27c5-4917-944e-f18dbec7cc27"></script></head><body class="post-template"><header class="top js-header"><a class="logo" href="https://www.k8s.it/">LAB</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://www.linkedin.com/in/lgirardi/">linkedin</a></li><li><a href="https://services.k8s.it/grafana/?orgId&#x3D;2">live monitoring</a></li><li><a href="https://www.k8s.it/whoami.html">whoami</a></li><li><a href="https://www.k8s.it/hobbies.html" target="_self">hobbies</a></li></ul></nav><div class="search"><div class="search__overlay js-search-overlay"><div class="wrapper search__overlay-inner"><form action="https://www.k8s.it/search.html" class="search__form"><input class="search__input" type="search" name="q" placeholder="search..." aria-label="search..."></form></div></div><button class="search__btn btn--icon js-search-btn" aria-label="Search"><svg height="18" width="18" role="presentation" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#search"/></svg></button></div></header><main class="post"><article class="content"><div class="hero hero--noimage"><header class="hero__content hero__content--centered"><div class="wrapper"><h1>Websocket, Cloudflare tunnel, apache httpd and a bit of security</h1><div class="feed__meta content__meta content__meta--centered"><time datetime="2023-08-03T21:56" class="feed__date">3 Aug 2023</time></div></div></header></div><div class="entry-wrapper content__entry"><div class="post__toc"><h3>Table of Contents</h3><ul><li><a href="#mcetoc_1ipkcf23cd9">The Infrastructure Overview</a></li><li><a href="#mcetoc_1h6ufv7hs6">Starting point </a></li><li><a href="#mcetoc_1ipkcjle2e7">Why Cloudflare Tunnel?</a></li><li><a href="#mcetoc_1ipkcks8uea">Setting Up Cloudflared in Kubernetes</a><ul><li><a href="#mcetoc_1ipkcf23cdc">Configuration</a></li><li><a href="#mcetoc_1ipkcf23cdd">Deployment</a></li></ul></li><li><a href="#mcetoc_1ipkcllt0ec">How the Traffic Flows: Sequence Diagram</a></li><li><a href="#mcetoc_1ipkcjle2e8">Security Considerations</a><ul><li><a href="#mcetoc_1ipkcf23cdh">1. Cloudflare WAF Protection</a></li><li><a href="#mcetoc_1ipkcf23cdi">2. Zero Trust Network Architecture</a></li><li><a href="#mcetoc_1ipkcf23cdj">3. Defense in Depth</a></li><li><a href="#mcetoc_1ipkcf23cdk">4. Credential Management</a></li><li><a href="#mcetoc_1ipkcf23cdl">5. HTTPS Everywhere</a></li></ul></li><li><a href="#mcetoc_1ipkd2pj3k4">Monitoring and Observability</a></li><li><a href="#mcetoc_1ipkd2pj3k5">Advanced Configurations</a><ul><li><a href="#mcetoc_1ipkd2pj3k6">Load Balancing</a></li><li><a href="#mcetoc_1ipkd2pj3k7">Path-Based Routing</a></li><li><a href="#mcetoc_1ipkd2pj3k8">Apache configuration</a></li></ul></li><li><a href="#mcetoc_1ipkd2pj3k9">Conclusion</a></li></ul></div><p>Here we are</p><h2 id="mcetoc_1ipkcf23cd9" class="text-xl font-bold text-text-100 mt-1 -mb-0.5">The Infrastructure Overview</h2><p class="whitespace-pre-wrap break-words">In today's interconnected world, exposing your home lab or self-hosted services to the internet can be both necessary and risky. Traditional methods like port forwarding or VPNs come with their own set of challenges and security concerns. This is where Cloudflare Tunnel (formerly Argo Tunnel) comes in as an elegant solution.</p><p class="whitespace-pre-wrap break-words">In this article, I'll walk you through how I've implemented a secure infrastructure using Cloudflare Tunnel with WebSocket support, running on a Kubernetes cluster with Apache HTTPD as a reverse proxy. This setup allows me to securely expose internal services without opening ports on my residential firewall while gaining the benefits of Cloudflare's security features.</p><h2 id="mcetoc_1h6ufv7hs6">Starting point </h2><p>This one of the scenarios (what made me crazy) where websocket are in use , grafana, since version 8.~ starts to use websocket to update dashboards</p><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/44/home_all_v1.drawio-4.png" alt="" width="763" height="371" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://www.k8s.it/media/posts/44/responsive/home_all_v1.drawio-4-xs.webp 640w, https://www.k8s.it/media/posts/44/responsive/home_all_v1.drawio-4-sm.webp 768w, https://www.k8s.it/media/posts/44/responsive/home_all_v1.drawio-4-md.webp 1024w, https://www.k8s.it/media/posts/44/responsive/home_all_v1.drawio-4-lg.webp 1366w, https://www.k8s.it/media/posts/44/responsive/home_all_v1.drawio-4-xl.webp 1600w, https://www.k8s.it/media/posts/44/responsive/home_all_v1.drawio-4-2xl.webp 1920w"></figure><p> </p><p>The original idea was to define a "role" for each aspect<br><br></p><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/44/cworkers.png" alt="" width="47" height="59" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://www.k8s.it/media/posts/44/responsive/cworkers-xs.webp 640w, https://www.k8s.it/media/posts/44/responsive/cworkers-sm.webp 768w, https://www.k8s.it/media/posts/44/responsive/cworkers-md.webp 1024w, https://www.k8s.it/media/posts/44/responsive/cworkers-lg.webp 1366w, https://www.k8s.it/media/posts/44/responsive/cworkers-xl.webp 1600w, https://www.k8s.it/media/posts/44/responsive/cworkers-2xl.webp 1920w"></figure>Used as global security header , this will take care to implement the same level of security for each application exposed<p></p><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/44/cfwaf.png" alt="" width="68" height="59" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://www.k8s.it/media/posts/44/responsive/cfwaf-xs.webp 640w, https://www.k8s.it/media/posts/44/responsive/cfwaf-sm.webp 768w, https://www.k8s.it/media/posts/44/responsive/cfwaf-md.webp 1024w, https://www.k8s.it/media/posts/44/responsive/cfwaf-lg.webp 1366w, https://www.k8s.it/media/posts/44/responsive/cfwaf-xl.webp 1600w, https://www.k8s.it/media/posts/44/responsive/cfwaf-2xl.webp 1920w"></figure>Used to "obfuscate" the origin and implement a sort of protection even if it's the free version of Cloudflare <p></p><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/44/Screenshot-2023-08-12-at-11.46.00.png" alt="" width="62" height="76" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.46.00-xs.webp 640w, https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.46.00-sm.webp 768w, https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.46.00-md.webp 1024w, https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.46.00-lg.webp 1366w, https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.46.00-xl.webp 1600w, https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.46.00-2xl.webp 1920w"></figure>Firewall linux based cause i need to make same acl and fw rules<p></p><p><img loading="lazy" src="https://roi4cio.com/fileadmin/user_upload/vmware-esxi.png" alt="VMware ESXi" width="96" height="60" data-is-external-image="true"> Vmware esxi as a "flat" platform to abstract hardware brands, extend portability, backups, etc etc</p><p> </p><p><img loading="lazy" src="https://juststickers.in/wp-content/uploads/2018/11/kubernetes-wordmark.png" alt="Kubernetes Logo and Wordmark Sticker - Just Stickers" width="57" height="57" data-is-external-image="true"> Kubernetes for all the workloads can be run as immutable images</p><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/44/Screenshot-2023-08-12-at-11.54.58.png" alt="" width="66" height="64" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.54.58-xs.webp 640w, https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.54.58-sm.webp 768w, https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.54.58-md.webp 1024w, https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.54.58-lg.webp 1366w, https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.54.58-xl.webp 1600w, https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.54.58-2xl.webp 1920w"></figure>Virtual machines when i need disk pressure <p></p><p>The code used for workers was the following</p><div><div><code>const securityHeaders = {</code></div><div><code>"Content-Security-Policy":"upgrade-insecure-requests",</code></div><div><code>"Strict-Transport-Security":"max-age=3600;includeSubdomains",</code></div><div><code>"X-Xss-Protection":"1; mode=block",</code></div><div><code>"X-Frame-Options":"DENY",</code></div><div><code>"X-Content-Type-Options":"nosniff",</code></div><div><code>"Permissions-Policy":"geolocation=()",</code></div><div><code>"Referrer-Policy":"strict-origin-when-cross-origin"</code></div><div><code>};</code></div><br><div><code>async function addHeaders(req) {</code></div><div><code>constresponse=awaitfetch(req),</code></div><div><code>newHeaders=newHeaders(response.headers),</code></div><div><code>setHeaders=Object.assign({},securityHeaders);</code></div><br><div><code>if (newHeaders.has("Content-Type") &amp;&amp;!newHeaders.get("Content-Type").includes("text/html")) {</code></div><div><code>returnnewResponse(response.body,{</code></div><div><code>status: response.status,</code></div><div><code>statusText: response.statusText,</code></div><div><code>headers: newHeaders</code></div><div><code>});</code></div><div><code>}</code></div><br><div><code>Object.keys(setHeaders).forEach(name=&gt;newHeaders.set(name,setHeaders[name]));</code></div><br><div><code>returnnewResponse(response.body,{</code></div><div><code>status: response.status,</code></div><div><code>statusText: response.statusText,</code></div><div><code>headers: newHeaders</code></div><div><code>});</code></div><div><code>}</code></div><br><div><code>addEventListener("fetch", event =&gt; event.respondWith(addHeaders(event.request)));</code></div><div> </div></div><div>Anyway now there is a specific topic in cloudflare portal about the alter headers for security ... <a href="https://developers.cloudflare.com/workers/examples/security-headers/" target="_blank" rel="noopener noreferrer">https://developers.cloudflare.com/workers/examples/security-headers/</a></div><div> </div><div> </div><div><h2 id="mcetoc_1ipkcjle2e7" class="whitespace-pre-wrap break-words">Why Cloudflare Tunnel?</h2></div><div><p class="whitespace-pre-wrap break-words">Before diving into the technical details, let's understand why this approach is superior:</p><ol class="[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7"><li class="whitespace-normal break-words"><strong>No Open Inbound Ports</strong>: Cloudflare Tunnel establishes an outbound-only connection, eliminating the need to open ports on your firewall</li><li class="whitespace-normal break-words"><strong>DDoS Protection</strong>: Cloudflare's network absorbs and mitigates attack traffic before it reaches your infrastructure</li><li class="whitespace-normal break-words"><strong>Zero Trust Access</strong>: Integrate with Cloudflare Access for identity-based authentication</li><li class="whitespace-normal break-words"><strong>TLS Encryption</strong>: All traffic is encrypted end-to-end</li><li class="whitespace-normal break-words"><strong>WebSocket Support</strong>: Critical for real-time applications and API</li></ol></div><div><p> </p><h2 id="mcetoc_1ipkcks8uea">Setting Up Cloudflared in Kubernetes</h2><p>The core component of this setup is cloudflared, the daemon that creates and maintains the secure tunnel. Here's how I've deployed it in Kubernetes:</p><h3 id="mcetoc_1ipkcf23cdc" class="text-lg font-bold text-text-100 mt-1 -mb-1.5">Configuration</h3><p class="whitespace-pre-wrap break-words">Let's examine the key components of the <code class="bg-text-200/5 border border-0.5 border-border-300 text-danger-000 whitespace-pre-wrap rounded-[0.4rem] px-1 py-px text-[0.9rem]">ConfigMap</code> that defines how cloudflared operates:</p><div class="relative group/copy rounded-lg"><div class="sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right"><div class="absolute right-0 h-8 px-2 items-center inline-flex"><div class="relative"> </div></div></div><div class="text-text-500 text-xs p-3.5 pb-0">yaml</div><div><pre class="code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed"><code class="language-yaml"><span class="token key">apiVersion</span><span class="token">:</span> v1
<span class="token key">kind</span><span class="token">:</span> ConfigMap
<span class="token key">metadata</span><span class="token">:</span>
  <span class="token key">name</span><span class="token">:</span> cloudflared
  <span class="token key">namespace</span><span class="token">:</span> cloudflared
<span class="token key">data</span><span class="token">:</span>
  <span class="token key">config.yaml</span><span class="token">:</span> <span class="token">|</span>
    # Name of the tunnel
    tunnel: home
    credentials-file: /etc/cloudflared/creds/credentials.json
    metrics: 0.0.0.0:2000
<span class="token scalar">    no-autoupdate: true</span>
    
    <span class="token"># Ingress rules define traffic routing</span>
    <span class="token key">ingress</span><span class="token">:</span>
    <span class="token"># Special case for Let's Encrypt verification</span>
    <span class="token">-</span> <span class="token key">hostname</span><span class="token">:</span> services.k8s.it
      <span class="token key">path</span><span class="token">:</span> /.well<span class="token">-</span>known/acme<span class="token">-</span>challenge/
      <span class="token key">service</span><span class="token">:</span> $internal-ingress
      <span class="token key">originRequest</span><span class="token">:</span>
        <span class="token key">httpHostHeader</span><span class="token">:</span> <span class="token">"services.k8s.it"</span>
        <span class="token key">noTLSVerify</span><span class="token">:</span> <span class="token">true</span>
        <span class="token key">http2Origin</span><span class="token">:</span> <span class="token">true</span>
    
    <span class="token"># Main service routing</span>
    <span class="token">-</span> <span class="token key">hostname</span><span class="token">:</span> services.k8s.it
      <span class="token key">service</span><span class="token">:</span> $internal-ingress
      <span class="token key">originRequest</span><span class="token">:</span>
        <span class="token key">httpHostHeader</span><span class="token">:</span> <span class="token">"services.k8s.it"</span>
        <span class="token key">noTLSVerify</span><span class="token">:</span> <span class="token">true</span>
        <span class="token key">http2Origin</span><span class="token">:</span> <span class="token">true</span>
    
    <span class="token"># Default rule</span>
    <span class="token">-</span> <span class="token key">service</span><span class="token">:</span> http_status<span class="token">:</span><span class="token">404</span></code></pre></div></div><p class="whitespace-pre-wrap break-words">This configuration maps different hostnames to internal services, with special handling for WebSockets and HTTP/2 connections.</p><h3 id="mcetoc_1ipkcf23cdd" class="text-lg font-bold text-text-100 mt-1 -mb-1.5">Deployment</h3><p class="whitespace-pre-wrap break-words">Here's the deployment configuration for cloudflared:</p><div class="relative group/copy rounded-lg"><div class="sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right"><div class="absolute right-0 h-8 px-2 items-center inline-flex"><div class="relative"> </div></div></div><div class="text-text-500 text-xs p-3.5 pb-0">yaml</div><div><pre class="code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed"><code class="language-yaml"><span class="token key">apiVersion</span><span class="token">:</span> apps/v1
<span class="token key">kind</span><span class="token">:</span> Deployment
<span class="token key">metadata</span><span class="token">:</span>
  <span class="token key">name</span><span class="token">:</span> cloudflared
<span class="token key">spec</span><span class="token">:</span>
  <span class="token key">selector</span><span class="token">:</span>
    <span class="token key">matchLabels</span><span class="token">:</span>
      <span class="token key">app</span><span class="token">:</span> cloudflared
  <span class="token key">replicas</span><span class="token">:</span> <span class="token">2</span>  <span class="token"># For high availability</span>
  <span class="token key">template</span><span class="token">:</span>
    <span class="token key">metadata</span><span class="token">:</span>
      <span class="token key">annotations</span><span class="token">:</span>
        <span class="token key">prometheus.io/path</span><span class="token">:</span> /metrics
        <span class="token key">prometheus.io/port</span><span class="token">:</span> <span class="token">"2000"</span>
        <span class="token key">prometheus.io/scrape</span><span class="token">:</span> <span class="token">"true"</span>
      <span class="token key">labels</span><span class="token">:</span>
        <span class="token key">app</span><span class="token">:</span> cloudflared
    <span class="token key">spec</span><span class="token">:</span>
      <span class="token key">containers</span><span class="token">:</span>
      <span class="token">-</span> <span class="token key">name</span><span class="token">:</span> cloudflared
        <span class="token key">image</span><span class="token">:</span> cloudflare/cloudflared<span class="token">:</span>2023.7.0
        <span class="token key">args</span><span class="token">:</span>
        <span class="token">-</span> tunnel
        <span class="token">-</span> <span class="token">-</span><span class="token">-</span>config
        <span class="token">-</span> /etc/cloudflared/config/config.yaml
        <span class="token">-</span> run
        <span class="token key">livenessProbe</span><span class="token">:</span>
          <span class="token key">httpGet</span><span class="token">:</span>
            <span class="token key">path</span><span class="token">:</span> /ready
            <span class="token key">port</span><span class="token">:</span> <span class="token">2000</span>
          <span class="token key">failureThreshold</span><span class="token">:</span> <span class="token">1</span>
          <span class="token key">initialDelaySeconds</span><span class="token">:</span> <span class="token">10</span>
          <span class="token key">periodSeconds</span><span class="token">:</span> <span class="token">10</span>
        <span class="token key">volumeMounts</span><span class="token">:</span>
        <span class="token">-</span> <span class="token key">name</span><span class="token">:</span> config
          <span class="token key">mountPath</span><span class="token">:</span> /etc/cloudflared/config
          <span class="token key">readOnly</span><span class="token">:</span> <span class="token">true</span>
        <span class="token">-</span> <span class="token key">name</span><span class="token">:</span> creds
          <span class="token key">mountPath</span><span class="token">:</span> /etc/cloudflared/creds
          <span class="token key">readOnly</span><span class="token">:</span> <span class="token">true</span>
      <span class="token key">volumes</span><span class="token">:</span>
      <span class="token">-</span> <span class="token key">name</span><span class="token">:</span> creds
        <span class="token key">secret</span><span class="token">:</span>
          <span class="token key">secretName</span><span class="token">:</span> tunnel<span class="token">-</span>credentials
      <span class="token">-</span> <span class="token key">name</span><span class="token">:</span> config
        <span class="token key">configMap</span><span class="token">:</span>
          <span class="token key">name</span><span class="token">:</span> cloudflared
          <span class="token key">items</span><span class="token">:</span>
          <span class="token">-</span> <span class="token key">key</span><span class="token">:</span> config.yaml
            <span class="token key">path</span><span class="token">:</span> config.yaml</code></pre></div></div><p class="whitespace-pre-wrap break-words">Notice the use of multiple replicas for redundancy and the liveness probe that ensures connectivity to Cloudflare's edge network.</p><p> </p><h2 id="mcetoc_1ipkcllt0ec">How the Traffic Flows: Sequence Diagram</h2><p class="whitespace-pre-wrap break-words">Let's visualize how a request flows through this infrastructure:</p><div class="relative group/copy rounded-lg"><div class="sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right"><div class="absolute right-0 h-8 px-2 items-center inline-flex"><div class="relative"> </div></div></div><div><pre class="code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed"><code>User -&gt; Cloudflare -&gt; Cloudflared -&gt; Kubernetes Ingress -&gt; Apache HTTPD -&gt; Application</code></pre></div></div><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/44/Screenshot-2025-04-24-at-19.07.35.png" alt="" width="1598" height="1438" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://www.k8s.it/media/posts/44/responsive/Screenshot-2025-04-24-at-19.07.35-xs.webp 640w, https://www.k8s.it/media/posts/44/responsive/Screenshot-2025-04-24-at-19.07.35-sm.webp 768w, https://www.k8s.it/media/posts/44/responsive/Screenshot-2025-04-24-at-19.07.35-md.webp 1024w, https://www.k8s.it/media/posts/44/responsive/Screenshot-2025-04-24-at-19.07.35-lg.webp 1366w, https://www.k8s.it/media/posts/44/responsive/Screenshot-2025-04-24-at-19.07.35-xl.webp 1600w, https://www.k8s.it/media/posts/44/responsive/Screenshot-2025-04-24-at-19.07.35-2xl.webp 1920w"></figure><p> </p><h2 id="mcetoc_1ipkcjle2e8">Security Considerations</h2><p class="whitespace-pre-wrap break-words"> </p><h3 id="mcetoc_1ipkcf23cdh" class="text-lg font-bold text-text-100 mt-1 -mb-1.5">1. Cloudflare WAF Protection</h3><p class="whitespace-pre-wrap break-words">Cloudflare's Web Application Firewall provides protection against:</p><ul class="[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-disc space-y-1.5 pl-7"><li class="whitespace-normal break-words">SQL injection attacks</li><li class="whitespace-normal break-words">Cross-site scripting (XSS)</li><li class="whitespace-normal break-words">Cross-site request forgery (CSRF)</li><li class="whitespace-normal break-words">DDoS attacks</li><li class="whitespace-normal break-words">Common vulnerabilities</li></ul><h3 id="mcetoc_1ipkcf23cdi" class="text-lg font-bold text-text-100 mt-1 -mb-1.5">2. Zero Trust Network Architecture</h3><p class="whitespace-pre-wrap break-words">The setup follows zero trust principles:</p><ul class="[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-disc space-y-1.5 pl-7"><li class="whitespace-normal break-words">No exposed ports on the residential firewall</li><li class="whitespace-normal break-words">All connections initiated outbound from inside the network</li><li class="whitespace-normal break-words">No direct path from internet to internal services</li></ul><h3 id="mcetoc_1ipkcf23cdj" class="text-lg font-bold text-text-100 mt-1 -mb-1.5">3. Defense in Depth</h3><p class="whitespace-pre-wrap break-words">Multiple security layers provide redundant protection:</p><ul class="[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-disc space-y-1.5 pl-7"><li class="whitespace-normal break-words">Cloudflare WAF (first line of defense)</li><li class="whitespace-normal break-words">Kubernetes network policies (segmentation)</li><li class="whitespace-normal break-words">Apache as an additional security layer (request filtering)</li><li class="whitespace-normal break-words">Application-level security</li></ul><h3 id="mcetoc_1ipkcf23cdk" class="text-lg font-bold text-text-100 mt-1 -mb-1.5">4. Credential Management</h3><p class="whitespace-pre-wrap break-words">Cloudflared credentials require careful handling:</p><ul class="[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-disc space-y-1.5 pl-7"><li class="whitespace-normal break-words">Store tunnel credentials as Kubernetes secrets</li><li class="whitespace-normal break-words">Regular credential rotation</li><li class="whitespace-normal break-words">Limit access to credential management</li></ul><h3 id="mcetoc_1ipkcf23cdl" class="text-lg font-bold text-text-100 mt-1 -mb-1.5">5. HTTPS Everywhere</h3><p class="whitespace-pre-wrap break-words">All traffic is encrypted:</p><ul class="[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-disc space-y-1.5 pl-7"><li class="whitespace-normal break-words">TLS between user and Cloudflare</li><li class="whitespace-normal break-words">TLS in the tunnel between Cloudflare and cloudflared</li><li class="whitespace-normal break-words">Optional TLS for internal communications</li></ul><p> </p><h2 id="mcetoc_1ipkd2pj3k4" class="text-xl font-bold text-text-100 mt-1 -mb-0.5">Monitoring and Observability</h2><p class="whitespace-pre-wrap break-words">The infrastructure includes robust monitoring:</p><ol class="[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7"><li class="whitespace-normal break-words"><strong>Prometheus Integration</strong>: Cloudflared exposes metrics on port 2000</li><li class="whitespace-normal break-words"><strong>Grafana Dashboards</strong>: Visualize performance and security metrics</li><li class="whitespace-normal break-words"><strong>Logs Aggregation</strong>: Collect logs from all components for analysis</li></ol><div class="relative group/copy rounded-lg"><div class="sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right"><div class="absolute right-0 h-8 px-2 items-center inline-flex"><div class="relative"> </div></div></div><div class="text-text-500 text-xs p-3.5 pb-0">yaml</div><div><pre class="code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed"><code class="language-yaml"><span class="token key">annotations</span><span class="token">:</span>
  <span class="token key">prometheus.io/path</span><span class="token">:</span> /metrics
  <span class="token key">prometheus.io/port</span><span class="token">:</span> <span class="token">"2000"</span>
  <span class="token key">prometheus.io/scrape</span><span class="token">:</span> <span class="token">"true"</span></code></pre></div></div><h2 id="mcetoc_1ipkd2pj3k5" class="text-xl font-bold text-text-100 mt-1 -mb-0.5">Advanced Configurations</h2><h3 id="mcetoc_1ipkd2pj3k6" class="text-lg font-bold text-text-100 mt-1 -mb-1.5">Load Balancing</h3><p class="whitespace-pre-wrap break-words">For high availability, the setup uses multiple cloudflared replicas:</p><div class="relative group/copy rounded-lg"><div class="sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right"><div class="absolute right-0 h-8 px-2 items-center inline-flex"><div class="relative"> </div></div></div><div><pre class="code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed"><code class="language-yaml"><span class="token key">replicas</span><span class="token">:</span> <span class="token">2</span>  <span class="token"># Multiple instances for reliability</span></code></pre></div></div><p class="whitespace-pre-wrap break-words">Cloudflare's global network automatically balances connections across available tunnels.</p><h3 id="mcetoc_1ipkd2pj3k7" class="text-lg font-bold text-text-100 mt-1 -mb-1.5">Path-Based Routing</h3><p class="whitespace-pre-wrap break-words">The ingress configuration supports path-based routing:</p><div class="relative group/copy rounded-lg"><div class="sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right"><div class="absolute right-0 h-8 px-2 items-center inline-flex"><div class="relative"> </div></div></div><div><pre class="code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed"><code class="language-yaml"><span class="token">-</span> <span class="token key">hostname</span><span class="token">:</span> services.k8s.it
  <span class="token key">path</span><span class="token">:</span> /.well<span class="token">-</span>known/acme<span class="token">-</span>challenge/
  <span class="token key">service</span><span class="token">:</span> http<span class="token">:</span>//$internal-ingress</code></pre></div></div><p class="whitespace-pre-wrap break-words">This allows for complex routing scenarios based on domain and path.</p><p> </p><h3 id="mcetoc_1ipkd2pj3k8" class="text-lg font-bold text-text-100 mt-1 -mb-1.5">Apache configuration</h3><pre class="language-apacheconf"><code>      &lt;Location /grafana/&gt;
        ProxyPass  http://IP:3000/
      &lt;/Location&gt;

      &lt;Location /grafana/api/live/ws&gt;
        ProxyPass  ws://IP:3000/api/live/ws
      &lt;/Location&gt;</code></pre></div><div> </div><div><h2 id="mcetoc_1ipkd2pj3k9" class="text-xl font-bold text-text-100 mt-1 -mb-0.5">Conclusion</h2><p class="whitespace-pre-wrap break-words">This architecture provides a secure, reliable way to expose home lab services to the internet. By leveraging Cloudflare Tunnel with WebSocket support, you get:</p><ol class="[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7"><li class="whitespace-normal break-words">Enhanced security with no open ports</li><li class="whitespace-normal break-words">Protection from Cloudflare's global network</li><li class="whitespace-normal break-words">Reliable connections for modern web applications</li><li class="whitespace-normal break-words">Simplified management through Kubernetes</li></ol><p class="whitespace-pre-wrap break-words">The combination of cloudflared, Kubernetes, and Apache HTTPD creates a robust infrastructure that's both secure and flexible, allowing you to safely expose services without compromising on security.</p><p class="whitespace-pre-wrap break-words">Remember that security is a continuous process - regularly update components, review configurations, and monitor for unusual activity to maintain a strong security posture.</p></div><p> </p></div><footer class="content__footer"><div class="entry-wrapper"><p class="content__updated">This article was updated on 24 Apr 2025</p><div class="content__actions"><ul class="content__tag"><li><a href="https://www.k8s.it/apache-httpd/">apache httpd</a></li><li><a href="https://www.k8s.it/argo/">argo</a></li><li><a href="https://www.k8s.it/cloudflare/">cloudflare</a></li><li><a href="https://www.k8s.it/headers/">headers</a></li><li><a href="https://www.k8s.it/httpd/">httpd</a></li><li><a href="https://www.k8s.it/security/">security</a></li><li><a href="https://www.k8s.it/tunnel/">tunnel</a></li><li><a href="https://www.k8s.it/websocket/">websocket</a></li><li><a href="https://www.k8s.it/workers/">workers</a></li></ul><div class="content__share"><button class="btn--icon content__share-button js-content__share-button"><svg width="20" height="20" aria-hidden="true"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#share"></use></svg> <span>Share It</span></button><div class="content__share-popup js-content__share-popup"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.k8s.it%2Fwebsocket-cloudflare-tunnel-apache-and-irritation.html" class="js-share facebook" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fwww.k8s.it%2Fwebsocket-cloudflare-tunnel-apache-and-irritation.html&amp;via=LAB&amp;text=Websocket%2C%20Cloudflare%20tunnel%2C%20apache%20httpd%20and%20a%20bit%20of%20security" class="js-share twitter" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.k8s.it%2Fwebsocket-cloudflare-tunnel-apache-and-irritation.html" class="js-share linkedin" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span> </a><a href="https://buffer.com/add?text=Websocket%2C%20Cloudflare%20tunnel%2C%20apache%20httpd%20and%20a%20bit%20of%20security&amp;url=https%3A%2F%2Fwww.k8s.it%2Fwebsocket-cloudflare-tunnel-apache-and-irritation.html" class="js-share buffer" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#buffer"/></svg> <span>Buffer</span> </a><a href="https://api.whatsapp.com/send?text=Websocket%2C%20Cloudflare%20tunnel%2C%20apache%20httpd%20and%20a%20bit%20of%20security https%3A%2F%2Fwww.k8s.it%2Fwebsocket-cloudflare-tunnel-apache-and-irritation.html" class="js-share whatsapp" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#whatsapp"/></svg> <span>WhatsApp</span></a></div></div></div><div class="content__bio bio"><div><h3 class="h4 bio__name"><a href="https://www.k8s.it/authors/lgirardi/" rel="author">lgirardi</a></h3><div class="bio__desc">If it isn't there, it can't break.</div></div></div></div><nav class="content__nav"><div class="wrapper"><div class="content__nav-inner"><div class="content__nav-prev"><a href="https://www.k8s.it/hpa-vs-rate-limit.html" class="content__nav-link" rel="prev"><figure class="content__nav-image"><img src="https://www.k8s.it/media/posts/43/responsive/Screenshot_2023-02-14_at_20.15.33-removebg-preview-2-xs.webp" class="lazyload" loading="lazy" alt="" height="229" width="229"></figure><div><span>Previous</span> HPA vs Rate-limit</div></a></div></div></div></nav></footer></article><div class="content__comments"><div class="entry-wrapper"></div></div><div class="content__related related"><div class="wrapper"><h2 class="h4 related__title">You should also read:</h2><article class="feed__item feed__item--centered"><div class="feed__content"><header><div class="feed__meta"><a href="https://www.k8s.it/authors/lgirardi/" class="feed__author">lgirardi</a> <time datetime="2020-08-11T20:48" class="feed__date">11 Aug 2020</time></div><h3 class="feed__title"><a href="https://www.k8s.it/kubernetes-apacherr.html">Kubernetes apache httpd</a></h3></header><p>The semi-unuseful apache implementation in kubernetes Well , why we are talking about apache httpd in kubernetes ? We have ingress resources , we have ambassador and we are using microservices... True but internet was not built yesterday and for some reasons out of my&hellip;</p><a href="https://www.k8s.it/kubernetes-apacherr.html" class="readmore feed__readmore">Continue reading...</a></div></article></div></div></main><footer class="footer footer--glued"><div class="wrapper"><div class="footer__copyright"><p>.</p></div><div class="footer__social"><a href="https://www.linkedin.com/in/lgirardi/" aria-label="LinkedIn"><svg><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#linkedin"/></svg></a></div><button id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg width="20" height="20"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#toparrow"/></svg></button></div></footer><script defer="defer" src="https://www.k8s.it/assets/js/scripts.min.js?v=ffcbea6c02c8178d10092962b235a5b0"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site, for marketing, and to provide social media functionality. <a href="#not-specified">More details...</a></div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--link pcb__btn--configure" aria-haspopup="dialog">Manage preferences</button> <button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Save</button></div></div></div><div class="pcb__popup" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-popup-title"><div class="pcb__popup__wrapper"><div class="pcb__inner pcb__popup__inner"><div class="pcb__popup__heading"><div id="pcb-popup-title" role="heading" aria-level="2" class="pcb__title">Cookie settings</div><button class="pcb__popup__close" aria-label="Close"></button></div><div class="pcb__popup__content"><div class="pcb__txt pcb__popup__txt">We use cookies to enhance your browsing experience, serve personalized ads or content, and analyze our traffic. By clicking "Accept All", you consent to our use of cookies. <a href="#not-specified">More details...</a></div><ul class="pcb__groups"><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Required</summary></details><div class="pcb__popup__switch is-checked"><input type="checkbox" data-group-name="" id="pcb-group-0" checked="checked"> <label for="pcb-group-0">Required</label></div></li><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Functionality</summary></details><div class="pcb__popup__switch"><input type="checkbox" data-group-name="functions" id="functions-cookies"> <label for="functions-cookies">Functionality</label></div></li><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Analytical</summary></details><div class="pcb__popup__switch"><input type="checkbox" data-group-name="analytics" id="analytics-cookies"> <label for="analytics-cookies">Analytical</label></div></li><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Marketing</summary></details><div class="pcb__popup__switch"><input type="checkbox" data-group-name="marketing" id="marketing-cookies"> <label for="marketing-cookies">Marketing</label></div></li></ul></div><div class="pcb__buttons pcb__popup__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button> <button type="button" class="pcb__btn pcb__btn--reject">Reject all</button> <button type="button" class="pcb__btn pcb__btn--save">Save settings</button></div></div></div></div><div class="pcb__overlay" aria-hidden="true"></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('🍪 Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('🍪 Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('🍪 Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && cbConfig.initialLsState.indexOf(allowedGroup) === -1) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('🍪 GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('🍪 Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('🍪 Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>