<!doctype html><html amp lang="en-us"><head><meta charset="utf-8"><title>Kubernetes-apigw - LAB</title><meta name="description" content="It's time to talk about the api gateway In a modern infrastructure , especially in a microservices environment you probably know what i'm referring to ,however it's better to clarify some points. An API gateway takes all API calls from clients, then routes them to&hellip;"><link rel="canonical" href="https://www.k8s.it/kubernetes-apigw.html"><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"><link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet" type="text/css"><script async custom-element="amp-sidebar" src="https://cdn.ampproject.org/v0/amp-sidebar-0.1.js"></script><script async custom-element="amp-social-share" src="https://cdn.ampproject.org/v0/amp-social-share-0.1.js"></script><script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script><script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.k8s.it/amp/kubernetes-apigw.html"},"headline":"Kubernetes-apigw","datePublished":"2020-11-08T13:57","dateModified":"2020-11-08T14:35","description":"It's time to talk about the api gateway In a modern infrastructure , especially in a microservices environment you probably know what i'm referring to ,however it's better to clarify some points. An API gateway takes all API calls from clients, then routes them to&hellip;","author":{"@type":"Person","name":"lgirardi"},"publisher":{"@type":"Organization","name":"lgirardi"}}</script><style amp-custom>article,
aside,
footer,
header,
hgroup,
main,
nav,
section {
  display: block; }

*,
*:before,
*:after {
  -webkit-box-sizing: content-box;
  box-sizing: content-box;
  margin: 0;
  padding: 0; }

li {
  list-style: none; }

amp-img {
  max-width: 100%; }

button,
input,
select,
textarea {
  font: inherit; }

html {
  font-size: 1rem; }

body {
  background: #f1f1f1;
  color: #262626;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
  line-height: 1.6; }

a {
  color:  #039be5;
  text-decoration: none;
  -webkit-transition: all 0.12s linear 0s;
  -o-transition: all 0.12s linear 0s;
  transition: all 0.12s linear 0s; }

a:hover {
  color: #262626;
  text-decoration: underline;
  -webkit-text-decoration-skip: ink;
  text-decoration-skip: ink; }

a:active {
  color: #262626; }

a:focus {
  outline: 2px dotted #039be5; }

figure,
blockquote,
p,
ul,
ol,
dl,
table,
hr,
fieldset {
  margin-top: 1.6rem; }

h1,
h2,
h3,
h4,
h5,
h6 {
  color: #262626;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
  font-weight: 500;
  line-height: 1.2;
  margin-top: 2.13333rem; }

h1 {
  font-size: 1.67583rem;
  font-weight: normal; }

h2 {
  font-size: 1.4729rem; }

h3 {
  font-size: 1.29454rem; }

h4 {
  font-size: 1.13778rem; }

h5 {
  font-size: 1rem; }

h6 {
  font-size: 0.87891rem; }

h2 + p,
h3 + p,
h4 + p,
h5 + p,
h6 + p {
  margin-top: 0.8rem; }

b,
strong {
  font-weight: 600; }

blockquote {
  color: #6c7175;
  font-family: "Droid Serif", "Times", "Source Serif Pro", serif;
  font-style: italic;
  padding: 1.33333rem 0.53333rem 1.33333rem 3.2rem;
  position: relative; }
  blockquote:before {
    display: block;
    content: "\201C";
    font-size: 4.41226rem;
    position: absolute;
    left: 0;
    top: -12px;
    color: rgba(108, 113, 117, 0.5); }
  blockquote > :nth-child(1) {
    margin-top: 0; }

ul,
ol {
  margin-left: 2rem; }
  ul > li,
  ol > li {
    list-style: inherit;
    padding: 0 0 0.26667rem 0.26667rem; }

dl dt {
  color: #262626;
  font-weight: 600; }

code,
pre {
  background-color: #f1f1f1;
  font-family: monospace; }

pre {
  margin: 1.6rem 0 0;
  padding: 1.6rem;
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-x: auto; }
  pre > code {
    color: #262626;
    padding: 0; }

code {
  border-radius: 3px;
  color: #262626;
  padding: 0.26667rem 0.53333rem; }

table {
  border-collapse: collapse;
  border-spacing: 0;
  border: 1px solid #d4d4d4;
  width: 100%;
  overflow-x: auto;
  vertical-align: top;
  text-align: left;
  white-space: nowrap; }
  table th {
    font-weight: 500;
    padding: 0.53333rem 1.06667rem; }
  table tr {
    border-bottom: 1px solid #d4d4d4; }
    table tr:nth-child(2n) {
      background: #f1f1f1; }
  table td {
    padding: 0.53333rem 1.06667rem; }

figcaption {
  clear: both;
  color: rgba(108, 113, 117, 0.6);
  font-size: 0.82397rem;
  margin: 0.8rem 0 0;
  text-align: center; }

sub,
sup {
  font-size: 65%; }

hr {
  border: 0;
  height: 0;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3); }

.btn, [type=button],
[type=submit],
button {
  background: #039be5;
  border: none;
  border-radius: 2px;
  color: #ffffff;
  cursor: pointer;
  display: inline-block;
  font-size: 0.87891rem;
  font-weight: 500;
  line-height: 1.9;
  padding: 0.53333rem 1.33333rem;
  text-align: center;
  text-decoration: none;
  -webkit-transition: all .15s ease;
  -o-transition: all .15s ease;
  transition: all .15s ease;
  width: auto; }
  .btn:hover, [type=button]:hover,
  [type=submit]:hover,
  button:hover {
    background: #262626;
    color: #ffffff; }
  .btn:focus, [type=button]:focus,
  [type=submit]:focus,
  button:focus {
    outline: none; }
  .btn-outline {
    border: 1px solid #ddd;
    background: #ffffff;
    border-radius: 3px;
    color: #262626; }

[type=button],
[type=submit],
button {
  text-transform: uppercase;
  -webkit-appearance: none;
  -moz-appearance: none; }

.navbar {
  background: #039be5;
  -webkit-box-shadow: 0 0 6px 0 rgba(0, 0, 0, 0.2);
  box-shadow: 0 0 6px 0 rgba(0, 0, 0, 0.2);
  line-height: 3;
  max-height: 4rem; }
  .navbar > div {
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    text-align: left;
    max-width: 700px;
    margin: 0 auto; }
  .navbar a {
    color: #ffffff;
    text-decoration: none; }
  .navbar-sidebar-toggle {
    left: 0;
    position: relative;
    text-indent: -99999rem; }
    .navbar-sidebar-toggle:before {
      content: "";
      display: block;
      border-top: 0.375rem double #ffffff;
      border-bottom: 0.125rem solid #ffffff;
      height: 0.125rem;
      position: absolute;
      text-indent: 0;
      top: 50%;
      width: 1.3rem;
      -webkit-transform: translate(0px, -50%);
      -ms-transform: translate(0px, -50%);
      transform: translate(0px, -50%); }


.logo {
            display: inline-block;
  font-weight: 600;
  line-height: 1;
            margin: 0 auto;
            height: 2rem;
            text-indent: -9999px;
            width: 240px;vertical-align: middle;
        }
        .logo.logo-text {
            line-height: 2;
            text-align: center;
            text-indent: 0;
        }

amp-sidebar {
  background: #ffffff;
  width: 240px; }
  amp-sidebar > ul {
    margin: 0.8rem 0 0;
    padding: 0; }
    amp-sidebar > ul ul {
      border-left: 1px solid #d4d4d4;
      margin: 0.53333rem 0 0; }
    amp-sidebar > ul li {
      color: #262626;
      font-size: 0.9375rem;
      font-weight: 600;
      list-style: none;
      line-height: 1.4;
      padding: 0.42667rem 1.06667rem; }
      amp-sidebar > ul li li {
        font-weight: normal;
        padding: 0.26667rem 0 0.26667rem 1.06667rem; }
    amp-sidebar > ul a,
    amp-sidebar > ul a:visited {
      color: #262626; }

.bg-white {
  background: #ffffff; }

.wrap-page {
  max-width: 700px;
  margin: 0 auto; }

@media all and (max-width: 43.6875em) {
  .wrap-inner {
    padding: 0 6%; } }

.page-title {
  background: #ffffff;
  -webkit-box-shadow: 0 2px 3px rgba(38, 38, 38, 0.1);
  box-shadow: 0 2px 3px rgba(38, 38, 38, 0.1);
  margin-bottom: 0.8rem;
  padding: 1.6rem 6%; }
  .page-title > h1 {
    margin: 0;
    font-size: 1.29454rem; }
  .page-title > p {
    font-size: 0.87891rem;
    color: #6c7175;
    line-height: 1.3;
    margin: 0.26667rem 0 0; }
  .page-title-author {
    border-radius: 50%;
    float: left;
    height: 2.5rem;
    width: 2.5rem; }
    .page-title-author + h1 {
      margin-left: 3.5rem; }
      .page-title-author + h1 + p {
        margin-left: 3.5rem; }

.card {
  background: #ffffff;
  -webkit-box-shadow: 0 2px 3px rgba(38, 38, 38, 0.1);
  box-shadow: 0 2px 3px rgba(38, 38, 38, 0.1);
  margin-bottom: 0.8rem;
  padding-bottom: 1.06667rem; }

  .card-meta {
    border-top: 1px solid #d4d4d4;
    color: rgba(108, 113, 117, 0.6);
    font-size: 0.7242rem;
    font-weight: 500;
    margin-top: 1.06667rem;
    padding-top: 1.06667rem;
    text-transform: uppercase; }
    .card-meta a + time:before {
      content: "";
      background: #d4d4d4;
      display: inline-block;
      height: 3px;
      margin: 0 8px;
      width: 3px;
      vertical-align: middle;
      border-radius: 50%; }
  .card-text {
    font-size: 0.9375rem;
    overflow: hidden;
    padding: 0 6%; }
    .card-text h2 {
      font-size: 1.13778rem; }

.post {
  margin-bottom: 2.13333rem; }
  .post-featured-image {
    margin-top: 0;
    position: relative; }
    .post-featured-image > figcaption {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 3px;
      color: #ffffff;
      position: absolute;
      bottom: 0.8rem;
      padding: 0 0.26667rem;
      right: 6%; }
  .post-header {
    margin-bottom: 2.13333rem; }
  .post-meta {
    border-bottom: 1px solid #d4d4d4;
    color: rgba(108, 113, 117, 0.6);
    font-size: 0.7242rem;
    font-weight: 500;
    margin-top: 1.06667rem;
    padding-bottom: 1.06667rem;
    text-transform: uppercase; }
    .post-meta a + time:before {
      content: "";
      background: #d4d4d4;
      display: inline-block;
      height: 3px;
      margin: 0 8px;
      width: 3px;
      vertical-align: middle;
      border-radius: 50%; }
  .post-tag {
    margin: 0; }
    .post-tag > li {
      display: inline-block;
      padding: 0; }
      .post-tag > li a {
        background: #f1f1f1;
        border-radius: 2px;
        color: #6c7175;
        font-size: 0.77248rem;
        display: inline-block;
        margin: 0 0.26667rem 0.26667rem 0;
        padding: 0.26667rem 0.53333rem; }
        .post-tag > li a:hover {
          background: #039be5;
          color: #ffffff;
          text-decoration: none; }
  .post-share {
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-orient: horizontal;
    -webkit-box-direction: normal;
    -ms-flex-direction: row;
    flex-direction: row;
    -webkit-box-pack: justify;
    -ms-flex-pack: justify;
    justify-content: space-between;
    margin-top: 1.6rem;
    width: 100%; }
    .post-share amp-social-share {
      -webkit-box-flex: 1;
      -ms-flex: 1 0 auto;
      flex: 1 0 auto;
      background-size: 24px; }
  .post-scroll {
    color: #ffffff;
    background: #039be5;
    bottom: 10px;
    border-radius: 50%;
    border: none;
    -webkit-box-shadow: 0 1px 1.5px 0 rgba(38, 38, 38, 0.12), 0 1px 1px 0 rgba(38, 38, 38, 0.24);
    box-shadow: 0 1px 1.5px 0 rgba(38, 38, 38, 0.12), 0 1px 1px 0 rgba(38, 38, 38, 0.24);
    font-size: 1.13778rem;
    height: 46px;
    opacity: 0;
    outline: none;
    position: fixed;
    padding: 0;
    right: 4%;
    visibility: hidden;
    width: 46px;
    z-index: 9999; }
    .post-scroll-marker {
      height: 0px;
      position: absolute;
      top: 100px;
      width: 0px; }
        .post-pagination {
    background: #f1f1f1;
    -webkit-box-shadow: inset 0 2px 3px rgba(38, 38, 38, 0.1);
    box-shadow: inset 0 2px 3px rgba(38, 38, 38, 0.1);
    border-top: 1px solid #d4d4d4;
    padding: 1.06667rem 0; }
    .post-pagination > div {
      line-height: 1.2;
      padding: 0.53333rem 1.06667rem;
      text-align: center; }
      .post-pagination > div span {
        display: block;
        color: #6c7175;
        font-size: 0.7242rem;
        font-weight: 500;
        margin-bottom: 0.26667rem;
        text-transform: uppercase; }
    .post-pagination-prev a:before {
      content: "\2190";
      margin-right: 0.26667rem; }
    .post-pagination-next a:after {
      content: "\2192";
      margin-left: 0.26667rem; }

aside {
  margin: 1.6rem 0 0; }

.align-left {
  text-align: left; }

.align-right {
  text-align: right; }

.align-center {
  text-align: center; }

.align-justify {
  text-align: justify; }

.msg {
  border-left: 2px solid transparent;
  padding: 1.06667rem 1.06667rem; }
  .msg--highlight {
    background-color: #fff8e6;
    border-color: #e2ac4f; }
  .msg--info {
    background: rgba(45, 97, 201, 0.03);
    border-color: #039be5; }
  .msg--success {
    background: #f7fbf6;
    border-color: #5ab44b; }
  .msg--warning {
    background: #fff3f3;
    border-color: #c06367;
    color: #a94442; }

.dropcap:first-letter {
  float: left;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
  font-size: 2.16943rem;
  line-height: 0.7;
  margin-right: 0.53333rem;
  padding: 0.53333rem 0.53333rem 0.53333rem 0; }

.pagination {
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-pack: justify;
  -ms-flex-pack: justify;
  justify-content: space-between;
  margin: 0.8rem 0; }
  .pagination > a {
    padding-left: 0;
    padding-right: 0;
    width: 49%; }
  .pagination-right {
    margin-left: auto; }

.bottom {
  background: #039be5;
  color: #ffffff;
  padding: 1.06667rem 4%;
  text-align: center; }</style><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript><script async src="https://cdn.ampproject.org/v0.js"></script><script custom-element="amp-animation" src="https://cdn.ampproject.org/v0/amp-animation-0.1.js" async></script><script custom-element="amp-position-observer" src="https://cdn.ampproject.org/v0/amp-position-observer-0.1.js" async></script></head><body class="bg-white"><nav class="navbar wrap-inner" id="top"><div><a on="tap:navbar-sidebar.toggle" class="navbar-sidebar-toggle" title="Menu">Menu</a> <a class="logo logo-text" href="https://www.k8s.it/amp/">LAB</a></div></nav><main class="wrap-page"><article class="post"><div class="wrap-inner"><header class="post-header"><h1>Kubernetes-apigw</h1><p class="post-meta"><time datetime="2020-11-08T13:57">8 Nov 2020</time></p></header><p>It's time to talk about the api gateway</p><p>In a modern infrastructure , especially in a microservices environment you probably know what i'm referring to ,however it's better to clarify some points.</p><p><em>An API gateway takes all API calls from clients, then routes them to the appropriate microservice with request routing, composition, and protocol translation. Typically it handles a request by invoking multiple microservices and aggregating the results, to determine the best path. It can translate between web protocols and web‑unfriendly protocols that are used internally.</em></p><p><em>An e‑commerce site might use an API gateway to provide mobile clients with an endpoint for retrieving all product details with a single request. It invokes various services, like product info and reviews, and combines the results</em></p><p><br><br></p><p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/70d257f92412994f23cfce0b702ca359556a2b64b7835f8f3ef9b58a493a4d60/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343833393633312f6d6973632f61706967772e706e67"><amp-img title="apigw" src="https://camo.githubusercontent.com/70d257f92412994f23cfce0b702ca359556a2b64b7835f8f3ef9b58a493a4d60/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343833393633312f6d6973632f61706967772e706e67" data-is-external-image="true" alt="apigw" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1604839631/misc/apigw.png" layout="responsive"></amp-img></a></p><p><br><br></p><p>Some months ago i discussed about the service mesh<br><a href="https://github.com/lorenzogirardi/kubernetes-servicemesh">https://github.com/lorenzogirardi/kubernetes-servicemesh</a></p><p>To better understand the differences on those products it is better to summarize the common areas</p><p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/43086b5aea0afa64170f3dac4261da1ad4a2ae2645d428fee16b7ce2eb6484f1/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343730333838302f6d6973632f61706967775f76735f736572766963656d6573682e706e67"><amp-img title="apigw_vs_servicemesh" src="https://camo.githubusercontent.com/43086b5aea0afa64170f3dac4261da1ad4a2ae2645d428fee16b7ce2eb6484f1/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343730333838302f6d6973632f61706967775f76735f736572766963656d6573682e706e67" data-is-external-image="true" alt="apigw_vs_servicemesh" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1604703880/misc/apigw_vs_servicemesh.png" layout="responsive"></amp-img></a></p><p>So forget about service mesh and have the focus only on the apigw.</p><p><br><br></p><h2><a id="user-content-goal" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#goal"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>GOAL</h2><p><br><br></p><p>Needed:</p><ul><li>Api must be public</li><li>Users needs to have authentication</li><li>An user could be rate limited</li><li>A service could be rate limited</li><li>Backend applications should not be changed</li><li>We need to interact as a code with the apigw<br><br><br></li></ul><p>Important:</p><ul><li>Analytics</li><li>Transformation</li><li>Versioning</li><li>Circuit Breaker</li><li>gRPC support</li><li>Caching</li><li>Documentation</li></ul><p><br><br></p><h2><a id="user-content-software-opportunity" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#software-opportunity"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Software opportunity</h2><p>Around the api gateway world we have some possibility, some of those are onprem, some other in cloud or hybrid.</p><p>The onprem scenario we have some historycal software and a "new generation" born in a kubernetes architecture, howevere here we will check for a tool that could work in kubernetes (with a plus for supporting vm)</p><p>From the most knew i'd like to mention:</p><ul><li>Kong</li><li>Tyk</li><li>Nginx</li><li>Ambassador</li><li>3scale</li></ul><p>On the other side on the cloud scenario we have:</p><ul><li>Aws api gateway</li><li>Mashery (from Tibco)</li><li>Google apigee</li><li>Akana (hybrid)</li><li>Azure api management<br><br><br></li></ul><p>Cloud</p><p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/6f7e05d1971da2d537452717a8571e3fc13ac8a7471428550e0cf065ca2997e1/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343736363830322f6d6973632f61706967775f636c6f75642e706e67"><amp-img title="apigw_cloud" src="https://camo.githubusercontent.com/6f7e05d1971da2d537452717a8571e3fc13ac8a7471428550e0cf065ca2997e1/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343736363830322f6d6973632f61706967775f636c6f75642e706e67" data-is-external-image="true" alt="apigw_cloud" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1604766802/misc/apigw_cloud.png" layout="responsive"></amp-img></a></p><p>The advantage/disadvantage of cloud solution is the pay per use, you don't need to manage the infrastrcture but only the configuration and you have the support that can drive you on the right configuration.<br>Another valid point of view is the <em>DDOS</em> attack that will not land to your platform but to a cloud infrastructure that is supposed was designed to manage this scenario.</p><p>PRO:</p><ul><li>managed infrastructure</li><li>support</li><li>attacks mitigation</li></ul><p>CONS:</p><ul><li>pricing</li><li>often not customizable<br><br></li></ul><p>Onprem</p><p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/f650f08e78f1fa640565179fa79ccedcb5928fc85554118e8b2cbb720bbea6e6/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343736363830322f6d6973632f61706967775f64632e706e67"><amp-img title="apigw_dc" src="https://camo.githubusercontent.com/f650f08e78f1fa640565179fa79ccedcb5928fc85554118e8b2cbb720bbea6e6/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343736363830322f6d6973632f61706967775f64632e706e67" data-is-external-image="true" alt="apigw_dc" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1604766802/misc/apigw_dc.png" layout="responsive"></amp-img></a></p><p>Those solutions should be hosted on your platform or in a cloud to let the datacenter <em>unknown</em> (anyway you have to pay per traffic "*" ).<br>Your engineer team need to know how it's working the infrastructure but they can also improve the process with automations</p><p>PRO:</p><ul><li>open source</li><li>customizable</li><li>awareness on the complete funnel</li></ul><p>CONS:</p><ul><li>you have to take care about attacks</li><li>infrastructure knowhow</li></ul><p><br><br>"*" you can easly have the apigw hosted onprem combined with a cdn/waf with ip lockdown , however you still have to pay the traffic towards it.</p><p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/e66b9fb512155cc277683660dd1ab517d7e9b9e50f023d3fc53f2b7e06a9f5e7/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343736363830322f6d6973632f61706967775f7761662e706e67"><amp-img title="apigw_waf" src="https://camo.githubusercontent.com/e66b9fb512155cc277683660dd1ab517d7e9b9e50f023d3fc53f2b7e06a9f5e7/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343736363830322f6d6973632f61706967775f7761662e706e67" data-is-external-image="true" alt="apigw_waf" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1604766802/misc/apigw_waf.png" layout="responsive"></amp-img></a></p><p><br><br></p><h2><a id="user-content-scenario" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#scenario"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Scenario</h2><p>I tried some cloud solution like Aws and Mashery,<br>i played also with some onprem solution, anyway i found out the right compromise with <a href="https://konghq.com/kong/" rel="nofollow">Kong</a></p><p>where compromise is :</p><ul><li><strong>Kubernetes ingress</strong></li><li><strong>Api managed</strong></li><li><strong>Documentation</strong></li><li>Admin UI (konga for the open source)</li><li>Basic auth</li><li><strong>Apikey</strong></li><li><strong>Oauth</strong></li><li><strong>JWT</strong></li><li>ip listing</li><li><strong>Analytics</strong></li><li><strong>Rate limiting</strong></li><li><strong>Transformation</strong></li><li>gRPC</li><li>Websockets</li><li>Service mesh (~ nice to have)</li><li><strong>Easy to use</strong></li></ul><p><br><br></p><h2><a id="user-content-infrastructure" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#infrastructure"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Infrastructure</h2><ul><li>kubernetes</li><li>backend application</li><li>kong api gateway</li><li>konga admin ui</li><li>waf (free cloudflare service)</li></ul><p><br><br></p><p>What we need for this test is a backend api application, i created a prototype just to simulate different applications behind the apigw.</p><p>Here you can find out more details</p><p><a href="https://github.com/lorenzogirardi/py-test-backend">https://github.com/lorenzogirardi/py-test-backend</a></p><p>briefly recap the application answer on /api/ with the main html page with methods</p><table><thead><tr><th>HTTP Method</th><th align="center">URI</th><th>Action</th></tr></thead><tbody><tr><td>GET</td><td align="center">http://[hostname]/api/get/context</td><td>Retrieve list of context</td></tr><tr><td>GET</td><td align="center">http://[hostname]/api/get/context/[context_id]</td><td>Retrieve a context</td></tr><tr><td>POST</td><td align="center">http://[hostname]/api/post/context</td><td>Create a new context</td></tr><tr><td>PUT</td><td align="center">http://[hostname]/api/put/context/[context_id]</td><td>Update an existing context</td></tr><tr><td>DELETE</td><td align="center">http://[hostname]/api/delete/context/[context_id]</td><td>Delete acontext</td></tr></tbody></table><p><br><br></p><h2><a id="user-content-configuration" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#configuration"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Configuration</h2><p> </p><div><div>git repo --&gt; <a href="https://github.com/lorenzogirardi/Kubernetes-apigw" target="_blank" rel="noopener noreferrer">https://github.com/lorenzogirardi/Kubernetes-apigw</a></div></div><p>Let's start to work...<br>I've used the public kong deployment with some changes to have the database where store the configurations.</p><p>Another trick is create it as a secondary <em>ingress</em> , since i've already and ingress in my infrastructure , kong is done to answer on different ports</p><p>All the yaml are subdivided per role</p><pre><code>kong
|-- 01-kong-ns.yaml
|-- 02-kong-cr.yaml
|-- 03-kong-sa.yaml
|-- 04-kong-rbac.yaml
|-- 05-kong-crb.yaml
|-- 06-kong-svc.yaml
|-- 07-kong-dpl.yaml
|-- 08-kong-ss.yaml
`-- 09-kong-job.yaml
</code></pre><p>some differences are related to the services node ports, deployment binding host and the database is now hosted with a volumeClaimTemplates</p><pre><code>  ports:
  - name: proxy
    nodePort: 30080
    port: 80
    protocol: TCP
    targetPort: 8000
  - name: proxy-ssl
    nodePort: 30443
    port: 443
    protocol: TCP
    targetPort: 8443
  - name: admin
    port: 8100
    protocol: TCP
    targetPort: 8100
  - name: admin-ssl
    port: 8444
    protocol: TCP
    targetPort: 8444
  selector:
    app: ingress-kong
  type: LoadBalancer
</code></pre><pre><code>      containers:
      - env:
        - name: KONG_DATABASE
          value: postgres
        - name: KONG_PG_HOST
          value: postgres
        - name: KONG_PG_PASSWORD
          value: kong
        - name: KONG_PROXY_LISTEN
          value: 0.0.0.0:8000, 0.0.0.0:8443 ssl http2
        - name: KONG_PORT_MAPS
          value: 80:8000, 443:8443
        - name: KONG_ADMIN_LISTEN
          value: 0.0.0.0:8444 ssl
        - name: KONG_STATUS_LISTEN
          value: 0.0.0.0:8100
</code></pre><pre><code>  volumeClaimTemplates:
  - metadata:
      name: datadir
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 250Mi
</code></pre><p>Here what is expected to see</p><pre><code>$ kubectl get svc -n kong
NAME                      TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                    AGE
kong-proxy                LoadBalancer   10.152.183.55    &lt;pending&gt;     80:30080/TCP,443:30443/TCP,8100:32588/TCP,8444:31793/TCP   7d
kong-validation-webhook   ClusterIP      10.152.183.190   &lt;none&gt;        443/TCP                                                    7d
postgres                  ClusterIP      10.152.183.177   &lt;none&gt;        5432/TCP
</code></pre><p>and the pods needed to have it online</p><pre><code>kong           ingress-kong-686b4bc5df-nm7zk              2/2     Running     4          7d
kong           kong-migrations-ftgdv                      0/1     Completed   0          7d
kong           postgres-0                                 1/1     Running     2          7d
kube-system    hostpath-provisioner-5c65fbdb4f-f5qsb      1/1     Running     6          40d
</code></pre><pre><code>NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS        AGE
datadir-postgres-0   Bound    pvc-8c5791c3-939f-4457-b5fb-74ac417ca3d7   250Mi        RWO                 k8s-hostpath   7d
</code></pre><p><br><br></p><p>Now i'd like to have also an Admin UI, i'm not fan of web ui ,<br>however i need to know if this interface could be shared outside IT<br>to delegate some business ownership and so on.</p><p>Kong Enterprise has it's own web ui instead the community one needs a third party tool... <a href="https://github.com/pantsel/konga">Konga</a></p><p>In the same way of kong, konga needs a database , and in the same way i elaborated a bit the default deployment</p><pre><code>konga
|-- 01-ns-konga.yaml
|-- 02-svc-konga.yaml
|-- 03-ing-konga.yaml
`-- 04-dpl-konga.yaml
</code></pre><p>just a couple of TIPS</p><p>postgres persistent storage</p><pre><code>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  namespace: konga
  name: konga-pv-claim
  labels:
    app: konga-storage-claim
spec:
  storageClassName: microk8s-hostpath
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 200Mi
</code></pre><p>and on deployment ...</p><pre><code>        env:
        - name: NODE_TLS_REJECT_UNAUTHORIZED
          value: "0"
        - name: NODE_ENV
          value: "production"
</code></pre><p>where NODE_TLS_REJECT_UNAUTHORIZED is the option to not verify the kong api certificate and<br>NODE_ENV is way to enable production or development , if you are not using production, the other two option enables the debug model and increase the cpu usage, i suggest to use production anyway <strong>during the first deploy you should enable development in order to bootstrap the sql schema</strong> that production is not able to do ... or create an init container to deploy the schema</p><p><code>konga konga-stable-8957b9d85-tq72z 2/2 Running 2 6d3h</code></p><p>since is now up and running it will be available on the standard infrastructure ingress</p><pre><code>  - host: konga.ing.h4x0r3d.lan
</code></pre><p>Konga Home <a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/0f76d690a796607e512cffaaf5f1405516e613575ecdf562d91399e1c646b05b/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737373233372f6d6973632f6b6f6e67615f75692e706e67"><amp-img title="konga_home" src="https://camo.githubusercontent.com/0f76d690a796607e512cffaaf5f1405516e613575ecdf562d91399e1c646b05b/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737373233372f6d6973632f6b6f6e67615f75692e706e67" data-is-external-image="true" alt="konga_home" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1604777237/misc/konga_ui.png" layout="responsive"></amp-img></a></p><p>Konga node configuration <a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/cda833f675290b3538fa9b4e4d49f8c91ea586bae71505e705d7646646b30fa8/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737373233382f6d6973632f6b6f6e67615f75695f6b6f6e676e6f64652e706e67"><amp-img title="konga_node" src="https://camo.githubusercontent.com/cda833f675290b3538fa9b4e4d49f8c91ea586bae71505e705d7646646b30fa8/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737373233382f6d6973632f6b6f6e67615f75695f6b6f6e676e6f64652e706e67" data-is-external-image="true" alt="konga_node" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1604777238/misc/konga_ui_kongnode.png" layout="responsive"></amp-img></a></p><p><br><br></p><ul><li>kong [INSTALLED]</li><li>konga [INSTALLED]</li><li>backend [INSTALLED]</li></ul><p>First of all we need to expose the backend with Kong in this example i created an ingress configuration dedicated for this porpose</p><pre><code>apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/ingress.class: "kong"
  name: api
  namespace: pytbak
  labels:
    app: api
spec:
  rules:
    - host: api.ing.h4x0r3d.lan
      http:
        paths:
          - path: /api/
            backend:
              serviceName: pytbak-svc
              servicePort: 5000
          - path: /api/get/
            backend:
              serviceName: pytbak-svc
              servicePort: 5000
          - path: /api/post/
            backend:
              serviceName: pytbak-svc
              servicePort: 5000
          - path: /api/put/
            backend:
              serviceName: pytbak-svc
              servicePort: 5000
          - path: /api/delete/
            backend:
              serviceName: pytbak-svc
              servicePort: 5000
</code></pre><p><code>kubernetes.io/ingress.class: "kong" </code>to match the kong ingress on the backend application <code>namespace: pytbak</code>.<br>As you can see i created mutiple paths to simulate different applications behind and create different ruls per path/application/context.</p><p>The kong configuration could be applied with</p><ul><li>kubernetes yaml</li><li>kong api</li><li>konga ui (only if you have the database)</li></ul><p>In the repo you will see some in kubernetes and some other not present , i tested the three option and the <strong>kong api</strong> is the best one</p><p><br><br>Create api user</p><p><code>curl -k -i -X POST --url https://192.168.1.14:31793/consumers/ --data "username=slow_user"</code></p><pre><code>HTTP/1.1 201 Created
Date: Sat, 07 Nov 2020 19:46:05 GMT
Content-Type: application/json; charset=utf-8
Connection: keep-alive
Access-Control-Allow-Origin: *
Server: kong/2.1.4
Content-Length: 121
X-Kong-Admin-Latency: 16
</code></pre><p><code>{"custom_id":null,"created_at":1604778365,"id":"3d45a73d-4024-4813-b356-43a14ecea702","tags":null,"username":"slow_user"}</code> <a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/34bd577bcb080782018378247fac228663f6c4508bfc1191f173a07d9f731e28/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737383930332f6d6973632f6b6f6e67615f636f6e73756d65722e706e67"><amp-img title="konga_consumer" src="https://camo.githubusercontent.com/34bd577bcb080782018378247fac228663f6c4508bfc1191f173a07d9f731e28/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737383930332f6d6973632f6b6f6e67615f636f6e73756d65722e706e67" data-is-external-image="true" alt="konga_consumer" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1604778903/misc/konga_consumer.png" layout="responsive"></amp-img></a></p><p><br><br>add a key token with key-auth plugin</p><p><code>curl -k -i -X POST --url https://192.168.1.14:31793/consumers/slow_user/key-auth/ --data 'key=332d05445a560ee65a76aeaa372d8904'</code></p><pre><code>HTTP/1.1 201 Created
Date: Sat, 07 Nov 2020 19:51:03 GMT
Content-Type: application/json; charset=utf-8
Connection: keep-alive
Access-Control-Allow-Origin: *
Server: kong/2.1.4
Content-Length: 190
X-Kong-Admin-Latency: 10
</code></pre><p><code>{"created_at":1604778663,"id":"52970ca8-848d-49b5-a16f-a235fe0e9ceb","tags":null,"ttl":null,"key":"332d05445a560ee65a76aeaa372d8904","consumer":{"id":"3d45a73d-4024-4813-b356-43a14ecea702"}}</code> <a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/2a45dbea6ede1ac159c1950a65f518aa347650b73efa3539a0edc11f8dbee793/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737383930332f6d6973632f6b6f6e67615f636f6e73756d65725f63726564656e7469616c2e706e67"><amp-img title="konga_consumer_cred" src="https://camo.githubusercontent.com/2a45dbea6ede1ac159c1950a65f518aa347650b73efa3539a0edc11f8dbee793/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737383930332f6d6973632f6b6f6e67615f636f6e73756d65725f63726564656e7469616c2e706e67" data-is-external-image="true" alt="konga_consumer_cred" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1604778903/misc/konga_consumer_credential.png" layout="responsive"></amp-img></a></p><p><br><br></p><p>routes.id where created when we created the kong ingress configuration for pytbak <code>curl -k -i -X GET https://192.168.1.14:31793/routes/</code></p><p>name: pytbak.api.00   path:/api/   route.id: 0a78b572-cfe0-4228-bdfe-639ef04b5117<br>name: pytbak.api.01   path:/api/get/   route.id: 8d2a24aa-636d-43ee-b0aa-b0fd1d3643fd<br>name: pytbak.api.02   path:/api/post/   route.id: f75ed3b6-07c3-4293-932b-4f53d0c38f74<br>name: pytbak.api.03   path:/api/put   route.id: f4823063-04e4-4da8-9c11-21977a93b1ba<br>name: pytbak.api.04   path:/api/delete   route.id: e396750c-9158-4a96-8d79-047197669cff</p><p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/c17c8b10cdcbb8526fdb448c903c6dad6090e4e460de537185e6a04be663c3e4/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737393732302f6d6973632f6b6f6e67615f726f757465732e706e67"><amp-img title="konga_routes" src="https://camo.githubusercontent.com/c17c8b10cdcbb8526fdb448c903c6dad6090e4e460de537185e6a04be663c3e4/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343737393732302f6d6973632f6b6f6e67615f726f757465732e706e67" data-is-external-image="true" alt="konga_routes" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1604779720/misc/konga_routes.png" layout="responsive"></amp-img></a></p><p><br><br>now i'd like to limit the user slow_user to perform only 4 request per sec on /api/<br>and 2 on /api/get/</p><pre><code>$ curl -k -X POST https://192.168.1.14:31793/plugins/ \
&gt;             --data "name=rate-limiting"  \
&gt;             --data "config.second=4" \
&gt;             --data "config.hour=1200" \
&gt;             --data "config.policy=local" \
&gt;             --data "consumer.id=3d45a73d-4024-4813-b356-43a14ecea702" \
&gt;             --data "route.id=0a78b572-cfe0-4228-bdfe-639ef04b5117"
</code></pre><p><code>{"created_at":1604780031,"id":"cfd3d752-7864-493c-a3b7-3970ab6eca86","tags":null,"enabled":true,"protocols":["grpc","grpcs","http","https"],"name":"rate-limiting","consumer":{"id":"3d45a73d-4024-4813-b356-43a14ecea702"},"service":null,"route":{"id":"0a78b572-cfe0-4228-bdfe-639ef04b5117"},"config":{"hide_client_headers":false,"minute":null,"policy":"local","month":null,"redis_timeout":2000,"limit_by":"consumer","redis_password":null,"second":4,"day":null,"redis_database":0,"year":null,"hour":1200,"redis_host":null,"redis_port":6379,"header_name":null,"fault_tolerant":true}}</code></p><pre><code>curl -k -X POST https://192.168.1.14:31793/plugins/ \
                --data "name=rate-limiting"  \
                --data "config.second=2" \
                --data "config.hour=600" \
                --data "config.policy=local" \
                --data "consumer.id=3d45a73d-4024-4813-b356-43a14ecea702" \
                --data "route.id=8d2a24aa-636d-43ee-b0aa-b0fd1d3643fd" 
</code></pre><p><code>{"created_at":1604780101,"id":"33bfc138-776a-4116-a2a9-8c70ab9d7a2a","tags":null,"enabled":true,"protocols":["grpc","grpcs","http","https"],"name":"rate-limiting","consumer":{"id":"3d45a73d-4024-4813-b356-43a14ecea702"},"service":null,"route":{"id":"8d2a24aa-636d-43ee-b0aa-b0fd1d3643fd"},"config":{"hide_client_headers":false,"minute":null,"policy":"local","month":null,"redis_timeout":2000,"limit_by":"consumer","redis_password":null,"second":2,"day":null,"redis_database":0,"year":null,"hour":600,"redis_host":null,"redis_port":6379,"header_name":null,"fault_tolerant":true}}</code></p><p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/31f166746c62aae6fda1d4e1bdb7a85ec1683afd6bdf2d859baf6150883e302e/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343738303230302f6d6973632f6b6f6e67615f726174655f6c696d69745f726f757465732e706e67"><amp-img title="konga_rate_routes" src="https://camo.githubusercontent.com/31f166746c62aae6fda1d4e1bdb7a85ec1683afd6bdf2d859baf6150883e302e/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313630343738303230302f6d6973632f6b6f6e67615f726174655f6c696d69745f726f757465732e706e67" data-is-external-image="true" alt="konga_rate_routes" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1604780200/misc/konga_rate_limit_routes.png" layout="responsive"></amp-img></a></p><p><br><br></p><h2><a id="user-content-use-cases" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#use-cases"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Use cases</h2><p>I created 3 users , one on the example above and a new one with a double of requests per second</p><table><thead><tr><th>route</th><th align="center">slow_user rate/s</th><th>fast_user rate/s</th></tr></thead><tbody><tr><td>/api/</td><td align="center">4</td><td>8</td></tr><tr><td>/api/get/</td><td align="center">2</td><td>4</td></tr><tr><td>/api/post/</td><td align="center">1</td><td>2</td></tr><tr><td>/api/put/</td><td align="center">1</td><td>2</td></tr><tr><td>/api/delete/</td><td align="center">1</td><td>2</td></tr></tbody></table><p><br><br>slow_user has apikey: 332d05445a560ee65a76aeaa372d8904<br>fast_user has apikey: 695aa0b18c6dbd1b387ee7c32c72c513<br>admin has a apikey: admin</p><p><br><br>i've also created a global rules on the service with max 9 reqquest per second for all other users with no specific rate limit rule applied (ex admin.)</p><p><code>$ curl -k -X POST https://192.168.1.14:31793/plugins --data "name=rate-limiting" --data "config.second=9" --data "config.policy=local" --data "service.id=53d35e73-b285-4eb2-ad24-853d82563ca4"</code></p><pre><code>{"created_at":1604786501,"id":"34182311-ecbf-49a3-bdcf-bdc1c9c58706","tags":null,"enabled":true,"protocols":["grpc","grpcs","http","https"],"name":"rate-limiting","consumer":null,"service":{"id":"53d35e73-b285-4eb2-ad24-853d82563ca4"},"route":null,"config":{"hide_client_headers":false,"minute":null,"policy":"local","month":null,"redis_timeout":2000,"limit_by":"consumer","redis_password":null,"second":9,"day":null,"redis_database":0,"year":null,"hour":null,"redis_host":null,"redis_port":6379,"header_name":null,"fault_tolerant":true}}
</code></pre><p>Using siege i've benchmarked the users</p><p><a target="_blank" rel="noopener noreferrer" href="https://camo.githubusercontent.com/ee42763f67ce2c6a3e6f97b945740f70bf12d80bc251a6fd1266b07cf10d68f9/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343738373237302f6d6973632f73696567655f75736572732e706e67"><amp-img title="siege_users" src="https://camo.githubusercontent.com/ee42763f67ce2c6a3e6f97b945740f70bf12d80bc251a6fd1266b07cf10d68f9/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313630343738373237302f6d6973632f73696567655f75736572732e706e67" data-is-external-image="true" alt="siege_users" data-canonical-src="https://res.cloudinary.com/ethzero/image/upload/v1604787270/misc/siege_users.png" layout="responsive"></amp-img></a></p><p>You can check the headers with curl<br><code>$ while true; do curl -I -H "apikey:332d05445a560ee65a76aeaa372d8904" http://api.ing.h4x0r3d.lan:30080/api/ &amp;&amp; sleep 0.2; done</code></p><pre><code>HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Content-Length: 658
Connection: keep-alive
Server: Werkzeug/1.0.1 Python/3.9.0
Date: Sat, 07 Nov 2020 22:21:34 GMT
X-RateLimit-Limit-Second: 4
X-RateLimit-Remaining-Second: 3
X-RateLimit-Limit-Hour: 1000000
RateLimit-Limit: 4
X-RateLimit-Remaining-Hour: 999755
RateLimit-Remaining: 3
RateLimit-Reset: 1
X-Kong-Upstream-Latency: 3
X-Kong-Proxy-Latency: 1
Via: kong/2.1.4

HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Content-Length: 658
Connection: keep-alive
Server: Werkzeug/1.0.1 Python/3.9.0
Date: Sat, 07 Nov 2020 22:21:34 GMT
X-RateLimit-Limit-Second: 4
X-RateLimit-Remaining-Second: 2
X-RateLimit-Limit-Hour: 1000000
RateLimit-Limit: 4
X-RateLimit-Remaining-Hour: 999754
RateLimit-Remaining: 2
RateLimit-Reset: 1
X-Kong-Upstream-Latency: 3
X-Kong-Proxy-Latency: 0
Via: kong/2.1.4

HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Content-Length: 658
Connection: keep-alive
Server: Werkzeug/1.0.1 Python/3.9.0
Date: Sat, 07 Nov 2020 22:21:34 GMT
X-RateLimit-Limit-Second: 4
X-RateLimit-Remaining-Second: 1
X-RateLimit-Limit-Hour: 1000000
RateLimit-Limit: 4
X-RateLimit-Remaining-Hour: 999753
RateLimit-Remaining: 1
RateLimit-Reset: 1
X-Kong-Upstream-Latency: 3
X-Kong-Proxy-Latency: 1
Via: kong/2.1.4

HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Content-Length: 658
Connection: keep-alive
Server: Werkzeug/1.0.1 Python/3.9.0
Date: Sat, 07 Nov 2020 22:21:34 GMT
X-RateLimit-Limit-Second: 4
X-RateLimit-Remaining-Second: 0
X-RateLimit-Limit-Hour: 1000000
RateLimit-Limit: 4
X-RateLimit-Remaining-Hour: 999752
RateLimit-Remaining: 0
RateLimit-Reset: 1
X-Kong-Upstream-Latency: 3
X-Kong-Proxy-Latency: 1
Via: kong/2.1.4

HTTP/1.1 429 Too Many Requests
Date: Sat, 07 Nov 2020 22:21:34 GMT
Content-Type: application/json; charset=utf-8
Connection: keep-alive
Retry-After: 1
Content-Length: 41
X-RateLimit-Limit-Second: 4
X-RateLimit-Remaining-Second: 0
X-RateLimit-Limit-Hour: 1000000
RateLimit-Limit: 4
X-RateLimit-Remaining-Hour: 999752
RateLimit-Remaining: 0
RateLimit-Reset: 1
X-Kong-Response-Latency: 1
Server: kong/2.1.4
</code></pre><p><br><br></p><h3><a id="user-content-rules-precedence" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#rules-precedence"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Rules Precedence</h3><p>A plugin will always be run once and only once per request. But the configuration with which it will run depends on the entities it has been configured for.</p><p>Plugins can be configured for various entities, combination of entities, or even globally. This is useful, for example, when you wish to configure a plugin a certain way for most requests, but make authenticated requests behave slightly differently.</p><p>Therefore, there exists an order of precedence for running a plugin when it has been applied to different entities with different configurations. The rule of thumb is: the more specific a plugin is with regards to how many entities it has been configured on, the higher its priority.</p><p>The complete order of precedence when a plugin has been configured multiple times is:</p><ol><li>Plugins configured on a combination of: a Route, a Service, and a Consumer. (Consumer means the request must be authenticated).</li><li>Plugins configured on a combination of a Route and a Consumer. (Consumer means the request must be authenticated).</li><li>Plugins configured on a combination of a Service and a Consumer. (Consumer means the request must be authenticated).</li><li>Plugins configured on a combination of a Route and a Service.</li><li>Plugins configured on a Consumer. (Consumer means the request must be authenticated).</li><li>Plugins configured on a Route.</li><li>Plugins configured on a Service.</li><li>Plugins configured to run globally.</li></ol><p>Example: if the rate-limiting plugin is applied twice (with different configurations): for a Service (Plugin config A), and for a Consumer (Plugin config B), then requests authenticating this Consumer will run Plugin config B and ignore A. However, requests that do not authenticate this Consumer will fallback to running Plugin config A. Note that if config B is disabled (its enabled flag is set to false), config A will apply to requests that would have otherwise matched config B.</p><p><br><br></p><h3><a id="user-content-waf" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#waf"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>WAF</h3><p>Last but not lease , the api is configured behind Cloudflare,</p><p>the users <code>slow_user fast_user</code> are available in case you want to test directly the service.</p><p>Endpoint: <code>https://services.k8s.it/api/</code></p><p><br><br></p><p><code>$ curl -I -H "apikey:332d05445a560ee65a76aeaa372d8904" https://services.k8s.it/api/</code></p><pre><code>HTTP/2 200
date: Sun, 08 Nov 2020 10:14:21 GMT
content-type: text/html; charset=utf-8
set-cookie: __cfduid=dab5b88be5427314b7b17a1a65d3178a41604830461; expires=Tue, 08-Dec-20 10:14:21 GMT; path=/; domain=.k8s.it; HttpOnly; SameSite=Lax
vary: Accept-Encoding
x-ratelimit-limit-second: 4
x-ratelimit-remaining-second: 3
x-ratelimit-limit-hour: 1000000
ratelimit-limit: 4
x-ratelimit-remaining-hour: 999995
ratelimit-remaining: 3
ratelimit-reset: 1
x-kong-upstream-latency: 3
x-kong-proxy-latency: 4
via: kong/2.1.4
cf-cache-status: DYNAMIC
cf-request-id: 0648f2980000000f72931c2000000001
expect-ct: max-age=604800, report-uri="https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct"
report-to: {"endpoints":[{"url":"https:\/\/a.nel.cloudflare.com\/report?s=z4j%2FU3og%2FT2jBByhUKZtShDNLfLMWncExIy3EowJ2hOPJ17oCB0oeyY1GVaXirT%2BgWpTEEuU%2F03gx%2F91uOy3mGD%2BFE4FhBGqFt7iC2bhaPc%3D"}],"group":"cf-nel","max_age":604800}
nel: {"report_to":"cf-nel","max_age":604800}
server: cloudflare
cf-ray: 5eee86d319770f72-MXP
</code></pre><p><br><br></p><h2><a id="user-content-conclusion" class="anchor" aria-hidden="true" href="https://github.com/lorenzogirardi/Kubernetes-apigw#conclusion"><svg class="octicon octicon-link" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Conclusion</h2><p>Kong is a scalable, open source API Gateway.<br>Kong runs in front of any RESTful API and is extended through Plugins, which provide extra functionality and services beyond the core platform.</p><p>The architecture is quite simple to understand and is made up of a few components…</p><ul><li>Kong base-module which wraps OpenResty and Nginx and is the engine which does the actual work</li><li>Database layer with choice of Cassandra or Postgres to store all the configuration so it can be retrieved easily in case of failures</li><li>Dashboard which provides User-Interface for API administration and viewing analytics (embedded in th Enerprise, third party for the community <em>Konga</em>)</li></ul><p>The Powerful of Kong is also supported by plugins from authentication, security, traffic control, logging, and etc…</p><p><br><br></p><p>If your business exposes APIs, the API GATEWAY is a required to handle the third party.</p><aside><ul class="post-tag"><li><a href="https://www.k8s.it/amp/api-key/">api key</a></li><li><a href="https://www.k8s.it/amp/api-gateway/">api-gateway</a></li><li><a href="https://www.k8s.it/amp/auth/">auth</a></li><li><a href="https://www.k8s.it/amp/kong/">kong</a></li><li><a href="https://www.k8s.it/amp/konga/">konga</a></li><li><a href="https://www.k8s.it/amp/kubernetes/">kubernetes</a></li><li><a href="https://www.k8s.it/amp/rate-limit/">rate limit</a></li></ul><div class="post-share"><amp-social-share type="system" width="40" height="40" data-param-text="Kubernetes-apigw"></amp-social-share><amp-social-share type="facebook" width="40" height="40" data-param-app_id="" data-param-text="Kubernetes-apigw" data-param-href="https://www.k8s.it/amp/kubernetes-apigw.html"></amp-social-share><amp-social-share type="twitter" width="40" height="40" data-param-text="Kubernetes-apigw" data-param-url="https://www.k8s.it/amp/kubernetes-apigw.html"></amp-social-share><amp-social-share type="pinterest" width="40" height="40" data-param-url="https://www.k8s.it/amp/kubernetes-apigw.html"></amp-social-share><amp-social-share type="tumblr" width="40" height="40" data-param-text="Kubernetes-apigw" data-param-url="https://www.k8s.it/amp/kubernetes-apigw.html"></amp-social-share><amp-social-share type="whatsapp" width="40" height="40" data-param-text="Kubernetes-apigw"></amp-social-share></div></aside></div></article><nav class="post-pagination wrap-inner"><div class="post-pagination-prev"><span>Previous</span> <a href="https://www.k8s.it/amp/python-rest-api-test-application.html">Python rest api test application</a></div></nav></main><amp-animation id="showAnim" layout="nodisplay"><script type="application/json">{
                    "duration": "200ms",
                    "fill": "both",
                    "iterations": "1",
                    "direction": "alternate",
                    "animations": [{
                        "selector": ".post-scroll",
                        "keyframes": [{
                            "opacity": "1",
                            "visibility": "visible",
                            "transform": "scale(1)"
                        }]
                    }]
                }</script></amp-animation><amp-animation id="hideAnim" layout="nodisplay"><script type="application/json">{
                    "duration": "200ms",
                    "fill": "both",
                    "iterations": "1",
                    "direction": "alternate",
                    "animations": [{
                        "selector": ".post-scroll",
                        "keyframes": [{
                            "opacity": "0",
                            "visibility": "hidden",
                            "transform": "scale(0.1)"
                        }]
                    }]
                }</script></amp-animation><div class="post-scroll-marker"><amp-position-observer on="enter:hideAnim.start; exit:showAnim.start" layout="nodisplay"></amp-position-observer></div><button class="post-scroll" on="tap:top.scrollTo(duration=200)">&#8593;</button><footer class="bottom">Powered by Publii</footer><amp-sidebar id="navbar-sidebar" layout="nodisplay"><ul><li><a href="https://www.linkedin.com/in/lgirardi/">linkedin</a></li><li><a href="https://services.k8s.it/grafana/?orgId&#x3D;2">live monitoring</a></li><li><a href="https://www.k8s.it/amp/whoami.html">whoami</a></li></ul></amp-sidebar></body></html>