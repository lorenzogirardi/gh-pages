{
    "version": "https://jsonfeed.org/version/1",
    "title": "LAB",
    "description": "",
    "home_page_url": "https://www.k8s.it",
    "feed_url": "https://www.k8s.it/feed.json",
    "user_comment": "",
    "author": {
        "name": "lgirardi"
    },
    "items": [
        {
            "id": "https://www.k8s.it/building-a-scalable-image-cdn-with-minio-imgproxy-and-cloudflare.html",
            "url": "https://www.k8s.it/building-a-scalable-image-cdn-with-minio-imgproxy-and-cloudflare.html",
            "title": "Building a Scalable Image CDN with MinIO, imgproxy, and Cloudflare",
            "summary": "Intro In today's digital landscape, efficiently serving images is critical for website performance. Users expect fast-loading, responsive websites, and images often account for the majority of a page's weight. In this article, I'll walk you through building a powerful, scalable image CDN using open-source tools&hellip;",
            "content_html": "<div tabindex=\"0\">\n<div class=\"grid-cols-1 grid gap-2.5 [&amp;_&gt;_*]:min-w-0 !gap-3.5\">\n<h1 id=\"mcetoc_1ipkej97e16a\"></h1>\n<h1 id=\"mcetoc_1ipkej97e16b\"></h1>\n<div class=\"post__toc\">\n<h3>Table of Contents</h3>\n<ul>\n<li><a href=\"#mcetoc_1ipkej97e16c\">Intro</a></li>\n<li><a href=\"#mcetoc_1ipkej97e16d\">The Architecture</a></li>\n<li><a href=\"#mcetoc_1ipkej97e16e\">How It Works</a></li>\n<li><a href=\"#mcetoc_1ipkej97e16f\">Setting Up MinIO</a></li>\n<li><a href=\"#mcetoc_1ipkej97e16g\">Setting Up imgproxy</a></li>\n<li><a href=\"#mcetoc_1ipkej97e16h\">Setting Up Cloudflare as CDN</a></li>\n<li><a href=\"#mcetoc_1ipkej97e16i\">Usage Examples</a></li>\n<li><a href=\"#mcetoc_1ipkej97e16j\">Security Considerations</a></li>\n<li><a href=\"#mcetoc_1ipkej97e16k\">Performance Optimization</a></li>\n<li><a href=\"#mcetoc_1ipkej97e16l\">Monitoring and Maintenance</a></li>\n<li><a href=\"#mcetoc_1ipkej97e16m\">Conclusion</a></li>\n</ul>\n</div>\n<h2 id=\"mcetoc_1ipkej97e16c\" class=\"text-2xl font-bold mt-1 text-text-100\"><br>Intro</h2>\n<p class=\"whitespace-pre-wrap break-words\">In today's digital landscape, efficiently serving images is critical for website performance. Users expect fast-loading, responsive websites, and images often account for the majority of a page's weight. In this article, I'll walk you through building a powerful, scalable image CDN using open-source tools that you can deploy in your own infrastructure.</p>\n<h2 id=\"mcetoc_1ipkej97e16d\" class=\"text-xl font-bold text-text-100 mt-1 -mb-0.5\">The Architecture</h2>\n<p class=\"whitespace-pre-wrap break-words\">Our image CDN consists of three main components:</p>\n<ol class=\"[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7\">\n<li class=\"whitespace-normal break-words\"><strong>MinIO</strong>: An S3-compatible object storage backend that stores our original images</li>\n<li class=\"whitespace-normal break-words\"><strong>imgproxy</strong>: A fast and secure image processing service that resizes and optimizes images on-the-fly</li>\n<li class=\"whitespace-normal break-words\"><strong>Cloudflare</strong>: Providing CDN capabilities through Cloudflare Tunnel</li>\n</ol>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/45/Screenshot-2025-04-24-at-19.42.20.png\" alt=\"\" width=\"1718\" height=\"670\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.20-xs.webp 640w ,https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.20-sm.webp 768w ,https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.20-md.webp 1024w ,https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.20-lg.webp 1366w ,https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.20-xl.webp 1600w ,https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.20-2xl.webp 1920w\"></figure>\n<p class=\"whitespace-pre-wrap break-words\">This architecture gives us several advantages:</p>\n<ul class=\"[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-disc space-y-1.5 pl-7\">\n<li class=\"whitespace-normal break-words\">On-demand image resizing and optimization</li>\n<li class=\"whitespace-normal break-words\">Edge caching for faster global delivery</li>\n<li class=\"whitespace-normal break-words\">Secure, private storage of original assets</li>\n<li class=\"whitespace-normal break-words\">High scalability and cost-effectiveness</li>\n</ul>\n<h2 id=\"mcetoc_1ipkej97e16e\" class=\"text-xl font-bold text-text-100 mt-1 -mb-0.5\">How It Works</h2>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/45/Screenshot-2025-04-24-at-19.42.47.png\" alt=\"\" width=\"1712\" height=\"996\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.47-xs.webp 640w ,https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.47-sm.webp 768w ,https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.47-md.webp 1024w ,https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.47-lg.webp 1366w ,https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.47-xl.webp 1600w ,https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.47-2xl.webp 1920w\"></figure>\n<p class=\"whitespace-pre-wrap break-words\">The process flow works like this:</p>\n<ol class=\"[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7\">\n<li class=\"whitespace-normal break-words\">Users request an image through our CDN URL</li>\n<li class=\"whitespace-normal break-words\">If Cloudflare has the image cached at the edge, it returns it immediately</li>\n<li class=\"whitespace-normal break-words\">If not cached, the request goes to imgproxy</li>\n<li class=\"whitespace-normal break-words\">imgproxy fetches the original image from MinIO</li>\n<li class=\"whitespace-normal break-words\">imgproxy processes the image according to URL parameters (resize, crop, etc.)</li>\n<li class=\"whitespace-normal break-words\">The processed image is returned through Cloudflare and cached at the edge</li>\n</ol>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/45/Screenshot-2025-04-24-at-19.42.31.png\" alt=\"\" width=\"1638\" height=\"1274\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.31-xs.webp 640w ,https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.31-sm.webp 768w ,https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.31-md.webp 1024w ,https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.31-lg.webp 1366w ,https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.31-xl.webp 1600w ,https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.31-2xl.webp 1920w\"></figure>\n<h2 id=\"mcetoc_1ipkej97e16f\" class=\"text-xl font-bold text-text-100 mt-1 -mb-0.5\">Setting Up MinIO</h2>\n<p class=\"whitespace-pre-wrap break-words\">MinIO is an open-source, S3-compatible object storage server that we'll use to store our original images. Let's deploy it on Kubernetes:</p>\n<div class=\"relative group/copy rounded-lg\">\n<div class=\"sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right\">\n<div class=\"absolute right-0 h-8 px-2 items-center inline-flex\">\n<div class=\"relative\"> </div>\n</div>\n</div>\n<div class=\"\">\n<pre class=\"code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed\"><code class=\"language-yaml\"><span class=\"token key\">apiVersion</span><span class=\"token\">:</span> apps/v1\n<span class=\"token key\">kind</span><span class=\"token\">:</span> Deployment\n<span class=\"token key\">metadata</span><span class=\"token\">:</span>\n  <span class=\"token key\">name</span><span class=\"token\">:</span> minio<span class=\"token\">-</span>deployment\n  <span class=\"token key\">namespace</span><span class=\"token\">:</span> minio\n<span class=\"token key\">spec</span><span class=\"token\">:</span>\n  <span class=\"token key\">replicas</span><span class=\"token\">:</span> <span class=\"token\">1</span>\n  <span class=\"token key\">selector</span><span class=\"token\">:</span>\n    <span class=\"token key\">matchLabels</span><span class=\"token\">:</span>\n      <span class=\"token key\">app</span><span class=\"token\">:</span> minio\n  <span class=\"token key\">strategy</span><span class=\"token\">:</span>\n    <span class=\"token key\">type</span><span class=\"token\">:</span> Recreate\n  <span class=\"token key\">template</span><span class=\"token\">:</span>\n    <span class=\"token key\">metadata</span><span class=\"token\">:</span>\n      <span class=\"token key\">labels</span><span class=\"token\">:</span>\n        <span class=\"token key\">app</span><span class=\"token\">:</span> minio\n    <span class=\"token key\">spec</span><span class=\"token\">:</span>\n      <span class=\"token key\">volumes</span><span class=\"token\">:</span>\n      <span class=\"token\">-</span> <span class=\"token key\">name</span><span class=\"token\">:</span> storage\n        <span class=\"token key\">persistentVolumeClaim</span><span class=\"token\">:</span>\n          <span class=\"token key\">claimName</span><span class=\"token\">:</span> minio<span class=\"token\">-</span>pv<span class=\"token\">-</span>claim\n      <span class=\"token key\">containers</span><span class=\"token\">:</span>\n      <span class=\"token\">-</span> <span class=\"token key\">name</span><span class=\"token\">:</span> minio\n        <span class=\"token key\">image</span><span class=\"token\">:</span> minio/minio<span class=\"token\">:</span>latest\n        <span class=\"token key\">args</span><span class=\"token\">:</span>\n        <span class=\"token\">-</span> server\n        <span class=\"token\">-</span> /storage\n        <span class=\"token key\">env</span><span class=\"token\">:</span>\n        <span class=\"token\">-</span> <span class=\"token key\">name</span><span class=\"token\">:</span> MINIO_ACCESS_KEY\n          <span class=\"token key\">value</span><span class=\"token\">:</span> <span class=\"token\">\"PLACEHOLDER\"</span>\n        <span class=\"token\">-</span> <span class=\"token key\">name</span><span class=\"token\">:</span> MINIO_SECRET_KEY\n          <span class=\"token key\">value</span><span class=\"token\">:</span> <span class=\"token\">\"PLACEHOLDER\"</span>\n        <span class=\"token\">-</span> <span class=\"token key\">name</span><span class=\"token\">:</span> MINIO_DOMAIN\n          <span class=\"token key\">value</span><span class=\"token\">:</span> minio-ingress\n        <span class=\"token key\">ports</span><span class=\"token\">:</span>\n        <span class=\"token\">-</span> <span class=\"token key\">containerPort</span><span class=\"token\">:</span> <span class=\"token\">9000</span>\n          <span class=\"token key\">hostPort</span><span class=\"token\">:</span> <span class=\"token\">9000</span>\n        <span class=\"token key\">volumeMounts</span><span class=\"token\">:</span>\n        <span class=\"token\">-</span> <span class=\"token key\">name</span><span class=\"token\">:</span> storage\n          <span class=\"token key\">mountPath</span><span class=\"token\">:</span> <span class=\"token\">\"/storage\"</span></code></pre>\n</div>\n</div>\n<p class=\"whitespace-pre-wrap break-words\">We also need a persistent volume claim to store our data:</p>\n<div class=\"relative group/copy rounded-lg\">\n<div class=\"\">\n<pre class=\"code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed\"><code class=\"language-yaml\"><span class=\"token key\">apiVersion</span><span class=\"token\">:</span> v1\n<span class=\"token key\">kind</span><span class=\"token\">:</span> PersistentVolumeClaim\n<span class=\"token key\">metadata</span><span class=\"token\">:</span>\n  <span class=\"token key\">namespace</span><span class=\"token\">:</span> minio\n  <span class=\"token key\">name</span><span class=\"token\">:</span> minio<span class=\"token\">-</span>pv<span class=\"token\">-</span>claim\n  <span class=\"token key\">labels</span><span class=\"token\">:</span>\n    <span class=\"token key\">app</span><span class=\"token\">:</span> minio<span class=\"token\">-</span>storage<span class=\"token\">-</span>claim\n<span class=\"token key\">spec</span><span class=\"token\">:</span>\n  <span class=\"token key\">storageClassName</span><span class=\"token\">:</span> microk8s<span class=\"token\">-</span>hostpath\n  <span class=\"token key\">accessModes</span><span class=\"token\">:</span>\n    <span class=\"token\">-</span> ReadWriteOnce\n  <span class=\"token key\">resources</span><span class=\"token\">:</span>\n    <span class=\"token key\">requests</span><span class=\"token\">:</span>\n      <span class=\"token key\">storage</span><span class=\"token\">:</span> 1Gi</code></pre>\n</div>\n</div>\n<p class=\"whitespace-pre-wrap break-words\">And a service to expose MinIO:</p>\n<div class=\"relative group/copy rounded-lg\">\n<div class=\"\">\n<pre class=\"code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed\"><code class=\"language-yaml\"><span class=\"token key\">apiVersion</span><span class=\"token\">:</span> v1\n<span class=\"token key\">kind</span><span class=\"token\">:</span> Service\n<span class=\"token key\">metadata</span><span class=\"token\">:</span>\n  <span class=\"token key\">name</span><span class=\"token\">:</span> minio<span class=\"token\">-</span>svc\n  <span class=\"token key\">namespace</span><span class=\"token\">:</span> minio\n  <span class=\"token key\">labels</span><span class=\"token\">:</span>\n    <span class=\"token key\">app</span><span class=\"token\">:</span> minio\n<span class=\"token key\">spec</span><span class=\"token\">:</span>\n  <span class=\"token key\">ports</span><span class=\"token\">:</span>\n  <span class=\"token\">-</span> <span class=\"token key\">name</span><span class=\"token\">:</span> http\n    <span class=\"token key\">port</span><span class=\"token\">:</span> <span class=\"token\">9000</span>\n    <span class=\"token key\">targetPort</span><span class=\"token\">:</span> <span class=\"token\">9000</span>\n  <span class=\"token\">-</span> <span class=\"token key\">name</span><span class=\"token\">:</span> console\n    <span class=\"token key\">port</span><span class=\"token\">:</span> <span class=\"token\">9001</span>\n    <span class=\"token key\">targetPort</span><span class=\"token\">:</span> <span class=\"token\">9001</span>\n  <span class=\"token key\">selector</span><span class=\"token\">:</span>\n    <span class=\"token key\">app</span><span class=\"token\">:</span> minio\n  <span class=\"token key\">type</span><span class=\"token\">:</span> ClusterIP</code></pre>\n</div>\n</div>\n<h2 id=\"mcetoc_1ipkej97e16g\" class=\"text-xl font-bold text-text-100 mt-1 -mb-0.5\">Setting Up imgproxy</h2>\n<p class=\"whitespace-pre-wrap break-words\">imgproxy is a fast and secure standalone server for resizing and processing images. We'll install it using Helm:</p>\n<div class=\"relative group/copy rounded-lg\">\n<div class=\"\">\n<pre class=\"code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed\"><code class=\"language-bash\">helm repo <span class=\"token\">add</span> imgproxy https://imgproxy.github.io/imgproxy-helm\nhelm <span class=\"token\">install</span> imgproxy imgproxy/imgproxy -n imgproxy</code></pre>\n</div>\n</div>\n<p class=\"whitespace-pre-wrap break-words\">Then we need to configure it to connect to our MinIO backend through environment variables. These are the critical settings:</p>\n<div class=\"relative group/copy rounded-lg\">\n<div class=\"sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right\">\n<div class=\"absolute right-0 h-8 px-2 items-center inline-flex\">\n<div class=\"relative\"> </div>\n</div>\n</div>\n<div class=\"\">\n<pre class=\"code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed\"><code>IMGPROXY_USE_S3: true\nIMGPROXY_S3_ENDPOINT: http://minio-service:9000/\nIMGPROXY_S3_BUCKET: images\nIMGPROXY_S3_REGION: local\nAWS_ACCESS_KEY_ID: PLACEHOLDER\nAWS_SECRET_ACCESS_KEY: PLACEHOLDER\nIMGPROXY_USE_S3_FORCE_PATH_STYLE: true\nIMGPROXY_ALLOW_UNSAFE_URLS: true</code></pre>\n</div>\n</div>\n<p class=\"whitespace-pre-wrap break-words\">Other important imgproxy settings include:</p>\n<div class=\"relative group/copy rounded-lg\">\n<div class=\"sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right\">\n<div class=\"absolute right-0 h-8 px-2 items-center inline-flex\">\n<div class=\"relative\"> </div>\n</div>\n</div>\n<div class=\"\">\n<pre class=\"code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed\"><code>IMGPROXY_QUALITY: 80\nIMGPROXY_MAX_SRC_RESOLUTION: 16.8 (controls max source image size in megapixels)\nIMGPROXY_STRIP_METADATA: true\nIMGPROXY_STRIP_COLOR_PROFILE: true</code></pre>\n</div>\n</div>\n<h2 id=\"mcetoc_1ipkej97e16h\" class=\"text-xl font-bold text-text-100 mt-1 -mb-0.5\">Setting Up Cloudflare as CDN</h2>\n<p class=\"whitespace-pre-wrap break-words\">To expose our image processing service to the internet securely, we'll use Cloudflare Tunnels, which provides a secure way to connect your resources to Cloudflare without a public IP.</p>\n<ol class=\"[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7\">\n<li class=\"whitespace-normal break-words\">Install the cloudflared daemon in your cluster</li>\n<li class=\"whitespace-normal break-words\">Configure a Cloudflare Tunnel to point to your imgproxy service</li>\n<li class=\"whitespace-normal break-words\">Create a DNS record in Cloudflare pointing to your tunnel</li>\n</ol>\n<h2 id=\"mcetoc_1ipkej97e16i\" class=\"text-xl font-bold text-text-100 mt-1 -mb-0.5\">Usage Examples</h2>\n<p class=\"whitespace-pre-wrap break-words\">Once everything is set up, you can start serving images with transformations. Here are some example URLs:</p>\n<div class=\"relative group/copy rounded-lg\">\n<div class=\"sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right\">\n<div class=\"absolute right-0 h-8 px-2 items-center inline-flex\">\n<div class=\"relative\"> </div>\n</div>\n</div>\n<div class=\"\">\n<pre class=\"code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed\"><code># Resize to 300x200\nhttps://images.yourdomain.com/unsafe/resize:300:200/plain/s3://bucket/image.jpg\n\n# Resize and crop to 300x300\nhttps://images.yourdomain.com/unsafe/resize:300:300:fill/plain/s3://bucket/image.jpg\n\n# Convert to WebP format\nhttps://images.yourdomain.com/unsafe/format:webp/plain/s3://bucket/image.jpg</code></pre>\n</div>\n</div>\n<h2 id=\"mcetoc_1ipkej97e16j\" class=\"text-xl font-bold text-text-100 mt-1 -mb-0.5\">Security Considerations</h2>\n<ol class=\"[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7\">\n<li class=\"whitespace-normal break-words\">Always use proper authentication for MinIO</li>\n<li class=\"whitespace-normal break-words\">Consider setting up signing keys for imgproxy to prevent URL tampering</li>\n<li class=\"whitespace-normal break-words\">Use Cloudflare security features like WAF and Rate Limiting</li>\n<li class=\"whitespace-normal break-words\">Implement proper CORS settings if serving images to websites on different domains</li>\n</ol>\n<h2 id=\"mcetoc_1ipkej97e16k\" class=\"text-xl font-bold text-text-100 mt-1 -mb-0.5\">Performance Optimization</h2>\n<ol class=\"[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7\">\n<li class=\"whitespace-normal break-words\">Configure appropriate cache TTLs in Cloudflare</li>\n<li class=\"whitespace-normal break-words\">Use Cloudflare's Polish feature in addition to imgproxy's optimizations</li>\n<li class=\"whitespace-normal break-words\">Consider Browser Cache TTL settings</li>\n<li class=\"whitespace-normal break-words\">Enable Brotli compression in Cloudflare</li>\n</ol>\n<h2 id=\"mcetoc_1ipkej97e16l\" class=\"text-xl font-bold text-text-100 mt-1 -mb-0.5\">Monitoring and Maintenance</h2>\n<ol class=\"[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7\">\n<li class=\"whitespace-normal break-words\">Set up monitoring for your MinIO and imgproxy services</li>\n<li class=\"whitespace-normal break-words\">Monitor disk usage on your MinIO server</li>\n<li class=\"whitespace-normal break-words\">Track image processing time and resource usage</li>\n<li class=\"whitespace-normal break-words\">Set up alerts for errors or performance degradation</li>\n</ol>\n<h2 id=\"mcetoc_1ipkej97e16m\" class=\"text-xl font-bold text-text-100 mt-1 -mb-0.5\">Conclusion</h2>\n<p class=\"whitespace-pre-wrap break-words\">Building your own image CDN provides flexibility, cost efficiency, and control over your image assets. By combining MinIO for storage, imgproxy for processing, and Cloudflare for edge delivery, you get a powerful solution that can handle high traffic loads while optimizing images for different devices and connection speeds.</p>\n<p class=\"whitespace-pre-wrap break-words\">This setup is particularly useful for sites with user-generated content, e-commerce platforms, or any website with a large number of images that need to be served in various sizes and formats.</p>\n<p class=\"whitespace-pre-wrap break-words\">The best part is that you maintain complete control over your infrastructure and can scale individual components as needed, while benefiting from the global reach of Cloudflare's CDN network.</p>\n</div>\n</div>\n<div class=\"h-8\"> </div>",
            "author": {
                "name": "lgirardi"
            },
            "tags": [
                   "minio",
                   "kubernetes",
                   "imgproxy",
                   "images",
                   "cloudflare",
                   "cache"
            ],
            "date_published": "2025-04-24T19:50:57+02:00",
            "date_modified": "2025-04-24T19:50:57+02:00"
        },
        {
            "id": "https://www.k8s.it/websocket-cloudflare-tunnel-apache-and-irritation.html",
            "url": "https://www.k8s.it/websocket-cloudflare-tunnel-apache-and-irritation.html",
            "title": "Websocket, Cloudflare tunnel, apache httpd and a bit of security",
            "summary": "Here we are In today's interconnected world, exposing your home lab or self-hosted services to the internet can be both necessary and risky. Traditional methods like port forwarding or VPNs come with their own set of challenges and security concerns. This is where Cloudflare Tunnel&hellip;",
            "content_html": "<div class=\"post__toc\">\n<h3>Table of Contents</h3>\n<ul>\n<li><a href=\"#mcetoc_1ipkcf23cd9\">The Infrastructure Overview</a></li>\n<li><a href=\"#mcetoc_1h6ufv7hs6\">Starting point </a></li>\n<li><a href=\"#mcetoc_1ipkcjle2e7\">Why Cloudflare Tunnel?</a></li>\n<li><a href=\"#mcetoc_1ipkcks8uea\">Setting Up Cloudflared in Kubernetes</a>\n<ul>\n<li><a href=\"#mcetoc_1ipkcf23cdc\">Configuration</a></li>\n<li><a href=\"#mcetoc_1ipkcf23cdd\">Deployment</a></li>\n</ul>\n</li>\n<li><a href=\"#mcetoc_1ipkcllt0ec\">How the Traffic Flows: Sequence Diagram</a></li>\n<li><a href=\"#mcetoc_1ipkcjle2e8\">Security Considerations</a>\n<ul>\n<li><a href=\"#mcetoc_1ipkcf23cdh\">1. Cloudflare WAF Protection</a></li>\n<li><a href=\"#mcetoc_1ipkcf23cdi\">2. Zero Trust Network Architecture</a></li>\n<li><a href=\"#mcetoc_1ipkcf23cdj\">3. Defense in Depth</a></li>\n<li><a href=\"#mcetoc_1ipkcf23cdk\">4. Credential Management</a></li>\n<li><a href=\"#mcetoc_1ipkcf23cdl\">5. HTTPS Everywhere</a></li>\n</ul>\n</li>\n<li><a href=\"#mcetoc_1ipkd2pj3k4\">Monitoring and Observability</a></li>\n<li><a href=\"#mcetoc_1ipkd2pj3k5\">Advanced Configurations</a>\n<ul>\n<li><a href=\"#mcetoc_1ipkd2pj3k6\">Load Balancing</a></li>\n<li><a href=\"#mcetoc_1ipkd2pj3k7\">Path-Based Routing</a></li>\n<li><a href=\"#mcetoc_1ipkd2pj3k8\">Apache configuration</a></li>\n</ul>\n</li>\n<li><a href=\"#mcetoc_1ipkd2pj3k9\">Conclusion</a></li>\n</ul>\n</div>\n<p>Here we are</p>\n<h2 id=\"mcetoc_1ipkcf23cd9\" class=\"text-xl font-bold text-text-100 mt-1 -mb-0.5\">The Infrastructure Overview</h2>\n<p class=\"whitespace-pre-wrap break-words\">In today's interconnected world, exposing your home lab or self-hosted services to the internet can be both necessary and risky. Traditional methods like port forwarding or VPNs come with their own set of challenges and security concerns. This is where Cloudflare Tunnel (formerly Argo Tunnel) comes in as an elegant solution.</p>\n<p class=\"whitespace-pre-wrap break-words\">In this article, I'll walk you through how I've implemented a secure infrastructure using Cloudflare Tunnel with WebSocket support, running on a Kubernetes cluster with Apache HTTPD as a reverse proxy. This setup allows me to securely expose internal services without opening ports on my residential firewall while gaining the benefits of Cloudflare's security features.</p>\n<h2 id=\"mcetoc_1h6ufv7hs6\">Starting point </h2>\n<p>This one of the scenarios (what made me crazy) where websocket are in use , grafana, since version 8.~ starts to use websocket to update dashboards</p>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/44/home_all_v1.drawio-4.png\" alt=\"\" width=\"763\" height=\"371\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/44/responsive/home_all_v1.drawio-4-xs.webp 640w ,https://www.k8s.it/media/posts/44/responsive/home_all_v1.drawio-4-sm.webp 768w ,https://www.k8s.it/media/posts/44/responsive/home_all_v1.drawio-4-md.webp 1024w ,https://www.k8s.it/media/posts/44/responsive/home_all_v1.drawio-4-lg.webp 1366w ,https://www.k8s.it/media/posts/44/responsive/home_all_v1.drawio-4-xl.webp 1600w ,https://www.k8s.it/media/posts/44/responsive/home_all_v1.drawio-4-2xl.webp 1920w\"></figure>\n<p> </p>\n<p>The original idea was to define a \"role\" for each aspect<br><br></p>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/44/cworkers.png\" alt=\"\" width=\"47\" height=\"59\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/44/responsive/cworkers-xs.webp 640w ,https://www.k8s.it/media/posts/44/responsive/cworkers-sm.webp 768w ,https://www.k8s.it/media/posts/44/responsive/cworkers-md.webp 1024w ,https://www.k8s.it/media/posts/44/responsive/cworkers-lg.webp 1366w ,https://www.k8s.it/media/posts/44/responsive/cworkers-xl.webp 1600w ,https://www.k8s.it/media/posts/44/responsive/cworkers-2xl.webp 1920w\"></figure> Used as global security header , this will take care to implement the same level of security for each application exposed</p>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/44/cfwaf.png\" alt=\"\" width=\"68\" height=\"59\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/44/responsive/cfwaf-xs.webp 640w ,https://www.k8s.it/media/posts/44/responsive/cfwaf-sm.webp 768w ,https://www.k8s.it/media/posts/44/responsive/cfwaf-md.webp 1024w ,https://www.k8s.it/media/posts/44/responsive/cfwaf-lg.webp 1366w ,https://www.k8s.it/media/posts/44/responsive/cfwaf-xl.webp 1600w ,https://www.k8s.it/media/posts/44/responsive/cfwaf-2xl.webp 1920w\"></figure>Used to \"obfuscate\" the origin and implement a sort of protection even if it's the free version of Cloudflare </p>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/44/Screenshot-2023-08-12-at-11.46.00.png\" alt=\"\" width=\"62\" height=\"76\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.46.00-xs.webp 640w ,https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.46.00-sm.webp 768w ,https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.46.00-md.webp 1024w ,https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.46.00-lg.webp 1366w ,https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.46.00-xl.webp 1600w ,https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.46.00-2xl.webp 1920w\"></figure> Firewall linux based cause i need to make same acl and fw rules</p>\n<p><img loading=\"lazy\" src=\"https://roi4cio.com/fileadmin/user_upload/vmware-esxi.png\" alt=\"VMware ESXi\" width=\"96\" height=\"60\" data-is-external-image=\"true\"> Vmware esxi as a \"flat\" platform to abstract hardware brands, extend portability, backups, etc etc</p>\n<p> </p>\n<p><img loading=\"lazy\" src=\"https://juststickers.in/wp-content/uploads/2018/11/kubernetes-wordmark.png\" alt=\"Kubernetes Logo and Wordmark Sticker - Just Stickers\" width=\"57\" height=\"57\" data-is-external-image=\"true\"> Kubernetes for all the workloads can be run as immutable images</p>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/44/Screenshot-2023-08-12-at-11.54.58.png\" alt=\"\" width=\"66\" height=\"64\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.54.58-xs.webp 640w ,https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.54.58-sm.webp 768w ,https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.54.58-md.webp 1024w ,https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.54.58-lg.webp 1366w ,https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.54.58-xl.webp 1600w ,https://www.k8s.it/media/posts/44/responsive/Screenshot-2023-08-12-at-11.54.58-2xl.webp 1920w\"></figure> Virtual machines when i need disk pressure </p>\n<p>The code used for workers was the following</p>\n<div>\n<div><code>const securityHeaders = {</code></div>\n<div><code>\"Content-Security-Policy\":\"upgrade-insecure-requests\",</code></div>\n<div><code>\"Strict-Transport-Security\":\"max-age=3600;includeSubdomains\",</code></div>\n<div><code>\"X-Xss-Protection\":\"1; mode=block\",</code></div>\n<div><code>\"X-Frame-Options\":\"DENY\",</code></div>\n<div><code>\"X-Content-Type-Options\":\"nosniff\",</code></div>\n<div><code>\"Permissions-Policy\":\"geolocation=()\",</code></div>\n<div><code>\"Referrer-Policy\":\"strict-origin-when-cross-origin\"</code></div>\n<div><code>};</code></div>\n<br>\n<div><code>async function addHeaders(req) {</code></div>\n<div><code>constresponse=awaitfetch(req),</code></div>\n<div><code>newHeaders=newHeaders(response.headers),</code></div>\n<div><code>setHeaders=Object.assign({},securityHeaders);</code></div>\n<br>\n<div><code>if (newHeaders.has(\"Content-Type\") &amp;&amp;!newHeaders.get(\"Content-Type\").includes(\"text/html\")) {</code></div>\n<div><code>returnnewResponse(response.body,{</code></div>\n<div><code>status: response.status,</code></div>\n<div><code>statusText: response.statusText,</code></div>\n<div><code>headers: newHeaders</code></div>\n<div><code>});</code></div>\n<div><code>}</code></div>\n<br>\n<div><code>Object.keys(setHeaders).forEach(name=&gt;newHeaders.set(name,setHeaders[name]));</code></div>\n<br>\n<div><code>returnnewResponse(response.body,{</code></div>\n<div><code>status: response.status,</code></div>\n<div><code>statusText: response.statusText,</code></div>\n<div><code>headers: newHeaders</code></div>\n<div><code>});</code></div>\n<div><code>}</code></div>\n<br>\n<div><code>addEventListener(\"fetch\", event =&gt; event.respondWith(addHeaders(event.request)));</code></div>\n<div> </div>\n</div>\n<div>Anyway now there is a specific topic in cloudflare portal about the alter headers for security ... <a href=\"https://developers.cloudflare.com/workers/examples/security-headers/\" target=\"_blank\" rel=\"noopener noreferrer\">https://developers.cloudflare.com/workers/examples/security-headers/</a></div>\n<div> </div>\n<div> </div>\n<div>\n<h2 id=\"mcetoc_1ipkcjle2e7\" class=\"whitespace-pre-wrap break-words\">Why Cloudflare Tunnel?</h2>\n</div>\n<div>\n<p class=\"whitespace-pre-wrap break-words\">Before diving into the technical details, let's understand why this approach is superior:</p>\n<ol class=\"[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7\">\n<li class=\"whitespace-normal break-words\"><strong>No Open Inbound Ports</strong>: Cloudflare Tunnel establishes an outbound-only connection, eliminating the need to open ports on your firewall</li>\n<li class=\"whitespace-normal break-words\"><strong>DDoS Protection</strong>: Cloudflare's network absorbs and mitigates attack traffic before it reaches your infrastructure</li>\n<li class=\"whitespace-normal break-words\"><strong>Zero Trust Access</strong>: Integrate with Cloudflare Access for identity-based authentication</li>\n<li class=\"whitespace-normal break-words\"><strong>TLS Encryption</strong>: All traffic is encrypted end-to-end</li>\n<li class=\"whitespace-normal break-words\"><strong>WebSocket Support</strong>: Critical for real-time applications and API</li>\n</ol>\n</div>\n<div>\n<p> </p>\n<h2 id=\"mcetoc_1ipkcks8uea\">Setting Up Cloudflared in Kubernetes</h2>\n<p>The core component of this setup is cloudflared, the daemon that creates and maintains the secure tunnel. Here's how I've deployed it in Kubernetes:</p>\n<h3 id=\"mcetoc_1ipkcf23cdc\" class=\"text-lg font-bold text-text-100 mt-1 -mb-1.5\">Configuration</h3>\n<p class=\"whitespace-pre-wrap break-words\">Let's examine the key components of the <code class=\"bg-text-200/5 border border-0.5 border-border-300 text-danger-000 whitespace-pre-wrap rounded-[0.4rem] px-1 py-px text-[0.9rem]\">ConfigMap</code> that defines how cloudflared operates:</p>\n<div class=\"relative group/copy rounded-lg\">\n<div class=\"sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right\">\n<div class=\"absolute right-0 h-8 px-2 items-center inline-flex\">\n<div class=\"relative\"> </div>\n</div>\n</div>\n<div class=\"text-text-500 text-xs p-3.5 pb-0\">yaml</div>\n<div class=\"\">\n<pre class=\"code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed\"><code class=\"language-yaml\"><span class=\"token key\">apiVersion</span><span class=\"token\">:</span> v1\n<span class=\"token key\">kind</span><span class=\"token\">:</span> ConfigMap\n<span class=\"token key\">metadata</span><span class=\"token\">:</span>\n  <span class=\"token key\">name</span><span class=\"token\">:</span> cloudflared\n  <span class=\"token key\">namespace</span><span class=\"token\">:</span> cloudflared\n<span class=\"token key\">data</span><span class=\"token\">:</span>\n  <span class=\"token key\">config.yaml</span><span class=\"token\">:</span> <span class=\"token\">|</span>\n    # Name of the tunnel\n    tunnel: home\n    credentials-file: /etc/cloudflared/creds/credentials.json\n    metrics: 0.0.0.0:2000\n<span class=\"token scalar\">    no-autoupdate: true</span>\n    \n    <span class=\"token\"># Ingress rules define traffic routing</span>\n    <span class=\"token key\">ingress</span><span class=\"token\">:</span>\n    <span class=\"token\"># Special case for Let's Encrypt verification</span>\n    <span class=\"token\">-</span> <span class=\"token key\">hostname</span><span class=\"token\">:</span> services.k8s.it\n      <span class=\"token key\">path</span><span class=\"token\">:</span> /.well<span class=\"token\">-</span>known/acme<span class=\"token\">-</span>challenge/\n      <span class=\"token key\">service</span><span class=\"token\">:</span> $internal-ingress\n      <span class=\"token key\">originRequest</span><span class=\"token\">:</span>\n        <span class=\"token key\">httpHostHeader</span><span class=\"token\">:</span> <span class=\"token\">\"services.k8s.it\"</span>\n        <span class=\"token key\">noTLSVerify</span><span class=\"token\">:</span> <span class=\"token\">true</span>\n        <span class=\"token key\">http2Origin</span><span class=\"token\">:</span> <span class=\"token\">true</span>\n    \n    <span class=\"token\"># Main service routing</span>\n    <span class=\"token\">-</span> <span class=\"token key\">hostname</span><span class=\"token\">:</span> services.k8s.it\n      <span class=\"token key\">service</span><span class=\"token\">:</span> $internal-ingress\n      <span class=\"token key\">originRequest</span><span class=\"token\">:</span>\n        <span class=\"token key\">httpHostHeader</span><span class=\"token\">:</span> <span class=\"token\">\"services.k8s.it\"</span>\n        <span class=\"token key\">noTLSVerify</span><span class=\"token\">:</span> <span class=\"token\">true</span>\n        <span class=\"token key\">http2Origin</span><span class=\"token\">:</span> <span class=\"token\">true</span>\n    \n    <span class=\"token\"># Default rule</span>\n    <span class=\"token\">-</span> <span class=\"token key\">service</span><span class=\"token\">:</span> http_status<span class=\"token\">:</span><span class=\"token\">404</span></code></pre>\n</div>\n</div>\n<p class=\"whitespace-pre-wrap break-words\">This configuration maps different hostnames to internal services, with special handling for WebSockets and HTTP/2 connections.</p>\n<h3 id=\"mcetoc_1ipkcf23cdd\" class=\"text-lg font-bold text-text-100 mt-1 -mb-1.5\">Deployment</h3>\n<p class=\"whitespace-pre-wrap break-words\">Here's the deployment configuration for cloudflared:</p>\n<div class=\"relative group/copy rounded-lg\">\n<div class=\"sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right\">\n<div class=\"absolute right-0 h-8 px-2 items-center inline-flex\">\n<div class=\"relative\"> </div>\n</div>\n</div>\n<div class=\"text-text-500 text-xs p-3.5 pb-0\">yaml</div>\n<div class=\"\">\n<pre class=\"code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed\"><code class=\"language-yaml\"><span class=\"token key\">apiVersion</span><span class=\"token\">:</span> apps/v1\n<span class=\"token key\">kind</span><span class=\"token\">:</span> Deployment\n<span class=\"token key\">metadata</span><span class=\"token\">:</span>\n  <span class=\"token key\">name</span><span class=\"token\">:</span> cloudflared\n<span class=\"token key\">spec</span><span class=\"token\">:</span>\n  <span class=\"token key\">selector</span><span class=\"token\">:</span>\n    <span class=\"token key\">matchLabels</span><span class=\"token\">:</span>\n      <span class=\"token key\">app</span><span class=\"token\">:</span> cloudflared\n  <span class=\"token key\">replicas</span><span class=\"token\">:</span> <span class=\"token\">2</span>  <span class=\"token\"># For high availability</span>\n  <span class=\"token key\">template</span><span class=\"token\">:</span>\n    <span class=\"token key\">metadata</span><span class=\"token\">:</span>\n      <span class=\"token key\">annotations</span><span class=\"token\">:</span>\n        <span class=\"token key\">prometheus.io/path</span><span class=\"token\">:</span> /metrics\n        <span class=\"token key\">prometheus.io/port</span><span class=\"token\">:</span> <span class=\"token\">\"2000\"</span>\n        <span class=\"token key\">prometheus.io/scrape</span><span class=\"token\">:</span> <span class=\"token\">\"true\"</span>\n      <span class=\"token key\">labels</span><span class=\"token\">:</span>\n        <span class=\"token key\">app</span><span class=\"token\">:</span> cloudflared\n    <span class=\"token key\">spec</span><span class=\"token\">:</span>\n      <span class=\"token key\">containers</span><span class=\"token\">:</span>\n      <span class=\"token\">-</span> <span class=\"token key\">name</span><span class=\"token\">:</span> cloudflared\n        <span class=\"token key\">image</span><span class=\"token\">:</span> cloudflare/cloudflared<span class=\"token\">:</span>2023.7.0\n        <span class=\"token key\">args</span><span class=\"token\">:</span>\n        <span class=\"token\">-</span> tunnel\n        <span class=\"token\">-</span> <span class=\"token\">-</span><span class=\"token\">-</span>config\n        <span class=\"token\">-</span> /etc/cloudflared/config/config.yaml\n        <span class=\"token\">-</span> run\n        <span class=\"token key\">livenessProbe</span><span class=\"token\">:</span>\n          <span class=\"token key\">httpGet</span><span class=\"token\">:</span>\n            <span class=\"token key\">path</span><span class=\"token\">:</span> /ready\n            <span class=\"token key\">port</span><span class=\"token\">:</span> <span class=\"token\">2000</span>\n          <span class=\"token key\">failureThreshold</span><span class=\"token\">:</span> <span class=\"token\">1</span>\n          <span class=\"token key\">initialDelaySeconds</span><span class=\"token\">:</span> <span class=\"token\">10</span>\n          <span class=\"token key\">periodSeconds</span><span class=\"token\">:</span> <span class=\"token\">10</span>\n        <span class=\"token key\">volumeMounts</span><span class=\"token\">:</span>\n        <span class=\"token\">-</span> <span class=\"token key\">name</span><span class=\"token\">:</span> config\n          <span class=\"token key\">mountPath</span><span class=\"token\">:</span> /etc/cloudflared/config\n          <span class=\"token key\">readOnly</span><span class=\"token\">:</span> <span class=\"token\">true</span>\n        <span class=\"token\">-</span> <span class=\"token key\">name</span><span class=\"token\">:</span> creds\n          <span class=\"token key\">mountPath</span><span class=\"token\">:</span> /etc/cloudflared/creds\n          <span class=\"token key\">readOnly</span><span class=\"token\">:</span> <span class=\"token\">true</span>\n      <span class=\"token key\">volumes</span><span class=\"token\">:</span>\n      <span class=\"token\">-</span> <span class=\"token key\">name</span><span class=\"token\">:</span> creds\n        <span class=\"token key\">secret</span><span class=\"token\">:</span>\n          <span class=\"token key\">secretName</span><span class=\"token\">:</span> tunnel<span class=\"token\">-</span>credentials\n      <span class=\"token\">-</span> <span class=\"token key\">name</span><span class=\"token\">:</span> config\n        <span class=\"token key\">configMap</span><span class=\"token\">:</span>\n          <span class=\"token key\">name</span><span class=\"token\">:</span> cloudflared\n          <span class=\"token key\">items</span><span class=\"token\">:</span>\n          <span class=\"token\">-</span> <span class=\"token key\">key</span><span class=\"token\">:</span> config.yaml\n            <span class=\"token key\">path</span><span class=\"token\">:</span> config.yaml</code></pre>\n</div>\n</div>\n<p class=\"whitespace-pre-wrap break-words\">Notice the use of multiple replicas for redundancy and the liveness probe that ensures connectivity to Cloudflare's edge network.</p>\n<p> </p>\n<h2 id=\"mcetoc_1ipkcllt0ec\">How the Traffic Flows: Sequence Diagram</h2>\n<p class=\"whitespace-pre-wrap break-words\">Let's visualize how a request flows through this infrastructure:</p>\n<div class=\"relative group/copy rounded-lg\">\n<div class=\"sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right\">\n<div class=\"absolute right-0 h-8 px-2 items-center inline-flex\">\n<div class=\"relative\"> </div>\n</div>\n</div>\n<div class=\"\">\n<pre class=\"code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed\"><code>User -&gt; Cloudflare -&gt; Cloudflared -&gt; Kubernetes Ingress -&gt; Apache HTTPD -&gt; Application</code></pre>\n</div>\n</div>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/44/Screenshot-2025-04-24-at-19.07.35.png\" alt=\"\" width=\"1598\" height=\"1438\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/44/responsive/Screenshot-2025-04-24-at-19.07.35-xs.webp 640w ,https://www.k8s.it/media/posts/44/responsive/Screenshot-2025-04-24-at-19.07.35-sm.webp 768w ,https://www.k8s.it/media/posts/44/responsive/Screenshot-2025-04-24-at-19.07.35-md.webp 1024w ,https://www.k8s.it/media/posts/44/responsive/Screenshot-2025-04-24-at-19.07.35-lg.webp 1366w ,https://www.k8s.it/media/posts/44/responsive/Screenshot-2025-04-24-at-19.07.35-xl.webp 1600w ,https://www.k8s.it/media/posts/44/responsive/Screenshot-2025-04-24-at-19.07.35-2xl.webp 1920w\"></figure>\n<p> </p>\n<h2 id=\"mcetoc_1ipkcjle2e8\">Security Considerations</h2>\n<p class=\"whitespace-pre-wrap break-words\"> </p>\n<h3 id=\"mcetoc_1ipkcf23cdh\" class=\"text-lg font-bold text-text-100 mt-1 -mb-1.5\">1. Cloudflare WAF Protection</h3>\n<p class=\"whitespace-pre-wrap break-words\">Cloudflare's Web Application Firewall provides protection against:</p>\n<ul class=\"[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-disc space-y-1.5 pl-7\">\n<li class=\"whitespace-normal break-words\">SQL injection attacks</li>\n<li class=\"whitespace-normal break-words\">Cross-site scripting (XSS)</li>\n<li class=\"whitespace-normal break-words\">Cross-site request forgery (CSRF)</li>\n<li class=\"whitespace-normal break-words\">DDoS attacks</li>\n<li class=\"whitespace-normal break-words\">Common vulnerabilities</li>\n</ul>\n<h3 id=\"mcetoc_1ipkcf23cdi\" class=\"text-lg font-bold text-text-100 mt-1 -mb-1.5\">2. Zero Trust Network Architecture</h3>\n<p class=\"whitespace-pre-wrap break-words\">The setup follows zero trust principles:</p>\n<ul class=\"[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-disc space-y-1.5 pl-7\">\n<li class=\"whitespace-normal break-words\">No exposed ports on the residential firewall</li>\n<li class=\"whitespace-normal break-words\">All connections initiated outbound from inside the network</li>\n<li class=\"whitespace-normal break-words\">No direct path from internet to internal services</li>\n</ul>\n<h3 id=\"mcetoc_1ipkcf23cdj\" class=\"text-lg font-bold text-text-100 mt-1 -mb-1.5\">3. Defense in Depth</h3>\n<p class=\"whitespace-pre-wrap break-words\">Multiple security layers provide redundant protection:</p>\n<ul class=\"[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-disc space-y-1.5 pl-7\">\n<li class=\"whitespace-normal break-words\">Cloudflare WAF (first line of defense)</li>\n<li class=\"whitespace-normal break-words\">Kubernetes network policies (segmentation)</li>\n<li class=\"whitespace-normal break-words\">Apache as an additional security layer (request filtering)</li>\n<li class=\"whitespace-normal break-words\">Application-level security</li>\n</ul>\n<h3 id=\"mcetoc_1ipkcf23cdk\" class=\"text-lg font-bold text-text-100 mt-1 -mb-1.5\">4. Credential Management</h3>\n<p class=\"whitespace-pre-wrap break-words\">Cloudflared credentials require careful handling:</p>\n<ul class=\"[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-disc space-y-1.5 pl-7\">\n<li class=\"whitespace-normal break-words\">Store tunnel credentials as Kubernetes secrets</li>\n<li class=\"whitespace-normal break-words\">Regular credential rotation</li>\n<li class=\"whitespace-normal break-words\">Limit access to credential management</li>\n</ul>\n<h3 id=\"mcetoc_1ipkcf23cdl\" class=\"text-lg font-bold text-text-100 mt-1 -mb-1.5\">5. HTTPS Everywhere</h3>\n<p class=\"whitespace-pre-wrap break-words\">All traffic is encrypted:</p>\n<ul class=\"[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-disc space-y-1.5 pl-7\">\n<li class=\"whitespace-normal break-words\">TLS between user and Cloudflare</li>\n<li class=\"whitespace-normal break-words\">TLS in the tunnel between Cloudflare and cloudflared</li>\n<li class=\"whitespace-normal break-words\">Optional TLS for internal communications</li>\n</ul>\n<p> </p>\n<h2 id=\"mcetoc_1ipkd2pj3k4\" class=\"text-xl font-bold text-text-100 mt-1 -mb-0.5\">Monitoring and Observability</h2>\n<p class=\"whitespace-pre-wrap break-words\">The infrastructure includes robust monitoring:</p>\n<ol class=\"[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7\">\n<li class=\"whitespace-normal break-words\"><strong>Prometheus Integration</strong>: Cloudflared exposes metrics on port 2000</li>\n<li class=\"whitespace-normal break-words\"><strong>Grafana Dashboards</strong>: Visualize performance and security metrics</li>\n<li class=\"whitespace-normal break-words\"><strong>Logs Aggregation</strong>: Collect logs from all components for analysis</li>\n</ol>\n<div class=\"relative group/copy rounded-lg\">\n<div class=\"sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right\">\n<div class=\"absolute right-0 h-8 px-2 items-center inline-flex\">\n<div class=\"relative\"> </div>\n</div>\n</div>\n<div class=\"text-text-500 text-xs p-3.5 pb-0\">yaml</div>\n<div class=\"\">\n<pre class=\"code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed\"><code class=\"language-yaml\"><span class=\"token key\">annotations</span><span class=\"token\">:</span>\n  <span class=\"token key\">prometheus.io/path</span><span class=\"token\">:</span> /metrics\n  <span class=\"token key\">prometheus.io/port</span><span class=\"token\">:</span> <span class=\"token\">\"2000\"</span>\n  <span class=\"token key\">prometheus.io/scrape</span><span class=\"token\">:</span> <span class=\"token\">\"true\"</span></code></pre>\n</div>\n</div>\n<h2 id=\"mcetoc_1ipkd2pj3k5\" class=\"text-xl font-bold text-text-100 mt-1 -mb-0.5\">Advanced Configurations</h2>\n<h3 id=\"mcetoc_1ipkd2pj3k6\" class=\"text-lg font-bold text-text-100 mt-1 -mb-1.5\">Load Balancing</h3>\n<p class=\"whitespace-pre-wrap break-words\">For high availability, the setup uses multiple cloudflared replicas:</p>\n<div class=\"relative group/copy rounded-lg\">\n<div class=\"sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right\">\n<div class=\"absolute right-0 h-8 px-2 items-center inline-flex\">\n<div class=\"relative\"> </div>\n</div>\n</div>\n<div class=\"\">\n<pre class=\"code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed\"><code class=\"language-yaml\"><span class=\"token key\">replicas</span><span class=\"token\">:</span> <span class=\"token\">2</span>  <span class=\"token\"># Multiple instances for reliability</span></code></pre>\n</div>\n</div>\n<p class=\"whitespace-pre-wrap break-words\">Cloudflare's global network automatically balances connections across available tunnels.</p>\n<h3 id=\"mcetoc_1ipkd2pj3k7\" class=\"text-lg font-bold text-text-100 mt-1 -mb-1.5\">Path-Based Routing</h3>\n<p class=\"whitespace-pre-wrap break-words\">The ingress configuration supports path-based routing:</p>\n<div class=\"relative group/copy rounded-lg\">\n<div class=\"sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right\">\n<div class=\"absolute right-0 h-8 px-2 items-center inline-flex\">\n<div class=\"relative\"> </div>\n</div>\n</div>\n<div class=\"\">\n<pre class=\"code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed\"><code class=\"language-yaml\"><span class=\"token\">-</span> <span class=\"token key\">hostname</span><span class=\"token\">:</span> services.k8s.it\n  <span class=\"token key\">path</span><span class=\"token\">:</span> /.well<span class=\"token\">-</span>known/acme<span class=\"token\">-</span>challenge/\n  <span class=\"token key\">service</span><span class=\"token\">:</span> http<span class=\"token\">:</span>//$internal-ingress</code></pre>\n</div>\n</div>\n<p class=\"whitespace-pre-wrap break-words\">This allows for complex routing scenarios based on domain and path.</p>\n<p> </p>\n<h3 id=\"mcetoc_1ipkd2pj3k8\" class=\"text-lg font-bold text-text-100 mt-1 -mb-1.5\">Apache configuration</h3>\n<pre class=\"language-apacheconf\"><code>      &lt;Location /grafana/&gt;\n        ProxyPass  http://IP:3000/\n      &lt;/Location&gt;\n\n      &lt;Location /grafana/api/live/ws&gt;\n        ProxyPass  ws://IP:3000/api/live/ws\n      &lt;/Location&gt;</code></pre>\n</div>\n<div> </div>\n<div>\n<h2 id=\"mcetoc_1ipkd2pj3k9\" class=\"text-xl font-bold text-text-100 mt-1 -mb-0.5\">Conclusion</h2>\n<p class=\"whitespace-pre-wrap break-words\">This architecture provides a secure, reliable way to expose home lab services to the internet. By leveraging Cloudflare Tunnel with WebSocket support, you get:</p>\n<ol class=\"[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7\">\n<li class=\"whitespace-normal break-words\">Enhanced security with no open ports</li>\n<li class=\"whitespace-normal break-words\">Protection from Cloudflare's global network</li>\n<li class=\"whitespace-normal break-words\">Reliable connections for modern web applications</li>\n<li class=\"whitespace-normal break-words\">Simplified management through Kubernetes</li>\n</ol>\n<p class=\"whitespace-pre-wrap break-words\">The combination of cloudflared, Kubernetes, and Apache HTTPD creates a robust infrastructure that's both secure and flexible, allowing you to safely expose services without compromising on security.</p>\n<p class=\"whitespace-pre-wrap break-words\">Remember that security is a continuous process - regularly update components, review configurations, and monitor for unusual activity to maintain a strong security posture.</p>\n</div>\n<p> </p>",
            "author": {
                "name": "lgirardi"
            },
            "tags": [
                   "workers",
                   "websocket",
                   "tunnel",
                   "security",
                   "httpd",
                   "headers",
                   "cloudflare",
                   "argo",
                   "apache httpd"
            ],
            "date_published": "2023-08-03T21:56:27+02:00",
            "date_modified": "2025-04-24T19:21:20+02:00"
        },
        {
            "id": "https://www.k8s.it/hpa-vs-rate-limit.html",
            "url": "https://www.k8s.it/hpa-vs-rate-limit.html",
            "title": "HPA vs Rate-limit",
            "summary": "Strange ... we are using hpa to increase the availability and we are introducing rate limit to reduce? Well let's create the context... This story is not a true o false sentence, it's a sort of analysis based on a few assumptions: In Kubernetes, a&hellip;",
            "content_html": "<div class=\"post__toc\">\n<h3>Table of Contents</h3>\n<ul>\n<li><a href=\"#mcetoc_1gpdt88oks2\">INTRO</a>\n<ul>\n<li><a href=\"#mcetoc_1gpdt88oks3\">HPA</a>\n<ul>\n<li><a href=\"#mcetoc_1gpdt88oks4\">Patterns</a></li>\n<li><a href=\"#mcetoc_1gpdt88oks5\">Meaning</a></li>\n<li><a href=\"#mcetoc_1gpdt88oks6\">Ideal Practice</a></li>\n</ul>\n</li>\n<li><a href=\"#mcetoc_1gpdt88oks7\">Rate Limit</a></li>\n</ul>\n</li>\n<li><a href=\"#mcetoc_1gpdt88oks8\">GOALS</a></li>\n<li><a href=\"#mcetoc_1gpdt88oks9\">Limits</a></li>\n<li><a href=\"#mcetoc_1gpdt88oksa\">Hands-on</a>\n<ul>\n<li><a href=\"#mcetoc_1gpdt88oksb\">Simulation</a>\n<ul>\n<li>\n<ul>\n<li><a href=\"#mcetoc_1gpdu7tqi167\">Note</a></li>\n</ul>\n</li>\n<li> </li>\n<li><a href=\"#mcetoc_1gpdu7tqi169\">NO AUTOSCALING</a>\n<ul>\n<li><a href=\"#mcetoc_1gpdu7tqi16a\">First run 40rps max</a></li>\n<li><a href=\"#mcetoc_1gpdu7tqi16b\">Second run 33rps max</a></li>\n</ul>\n</li>\n<li><a href=\"#mcetoc_1gpduj9db16h\">AUTOSCALING</a>\n<ul>\n<li><a href=\"#mcetoc_1gpduui3818q\">1 pod start - hpa 33rps - 15 min - 99 max requests</a></li>\n<li><a href=\"#mcetoc_1gpdvmntb1ba\">2 pod start - hpa 33rps - 15 min - 99 max requests</a></li>\n<li><a href=\"#mcetoc_1gpdvne631bd\">1 pod start - hpa 30rps - 15 min - 99 max requests</a></li>\n<li><a href=\"#mcetoc_1gpe003lg1ci\">1 pod start - hpa 27rps - 15 min - 99 max requests</a></li>\n<li><a href=\"#mcetoc_1gpe0j6931f3\"> [optimal] 1 pod start - hpa 24rps - 15 min - 99 max requests</a></li>\n<li><a href=\"#mcetoc_1gpe0j6931f4\">1 pod start - hpa 25rps - 15 min - 99 max requests</a></li>\n</ul>\n</li>\n<li><a href=\"#mcetoc_1gpe0j6931f5\">AUTOSCALING Internal rate limit</a>\n<ul>\n<li><a href=\"#mcetoc_1gpe0pd9t1fm\">[optimal] 1 pod start - hpa 25rps- 15 min - 99 max requests rate-limit 27</a></li>\n<li><a href=\"#mcetoc_1gpe1laq11pb\">1 pod start - hpa 26rps - 15 min - 99 max requests rate-limit 28</a></li>\n<li><a href=\"#mcetoc_1gpe1laq11pc\">1 pod start - hpa 27rps - 15 min - 99 max requests rate-limit 29</a></li>\n</ul>\n</li>\n<li><a href=\"#mcetoc_1gpe1laq11pd\">AUTOSCALING envoy rate limit</a>\n<ul>\n<li><a href=\"#mcetoc_1gpe1laq11pe\">1 pod start - hpa 27rps - 15 min - 99 max requests rate-limit 29 - envoy</a></li>\n<li><a href=\"#mcetoc_1gpe1laq11pf\">[optimal] 1 pod start - hpa 26rps - 15 min - 99 max requests rate-limit 29 - envoy</a></li>\n</ul>\n</li>\n<li><a href=\"#mcetoc_1gpe1laq11pg\">Unexpected traffic</a>\n<ul>\n<li><a href=\"#mcetoc_1gpe2t9fu2jk\">3 pod start - hpa 26rps - 15 min - 82 avg requests with spikes -  rate-limit 27 internal</a></li>\n<li><a href=\"#mcetoc_1gpe2t9fu2jl\">[optimal] 3 pod start - hpa 26rps - 15 min - 82 avg requests with spikes -  rate-limit 27 - envoy</a></li>\n</ul>\n</li>\n<li><a href=\"#mcetoc_1gpe2t9fu2jm\">Conclusions</a>\n<ul>\n<li><a href=\"#mcetoc_1gpe2t9fu2jn\">HPA</a></li>\n<li><a href=\"#mcetoc_1gpe2t9fu2jo\">Rate Limit</a></li>\n<li><a href=\"#mcetoc_1gpe2t9fu2jp\">Both</a></li>\n<li><a href=\"#mcetoc_1gpe2t9fu2jq\">Costs</a>\n<ul>\n<li><a href=\"#mcetoc_1gpe2t9fu2jr\">Highlights</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</div>\n<p>Strange ... we are using hpa to increase the availability and we are introducing rate limit to reduce?  </p>\n<p>Well let's create the context...</p>\n<h1 id=\"mcetoc_1gpdt88oks2\">INTRO</h1>\n<p>This <em>story </em>is not a true o false sentence, it's a sort of analysis based on a few assumptions:</p>\n<ul>\n<li>cloud environment</li>\n<li>dynamic infrastructure</li>\n<li>minimum resources available </li>\n</ul>\n<h2 id=\"mcetoc_1gpdt88oks3\">HPA</h2>\n<p><span style=\"font-weight: 400;\">In Kubernetes, a </span><i><span style=\"font-weight: 400;\">HorizontalPodAutoscaler</span></i><span style=\"font-weight: 400;\"> automatically updates a workload resource (such as a </span><a href=\"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/\"><span style=\"font-weight: 400;\">Deployment</span></a><span style=\"font-weight: 400;\"> or </span><a href=\"https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/\"><span style=\"font-weight: 400;\">StatefulSet</span></a><span style=\"font-weight: 400;\">), with the aim of automatically scaling the workload to match demand.</span></p>\n<h3 id=\"mcetoc_1gpdt88oks4\">Patterns</h3>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-20.28.38.png\" alt=\"\" width=\"1174\" height=\"916\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-20.28.38-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-20.28.38-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-20.28.38-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-20.28.38-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-20.28.38-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-20.28.38-2xl.webp 1920w\"></figure>\n<h3 id=\"mcetoc_1gpdt88oks5\">Meaning</h3>\n<table style=\"border-collapse: collapse; width: 100%;\" border=\"1\">\n<tbody>\n<tr>\n<td style=\"width: 21.2501%;\"><strong>Type</strong></td>\n<td style=\"width: 78.7499%;\"><strong>Behaviour</strong></td>\n</tr>\n<tr>\n<td style=\"width: 21.2501%;\">Slow and temporary</td>\n<td style=\"width: 78.7499%;\">it might have daily fluctuations in requests volume, peaking during the day and troughing at night</td>\n</tr>\n<tr>\n<td style=\"width: 21.2501%;\">Rapid and temporary</td>\n<td style=\"width: 78.7499%;\">it might be subject to short bursts of high request volume from poorly-behaved downstream services</td>\n</tr>\n<tr>\n<td style=\"width: 21.2501%;\">Slow and persistent</td>\n<td style=\"width: 78.7499%;\">it might see its request volume slowly increase over rime, as the product sees greater adoption</td>\n</tr>\n<tr>\n<td style=\"width: 21.2501%;\">Rapid and persistent</td>\n<td style=\"width: 78.7499%;\">it might see abrupt shift from low to high volumes, such as if it's called by batch jobs</td>\n</tr>\n</tbody>\n</table>\n<p> </p>\n<h3 id=\"mcetoc_1gpdt88oks6\">Ideal Practice</h3>\n<table style=\"border-collapse: collapse; width: 100%;\" border=\"1\">\n<tbody>\n<tr>\n<td style=\"width: 22.7209%;\"><strong>Type</strong></td>\n<td style=\"width: 77.4218%;\"><strong>Behaviour</strong></td>\n</tr>\n<tr>\n<td style=\"width: 22.7209%;\">Slow and temporary</td>\n<td style=\"width: 77.4218%;\">The HPA should add and remove pods as necessary</td>\n</tr>\n<tr>\n<td style=\"width: 22.7209%;\">Rapid and temporary</td>\n<td style=\"width: 77.4218%;\">The HPA should not modify the pod count; instead, the service should leave enough headroom to deal with these brief spikes with only existing pods</td>\n</tr>\n<tr>\n<td style=\"width: 22.7209%;\">Slow and persistent </td>\n<td style=\"width: 77.4218%;\">The HPA should add and remove pods as necessary</td>\n</tr>\n<tr>\n<td style=\"width: 22.7209%;\">Rapid and persistent</td>\n<td style=\"width: 77.4218%;\">The service should leave enough headroom to deal with the rapid change, and the HPA should add pods soon after to bring the service back to target utilization</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"mcetoc_1gpdt88oks7\">Rate Limit</h2>\n<p><span style=\"font-weight: 400;\">A rate limit is the number of API calls an app or user can make within a given time period. If this limit is exceeded or if CPU or total time limits are exceeded, the app or user may be throttled. API requests made by a throttled user or app will fail. All API requests are subject to rate limits.</span></p>\n<p>However, keep the HPA patterns as a reference even for this one.</p>\n<p> </p>\n<h1 id=\"mcetoc_1gpdt88oks8\"><span style=\"font-weight: 400;\">GOALS</span></h1>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><span style=\"font-weight: 400;\">Understand how much we can close with the application enervation during an autoscaling situation using rate limit</span></li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><span style=\"font-weight: 400;\">Understand how to handle unexpected traffic with rate limit</span></li>\n</ul>\n<p> </p>\n<h1 id=\"mcetoc_1gpdt88oks9\"><span style=\"font-weight: 400;\">Limits</span></h1>\n<p>Sometimes we can have a spike of requests that are legit... for example consider the google crawlers (image from ... somewhere in google image)</p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/logs-crawl-spikes-three-c-sm-border.png\" alt=\"\" width=\"518\" height=\"277\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/logs-crawl-spikes-three-c-sm-border-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/logs-crawl-spikes-three-c-sm-border-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/logs-crawl-spikes-three-c-sm-border-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/logs-crawl-spikes-three-c-sm-border-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/logs-crawl-spikes-three-c-sm-border-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/logs-crawl-spikes-three-c-sm-border-2xl.webp 1920w\"></figure>\n<p> </p>\n<h1 id=\"mcetoc_1gpdt88oksa\"><span style=\"font-weight: 400;\">Hands-on</span></h1>\n<h2 id=\"mcetoc_1gpdt88oksb\"><span style=\"font-weight: 400;\">Simulation</span></h2>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><span style=\"font-weight: 400;\"><a href=\"https://github.com/lorenzogirardi/py-test-backend\">python</a> app that generates fibonacci sequence</span></li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><span style=\"font-weight: 400;\">fibonacci number 18500</span></li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><span style=\"font-weight: 400;\">load test done using gatling</span></li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><span style=\"font-weight: 400;\">Application capped on cpu (each request is ~10mcpu) with max of 300mcpu for pod (cpu bound)</span></li>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><span style=\"font-weight: 400;\">Hpa based on keda flask_http_request_duration_seconds_count</span></li>\n</ul>\n<p> </p>\n<p><span style=\"font-weight: 400;\">Results Example </span></p>\n<p><span style=\"font-weight: 400;\">$ curl http://xxx/api/fib/18500<br></span><span style=\"font-family: var(--editor-font-family); font-size: inherit;\">8353329688443562486779853158514... etc etc<br></span></p>\n<p><span style=\"font-weight: 400;\">This ensures that it is not just an echo answer and that we have work behind the scenes.</span></p>\n<p> </p>\n<h4 id=\"mcetoc_1gpdu7tqi167\">Note</h4>\n<p>Gatling is using an interesting concept that call \"active users\"</p>\n<p><span style=\"font-weight: 400;\">“Active users” is neither “concurrent users” or “users arrival rate”. It’s a kind of mixed metric that serves for both open and closed workload models and that represents “users who were active on the system under load at a given second”.</span></p>\n<p><span style=\"font-weight: 400;\">It’s computed as:</span></p>\n<p><span style=\"font-weight: 400;\"> (number of alive users at previous second)<br></span><span style=\"font-family: var(--editor-font-family); font-size: inherit;\">+ (number of users that were started during this second)<br></span><span style=\"font-weight: 400;\">- (number of users that were terminated during previous second)</span></p>\n<h3 id=\"mcetoc_1gpdu7tqi168\"></h3>\n<h3 id=\"mcetoc_1gpdu7tqi169\"><span style=\"font-weight: 400;\">NO AUTOSCALING</span></h3>\n<p> </p>\n<h4 id=\"mcetoc_1gpdu7tqi16a\"><span style=\"font-weight: 400;\">First run 40rps max</span></h4>\n<p class=\"msg msg--info\"><span style=\"font-weight: 400;\">rampUsers(10).during(60.seconds), // increase users to 10 in 60 sec<br></span><span style=\"font-weight: 400;\">constantUsersPerSec(10).during(60.seconds), // keep 10 users for 60 sec<br></span><span style=\"font-weight: 400;\">rampUsersPerSec(10).to(40).during(5.minutes), // increase users to 40 in 5 min</span></p>\n<p> </p>\n<figure class=\"post__image post__image--center\"><span style=\"font-family: var(--editor-font-family); font-size: inherit;\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.15.19.png\" alt=\"\" width=\"1198\" height=\"468\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.15.19-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.15.19-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.15.19-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.15.19-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.15.19-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.15.19-2xl.webp 1920w\"></figure></span></p>\n<p><span style=\"font-family: var(--editor-font-family); font-size: inherit;\"> As soon as we reach the limit the pods start to be unresponsive</span></p>\n<figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.16.02.png\" alt=\"\" width=\"1200\" height=\"326\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.16.02-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.16.02-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.16.02-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.16.02-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.16.02-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.16.02-2xl.webp 1920w\"></figure><br>No metrics after 33 rps, pod crashed<br><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.17.54.png\" alt=\"\" width=\"1194\" height=\"436\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.17.54-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.17.54-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.17.54-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.17.54-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.17.54-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.17.54-2xl.webp 1920w\"></figure><br>No metrics after &gt;28% of cpu (consider the max as 30% as the pod limit is 300mcpu)<br><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.19.22.png\" alt=\"\" width=\"1200\" height=\"482\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.19.22-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.19.22-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.19.22-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.19.22-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.19.22-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.19.22-2xl.webp 1920w\"></figure>\n<figure class=\"post__image post__image--center\"><span style=\"font-weight: 400;\">Failure rate (low) when rps &gt; 35 and high response time<br><br><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.20.38.png\" alt=\"\" width=\"1182\" height=\"476\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.20.38-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.20.38-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.20.38-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.20.38-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.20.38-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.20.38-2xl.webp 1920w\"></figure><br></span><span style=\"font-weight: 400;\">Active users increase dramatically after 33 rps<br><br></span></p>\n<h4 id=\"mcetoc_1gpdu7tqi16b\"><span style=\"font-weight: 400;\">Second run 33rps max</span></h4>\n<p class=\"msg msg--info\"><span style=\"font-weight: 400;\">rampUsers(10).during(60.seconds), // increase users to 10 in 60 sec<br>constantUsersPerSec(10).during(60.seconds), // keep 10 users for 60 sec<br>rampUsersPerSec(10).to(30).during(4.minutes), // increase users to 30 in 4 min<br></span></p>\n<figure class=\"post__image post__image--center\"><span style=\"font-weight: 400;\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.24.14.png\" alt=\"\" width=\"1196\" height=\"470\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.14-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.14-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.14-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.14-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.14-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.14-2xl.webp 1920w\"></figure></span></p>\n<figure class=\"post__image post__image--center\"><span style=\"font-weight: 400;\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.24.22.png\" alt=\"\" width=\"1198\" height=\"282\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.22-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.22-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.22-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.22-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.22-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.22-2xl.webp 1920w\"></figure></span></p>\n<figure class=\"post__image post__image--center\"><span style=\"font-weight: 400;\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.24.30.png\" alt=\"\" width=\"1162\" height=\"428\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.30-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.30-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.30-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.30-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.30-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.30-2xl.webp 1920w\"></figure></span></p>\n<figure class=\"post__image post__image--center\"><span style=\"font-weight: 400;\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.24.39.png\" alt=\"\" width=\"1190\" height=\"480\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.39-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.39-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.39-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.39-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.39-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.39-2xl.webp 1920w\"></figure></span></p>\n<figure class=\"post__image post__image--center\"><span style=\"font-weight: 400;\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.24.46.png\" alt=\"\" width=\"1194\" height=\"480\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.46-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.46-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.46-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.46-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.46-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.46-2xl.webp 1920w\"></figure></span></p>\n<p><span style=\"font-weight: 400;\">Really better, we can say that the MAX rps is 33 ... this valid <i>one-shot</i> in a single run</span></p>\n<p> </p>\n<h3 id=\"mcetoc_1gpduj9db16h\"><span style=\"font-weight: 400;\">AUTOSCALING</span></h3>\n<p class=\"msg msg--info\"><span style=\"font-weight: 400;\"> rampUsers(10).during(60.seconds), // increase users to 10 in 60 sec<br></span><span style=\"font-weight: 400;\"> constantUsersPerSec(10).during(60.seconds), // keep 10 users for 60sec<br></span><span style=\"font-weight: 400;\"> rampUsersPerSec(10).to(99).during(15.minutes), // increase users to 99 in 15 min</span></p>\n<p> </p>\n<h4 id=\"mcetoc_1gpduui3818q\"><span style=\"font-weight: 400;\">1 pod start - hpa 33rps - 15 min - 99 max requests</span></h4>\n<figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.30.24.png\" alt=\"\" width=\"1194\" height=\"250\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.24-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.24-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.24-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.24-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.24-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.24-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.30.30.png\" alt=\"\" width=\"1192\" height=\"430\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.30-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.30-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.30-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.30-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.30-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.30-2xl.webp 1920w\"></figure><br>DEAD !!! <br><br>Test stopped as per ...</p>\n<p class=\"msg msg--warning\"><span style=\"font-weight: 400;\">================================================================================<br></span><span style=\"font-weight: 400;\">2023-02-09 10:01:38                                         885s elapsed<br></span><span style=\"font-weight: 400;\">---- Requests ------------------------------------------------------------------<br></span><span style=\"font-weight: 400;\">&gt; Global                                                   (OK=17944  KO=18236 )<br></span><span style=\"font-weight: 400;\">&gt; request_1                                                (OK=17944  KO=18236 )<br></span><span style=\"font-weight: 400;\">---- Errors --------------------------------------------------------------------<br></span><span style=\"font-weight: 400;\">&gt; status.find.in(200,201,202,203,204,205,206,207,208,209,304), f   8358 (45.83%)f</span><span style=\"font-weight: 400;\">ound 503<br></span><span style=\"font-weight: 400;\">&gt; status.find.in(200,201,202,203,204,205,206,207,208,209,304), f   5529 (30.32%)f</span><span style=\"font-weight: 400;\">ound 502<br></span><span style=\"font-weight: 400;\">&gt; status.find.in(200,201,202,203,204,205,206,207,208,209,304), f   4273 (23.43%)f</span><span style=\"font-weight: 400;\">ound 504<br></span><span style=\"font-weight: 400;\">&gt; i.g.h.c.i.RequestTimeoutException: Request timeout to oracolo.     73 ( 0.40%)<br></span><span style=\"font-weight: 400;\">&gt; j.i.IOException: Premature close                                    3 ( 0.02%)<br></span><span style=\"font-weight: 400;\">---- BasicSimulation -----------------------------------------------------------<br></span><span style=\"font-weight: 400;\">[#####################################################--                   ] 72%<br></span><span style=\"font-weight: 400;\">waiting: 12549  / active: 932    / done: 36180<br></span><span style=\"font-weight: 400;\">================================================================================</span></p>\n<p> </p>\n<h4 id=\"mcetoc_1gpdvmntb1ba\"><span style=\"font-weight: 400;\">2 pod start - hpa 33rps - 15 min - 99 max requests</span></h4>\n<figure class=\"post__image post__image--center\"><span style=\"font-weight: 400;\">Autoscaler is not able to support the traffic in the picture before , the curve is stressing the namespace in a way to make impossible the scaling and reliability, this can be by a single pod start and ratio of requests absorbed, let’s try starting with 2 , it’s supposed in that way to have half of the requests to absorb each one<br><br><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.41.18.png\" alt=\"\" width=\"1194\" height=\"474\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.18-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.18-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.18-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.18-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.18-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.18-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.41.29.png\" alt=\"\" width=\"1196\" height=\"274\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.29-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.29-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.29-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.29-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.29-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.29-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.41.37.png\" alt=\"\" width=\"1182\" height=\"434\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.37-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.37-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.37-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.37-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.37-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.37-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.41.44.png\" alt=\"\" width=\"1194\" height=\"484\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.44-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.44-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.44-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.44-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.44-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.44-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.41.52.png\" alt=\"\" width=\"1194\" height=\"472\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.52-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.52-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.52-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.52-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.52-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.52-2xl.webp 1920w\"></figure><br>Naaaa... still not able to scale </span></p>\n<p><br><br></p>\n<h4 id=\"mcetoc_1gpdvne631bd\"><span style=\"font-weight: 400;\">1 pod start - hpa 30rps - 15 min - 99 max requests</span></h4>\n<figure class=\"post__image post__image--center\"><span style=\"font-weight: 400;\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.44.45.png\" alt=\"\" width=\"1198\" height=\"472\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.45-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.45-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.45-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.45-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.45-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.45-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.44.57.png\" alt=\"\" width=\"1132\" height=\"318\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.57-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.57-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.57-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.57-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.57-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.57-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.45.03.png\" alt=\"\" width=\"1124\" height=\"466\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.03-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.03-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.03-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.03-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.03-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.03-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.45.10.png\" alt=\"\" width=\"1198\" height=\"480\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.10-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.10-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.10-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.10-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.10-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.10-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.45.17.png\" alt=\"\" width=\"1192\" height=\"480\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.17-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.17-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.17-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.17-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.17-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.17-2xl.webp 1920w\"></figure><br>Ok we are able to scale but at the end we have a complete crash</span></p>\n<h4 id=\"mcetoc_1gpe003lg1ci\"><span style=\"font-weight: 400;\"><br>1 pod start - hpa 27rps - 15 min - 99 max requests</span></h4>\n<figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.53.36.png\" alt=\"\" width=\"1194\" height=\"470\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.36-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.36-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.36-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.36-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.36-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.36-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.53.43.png\" alt=\"\" width=\"1198\" height=\"300\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.43-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.43-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.43-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.43-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.43-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.43-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.53.51.png\" alt=\"\" width=\"1122\" height=\"412\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.51-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.51-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.51-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.51-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.51-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.51-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.53.58.png\" alt=\"\" width=\"1202\" height=\"472\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.58-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.58-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.58-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.58-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.58-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.58-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.54.07.png\" alt=\"\" width=\"1198\" height=\"476\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.54.07-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.54.07-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.54.07-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.54.07-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.54.07-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.54.07-2xl.webp 1920w\"></figure><br>Oh noooo ... worse than before with fewer rps ... since we are over-stressed when start to crash can have weird behaviour  </p>\n<p> </p>\n<h4 id=\"mcetoc_1gpe0j6931f3\"><span style=\"font-weight: 400;\"> [optimal] 1 pod start - hpa 24rps - 15 min - 99 max requests</span></h4>\n<figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.58.23.png\" alt=\"\" width=\"1196\" height=\"468\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.23-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.23-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.23-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.23-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.23-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.23-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.58.33.png\" alt=\"\" width=\"1198\" height=\"294\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.33-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.33-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.33-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.33-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.33-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.33-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.58.41.png\" alt=\"\" width=\"1194\" height=\"434\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.41-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.41-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.41-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.41-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.41-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.41-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.58.51.png\" alt=\"\" width=\"1196\" height=\"466\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.51-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.51-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.51-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.51-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.51-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.51-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.58.58.png\" alt=\"\" width=\"1198\" height=\"472\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.58-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.58-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.58-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.58-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.58-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.58-2xl.webp 1920w\"></figure><br>Here we are !!!</p>\n<p> </p>\n<h4 id=\"mcetoc_1gpe0j6931f4\"><span style=\"font-weight: 400;\">1 pod start - hpa 25rps - 15 min - 99 max requests</span></h4>\n<p>let's try with one more</p>\n<figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.00.50.png\" alt=\"\" width=\"1194\" height=\"464\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.50-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.50-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.50-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.50-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.50-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.50-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.00.59.png\" alt=\"\" width=\"1196\" height=\"310\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.59-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.59-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.59-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.59-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.59-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.59-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.01.06.png\" alt=\"\" width=\"1188\" height=\"422\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.06-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.06-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.06-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.06-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.06-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.06-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.01.15.png\" alt=\"\" width=\"1192\" height=\"486\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.15-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.15-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.15-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.15-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.15-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.15-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.01.22.png\" alt=\"\" width=\"1202\" height=\"478\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.22-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.22-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.22-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.22-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.22-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.22-2xl.webp 1920w\"></figure><br>Naaaa .... no more than 24 rps</p>\n<p> </p>\n<h3 id=\"mcetoc_1gpe0j6931f5\"><span style=\"font-weight: 400;\">AUTOSCALING Internal rate limit</span></h3>\n<p><a href=\"https://www.k8s.it/application-rate-limiting.html\" target=\"_blank\" rel=\"noopener noreferrer\">Here how to</a></p>\n<h4 id=\"mcetoc_1gpe0pd9t1fm\"><span style=\"font-weight: 400;\">[optimal] 1 pod start - hpa 25rps</span><span style=\"font-weight: 400;\">- 15 min - 99 max requests rate-limit 27</span></h4>\n<p><span style=\"font-weight: 400;\">I suppose that the </span><em><span style=\"font-weight: 400;\">optimal</span></em><span style=\"font-weight: 400;\">  before (24rps) is working good also with RL so let’s start with 25</span></p>\n<figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.08.07.png\" alt=\"\" width=\"1198\" height=\"622\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.07-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.07-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.07-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.07-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.07-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.07-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.08.14.png\" alt=\"\" width=\"1194\" height=\"334\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.14-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.14-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.14-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.14-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.14-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.14-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.08.20.png\" alt=\"\" width=\"1130\" height=\"448\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.20-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.20-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.20-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.20-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.20-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.20-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.08.29.png\" alt=\"\" width=\"1192\" height=\"468\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.29-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.29-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.29-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.29-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.29-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.29-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.08.34.png\" alt=\"\" width=\"1200\" height=\"472\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.34-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.34-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.34-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.34-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.34-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.34-2xl.webp 1920w\"></figure>\n<p><span style=\"font-weight: 400;\">Better than the same rps with no ratelimit<br></span></p>\n<p><span style=\"font-weight: 400;\">The errors are just the 429 triggered by rate limit … so the good answer are ok and no issue or restart on the application during the autoscaling… a bit of queue</span></p>\n<p><span style=\"font-weight: 400;\">No so bad considering the errors in red as just rate limited calls</span></p>\n<p> </p>\n<h4 id=\"mcetoc_1gpe1laq11pb\"><span style=\"font-weight: 400;\">1 pod start - hpa 26rps - 15 min - 99 max requests rate-limit 28</span></h4>\n<figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.11.25.png\" alt=\"\" width=\"1200\" height=\"650\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.25-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.25-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.25-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.25-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.25-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.25-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.11.33.png\" alt=\"\" width=\"1198\" height=\"294\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.33-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.33-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.33-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.33-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.33-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.33-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.11.41.png\" alt=\"\" width=\"1114\" height=\"418\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.41-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.41-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.41-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.41-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.41-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.41-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.11.49.png\" alt=\"\" width=\"1194\" height=\"474\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.49-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.49-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.49-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.49-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.49-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.49-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.11.56.png\" alt=\"\" width=\"1196\" height=\"472\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.56-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.56-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.56-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.56-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.56-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.56-2xl.webp 1920w\"></figure>\n<p><span style=\"font-weight: 400;\">Just one error for pod unresponsive</span></p>\n<p> </p>\n<h4 id=\"mcetoc_1gpe1laq11pc\"><span style=\"font-weight: 400;\">1 pod start - hpa 27rps - 15 min - 99 max requests rate-limit 29</span></h4>\n<figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.13.57.png\" alt=\"\" width=\"1196\" height=\"770\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.13.57-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.13.57-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.13.57-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.13.57-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.13.57-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.13.57-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.14.08.png\" alt=\"\" width=\"1112\" height=\"266\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.08-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.08-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.08-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.08-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.08-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.08-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.14.14.png\" alt=\"\" width=\"1094\" height=\"422\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.14-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.14-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.14-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.14-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.14-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.14-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.14.21.png\" alt=\"\" width=\"1192\" height=\"478\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.21-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.21-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.21-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.21-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.21-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.21-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.14.28.png\" alt=\"\" width=\"1198\" height=\"458\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.28-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.28-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.28-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.28-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.28-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.28-2xl.webp 1920w\"></figure><br>Broken!!!</p>\n<p> </p>\n<h3 id=\"mcetoc_1gpe1laq11pd\"><span style=\"font-weight: 400;\">AUTOSCALING envoy rate limit</span></h3>\n<h4 id=\"mcetoc_1gpe1laq11pe\"><span style=\"font-weight: 400;\">1 pod start - hpa 27rps - 15 min - 99 max requests rate-limit 29 - envoy</span></h4>\n<figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.17.26.png\" alt=\"\" width=\"1190\" height=\"706\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.26-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.26-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.26-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.26-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.26-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.26-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.17.33.png\" alt=\"\" width=\"1122\" height=\"258\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.33-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.33-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.33-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.33-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.33-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.33-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.17.39.png\" alt=\"\" width=\"1098\" height=\"412\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.39-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.39-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.39-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.39-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.39-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.39-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.17.46.png\" alt=\"\" width=\"1196\" height=\"472\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.46-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.46-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.46-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.46-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.46-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.46-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.17.53.png\" alt=\"\" width=\"1196\" height=\"474\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.53-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.53-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.53-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.53-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.53-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.53-2xl.webp 1920w\"></figure><br>Broken!!!</p>\n<p> </p>\n<h4 id=\"mcetoc_1gpe1laq11pf\"><span style=\"font-weight: 400;\">[optimal] 1 pod start - hpa 26rps - 15 min - 99 max requests rate-limit 29 - envoy</span></h4>\n<figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.19.24.png\" alt=\"\" width=\"1188\" height=\"602\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.24-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.24-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.24-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.24-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.24-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.24-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.19.30.png\" alt=\"\" width=\"1194\" height=\"300\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.30-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.30-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.30-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.30-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.30-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.30-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.19.38.png\" alt=\"\" width=\"1176\" height=\"428\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.38-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.38-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.38-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.38-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.38-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.38-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.19.46.png\" alt=\"\" width=\"1176\" height=\"472\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.46-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.46-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.46-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.46-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.46-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.46-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.19.52.png\" alt=\"\" width=\"1182\" height=\"478\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.52-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.52-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.52-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.52-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.52-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.52-2xl.webp 1920w\"></figure>\n<p><span style=\"font-weight: 400;\">Better than expected compared to the solution with rate limit embedded </span></p>\n<p> </p>\n<h3 id=\"mcetoc_1gpe1laq11pg\"><span style=\"font-weight: 400;\">Unexpected traffic</span></h3>\n<p class=\"msg msg--info\"><span style=\"font-weight: 400;\">rampUsers(30).during(60.seconds),<br></span><span style=\"font-weight: 400;\">constantUsersPerSec(30).during(60.seconds).randomized, <br></span><span style=\"font-weight: 400;\">rampUsersPerSec(30).to(82).during(4.minutes), <br></span><span style=\"font-weight: 400;\">constantUsersPerSec(82).during(120.seconds).randomized,<br></span><span style=\"font-weight: 400;\">rampUsersPerSec(82).to(170).during(10.seconds),<br></span><span style=\"font-weight: 400;\">constantUsersPerSec(82).during(120.seconds).randomized,<br></span><span style=\"font-weight: 400;\">rampUsersPerSec(82).to(130).during(20.seconds),<br></span><span style=\"font-weight: 400;\">constantUsersPerSec(82).during(120.seconds).randomized,<br></span><span style=\"font-weight: 400;\">rampUsersPerSec(82).to(210).during(30.seconds),<br></span><span style=\"font-weight: 400;\">constantUsersPerSec(82).during(120.seconds).randomized,<br></span><span style=\"font-weight: 400;\">constantUsersPerSec(333).during(2.seconds),<br></span><span style=\"font-weight: 400;\">constantUsersPerSec(82).during(120.seconds).randomized,<br></span><span style=\"font-weight: 400;\">constantUsersPerSec(333).during(10.seconds),<br></span><span style=\"font-weight: 400;\">constantUsersPerSec(82).during(80.seconds)</span></p>\n<p><span style=\"font-weight: 400;\"> </span></p>\n<h4 id=\"mcetoc_1gpe2t9fu2jk\"><span style=\"font-weight: 400;\">3 pod start - hpa 26rps - 15 min - 82 avg requests with spikes -  rate-limit 27 internal</span></h4>\n<figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.25.08.png\" alt=\"\" width=\"1194\" height=\"714\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.08-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.08-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.08-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.08-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.08-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.08-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.25.15.png\" alt=\"\" width=\"1192\" height=\"238\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.15-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.15-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.15-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.15-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.15-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.15-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.25.22.png\" alt=\"\" width=\"1148\" height=\"462\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.22-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.22-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.22-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.22-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.22-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.22-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.25.29.png\" alt=\"\" width=\"1194\" height=\"482\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.29-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.29-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.29-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.29-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.29-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.29-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.25.36.png\" alt=\"\" width=\"1200\" height=\"484\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.36-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.36-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.36-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.36-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.36-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.36-2xl.webp 1920w\"></figure>\n<p>Since the incoming requests are absorbed from the app we reach the limit<br>Errors are not only 429 as rate but 5xx</p>\n<p>Broken!!!</p>\n<p> </p>\n<h4 id=\"mcetoc_1gpe2t9fu2jl\"><span style=\"font-weight: 400;\">[optimal] 3 pod start - hpa 26rps - 15 min - 82 avg requests with spikes -  rate-limit 27 - envoy</span></h4>\n<figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.27.32.png\" alt=\"\" width=\"1192\" height=\"594\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.32-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.32-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.32-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.32-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.32-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.32-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.27.40.png\" alt=\"\" width=\"1196\" height=\"234\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.40-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.40-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.40-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.40-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.40-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.40-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.27.46.png\" alt=\"\" width=\"1200\" height=\"422\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.46-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.46-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.46-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.46-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.46-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.46-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.27.54.png\" alt=\"\" width=\"1202\" height=\"472\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.54-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.54-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.54-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.54-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.54-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.54-2xl.webp 1920w\"></figure><br><figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.28.01.png\" alt=\"\" width=\"1204\" height=\"478\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.28.01-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.28.01-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.28.01-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.28.01-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.28.01-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.28.01-2xl.webp 1920w\"></figure>\n<p><span style=\"font-weight: 400;\">No issue at all , since the rl is performed by envoy the python app has no “spikes”</span></p>\n<p> </p>\n<p> </p>\n<h3 id=\"mcetoc_1gpe2t9fu2jm\"><span style=\"font-weight: 400;\">Conclusions</span></h3>\n<h4 id=\"mcetoc_1gpe2t9fu2jn\"><span style=\"font-weight: 400;\">HPA</span></h4>\n<p><span style=\"font-weight: 400;\">This application is cpu bound … so I used req/s even if the right autoscaling metric is the cpu usage, however, I would say that each application has the intent to serve requests.</span><span style=\"font-weight: 400;\"><br></span><span style=\"font-weight: 400;\"><span style=\"text-decoration: underline;\">Create a dedicated configuration, application per application, for the hpa is the best option</span> but it requires <strong>HUGE</strong> know-how and time …</span><span style=\"font-weight: 400;\"><br></span><span style=\"font-weight: 400;\">Considering the sentence before, I was impressed about </span><a href=\"https://gatling.io/docs/gatling/reference/current/stats/reports/#:~:text=%E2%80%9CActive%20users%E2%80%9D%20is%20neither%20%E2%80%9C,load%20at%20a%20given%20second%E2%80%9D.\"><span style=\"font-weight: 400;\">Active users</span></a><span style=\"font-weight: 400;\">  since share the correct clue at high levels about the status of the application, it’s really really close to measuring the enervation of the app</span></p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.30.45.png\" alt=\"\" width=\"1200\" height=\"474\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.30.45-xs.webp 640w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.30.45-sm.webp 768w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.30.45-md.webp 1024w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.30.45-lg.webp 1366w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.30.45-xl.webp 1600w ,https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.30.45-2xl.webp 1920w\"></figure>\n<p>I would say that the concept of active users as a HPA metric is better than <span style=\"font-weight: 400;\">flask_http_request_duration_seconds_count</span></p>\n<p><span style=\"font-weight: 400;\">Even if we can reach 33rps in a single pod , we should consider that in an autoscaling scenario this will be reduced to </span><strong>less, </strong><span style=\"font-weight: 400;\">cause for a certain amount of time we have more requests till we are waiting for new pods/node etc etc </span></p>\n<p>I would say that is better to have an application running at 65% of max capacity before scale</p>\n<p> </p>\n<h4 id=\"mcetoc_1gpe2t9fu2jo\"><span style=\"font-weight: 400;\">Rate Limit</span></h4>\n<p><br><i></i></p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><i><span style=\"font-weight: 400;\">Understand how much we can close with the application enervation during an autoscaling situation using rate limit</span></i></li>\n</ul>\n<p><strong>No</strong><span style=\"font-weight: 400;\"> … or better … we can increase a bit the limit to exploit the app at max possible, however, it’s just a risk for 5% more in rps.</span><span style=\"font-weight: 400;\"><br></span><span style=\"font-weight: 400;\">The application will be more sensible and the rl is really close to the hpa</span></p>\n<p> </p>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><span style=\"font-weight: 400;\">Understand how to handle unexpected traffic with a rate limit</span></li>\n</ul>\n<p><strong>Yes </strong><span style=\"font-weight: 400;\">… this pattern is the right one for the rate limit</span><span style=\"font-weight: 400;\"><br></span><span style=\"font-weight: 400;\">Better is to perform this action outside the application container since will impact unfortunately the incoming requests, the saturation etc etc and you have rl and hpa that can fight each other </span></p>\n<p> </p>\n<h4 id=\"mcetoc_1gpe2t9fu2jp\"><span style=\"font-weight: 400;\">Both</span></h4>\n<ul>\n<li style=\"font-weight: 400;\" aria-level=\"1\"><span style=\"font-weight: 400;\">Do not force hpa to collaborate with rl … should be 2 different parameters</span></li>\n</ul>\n<p>In this scenario are both rps ... but are profiled in a different way , so do not consider as the same metric or meaning</p>\n<p> </p>\n<h4 id=\"mcetoc_1gpe2t9fu2jq\"><span style=\"font-weight: 400;\">Costs</span></h4>\n<p> </p>\n<p><span style=\"font-weight: 400;\">In some way trying to save money by increasing to the possible max rps is risky, we should leverage the kubernetes pod scheduling more than try to reach 100% of the application</span></p>\n<h5 id=\"mcetoc_1gpe2t9fu2jr\"><span style=\"font-weight: 400;\">Highlights</span></h5>\n<p><span style=\"font-weight: 400;\">Unexpected traffic can be something that is generated for a wrong deployment/batch 5% of cases or by external calls 95%</span></p>\n<p><span style=\"font-weight: 400;\">The external calls come from public or private endpoints can be managed by<br></span></p>\n<ul>\n<li>waf rate limit</li>\n<li>api gateway rate limit</li>\n</ul>\n<p><span style=\"font-weight: 400;\">Those two solutions are better, cause they can keep the infrastructure safe as a first point of contact but ... </span><span style=\"font-weight: 400;\">A big </span><strong>BUT</strong></p>\n<p><span style=\"font-weight: 400;\">In a dynamic infrastructure where we have autoscaling and downscaling,  a legit peak like </span><span style=\"font-weight: 400;\">google scrape </span><span style=\"font-weight: 400;\">is not possible to handle, cause the RL is service level <br></span><strong>AND…</strong><span style=\"font-weight: 400;\"> <br></span><span style=\"font-weight: 400;\">during the night, it's supposed to have the minimum pods available as there is less user traffic for example.</span></p>\n<p> </p>\n<p><span style=\"font-weight: 400;\">So … <span style=\"text-decoration: underline;\">I’ll remark on the drawback of cost savings</span> following the </span><span style=\"font-weight: 400;\">matrix based on hpa patterns</span><span style=\"font-weight: 400;\"> (cit </span><a href=\"https://www.imdb.com/title/tt0088850/\"><span style=\"font-weight: 400;\">brewster's millions</span></a><span style=\"font-weight: 400;\">)<br></span>As much as we are close to using fewer resources as possible, as much we are increasing corner cases and unexpected situations.<br><br>Be careful to evaluate the rate limit concept </p>\n<p>Cheers :-) </p>\n<p> </p>\n<p> </p>\n<p> </p>",
            "image": "https://www.k8s.it/media/posts/43/Screenshot_2023-02-14_at_20.15.33-removebg-preview-2.png",
            "author": {
                "name": "lgirardi"
            },
            "tags": [
                   "rate-limiting",
                   "rate limit vs hpa",
                   "hpa",
                   "envoy",
                   "dynamic infrastructure",
                   "cost saving"
            ],
            "date_published": "2023-02-14T20:23:45+01:00",
            "date_modified": "2023-02-16T23:07:18+01:00"
        },
        {
            "id": "https://www.k8s.it/application-rate-limiting.html",
            "url": "https://www.k8s.it/application-rate-limiting.html",
            "title": "application rate limit ",
            "summary": "For some reasons that i will share later on in a dedicated discussion, i had the need to create a rate limit inside the application. For this scenario we have 2 greddy options: the code way This is the simplest one but has some side&hellip;",
            "content_html": "<p dir=\"auto\">For some reasons that i will share later on in a dedicated discussion, i had the need to create a rate limit inside the application.<br><br></p>\n<p dir=\"auto\">For this scenario we have 2 greddy options:</p>\n<ul dir=\"auto\">\n<li>have the logic inside the app , in a <em>code</em> way</li>\n<li>have a sidecar container that has this role</li>\n</ul>\n<p><br><br></p>\n<h2 dir=\"auto\"><a id=\"user-content-the-code-way\" class=\"anchor\" aria-hidden=\"true\" href=\"https://github.com/lorenzogirardi/Kubernetes-sidecar-ratelimit#the-code-way\"><svg class=\"octicon octicon-link\" viewbox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>the code way</h2>\n<p dir=\"auto\">This is the simplest one but has some side effects,<br>first of all can be reaused just for the same language apps.<br>Same as before , having this rate inside the app , we are creating a role inside this app<br>that can be good or bad depending of the strategy applied,<br>imagine the request interceptor for example will consume cpu and may <em>false</em> metrics if we are not aware of it.<br><br>But anyway , it can be a solution , so in a simple python code you have to add the following for example<br>(i will use the usual <a href=\"https://github.com/lorenzogirardi/py-test-backend/tree/ratelimit/docker\">app</a> i'm using for labs stuff)<br>I'ts Flask so you just have to add the following:<br>in requirements.txt --&gt; <code>Flask-Limiter</code></p>\n<p dir=\"auto\">Inside your code , import the libraries</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>from flask_limiter import Limiter\nfrom flask_limiter.util import get_remote_address\n</code></pre>\n</div>\n<p dir=\"auto\">Enable the <em>limiter</em></p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>limiter = Limiter(\n\tget_remote_address,\n\tapp=app,\n\tstorage_uri=\"memory://\",\n)\n</code></pre>\n</div>\n<p dir=\"auto\">And add the limiting option in the route u'd like to rate</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>@limiter.limit(\"28 per second\")\n</code></pre>\n</div>\n<p> </p>\n<h3 dir=\"auto\"><a id=\"user-content-handson\" class=\"anchor\" aria-hidden=\"true\" href=\"https://github.com/lorenzogirardi/Kubernetes-sidecar-ratelimit#handson\"><svg class=\"octicon octicon-link\" viewbox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Handson</h3>\n<p dir=\"auto\">Just moved from <code>@limiter.limit(\"28 per second\")</code> to <code>@limiter.limit(\"2 per second\")</code></p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>$ docker build -t lgirardi/pytbakrated .\n[+] Building 11.1s (9/9) FINISHED\n =&gt; [internal] load build definition from Dockerfile                                                                                                                                                                                     0.0s\n =&gt; =&gt; transferring dockerfile: 34B                                                                                                                                                                                                      0.0s\n =&gt; [internal] load .dockerignore                                                                                                                                                                                                        0.0s\n =&gt; =&gt; transferring context: 2B                                                                                                                                                                                                          0.0s\n =&gt; [internal] load metadata for docker.io/library/python:3.9-alpine                                                                                                                                                                     0.6s\n =&gt; [internal] load build context                                                                                                                                                                                                        0.0s\n =&gt; =&gt; transferring context: 4.47kB                                                                                                                                                                                                      0.0s\n =&gt; CACHED [1/4] FROM docker.io/library/python:3.9-alpine@sha256:8bda1e9a98fa4e87ff6e3a7682f496532b06fcbae10326a59c8656126051d4df                                                                                                        0.0s\n =&gt; [2/4] COPY . /app                                                                                                                                                                                                                    0.0s\n =&gt; [3/4] WORKDIR /app                                                                                                                                                                                                                   0.0s\n =&gt; [4/4] RUN pip install -r requirements.txt                                                                                                                                                                                            9.9s\n =&gt; exporting to image                                                                                                                                                                                                                   0.4s\n =&gt; =&gt; exporting layers                                                                                                                                                                                                                  0.4s\n =&gt; =&gt; writing image sha256:583ec19905662414ad6bdb3b0da1042ec799ec46f8a676fac6553364cd02bf1e                                                                                                                                             0.0s\n =&gt; =&gt; naming to docker.io/lgirardi/pytbakrated\n</code></pre>\n</div>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>$ docker run -p 5000:5000 lgirardi/pytbakrated\n * Serving Flask app 'app'\n * Debug mode: off\n2023-02-11 10:36:06,264 INFO werkzeug MainThread : WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.\n * Running on all addresses (0.0.0.0)\n * Running on http://127.0.0.1:5000\n * Running on http://172.17.0.2:5000\n2023-02-11 10:36:06,264 INFO werkzeug MainThread : Press CTRL+C to quit\n</code></pre>\n</div>\n<p dir=\"auto\">With a simple curl you can check if it's working , so the rate will be triggered if u go over 2 req/sec</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>$ while true; do curl -I localhost:5000/api/fib/1 &amp;&amp; sleep 0.4;done\nHTTP/1.1 200 OK\nServer: Werkzeug/2.2.2 Python/3.9.16\nDate: Sat, 11 Feb 2023 10:37:54 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 1\nVary: Accept-Encoding\nConnection: close\n\nHTTP/1.1 200 OK\nServer: Werkzeug/2.2.2 Python/3.9.16\nDate: Sat, 11 Feb 2023 10:37:54 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 1\nVary: Accept-Encoding\nConnection: close\n\nHTTP/1.1 429 TOO MANY REQUESTS\nServer: Werkzeug/2.2.2 Python/3.9.16\nDate: Sat, 11 Feb 2023 10:37:55 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 117\nVary: Accept-Encoding\nConnection: close\n\nHTTP/1.1 200 OK\nServer: Werkzeug/2.2.2 Python/3.9.16\nDate: Sat, 11 Feb 2023 10:37:55 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 1\nVary: Accept-Encoding\nConnection: close\n\nHTTP/1.1 200 OK\nServer: Werkzeug/2.2.2 Python/3.9.16\nDate: Sat, 11 Feb 2023 10:37:56 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 1\nVary: Accept-Encoding\nConnection: close\n\nHTTP/1.1 429 TOO MANY REQUESTS\nServer: Werkzeug/2.2.2 Python/3.9.16\nDate: Sat, 11 Feb 2023 10:37:56 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 117\n</code></pre>\n</div>\n<p dir=\"auto\">in the same way the contrainer logs are showing the same</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>2023-02-11 10:37:54,359 INFO werkzeug Thread-34 : 172.17.0.1 - - [11/Feb/2023 10:37:54] \"HEAD /api/fib/1 HTTP/1.1\" 200 -\n2023-02-11 10:37:54,778 INFO werkzeug Thread-36 : 172.17.0.1 - - [11/Feb/2023 10:37:54] \"HEAD /api/fib/1 HTTP/1.1\" 200 -\n2023-02-11 10:37:55,196 INFO flask-limiter Thread-38 : ratelimit 2 per 1 second (172.17.0.1) exceeded at endpoint: fib\n2023-02-11 10:37:55,197 INFO werkzeug Thread-38 : 172.17.0.1 - - [11/Feb/2023 10:37:55] \"HEAD /api/fib/1 HTTP/1.1\" 429 -\n2023-02-11 10:37:55,616 INFO werkzeug Thread-40 : 172.17.0.1 - - [11/Feb/2023 10:37:55] \"HEAD /api/fib/1 HTTP/1.1\" 200 -\n2023-02-11 10:37:56,035 INFO werkzeug Thread-42 : 172.17.0.1 - - [11/Feb/2023 10:37:56] \"HEAD /api/fib/1 HTTP/1.1\" 200 -\n2023-02-11 10:37:56,455 INFO flask-limiter Thread-44 : ratelimit 2 per 1 second (172.17.0.1) exceeded at endpoint: fib\n2023-02-11 10:37:56,456 INFO werkzeug Thread-44 : 172.17.0.1 - - [11/Feb/2023 10:37:56] \"HEAD /api/fib/1 HTTP/1.1\" 429 -\n</code></pre>\n</div>\n<p dir=\"auto\">Honestly there are few pro and cons ... but i'd like to enter in those details with a more practical exmaple ...<br>just few concepts anyway are:</p>\n<ul dir=\"auto\">\n<li>is using the same pool of connections</li>\n<li>it's impacting the same metric that i'm using for autoscaling</li>\n<li>is stealing resources from app</li>\n<li>is really simple rate limit that can fight with others stuff</li>\n</ul>\n<p><br><br></p>\n<h2 dir=\"auto\"><a id=\"user-content-the-sidecar-way\" class=\"anchor\" aria-hidden=\"true\" href=\"https://github.com/lorenzogirardi/Kubernetes-sidecar-ratelimit#the-sidecar-way\"><svg class=\"octicon octicon-link\" viewbox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>the sidecar way</h2>\n<p dir=\"auto\">Yes i know , this is a <em>stretch</em>, since we have service mesh , gateway etc etc that embrace this concept.<br>However, for a specific reason, i created just a sidecar container that can be reused without the needs to implement the infrastructure mentioned before</p>\n<p dir=\"auto\">First of all the choice, tons of possibility, from nginx reverse proxy , to haproxy to <em>whatever</em> proxy ...<br>in this scenario i took the opportunity to use <strong>envoy</strong> , i've already used it with istio , and is really really flexible<br>(sometimes too much, in a way to be confused :-)</p>\n<p dir=\"auto\">Anyway ... it's just a sidecar<br>In an existing app you have to add the following to add envoy</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>      - name: sidecar\n        image: envoyproxy/envoy:v1.22-latest\n        resources:\n          limits:\n            cpu: 100m\n            memory: 150Mi\n          requests:\n            cpu: 30m\n            memory: 55Mi\n        ports:\n          - name: http\n            containerPort: 5002\n            protocol: TCP\n        volumeMounts:\n          - name: sidecar-config\n            mountPath: \"/etc/envoy\"\n            readOnly: true\n      volumes:\n        - name: sidecar-config\n          configMap:\n            name: pytbakt-configmap\n</code></pre>\n</div>\n<p dir=\"auto\">(great fantasy for the name :-)</p>\n<p dir=\"auto\">and ... well the most important configuration is the <code>pytbakt-configmap</code> that is the envoy configuration</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: pytbakt-configmap\n  labels:\n    app: pytbak\n  namespace: pytbak\ndata:\n  envoy.yaml: |\n    static_resources:\n      listeners:\n      - name: listener_0\n        address:\n          socket_address:\n            address: 0.0.0.0\n            port_value: 5002\n        filter_chains:\n        - filters:\n          - name: envoy.filters.network.http_connection_manager\n            typed_config:\n              \"@type\": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\n              stat_prefix: ingress_http\n              route_config:\n                name: local_route\n                virtual_hosts:\n                - name: local_service\n                  domains: [\"*\"]\n                  routes:\n                  - match:\n                      prefix: \"/\"\n                    route:\n                      cluster: pytbak\n              http_filters:\n              - name: envoy.filters.http.local_ratelimit\n                typed_config:\n                  \"@type\": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit\n                  stat_prefix: http_local_rate_limiter\n                  token_bucket:\n                    max_tokens: 29\n                    tokens_per_fill: 29\n                    fill_interval: 1s\n                  filter_enabled:\n                    runtime_key: local_rate_limit_enabled\n                    default_value:\n                      numerator: 100\n                      denominator: HUNDRED\n                  filter_enforced:\n                    runtime_key: local_rate_limit_enforced\n                    default_value:\n                      numerator: 100\n                      denominator: HUNDRED\n                  response_headers_to_add:\n                  - append_action: OVERWRITE_IF_EXISTS_OR_ADD\n                    header:\n                      key: x-local-rate-limit\n                      value: 'true'\n                  local_rate_limit_per_downstream_connection: false\n\n              - name: envoy.filters.http.router\n                typed_config:\n                  \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\n\n      clusters:\n      - name: pytbak\n        connect_timeout: 0.25s\n        type: LOGICAL_DNS\n        dns_lookup_family: V4_ONLY\n        lb_policy: ROUND_ROBIN\n        load_assignment:\n          cluster_name: service_a\n          endpoints:\n          - lb_endpoints:\n            - endpoint:\n                address:\n                  socket_address:\n                    address: localhost\n                    port_value: 5000\n</code></pre>\n</div>\n<p dir=\"auto\">in a Human readable way ...</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>      - name: listener_0\n        address:\n          socket_address:\n            address: 0.0.0.0\n            port_value: 5002\n</code></pre>\n</div>\n<p dir=\"auto\">envoy proxy is listening on port 5002</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>                - name: local_service\n                  domains: [\"*\"]\n                  routes:\n                  - match:\n                      prefix: \"/\"\n                    route:\n                      cluster: pytbak\n</code></pre>\n</div>\n<p dir=\"auto\">no path or domain configuration , just handle all after <code>/</code></p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>      clusters:\n      - name: pytbak\n        connect_timeout: 0.25s\n        type: LOGICAL_DNS\n        dns_lookup_family: V4_ONLY\n        lb_policy: ROUND_ROBIN\n        load_assignment:\n          cluster_name: service_a\n          endpoints:\n          - lb_endpoints:\n            - endpoint:\n                address:\n                  socket_address:\n                    address: localhost\n                    port_value: 5000\n</code></pre>\n</div>\n<p dir=\"auto\">something like <em>reverse proxy</em> configuration since the app is listening on port 5000</p>\n<p dir=\"auto\">And now the Rate limiting section</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>              http_filters:\n              - name: envoy.filters.http.local_ratelimit\n                typed_config:\n                  \"@type\": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit\n                  stat_prefix: http_local_rate_limiter\n                  token_bucket:\n                    max_tokens: 29\n                    tokens_per_fill: 29\n                    fill_interval: 1s\n                  filter_enabled:\n                    runtime_key: local_rate_limit_enabled\n                    default_value:\n                      numerator: 100\n                      denominator: HUNDRED\n                  filter_enforced:\n                    runtime_key: local_rate_limit_enforced\n                    default_value:\n                      numerator: 100\n                      denominator: HUNDRED\n                  response_headers_to_add:\n                  - append_action: OVERWRITE_IF_EXISTS_OR_ADD\n                    header:\n                      key: x-local-rate-limit\n                      value: 'true'\n                  local_rate_limit_per_downstream_connection: false\n</code></pre>\n</div>\n<p dir=\"auto\">we have a bucket of 29 token , and every second it re-enable the 29 token in the bucket ... i mean ... 29req/second <em>almost</em> :-)</p>\n<h3 dir=\"auto\"><a id=\"user-content-handson-1\" class=\"anchor\" aria-hidden=\"true\" href=\"https://github.com/lorenzogirardi/Kubernetes-sidecar-ratelimit#handson-1\"><svg class=\"octicon octicon-link\" viewbox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Handson</h3>\n<p dir=\"auto\">Again i changed the rate limit to 2req/second</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>                  token_bucket:\n                    max_tokens: 2\n                    tokens_per_fill: 2\n                    fill_interval: 1s\n</code></pre>\n</div>\n<p dir=\"auto\">in kubernetes <code>pytbak              pytbak-stable-bd648fd46-nj95m              2/2     Running       0                 13s</code></p>\n<p dir=\"auto\">kubectl describe pod pytbak-stable-bd648fd46-nj95m -n pytbak</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>Name:         pytbak-stable-bd648fd46-nj95m\nNamespace:    pytbak\nPriority:     0\nNode:         instance-20220215-1853/10.0.254.135\nStart Time:   Sat, 11 Feb 2023 11:19:45 +0000\nLabels:       app=pytbak\n              pod-template-hash=bd648fd46\n              track=pytbak-stable\nAnnotations:  cni.projectcalico.org/podIP: 10.1.156.173/32\n              cni.projectcalico.org/podIPs: 10.1.156.173/32\n              prometheus.io/path: /metrics\n              prometheus.io/port: 5000\n              prometheus.io/scrape: true\nStatus:       Running\nIP:           10.1.156.173\nIPs:\n  IP:           10.1.156.173\nControlled By:  ReplicaSet/pytbak-stable-bd648fd46\nContainers:\n  pytbak:\n    Container ID:   containerd://9a54504e73a14746299366e2941b51f7069b6649208329a3f87708b053ef1eaf\n    Image:          lgirardi/rest-test-multip:0.6\n    Image ID:       docker.io/lgirardi/rest-test-multip@sha256:c94695a04fb3b862bfb576ead460aba3528bd098327f88122d087f48380506dd\n    Port:           5000/TCP\n    Host Port:      0/TCP\n    State:          Running\n      Started:      Sat, 11 Feb 2023 11:19:46 +0000\n    Ready:          True\n    Restart Count:  0\n    Limits:\n      cpu:     300m\n      memory:  250Mi\n    Requests:\n      cpu:        30m\n      memory:     125Mi\n    Liveness:     http-get http://:5000/api/ delay=40s timeout=10s period=10s #success=1 #failure=3\n    Readiness:    http-get http://:5000/api/ delay=5s timeout=15s period=10s #success=1 #failure=3\n    Environment:  &lt;none&gt;\n    Mounts:\n      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-xrr7c (ro)\n  sidecar:\n    Container ID:   containerd://a0d45982aa56704983a89bacd664e5cbb8b38b1df943df92ad879e7c66986c22\n    Image:          envoyproxy/envoy:v1.22-latest\n    Image ID:       docker.io/envoyproxy/envoy@sha256:3b1e0114dbead3fbd9f561994f3894f5d113a815e023065cabdf0c48d55396ce\n    Port:           5002/TCP\n    Host Port:      0/TCP\n    State:          Running\n      Started:      Sat, 11 Feb 2023 11:19:47 +0000\n    Ready:          True\n    Restart Count:  0\n    Limits:\n      cpu:     100m\n      memory:  150Mi\n    Requests:\n      cpu:        30m\n      memory:     55Mi\n    Environment:  &lt;none&gt;\n    Mounts:\n      /etc/envoy from sidecar-config (ro)\n      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-xrr7c (ro)\nConditions:\n  Type              Status\n  Initialized       True\n  Ready             True\n  ContainersReady   True\n  PodScheduled      True\nVolumes:\n  sidecar-config:\n    Type:      ConfigMap (a volume populated by a ConfigMap)\n    Name:      pytbakt-configmap\n    Optional:  false\n  kube-api-access-xrr7c:\n    Type:                    Projected (a volume that contains injected data from multiple sources)\n    TokenExpirationSeconds:  3607\n    ConfigMapName:           kube-root-ca.crt\n    ConfigMapOptional:       &lt;nil&gt;\n    DownwardAPI:             true\nQoS Class:                   Burstable\nNode-Selectors:              &lt;none&gt;\nTolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s\n                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s\nEvents:\n  Type    Reason     Age    From               Message\n  ----    ------     ----   ----               -------\n  Normal  Scheduled  3m53s  default-scheduler  Successfully assigned pytbak/pytbak-stable-bd648fd46-nj95m to instance-20220215-1853\n  Normal  Pulled     3m53s  kubelet            Container image \"lgirardi/rest-test-multip:0.6\" already present on machine\n  Normal  Created    3m53s  kubelet            Created container pytbak\n  Normal  Started    3m53s  kubelet            Started container pytbak\n  Normal  Pulled     3m53s  kubelet            Container image \"envoyproxy/envoy:v1.22-latest\" already present on machine\n  Normal  Created    3m53s  kubelet            Created container sidecar\n  Normal  Started    3m52s  kubelet            Started container sidecar\n</code></pre>\n</div>\n<p dir=\"auto\">With curl</p>\n<p dir=\"auto\">$ while true;do curl -I <a href=\"http://oracolo.k8s.it/api/fib/1\" rel=\"nofollow\">http://oracolo.k8s.it/api/fib/1</a> &amp;&amp; sleep 0.4;done</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>HTTP/1.1 200 OK\nDate: Sat, 11 Feb 2023 11:29:48 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 1\nConnection: keep-alive\nvary: Accept-Encoding\nx-envoy-upstream-service-time: 2\n\nHTTP/1.1 200 OK\nDate: Sat, 11 Feb 2023 11:29:49 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 1\nConnection: keep-alive\nvary: Accept-Encoding\nx-envoy-upstream-service-time: 2\n\nHTTP/1.1 429 Too Many Requests\nDate: Sat, 11 Feb 2023 11:29:49 GMT\nContent-Type: text/plain\nContent-Length: 18\nConnection: keep-alive\nx-local-rate-limit: true\n\nHTTP/1.1 200 OK\nDate: Sat, 11 Feb 2023 11:29:50 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 1\nConnection: keep-alive\nvary: Accept-Encoding\nx-envoy-upstream-service-time: 2\n\nHTTP/1.1 200 OK\nDate: Sat, 11 Feb 2023 11:29:50 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 1\nConnection: keep-alive\nvary: Accept-Encoding\nx-envoy-upstream-service-time: 2\n\nHTTP/1.1 429 Too Many Requests\nDate: Sat, 11 Feb 2023 11:29:50 GMT\nContent-Type: text/plain\nContent-Length: 18\nConnection: keep-alive\nx-local-rate-limit: true\n\nHTTP/1.1 200 OK\nDate: Sat, 11 Feb 2023 11:29:51 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 1\nConnection: keep-alive\nvary: Accept-Encoding\nx-envoy-upstream-service-time: 2\n\nHTTP/1.1 200 OK\nDate: Sat, 11 Feb 2023 11:29:51 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 1\nConnection: keep-alive\nvary: Accept-Encoding\nx-envoy-upstream-service-time: 2\n\nHTTP/1.1 429 Too Many Requests\nDate: Sat, 11 Feb 2023 11:29:51 GMT\nContent-Type: text/plain\nContent-Length: 18\nConnection: keep-alive\nx-local-rate-limit: true</code></pre>\n<p>Both solution are working, different ways and different impacts on the app. In the next episode i will explain why i did this job , however, now in case u need a simple way to rate limit you app you can have a sidecar container out of the box.</p>\n</div>",
            "image": "https://www.k8s.it/media/posts/42/Screenshot-2023-02-11-at-13.18.48.png",
            "author": {
                "name": "lgirardi"
            },
            "tags": [
                   "standalone",
                   "sidecar conatiner",
                   "sidecar",
                   "service mesh",
                   "rate-limiting",
                   "rate limit",
                   "python",
                   "kubernetes",
                   "flask",
                   "envoy",
                   "api-gateway"
            ],
            "date_published": "2023-02-11T13:10:54+01:00",
            "date_modified": "2023-02-11T13:23:20+01:00"
        },
        {
            "id": "https://www.k8s.it/ya-vpn-service-in-kubernetes.html",
            "url": "https://www.k8s.it/ya-vpn-service-in-kubernetes.html",
            "title": "YA vpn service in kubernetes",
            "summary": "Table of contents Why Key generation Kubernetes deployment Test and results Why Honestly i was scared to dismiss my beloved ipsec based on strongswan, however on of my colleagues shared me how low is the overhead of wireguard, so i was interested to check myself. First&hellip;",
            "content_html": "<h2 dir=\"auto\">Table of contents</h2>\n<ol dir=\"auto\">\n<li>Why</li>\n<li>Key generation</li>\n<li>Kubernetes deployment</li>\n<li>Test and results</li>\n</ol>\n<h2 dir=\"auto\">Why</h2>\n<p dir=\"auto\">Honestly i was scared to dismiss my beloved ipsec based on <a href=\"https://github.com/lorenzogirardi/kubernetes-strongswan\">strongswan</a>,<br>however on of my colleagues shared me how low is the overhead of wireguard, so i was interested to check myself.</p>\n<p dir=\"auto\"><br><br></p>\n<h2 dir=\"auto\">Key generation</h2>\n<p dir=\"auto\">First you have to install wg somewhere , however if u are using a mac , it's enough<br><code>brew install wireguard-tools</code></p>\n<p dir=\"auto\">Second step is generate the keys</p>\n<p dir=\"auto\">Server:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>wg genkey &gt; server_privatekey  \nwg pubkey &lt; server_privatekey &gt; server_publickey_me\n</code></pre>\n</div>\n<p dir=\"auto\">Client:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>wg genkey | tee me_privatekey | wg pubkey &gt; me_publickey   \n</code></pre>\n</div>\n<p dir=\"auto\"><br><span style=\"color: var(--headings-color); font-family: var(--font-base); font-size: 1.60181em; font-weight: var(--font-weight-bold); letter-spacing: var(--letter-spacing);\">Kubernetes deployment</span></p>\n<p dir=\"auto\">Let's create a dedicated namespace , i'm not a fan of default</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>apiVersion: v1\nkind: Namespace\nmetadata:\n  name: wireguard\n  labels:\n    name: wireguard\n</code></pre>\n</div>\n<p dir=\"auto\">Since i'm under a vps i will use the nodePort</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: wireguard\n  namespace: wireguard\nspec:\n  type: NodePort\n  ports:\n    - port: 51820\n      nodePort: 31820\n      protocol: UDP\n      targetPort: 51820\n  selector:\n    name: wireguard\n</code></pre>\n</div>\n<p dir=\"auto\">in this example the udp will be shown on public_ip:31820</p>\n<p dir=\"auto\">Now ... we have multiple options , mount a persisten volume , use secrets , use configmaps etc etc<br>here just for a test purpose i've used the secrets</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: wireguard\n  namespace: wireguard\ntype: Opaque\nstringData:\n  wg0.conf.template: |\n    [Interface]\n    Address = 172.16.18.0/20\n    ListenPort = 51820\n    PrivateKey = &lt;server_privatekey&gt;\n    PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o ENI -j MASQUERADE\n    PostUp = sysctl -w -q net.ipv4.ip_forward=1\n    PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o ENI -j MASQUERADE\n    PostDown = sysctl -w -q net.ipv4.ip_forward=0\n\n    [Peer]\n    #me\n    PublicKey = &lt;me_publickey&gt;\n    AllowedIPs = 172.16.18.10\n</code></pre>\n</div>\n<p dir=\"auto\">where <code>72.16.18.0/20</code> is the road warrior tunnel and<br><code>172.16.18.10</code> is the client ip assigned to me.</p>\n<p dir=\"auto\">Last the deployment</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: wireguard\n  namespace: wireguard\nspec:\n  selector:\n    matchLabels:\n      name: wireguard\n  template:\n    metadata:\n      labels:\n        name: wireguard\n    spec:\n      initContainers:\n        - name: \"wireguard-template-replacement\"\n          image: \"busybox\"\n          command: [\"sh\", \"-c\", \"ENI=$(ip route get 8.8.8.8 | grep 8.8.8.8 | awk '{print $5}'); sed \\\"s/ENI/$ENI/g\\\" /etc/wireguard-secret/wg0.conf.template &gt; /etc/wireguard/wg0.conf; chmod 400 /etc/wireguard/wg0.conf\"]\n          volumeMounts:\n            - name: wireguard-config\n              mountPath: /etc/wireguard/\n            - name: wireguard-secret\n              mountPath: /etc/wireguard-secret/\n      containers:\n        - name: \"wireguard\"\n          image: \"linuxserver/wireguard:latest\"\n          ports:\n            - containerPort: 51820\n          env:\n            - name: \"TZ\"\n              value: \"Europe/Rome\"\n            - name: \"PEERS\"\n              value: \"example\"\n          volumeMounts:\n            - name: wireguard-config\n              mountPath: /etc/wireguard/\n              readOnly: true\n          securityContext:\n            privileged: true\n            capabilities:\n              add:\n                - NET_ADMIN\n      volumes:\n        - name: wireguard-config\n          emptyDir: {}\n        - name: wireguard-secret\n          secret:\n            secretName: wireguard\n      imagePullSecrets:\n        - name: docker-registry\n</code></pre>\n</div>\n<p dir=\"auto\">if everithing is done correctly you will se the following<br><code>kubectl get pods -n wireguard</code></p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>NAME                         READY   STATUS    RESTARTS   AGE\nwireguard-74ff66988d-ltwkq   1/1     Running   0          108m\n</code></pre>\n</div>\n<p dir=\"auto\">and</p>\n<p dir=\"auto\"><code># kubectl exec -n wireguard -it deployment/wireguard -- bash</code></p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>root@wireguard-74ff66988d-ltwkq:/# wg show\ninterface: wg0\n  public key: Er7V4vxMEVBNZbqbDzHgXlYnZjSwrJYtwds86oOLLEg=\n  private key: (hidden)\n  listening port: 51820\n\npeer: dfJjw5rdVNhmcIlDyFAXZI0rBQydsw9uqlh4kFJxBa0I=\n  endpoint: 10.0.254.135:33851\n  allowed ips: 172.16.18.10/32\n  latest handshake: 5 minutes, 16 seconds ago\n  transfer: 30.63 MiB received, 6.55 MiB sent\n</code></pre>\n</div>\n<p dir=\"auto\">For the client i strongly ... STRONGLY suggest to import a configuration</p>\n<p dir=\"auto\"><code>$ cat wireconf.conf</code></p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>[Interface]\nAddress = 172.16.18.10/32\nPrivateKey = &lt;me_privatekey&gt;\nDNS = 1.1.1.1\n\n[Peer]\nPublicKey = &lt;server_publickey_me&gt;\nAllowedIPs = 0.0.0.0/0, ::/0\nEndpoint = &lt;your-public-ip&gt;:31820\n</code></pre>\n</div>\n<h2 dir=\"auto\"> </h2>\n<h2 dir=\"auto\">Test and results</h2>\n<p dir=\"auto\">From mobile<br><a href=\"https://res.cloudinary.com/ethzero/video/upload/v1658175554/misc/wireguard-mobile.mp4\" title=\"wirecardmobile\" rel=\"nofollow\"><img loading=\"lazy\" src=\"https://camo.githubusercontent.com/6ce79561a4eab7bc80d169a5c3f3f184d6f14642fe06fa6de0d72b0be062285f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3234302f76313635383137353835372f6d6973632f77697265636172646d6f62696c652e706e67\" alt=\"wirecardmobile\" data-canonical-src=\"https://res.cloudinary.com/ethzero/image/upload/c_scale,w_240/v1658175857/misc/wirecardmobile.png\" data-is-external-image=\"true\"></a></p>\n<p dir=\"auto\">And what about the resources usage with 1g file download...<br><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://camo.githubusercontent.com/8b842d08f4e0858968e44bb161c194c426e7eb624e1f22dcab7a61cf28eb58b1/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313635383137363737332f6d6973632f77697265677561726465736b746f702e706e67\"><img loading=\"lazy\" src=\"https://camo.githubusercontent.com/8b842d08f4e0858968e44bb161c194c426e7eb624e1f22dcab7a61cf28eb58b1/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313635383137363737332f6d6973632f77697265677561726465736b746f702e706e67\" alt=\"\" data-canonical-src=\"https://res.cloudinary.com/ethzero/image/upload/v1658176773/misc/wireguardesktop.png\" data-is-external-image=\"true\"></a></p>\n<p dir=\"auto\"><br><br></p>\n<p dir=\"auto\">So i'm really impressed by the efficiency of this tool ... i was reading a lot of good mention about it,<br>however today i discovered another tool for my swiss army knife</p>\n<p dir=\"auto\"> </p>\n<h3 dir=\"auto\">UPDATE</h3>\n<p dir=\"auto\">Added a monitoring service as a sidecar container based on prometheus exporter <a href=\"https://github.com/MindFlavor/prometheus_wireguard_exporter\">https://github.com/MindFlavor/prometheus_wireguard_exporter</a></p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>      annotations:\n        prometheus.io/scrape: \"true\"\n        prometheus.io/path: \"/metrics\"\n        prometheus.io/port: \"9586\"\n</code></pre>\n</div>\n<p dir=\"auto\">this annotation is based of kubernetes service discovery in prometheus server</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\">\n<pre class=\"notranslate\"><code>        - name: \"wg-exporter\"\n          image: \"mindflavor/prometheus-wireguard-exporter:3.6.3\"\n          args: [\"--prepend_sudo=true\"]\n          ports:\n            - containerPort: 9586\n          securityContext:\n            privileged: true\n            capabilities:\n              add:\n                - NET_ADMIN\n                - NET_BIND_SERVICE\n</code></pre>\n</div>\n<p dir=\"auto\">configuration file available in monitoring branch <a href=\"https://github.com/lorenzogirardi/kubernetes-wireguard/blob/monitoring/deploy/wireguard-dpl.yaml\">https://github.com/lorenzogirardi/kubernetes-wireguard/blob/monitoring/deploy/wireguard-dpl.yaml</a></p>\n<p dir=\"auto\">Grafana</p>\n<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://camo.githubusercontent.com/28a65e4b0102d5eac3718ca9130f124b934a57eee7c959621da22e44ac153081/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313635383930313235322f6d6973632f67726166616e612d7769726567756172642e706e67\"><img loading=\"lazy\" src=\"https://camo.githubusercontent.com/28a65e4b0102d5eac3718ca9130f124b934a57eee7c959621da22e44ac153081/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f76313635383930313235322f6d6973632f67726166616e612d7769726567756172642e706e67\" alt=\"\" data-canonical-src=\"https://res.cloudinary.com/ethzero/image/upload/v1658901252/misc/grafana-wireguard.png\" data-is-external-image=\"true\"></a></p>",
            "author": {
                "name": "lgirardi"
            },
            "tags": [
                   "wireguard",
                   "vpn",
                   "system metrics",
                   "performances",
                   "kubernetes"
            ],
            "date_published": "2022-07-18T23:08:25+02:00",
            "date_modified": "2022-07-27T07:58:34+02:00"
        },
        {
            "id": "https://www.k8s.it/lazy-people-do-it-better.html",
            "url": "https://www.k8s.it/lazy-people-do-it-better.html",
            "title": "Lazy people do it better",
            "summary": "We are usually habit, sometimes, to react to some events with predefined actions If we increase the traffic then we increase the resources That is true and in some scenario is still the procedure , however i think we need to better understand what we have&hellip;",
            "content_html": "<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/35/lazy.gif\" alt=\"\" width=\"480\" height=\"270\"></figure>\n<p> </p>\n<p>We are usually habit, sometimes, to react to some events with predefined actions </p>\n<p><strong>If</strong> we increase the traffic <strong>then </strong>we increase the resources <br>That is true and in some scenario is still the procedure , however i think we need to better understand what we have behind and the goal that we want to reach.<br><br>Since <span style=\"text-decoration: underline;\">I'm lazy</span> i prefer to work one time , rather than be event driven </p>\n<p>First of all the <strong>KPI </strong><br>This is not only related if the service is up and down , or if it's degraded or not ... is mostly focused on the service expectation <br><br>Answer in 3ms ?<br>Answer in 30ms ?<br>Answer in 300ms ?<br>Answer in 3000ms ?</p>\n<p>In all the above question the service is running but the impact can be really different</p>\n<p>So let's talk a bit about <strong>ONE </strong>of the possible infrastructure helpful trick ... the autoscaling.<br>This concept is already present since some years , aws has embraced it as first with the autoscaling solution for ec2 instances , now (since few years) kubernetes as introduced the HPA<br><br>How can help ?<br>There are many answer , but it's better to test with a lab some of those<br><br></p>\n<h4>Environment settings</h4>\n<p>Imagine an application that is managing a service<br>In this example is a <a href=\"https://github.com/lorenzogirardi/py-test-backend\">python api</a> that answer for a fibonacci serie</p>\n<p><code>$ curl -i https://oracolo.k8s.it/api/fiHTTP/1.1 200 OK</code><br><code>Date: Mon, 21 Feb 2022 15:18:50 GMT</code><br><code>Content-Type: text/html; charset=utf-8</code><br><code>Content-Length: 21</code><br><code>Connection: keep-alive</code><br><br><code>354224848179261915075</code></p>\n<p>The idea was to have a function to slowdown the requests with the increase of cpu usage but to have a response time within 300ms (the <strong>KPI</strong>)</p>\n<p>The application is installed on kubernetes with the following deployment</p>\n<p><code>apiVersion: apps/v1</code><br><code>kind: Deployment</code><br><code>metadata:</code><br><code>  labels:</code><br><code>    app: pytbak</code><br><code>    track: pytbak-stable</code><br><code>  name: pytbak-stable</code><br><code>  namespace: pytbak</code><br><code>spec:</code><br><code>  minReadySeconds: 10</code><br><code>  replicas: 3</code><br><code>  revisionHistoryLimit: 5</code><br><code>  selector:</code><br><code>    matchLabels:</code><br><code>      app: pytbak</code><br><code>      track: pytbak-stable</code><br><code>  strategy:</code><br><code>    rollingUpdate:</code><br><code>      maxSurge: 50%</code><br><code>      maxUnavailable: 0</code><br><code>    type: RollingUpdate</code><br><code>  template:</code><br><code>    metadata:</code><br><code>      annotations:</code><br><code>        prometheus.io/scrape: \"true\"</code><br><code>        prometheus.io/path: \"/metrics\"</code><br><code>        prometheus.io/port: \"5000\"</code><br><code>      labels:</code><br><code>        app: pytbak</code><br><code>        track: pytbak-stable</code><br><code>    spec:</code><br><code>      containers:</code><br><code>      - name: pytbak</code><br><code>        image: lgirardi/rest-test-multip:0.3</code><br><code>        resources:</code><br><code>          limits:</code><br><code>            cpu: 300m</code><br><code>            memory: 250Mi</code><br><code>          requests:</code><br><code>            cpu: 30m</code><br><code>            memory: 125Mi</code><br><code>        ports:</code><br><code>        - name: http</code><br><code>          containerPort: 5000</code><br><code>        livenessProbe:</code><br><code>          httpGet:</code><br><code>            path: /api/</code><br><code>            port: 5000</code><br><code>          initialDelaySeconds: 40</code><br><code>          timeoutSeconds: 10</code><br><code>        readinessProbe:</code><br><code>          httpGet:</code><br><code>            path: /api/</code><br><code>            port: 5000</code><br><code>          initialDelaySeconds: 5</code><br><code>          timeoutSeconds: 15</code></p>\n<p>Now we have how 3 pods ready to handle requests</p>\n<p>In an unrealistic use cases we have a constant usage, instead in the real world, the usage is impacted by peak of traffic, scrapes , new feature , promotion , regional distribution etc etc </p>\n<p>I know , it's a stretch using this gatling configuration but it's useful to share the idea<br><code>  setUp(</code><br><code>      scn.inject(</code><br><code>    nothingFor(1.seconds), // do nothing for 1 sec</code><br><code>    atOnceUsers(1), // have 1 call for 1 sec</code><br><code>    rampUsers(10).during(20.seconds), // increase users to 10 in 20 sec</code><br><code>    constantUsersPerSec(10).during(15.seconds), // keep 10 users for 15 sec</code><br><code>    rampUsersPerSec(10).to(100).during(3.minutes), // increase users to 100 in 3 min</code><br><code>    constantUsersPerSec(100).during(60.seconds), // keep 100 users for 1 min</code><br><code>    rampUsersPerSec(100).to(10).during(3.minutes).randomized, // decrease users to 10 in 3 min</code><br><code>    constantUsersPerSec(10).during(30.seconds), // keep 10 users for 30 sec</code><br><code>    rampUsersPerSec(10).to(1).during(10.seconds).randomized, // decrease users to 1 in 10 sec</code><br><code>  ).protocols(httpProtocol)</code><br><code>)</code></p>\n<p> </p>\n<p>and the url tested was</p>\n<p><code>$ curl -i https://oracolo.k8s.it/api/fib/18500<br>HTTP/1.1 200 OK<br>Date: Mon, 21 Feb 2022 15:46:02 GMT<br>Content-Type: text/html; charset=utf-8<br>Content-Length: 3866<br>Connection: keep-alive<br>Vary: Accept-Encoding</code></p>\n<p><code>83533296884435624867798531585140565339442079861725087204086868538470047335735<br>43822749284012562109156072993926836560850582712240843325537682043365082110610<br>74026311291800113704704348249392230730803891751617970900168446982968243007736<br>51197815341736702893065750384164322487072420946350671608236528336490734320752<br>15766217894062662319153446190938791478882600888720832141034382665639025753273<br>30750839228343101989644891936468903562404233796143208624300662188211844387971<br>12866863645098425877607285194374927111578752851305578221078133055618856142572<br>55524813028556809618441843877627693663784558866751538817238272015121741425393<br>99049964805007884503362484550579798684692431918631521197439158243117538949606<br>37155643851292040158395873383975165892212817619455430033494636143410239812404<br>80529547905260319321739870888187908535609149526797446231747889061304445725815<br>63419312476001987112390317255585462630499726624943926108760315984710835726791<br>64604969656765499209392211865567181332414241748115992393468455078857640503788<br>18491664670055330318299320987588212834680593778419314796246160245694639311623<br>45963069508719454819599551852953998681323163667721305365938646262462463653426<br>03120490907728272394316733945290936238595191234306195169403527451189150944412<br>55734943613733388177050741716869683215360508942821849631632473401081464418614<br>88129911023030514034348960453039999292198017445266482693060747698164480133895<br>42107812053775651030682262614149238225324860891787622323532546655762387576106<br>16744230275914963410655344193109686235699009316258222627309839038398946965798<br>93288112545157969932414111834814316569339369657297666636164718674805983154767<br>82716375582052616490320939205226143196168442740492338964903461454065891061788<br>24914385318462704330186677169214346572575320087900214462474550701206183564981<br>67940149169727266071833671192220852019181820327868422609361307508447137372952<br>70741193765954124906216947802897539084895498757041969867186546875822187085826<br>51268178561205184593600199506688874949513005414185093510082888499893907289670<br>60694081358868925846231023994576416351401218579760341994807107707262673164628<br>93989847554183605689726587752375584972993275839904589589079161246680599376961<br>46522822317563050982509757869699803683290147662057482039180565933217050406411<br>63613334575670225316495894808773628497941926683531555239853003061300649659051<br>80663038779126115354211249859182852080094185399771594786495630198172605116654<br>36484876158120241561970086240965134946001448112627411711997627120355963199768<br>37453968472163446367339200530252903452374910026941922776248397460043788137117<br>03792457930019057411962758264853807991677322585740303176087173311737493675814<br>97785846553584211669490948369627378763409533632607628189347167959335358534179<br>14936021275618379596024302703059923780925579890415606776752696469049010540674<br>16762272554571834669670185083416940001269702457012387259986804993721400659735<br>98402981836433913009273334871164379864504944274151763420867965690836123620164<br>71052527907012070090155568723470808988725230762895495242080853258248938503812<br>92377624996414841905746084025711457998759036082766019389458672225594149040894<br>25339957409692717694606288768279530280880496597818894383696651292555863738105<br>42519877809534106427059668587274469061728503718737115492047330320710617418343<br>36509845478020766819148991938613184822854393146963871218131954000091828603844<br>30710696936075943284582450858926759953941330918016364297470882233548644972398<br>02671169604082172661201779291650562320255581897779891571992387794168420428875<br>01665380594740126434308738080451514239759906771130514871814286159379595046723<br>96787175930658277115296525324844486906484486308261475140105238542837827794788<br>42270482292915032600476652997028797988664978676168344677300636439380532376130<br>50531301554510586963399762243280359072814214224506146343965459717217720978975<br>50897175029897270621313926837122497590225684346650930922871186632985491270868<br>6598493717570125</code></p>\n<p> </p>\n<h4>Results </h4>\n<p> </p>\n<h5>fixed pods number</h5>\n<p>... what happened ?</p>\n<p>Gatling results: <a href=\"https://lorenzogirardi.github.io/gatling-k8s-fixed-3-pods/\">https://lorenzogirardi.github.io/gatling-k8s-fixed-3-pods/</a></p>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-16.48.10.png\" alt=\"\" width=\"1024\" height=\"409\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-xs.webp 640w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-sm.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-md.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-lg.webp 1366w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-xl.webp 1600w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-2xl.webp 1920w\"></figure>\n<p><span style=\"color: #236fa1;\">Big cluster of huge response time <br><span style=\"color: #e03e2d;\">Closing to 100 rps , service unavailable</span><br></span></p>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-17.18.34.png\" alt=\"\" width=\"1024\" height=\"408\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-xs.webp 640w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-sm.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-md.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-lg.webp 1366w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-xl.webp 1600w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-2xl.webp 1920w\"></figure>\n<p><span style=\"color: #000000;\">huge active users ... more than the requests (slowdown ... queue.... failures)</span></p>\n<p><span style=\"color: #000000;\">And the application status ?</span></p>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/35/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02.png\" alt=\"\" width=\"2880\" height=\"3340\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-xs.webp 640w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-sm.webp 768w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-md.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-lg.webp 1366w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-xl.webp 1600w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-2xl.webp 1920w\"></figure>\n<p> </p>\n<p>Well now we know we know a bit our application ... we know the critical point but also that the <strong>KPI </strong>went to hell , high cpu and some pod crash</p>\n<p class=\"align-center\"> </p>\n<p> </p>\n<h5>dynamic pods number</h5>\n<p>... what happened ?</p>\n<p>Gatling results: <a href=\"https://lorenzogirardi.github.io/gatling-k8s-hpa/\">https://lorenzogirardi.github.io/gatling-k8s-hpa/</a></p>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-17.11.09.png\" alt=\"\" width=\"1024\" height=\"404\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-xs.webp 640w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-sm.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-md.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-lg.webp 1366w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-xl.webp 1600w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-2xl.webp 1920w\"></figure>\n<p>Some sporadic request over 300ms but 99% below</p>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-17.19.57.png\" alt=\"\" width=\"1024\" height=\"412\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-xs.webp 640w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-sm.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-md.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-lg.webp 1366w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-xl.webp 1600w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-2xl.webp 1920w\"></figure>\n<p><span style=\"color: #000000;\">active users inline with the requests</span></p>\n<p><span style=\"color: #000000;\">And the application status ?<br></span></p>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/35/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02.png\" alt=\"\" width=\"2880\" height=\"3340\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-xs.webp 640w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-sm.webp 768w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-md.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-lg.webp 1366w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-xl.webp 1600w ,https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-2xl.webp 1920w\"></figure>\n<p><span style=\"color: #000000;\">cpu under control , response time ok , no crash and autoscaled from 3 to 10 pods<br></span></p>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-17.16.38.png\" alt=\"\" width=\"2192\" height=\"1096\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-xs.webp 640w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-sm.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-md.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-lg.webp 1366w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-xl.webp 1600w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-2xl.webp 1920w\"></figure>\n<p><span style=\"color: #000000;\"> </span></p>\n<h4>HPA in pills</h4>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/35/cn-dyn-img-4.gif\" alt=\"\" width=\"480\" height=\"336\"></figure>\n<p> </p>\n<p>There are many how to and suggestions that explain this topic,</p>\n<p>however what you need is: </p>\n<ul>\n<li>prometheus</li>\n<li>kpi and application tolerance knowhow</li>\n<li>keda.sh (i really hate the <em>prometheus adapter</em>)</li>\n</ul>\n<p>Let's skip prometheus and go directly to kpi, application tolerance and keda.sh<br><br>When i create the fibonacci code , i was able to test the impact on cpu and response time , having the fibonacci as 18500</p>\n<ul>\n<li>the max pod tolerance to be running without error was 30rps</li>\n<li>to be within 300ms 15rps</li>\n</ul>\n<p>I know, is not real life scenario but the concept is the same ... just identify the correct rps in a case where this value can be a trigger for the autoscaling</p>\n<p>In the python app is <code>flask_http_request_duration_seconds_count</code></p>\n<p>the following configuration for keda use this value as a trigger</p>\n<p><code>apiVersion: keda.sh/v1alpha1<br>kind: ScaledObject<br>metadata:<br>  name: rps-scaledobject<br>  namespace: pytbak<br>spec:<br>  minReplicaCount: 3<br>  maxReplicaCount: 10<br>  pollingInterval: 10  # Optional. Default: 30 seconds<br>  scaleTargetRef:<br>    name: pytbak-stable<br>  advanced:                                          # Optional. Section to specify advanced options<br>    horizontalPodAutoscalerConfig:                   # Optional. Section to specify HPA related options<br>      behavior:                                      # Optional. Use to modify HPA's scaling behavior<br>        scaleDown:<br>          stabilizationWindowSeconds: 45 #option from kubernetes hpa to force pod shutdown in 45 dec , default 5 min<br>  triggers:<br>  - type: prometheus<br>    metadata:<br>    # Required fields:<br>      serverAddress: <a href=\"http://10.152.183.99:9090\">http://10.152.183.99:9090</a> # prometheus server<br>      metricName: flask_http_request_duration_seconds_count # Note: name to identify the metric<br>      query: sum(rate(flask_http_request_duration_seconds_count{status=\"200\"}[60s])) # Note: query must return a vector/scalar single element response<br>      threshold: '10'<br></code></p>\n<p> </p>\n<p>An this is what happened during the gatling test with hpa</p>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/35/Screenshot-2022-02-20-at-14.47.57.png\" alt=\"\" width=\"720\" height=\"104\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-xs.webp 640w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-sm.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-md.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-lg.webp 1366w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-xl.webp 1600w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-2xl.webp 1920w\"></figure>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/35/Screenshot-2022-02-20-at-14.48.36.png\" alt=\"\" width=\"720\" height=\"81\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-xs.webp 640w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-sm.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-md.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-lg.webp 1366w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-xl.webp 1600w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-2xl.webp 1920w\"></figure>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/35/Screenshot-2022-02-20-at-14.49.07.png\" alt=\"\" width=\"720\" height=\"94\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-xs.webp 640w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-sm.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-md.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-lg.webp 1366w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-xl.webp 1600w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-2xl.webp 1920w\"></figure>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/35/Screenshot-2022-02-20-at-14.49.22.png\" alt=\"\" width=\"720\" height=\"79\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-xs.webp 640w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-sm.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-md.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-lg.webp 1366w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-xl.webp 1600w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-2xl.webp 1920w\"></figure>\n<figure class=\"post__image\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/35/Screenshot-2022-02-20-at-14.50.36.png\" alt=\"\" width=\"720\" height=\"79\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-xs.webp 640w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-sm.webp 768w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-md.webp 1024w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-lg.webp 1366w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-xl.webp 1600w ,https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-2xl.webp 1920w\"></figure>\n<p> </p>\n<h4>Conclusions</h4>\n<p>HPA is an amazing solution not only in cloud there this feature is mandatory if you want to use the cloud in the right way and if you would like to remove overspending </p>\n<p>but anyway...</p>\n<p>It's the right model for lazy people in order to have a dynamic infrastructure to support the traffic, to reduce the monitoring and alerting alarms and be ready to scale :) </p>",
            "image": "https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-16.32.46.png",
            "author": {
                "name": "lgirardi"
            },
            "tags": [
                   "performances",
                   "metrics",
                   "kubernetes",
                   "kpi",
                   "hpa",
                   "dynamic infrastructure",
                   "autoscaling",
                   "application metrics"
            ],
            "date_published": "2022-02-20T12:47:02+01:00",
            "date_modified": "2022-03-05T12:56:45+01:00"
        },
        {
            "id": "https://www.k8s.it/kubernetes-nstats.html",
            "url": "https://www.k8s.it/kubernetes-nstats.html",
            "title": "Kubernetes-nstats",
            "summary": "Here we go ... another weird sidecar container Motivations I've always been interested in the observability area , there are many aspect that improve performances and fix bugs One of the most interested aspect is te network usage. This is not related to \"network issue\"&hellip;",
            "content_html": "<p>Here we go ... another weird sidecar container</p>\n<h2><a id=\"user-content-motivations\" class=\"anchor\" aria-hidden=\"true\" href=\"https://github.com/lorenzogirardi/Kubernetes-nstats#motivations\"><svg class=\"octicon octicon-link\" viewbox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Motivations</h2>\n<p><br><br>I've always been interested in the observability area , there are many aspect that improve performances and fix bugs<br>One of the most interested aspect is te network usage.</p>\n<p>This is not related to \"network issue\"<br><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://camo.githubusercontent.com/2f639fd02add51a9e1529a68b56a830b12ea328791f0ae671771c5db650dcccd/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3234302f76313631333938303238392f6d6973632f6e6574776f726b69737375652e706e67\"><img loading=\"lazy\" src=\"https://camo.githubusercontent.com/2f639fd02add51a9e1529a68b56a830b12ea328791f0ae671771c5db650dcccd/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3234302f76313631333938303238392f6d6973632f6e6574776f726b69737375652e706e67\" alt=\"network_issue\" data-canonical-src=\"https://res.cloudinary.com/ethzero/image/upload/c_scale,w_240/v1613980289/misc/networkissue.png\" data-is-external-image=\"true\"></a><br><br></p>\n<p>It's related to the usages</p>\n<p>You are probably habit to see something like this for your vms<br><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://camo.githubusercontent.com/722f34ecd7e011074527d76ce43b8c3eb28dba06876c311d8900ae1d9f518a17/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938303835362f6d6973632f766d5f6e65742e706e67\"><img loading=\"lazy\" src=\"https://camo.githubusercontent.com/722f34ecd7e011074527d76ce43b8c3eb28dba06876c311d8900ae1d9f518a17/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938303835362f6d6973632f766d5f6e65742e706e67\" alt=\"vm_net\" data-canonical-src=\"https://res.cloudinary.com/ethzero/image/upload/c_scale,w_640/v1613980856/misc/vm_net.png\" data-is-external-image=\"true\"></a><br>That is showing the traditional IN and OUT<br><br><br></p>\n<p>An now ... with kubernetes you can have the same related to your pod<br><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://camo.githubusercontent.com/7051fc44a11f2cc78bd547e91bfba0218d9dd7aba2082de32ddb8475cdb1ad0f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938313333382f6d6973632f706f645f6e65742e706e67\"><img loading=\"lazy\" src=\"https://camo.githubusercontent.com/7051fc44a11f2cc78bd547e91bfba0218d9dd7aba2082de32ddb8475cdb1ad0f/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938313333382f6d6973632f706f645f6e65742e706e67\" alt=\"pod_net\" data-canonical-src=\"https://res.cloudinary.com/ethzero/image/upload/c_scale,w_640/v1613981338/misc/pod_net.png\" data-is-external-image=\"true\"></a><br>And again you have the IN and OUT<br><br><br></p>\n<p>But <strong>where</strong> this bandwidth is be used ?</p>\n<p>Answer is not easy , i mean</p>\n<ul>\n<li>you can profile the application</li>\n<li>you can profile the vm/pod</li>\n<li>you can have a dedicated APM</li>\n<li>you can have installed a <a href=\"https://github.com/lorenzogirardi/kubernetes-servicemesh\">service mesh</a><br><br></li>\n</ul>\n<p>Service mesh is a good tool but for the reasons explained in the link ... you should promote it in the right way ... it's able to cover my question but let's assume it's a overengineering for my porpose.</p>\n<p>APM ... well it depends on your company/money capability</p>\n<p>What is missing ?<br>Well even if we are in 2021 i'm habit to use <strong>iftop</strong> to understand the usage , the limit is that is working in rountime and i miss a long vision term.<br><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://camo.githubusercontent.com/72309f9a4ee7e1f4c6b64f784c375d764d6b73385ea107d01e132e55b1f7e7a9/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313631333938373038352f6d6973632f6966746f702e706e67\"><img loading=\"lazy\" src=\"https://camo.githubusercontent.com/72309f9a4ee7e1f4c6b64f784c375d764d6b73385ea107d01e132e55b1f7e7a9/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313631333938373038352f6d6973632f6966746f702e706e67\" alt=\"iftop\" data-canonical-src=\"https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1613987085/misc/iftop.png\" data-is-external-image=\"true\"></a></p>\n<p><br><br><br><br></p>\n<h2><a id=\"user-content-goals\" class=\"anchor\" aria-hidden=\"true\" href=\"https://github.com/lorenzogirardi/Kubernetes-nstats#goals\"><svg class=\"octicon octicon-link\" viewbox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>GOALs</h2>\n<p><br><br></p>\n<ul>\n<li>Monitor a kubernetes pod network with a sidecar container</li>\n<li>Be able to know src-dst of the pod connections</li>\n<li>Use it as sidecar</li>\n<li>Try to imagine a win-win solution (aka quick and dirty)</li>\n</ul>\n<p><br><br><br><br></p>\n<h2><a id=\"user-content-implementation\" class=\"anchor\" aria-hidden=\"true\" href=\"https://github.com/lorenzogirardi/Kubernetes-nstats#implementation\"><svg class=\"octicon octicon-link\" viewbox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Implementation</h2>\n<p> </p>\n<p>Project https://github.com/lorenzogirardi/Kubernetes-nstats<br><br>My colleagues has done an amazing work with a GO container able to have this kind of observability.<br>I tried to imagine a prototype with a win-win solution and i started evaluation this interesting <a href=\"https://github.com/scottmsilver/iftop-telegraf-influx\">project</a>,<br>where most the work as already done with the following steps:</p>\n<ul>\n<li>Create an iftop static dump</li>\n<li>Filter the results in a matrix</li>\n<li>Build an influxdb layout to POST directly to the database</li>\n</ul>\n<p>so ... let's share some evidence</p>\n<p>Kubernetes-nstats<br>|-- Dockerfile<br>|-- README.md<br>|-- cron.sh<br>|-- crontab<br>|-- format.py<br>`-- parse.awk</p>\n<h3><a id=\"user-content-dockerfile\" class=\"anchor\" aria-hidden=\"true\" href=\"https://github.com/lorenzogirardi/Kubernetes-nstats#dockerfile\"><svg class=\"octicon octicon-link\" viewbox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Dockerfile</h3>\n<pre><code>FROM debian:stretch-slim\nMAINTAINER lgirardi &lt;l@k8s.it&gt;\n\nRUN apt-get -y update &amp;&amp; apt-get -yq install \\\n\tiftop \\\n\tpython3 \\\n\tcron \\\n\tcurl\n\n\nRUN touch /var/log/cron.log\nRUN mkdir /code\nWORKDIR /code\nADD . /code/\nRUN chmod +x /code/cron.sh\nCOPY crontab /etc/crontab\nRUN crontab /etc/crontab\nCMD env &gt; /code/env.sh ; cron -f\n</code></pre>\n<p>CRON ?!?!?! ... yes it's a prototype and for this scope k8s cronjob are not effective. The most interesting part is <code>env &gt; /code/env.sh</code> that is used to create an environment file based on the docker environment variables.</p>\n<h3><a id=\"user-content-code\" class=\"anchor\" aria-hidden=\"true\" href=\"https://github.com/lorenzogirardi/Kubernetes-nstats#code\"><svg class=\"octicon octicon-link\" viewbox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Code</h3>\n<p>cron.sh</p>\n<pre><code>#!/bin/bash\n/usr/sbin/iftop -nNb -i $(grep IFACE /code/env.sh |cut -d= -f2) -s 10 -o 10s -t -L 100 2&gt;/dev/null |/usr/bin/awk -f /code/parse.awk |/usr/bin/python3 /code/format.py |/usr/bin/curl -i -XPOST 'http://'\"$(grep INFLUX /code/env.sh |cut -d= -f2)\"'/write?db='\"$(grep IDB /code/env.sh |cut -d= -f2)\"'' --data-binary @-\n</code></pre>\n<p>parse.awk</p>\n<pre><code>#!/bin/awk -f\nBEGIN {\n\tnumlist = 0\n\tnblines = 15\n}\n{\n\tif ( numlist == 1 &amp;&amp; $1 == \"--------------------------------------------------------------------------------------------\" ) {\n\t\texit\n\t}\n\n\tif ( numlist == 0 &amp;&amp; $1 == \"--------------------------------------------------------------------------------------------\" ) {\n\t\tnumlist = 1\n\t\tnext\n\t}\n\n\tif ( numlist == 1 ) {\n\t\tif ( $0 ~ \"=&gt;\" &amp;&amp; nblines &gt; 0 ) {\n\t\t\tSENDER = $2\n\t\t\tSTX = pfFormat($5)\n\t\t\tgetline\n\t\t\tRECEIVER = $1\n\t\t\tRTX = pfFormat($4)\n\t\t\tprintf \"%s,%s,%s,%s\\n\", SENDER, RECEIVER, RTX, STX\n\t\t\tnblines--\n\t\t\tif ( nblines &lt; 1 ) {\n\t\t\t\texit\n\t\t\t}\n\t\t}\n\t\tnext\n\t}\n}\nEND {\n}\n\nfunction pfFormat(str) {\n \tsub(\"b\",\"\",str)\n\treturn str\n}\n</code></pre>\n<p>format.py</p>\n<pre><code>#!/usr/local/bin/python3\n\nimport csv\nimport socket\nimport sys\nimport re\n\ndef getHostName(ipAddress):\n\thostName = ipAddress\n\n\ttry:\n\t\thostName = socket.gethostbyaddr(ipAddress.strip())[0]\n\texcept socket.herror:\n\t\tpass\n\n\treturn hostName\n\ndef prefixToMultiplier(prefix):\n\tmultiplier = {\n\t\t'K': 1000,\n\t\t'M': 1000000,\n    'G': 1000000000\n\t}\n\n\treturn multiplier.get(prefix, 1)\n\n\ndef expandBitRate(bitRate):\n\tgroups = re.match(r\"(\\d+\\.?\\d*)(?:(K|M|G)?)\", bitRate).groups()\n\tmultiplier = 1.0\n\tif len(groups) &gt; 1:\n\t\tmultiplier = prefixToMultiplier(groups[1])\n\n\tvalue = float(groups[0])\n\treturn value * multiplier\n\nhost = socket.gethostname()\n\nwith sys.stdin as csvfile:\n\tcsvReader = csv.reader(csvfile)\n\tfor row in csvReader:\n\t\t(senderIp, receiverIp, receiveRate, sendRate) = (row[0], row[1], expandBitRate(row[2]), expandBitRate(row[3]))\n\t\tsender = getHostName(senderIp)\n\t\treceiver = getHostName(receiverIp)\n\t\tprint(\"nstat,hosts=\" + host +\",sender=\" + sender + \",receiver=\" + receiver + \" sendRate=\" + str(sendRate) + \",receiveRate=\" + str(receiveRate))\n</code></pre>\n<p>crontab</p>\n<pre><code>SHELL=/bin/bash\nPATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin\n* * * * *  sh -x /code/cron.sh &gt;&gt; /var/log/cron.log 2&gt;&amp;1\n#\n</code></pre>\n<p><br><br>So that this stuff is doing ?</p>\n<p><code>/usr/sbin/iftop -nNb -i $(grep IFACE /code/env.sh |cut -d= -f2) -s 10 -o 10s -t -L 100 2&gt;/dev/null</code> on this part is defined a 10 second of dump sorted on the last 10second column.</p>\n<p><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://camo.githubusercontent.com/ec94b65472cf70ce7e0e6024aa4433bee5eccb53f02c6a4c69554598958fa5cc/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938373739312f6d6973632f6966746f705f64756d702e706e67\"><img loading=\"lazy\" src=\"https://camo.githubusercontent.com/ec94b65472cf70ce7e0e6024aa4433bee5eccb53f02c6a4c69554598958fa5cc/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938373739312f6d6973632f6966746f705f64756d702e706e67\" alt=\"iftop_dump\" data-canonical-src=\"https://res.cloudinary.com/ethzero/image/upload/c_scale,w_640/v1613987791/misc/iftop_dump.png\" data-is-external-image=\"true\"></a></p>\n<p>at this point the awk parsing <code>| /usr/bin/awk -f /code/parse.awk</code>   </p>\n<p><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://camo.githubusercontent.com/ca6cc436234b92705223f0d117a4b01a3bca8f109258e229b8bee0ceeced85fa/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938373739312f6d6973632f6966746f705f61776b2e706e67\"><img loading=\"lazy\" src=\"https://camo.githubusercontent.com/ca6cc436234b92705223f0d117a4b01a3bca8f109258e229b8bee0ceeced85fa/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938373739312f6d6973632f6966746f705f61776b2e706e67\" alt=\"iftop_awk\" data-canonical-src=\"https://res.cloudinary.com/ethzero/image/upload/c_scale,w_640/v1613987791/misc/iftop_awk.png\" data-is-external-image=\"true\"></a></p>\n<p>the format part done by python script <code>| /usr/bin/python3 /code/format.py</code><br><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://camo.githubusercontent.com/2159b3ceb19d51de4e7a8cc95fc909cc9b3e65f7476129209e3a9f5c60b28784/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938373739312f6d6973632f6966746f705f666f726d61742e706e67\"><img loading=\"lazy\" src=\"https://camo.githubusercontent.com/2159b3ceb19d51de4e7a8cc95fc909cc9b3e65f7476129209e3a9f5c60b28784/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f3634302f76313631333938373739312f6d6973632f6966746f705f666f726d61742e706e67\" alt=\"iftop_format\" data-canonical-src=\"https://res.cloudinary.com/ethzero/image/upload/c_scale,w_640/v1613987791/misc/iftop_format.png\" data-is-external-image=\"true\"></a></p>\n<p>and finally we ship the metrics to influxdb with <code>| /usr/bin/curl -i -XPOST 'http://$IP/write?db=$DB' --data-binary @-</code></p>\n<p><br><br><br><br></p>\n<h2><a id=\"user-content-results\" class=\"anchor\" aria-hidden=\"true\" href=\"https://github.com/lorenzogirardi/Kubernetes-nstats#results\"><svg class=\"octicon octicon-link\" viewbox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z\"></path></svg></a>Results</h2>\n<p>You can build an run locally <code>docker build -t nstats .</code><br><code>docker run -d -e IFACE=eth0 -e INFLUX=192.168.1.28:8086 -e IDB=test nstats</code></p>\n<p>or add into kubernetes in an existing pod<br>it is quite simple and doesn't need any refactoring</p>\n<pre><code>      containers:\n      - image: lgirardi/py-test-backend\n        imagePullPolicy: Always\n        name: pytbak\n    etc etc etc ....\n      - env:\n        - name: IFACE\n          value: eth0\n        - name: INFLUX\n          value: 192.168.1.28:8086\n        - name: IDB\n          value: test\n        image: lgirardi/nstats\n        imagePullPolicy: Always\n        name: nstats\n</code></pre>\n<p><br><br>What you should have on your grafana reflect the network usages</p>\n<p><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://camo.githubusercontent.com/4613ad0a5c58a0c87db124ead36ff00cad611599b58314fb61cea6442163bbf0/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313631343031333731352f6d6973632f6966746f705f67726166616e612e706e67\"><img loading=\"lazy\" src=\"https://camo.githubusercontent.com/4613ad0a5c58a0c87db124ead36ff00cad611599b58314fb61cea6442163bbf0/68747470733a2f2f7265732e636c6f7564696e6172792e636f6d2f6574687a65726f2f696d6167652f75706c6f61642f635f7363616c652c775f313032342f76313631343031333731352f6d6973632f6966746f705f67726166616e612e706e67\" alt=\"iftop_grafana\" data-canonical-src=\"https://res.cloudinary.com/ethzero/image/upload/c_scale,w_1024/v1614013715/misc/iftop_grafana.png\" data-is-external-image=\"true\"></a></p>",
            "image": "https://www.k8s.it/media/posts/25/Screenshot-2021-02-22-at-18.16.33.png",
            "author": {
                "name": "lgirardi"
            },
            "tags": [
                   "sidecar",
                   "pod",
                   "observability",
                   "network",
                   "kubernetes",
                   "influxdb",
                   "iftop",
                   "grafana",
                   "docker"
            ],
            "date_published": "2021-02-22T18:18:20+01:00",
            "date_modified": "2021-02-22T18:25:57+01:00"
        },
        {
            "id": "https://www.k8s.it/homelab-when-small-is-big.html",
            "url": "https://www.k8s.it/homelab-when-small-is-big.html",
            "title": "Homelab , when small is big",
            "summary": "When I started getting interested on the IT world , i've usually kept all my devices on 24 h to 24. The first labs was an impressive tower in '99 with a huge amount of disk and memory banks, a good cpu cooled by a&hellip;",
            "content_html": "<p>When I started getting interested on the IT world , i've usually kept all my devices on 24 h to 24.</p>\n<p>The first labs was an impressive tower in '99 with a huge amount of disk and memory banks, a good cpu cooled by a giant copper heatsink combined with a 12cm fan.<br>All those components were quite similar to a helicopter noise during the night.</p>\n<p>The evolution of the lab than , changed a lot year by year , not only reaching a good level of noise but mostly to be cost effective hardware that guarantee new a semplificate production environment.</p>\n<p>Now some goals has changed compared with the '99 approach so let's summarize the lab expectations:</p>\n<ul>\n<li>Cheap hardware </li>\n<li>Noiseless </li>\n<li>TDP under 20w</li>\n<li>24/24 uptime</li>\n<li>Virtualization support </li>\n<li>Enough to have a Kubernetes installation</li>\n<li>Backup solution</li>\n<li>Automation ready </li>\n</ul>\n<p> </p>\n<p>Let's now explain the needs behind,<br>i'd like to have a solution that is able to cover all my needs in terms of hobby and experiments, i don't need power , since i take care to the goodness of the solution instead the absolute performance.</p>\n<h3>Hardware</h3>\n<p>Base: <a href=\"https://ark.intel.com/content/www/us/en/ark/products/126137/intel-nuc-kit-nuc7pjyh.html\" target=\"_blank\" rel=\"noopener noreferrer\">Intel® NUC NUC7PJYH</a></p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-16.39.21-2.png\" alt=\"\" width=\"820\" height=\"594\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.21-2-xs.webp 640w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.21-2-sm.webp 768w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.21-2-md.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.21-2-lg.webp 1366w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.21-2-xl.webp 1600w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.21-2-2xl.webp 1920w\"></figure>\n<p>RAM: even if the website is reporting 8gb max... this is not true<br>on my installation i have 16GB with G.Skill Ripjaws SO-DIMM 16GB DDR4-2400Mhz 2x8GB</p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-16.39.50-2.png\" alt=\"\" width=\"820\" height=\"743\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.50-2-xs.webp 640w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.50-2-sm.webp 768w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.50-2-md.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.50-2-lg.webp 1366w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.50-2-xl.webp 1600w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.39.50-2-2xl.webp 1920w\"></figure>\n<p>CPU: j5005 i thinks is the best tdp/performance (here compared to the old q6600 the first intel quadcore ever)</p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/24/j5005vsq6600.png\" alt=\"\" width=\"820\" height=\"1321\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/24/responsive/j5005vsq6600-xs.webp 640w ,https://www.k8s.it/media/posts/24/responsive/j5005vsq6600-sm.webp 768w ,https://www.k8s.it/media/posts/24/responsive/j5005vsq6600-md.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/j5005vsq6600-lg.webp 1366w ,https://www.k8s.it/media/posts/24/responsive/j5005vsq6600-xl.webp 1600w ,https://www.k8s.it/media/posts/24/responsive/j5005vsq6600-2xl.webp 1920w\"></figure>\n<p>DISK: 250gb with ocz vertex4 are a good starting point </p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-16.40.09.png\" alt=\"\" width=\"820\" height=\"748\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.40.09-xs.webp 640w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.40.09-sm.webp 768w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.40.09-md.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.40.09-lg.webp 1366w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.40.09-xl.webp 1600w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-16.40.09-2xl.webp 1920w\"></figure>\n<p> </p>\n<h3>Software</h3>\n<p>Base os vmware esxi 6.7 (free/essential)</p>\n<p>Now:</p>\n<p><strong>Why</strong> vmware?<br>Because the virtualization stack is really important to have an abstraction layer ,<br>see this <a href=\"https://www.k8s.it/kubernetes-destroyed-the-virtualization-or-not.html\">post</a> </p>\n<p><strong>Why</strong> 6.7?<br>Because the vmkernel in 7.0 is changed and is not possible import external network driver (needed for this nuc model), even if there is a trick with usb network adapter and <a href=\"https://flings.vmware.com/usb-network-native-driver-for-esxi\">https://flings.vmware.com/usb-network-native-driver-for-esxi</a> vmware labs usb drivers.</p>\n<p><strong>How</strong> build the image with Realtek network card ?<br>First of all you need a windows :( , than you should need to identify your hardware driver , in my case <a href=\"https://vibsdepot.v-front.de/wiki/index.php/Net55-r8168\">https://vibsdepot.v-front.de/wiki/index.php/Net55-r8168</a> and at the end you need to rebuild the image with <a href=\"https://www.v-front.de/p/esxi-customizer-ps.html\" target=\"_blank\" rel=\"noopener noreferrer\">ESXi-Customizer-PS</a></p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-17.16.41.png\" alt=\"\" width=\"1024\" height=\"497\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.16.41-xs.webp 640w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.16.41-sm.webp 768w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.16.41-md.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.16.41-lg.webp 1366w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.16.41-xl.webp 1600w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.16.41-2xl.webp 1920w\"></figure>\n<p><strong>What</strong> we can do with this \"toy\"?<br>Well more or less everything you are doing in your datacenter, using packer and ansible for the installation and vm configuration , you can boostrap a k3s cluster or a microk8s standalone kubernetes, few virtualmachines and so on.<br><br><strong>But</strong> is small compared to a server !1!1! <br>different needs , different size ( but same mindset in terms of reliability , flexibility , usability)... however this is my current usage</p>\n<p>4 VMS:</p>\n<ul>\n<li>microk8s installation </li>\n<li>monitoring infrastructure</li>\n<li>windows active directory</li>\n<li>console vm (usually used as ephemeral environment)</li>\n</ul>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-17.26.10.png\" alt=\"\" width=\"1024\" height=\"89\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.26.10-xs.webp 640w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.26.10-sm.webp 768w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.26.10-md.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.26.10-lg.webp 1366w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.26.10-xl.webp 1600w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.26.10-2xl.webp 1920w\"></figure>\n<p> </p>\n<p>If you have some doubts about the possibility to run kubernetes in a <em>toy </em>, is the base that i used for all my posts</p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-17.30.13.png\" alt=\"\" width=\"820\" height=\"529\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.30.13-xs.webp 640w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.30.13-sm.webp 768w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.30.13-md.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.30.13-lg.webp 1366w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.30.13-xl.webp 1600w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.30.13-2xl.webp 1920w\"></figure>\n<p> </p>\n<h3>Monitoring</h3>\n<p>Well again grafana and influxdb are supporting me</p>\n<p>HOST<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-17.34.04.png\" alt=\"\" width=\"1024\" height=\"485\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.34.04-xs.webp 640w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.34.04-sm.webp 768w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.34.04-md.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.34.04-lg.webp 1366w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.34.04-xl.webp 1600w ,https://www.k8s.it/media/posts/24/responsive/Screenshot-2021-02-19-at-17.34.04-2xl.webp 1920w\"></figure>\n<p>VMS</p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/24/vmsgrafana.png\" alt=\"\" width=\"1024\" height=\"1601\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/24/responsive/vmsgrafana-xs.webp 640w ,https://www.k8s.it/media/posts/24/responsive/vmsgrafana-sm.webp 768w ,https://www.k8s.it/media/posts/24/responsive/vmsgrafana-md.webp 1024w ,https://www.k8s.it/media/posts/24/responsive/vmsgrafana-lg.webp 1366w ,https://www.k8s.it/media/posts/24/responsive/vmsgrafana-xl.webp 1600w ,https://www.k8s.it/media/posts/24/responsive/vmsgrafana-2xl.webp 1920w\"></figure>\n<p> </p>\n<h3>Backup</h3>\n<p><strong>Why</strong> backup?<br>Because even if the env is automated, some data are inside the vms and i'd like to play with the env and if needed restore the previous snapshot.</p>\n<p>Again another free tool is helping me <a href=\"https://github.com/lamw/ghettoVCB\">https://github.com/lamw/ghettoVCB</a></p>\n<p>It's a quite simple script that i used for non production environment since the beginning.</p>\n<p>In the main path i've created a <em>script</em> folder with ghetto inside and other stuff like packer firewall rules</p>\n<p><code>[root@amaterasu:/vmfs/volumes/5eafe677-1260d7e8-2521-94c691a54f7d/script] ls -la<br>total 2240<br>drwxr-xr-x    1 root     root         73728 May  6  2020 .<br>drwxr-xr-t    1 root     root         77824 Dec 28 10:51 ..<br>-rw-r--r--    1 root     root           577 May  4  2020 email.xml<br>-rwxr-xr-x    1 root     root         17207 May  4  2020 ghettoVCB-restore.sh<br>-rw-r--r--    1 root     root           309 May  4  2020 ghettoVCB-restore_vm_restore_configuration_template<br>-rw-r--r--    1 root     root           356 May  4  2020 ghettoVCB-vm_backup_configuration_template<br>-rw-r--r--    1 root     root           832 May 10  2020 ghettoVCB.conf<br>-rwxr-xr-x    1 root     root         72122 May  4  2020 ghettoVCB.sh<br>-rwxr-xr-x    1 root     root           404 May 12  2020 init.sh<br>-rw-r--r--    1 root     root           372 May  4  2020 packer.xml</code></p>\n<p>The init.sh files should be added on local.sh to have it running on all machine startup <br><code>[root@amaterasu:/vmfs/volumes/5eafe677-1260d7e8-2521-94c691a54f7d/script] cat /etc/rc.local.d/local.sh<br>#!/bin/sh<br><br># local configuration options<br><br># Note: modify at your own risk!  If you do/use anything in this<br># script that is not part of a stable API (relying on files to be in<br># specific places, specific tools, specific output, etc) there is a<br># possibility you will end up with a broken system after patching or<br># upgrading.  Changes are not supported unless under direction of<br># VMware support.<br><br># Note: This script will not be run when UEFI secure boot is enabled.<br><br>sh -x /vmfs/volumes/amaterasu-datastore/script/init.sh<br><br>exit 0</code></p>\n<p>... on the init file you need to apply all changes to have the ghetto running in crontab</p>\n<p><code>[root@amaterasu:/vmfs/volumes/5eafe677-1260d7e8-2521-94c691a54f7d/script] cat init.sh<br>#!/bin/bash<br>cp /vmfs/volumes/amaterasu-datastore/script/email.xml /etc/vmware/firewall/<br>cp /vmfs/volumes/amaterasu-datastore/script/packer.xml /etc/vmware/firewall/<br>esxcli network firewall refresh<br>echo \"0 22 * * 6 /vmfs/volumes/amaterasu-datastore/script/ghettoVCB.sh -a -g /vmfs/volumes/amaterasu-datastore/script/ghettoVCB.conf<br>\" &gt;&gt;  /var/spool/cron/crontabs/root<br>kill $(cat /var/run/crond.pid)<br>crond</code></p>\n<p>it is missing only the ghettoVCB.conf configuration that depends on your needs</p>\n<p><code>[root@amaterasu:/vmfs/volumes/5eafe677-1260d7e8-2521-94c691a54f7d/script] cat ghettoVCB.conf<br>DISK_BACKUP_FORMAT=thin<br>VM_BACKUP_ROTATION_COUNT=3<br>POWER_VM_DOWN_BEFORE_BACKUP=0<br>ENABLE_HARD_POWER_OFF=0<br>ITER_TO_WAIT_SHUTDOWN=3<br>POWER_DOWN_TIMEOUT=5<br>ENABLE_COMPRESSION=0<br>VM_SNAPSHOT_MEMORY=0<br>VM_SNAPSHOT_QUIESCE=0<br>ALLOW_VMS_WITH_SNAPSHOTS_TO_BE_BACKEDUP=0<br>ENABLE_NON_PERSISTENT_NFS=1<br>UNMOUNT_NFS=1<br>NFS_SERVER=192.168.1.13<br>NFS_VERSION=nfs<br>NFS_MOUNT=/export/backup<br>NFS_LOCAL_NAME=nfs_storage_backup<br>NFS_VM_BACKUP_DIR=amaterasu<br>ENABLE_NFS_IO_HACK=1<br>NFS_IO_HACK_LOOP_MAX=10<br>NFS_IO_HACK_SLEEP_TIMER=60<br>SNAPSHOT_TIMEOUT=15<br>EMAIL_ALERT=0<br>EMAIL_LOG=1<br>EMAIL_SERVER=smtp.k8s.it<br>EMAIL_SERVER_PORT=25<br>EMAIL_DELAY_INTERVAL=1<br>EMAIL_USER_NAME=<br>EMAIL_USER_PASSWORD=<br>EMAIL_TO=backup@xxs.it<br>EMAIL_ERRORS_TO=backup@xxs.it<br>EMAIL_FROM=ghettoVCB-amaterasu@xxs.it<br>WORKDIR_DEBUG=0<br>VM_SHUTDOWN_ORDER=<br>VM_STARTUP_ORDER=</code></p>\n<p>And ... well thats all ... you have your weekly snapshot <br><code>2021-02-13 22:00:00 -- info: ============================== ghettoVCB LOG START ==============================<br><br>2021-02-13 22:00:01 -- info: CONFIG - USING GLOBAL GHETTOVCB CONFIGURATION FILE = /vmfs/volumes/amaterasu-datast<wbr>ore/script/ghettoVCB.conf<br>2021-02-13 22:00:01 -- info: CONFIG - VERSION = 2019_01_06_4<br>2021-02-13 22:00:01 -- info: CONFIG - GHETTOVCB_PID = 2250208<br>2021-02-13 22:00:01 -- info: CONFIG - VM_BACKUP_VOLUME = /vmfs/volumes/nfs_storage_back<wbr>up/amaterasu<br>2021-02-13 22:00:01 -- info: CONFIG - ENABLE_NON_PERSISTENT_NFS = 1<br>2021-02-13 22:00:01 -- info: CONFIG - UNMOUNT_NFS = 1<br>2021-02-13 22:00:01 -- info: CONFIG - NFS_SERVER = 192.168.1.13<br>2021-02-13 22:00:01 -- info: CONFIG - NFS_VERSION = nfs<br>2021-02-13 22:00:01 -- info: CONFIG - NFS_MOUNT = /export/backup<br>2021-02-13 22:00:01 -- info: CONFIG - VM_BACKUP_ROTATION_COUNT = 3<br>2021-02-13 22:00:01 -- info: CONFIG - VM_BACKUP_DIR_NAMING_CONVENTIO<wbr>N = 2021-02-13_22-00-00<br>2021-02-13 22:00:01 -- info: CONFIG - DISK_BACKUP_FORMAT = thin<br>2021-02-13 22:00:01 -- info: CONFIG - POWER_VM_DOWN_BEFORE_BACKUP = 0<br>2021-02-13 22:00:01 -- info: CONFIG - ENABLE_HARD_POWER_OFF = 0<br>2021-02-13 22:00:01 -- info: CONFIG - ITER_TO_WAIT_SHUTDOWN = 3<br>2021-02-13 22:00:01 -- info: CONFIG - POWER_DOWN_TIMEOUT = 5<br>2021-02-13 22:00:01 -- info: CONFIG - SNAPSHOT_TIMEOUT = 15<br>2021-02-13 22:00:01 -- info: CONFIG - LOG_LEVEL = info<br>2021-02-13 22:00:01 -- info: CONFIG - BACKUP_LOG_OUTPUT = /tmp/ghettoVCB-2021-02-13_22-0<wbr>0-00-2250208.log<br>2021-02-13 22:00:01 -- info: CONFIG - ENABLE_COMPRESSION = 0<br>2021-02-13 22:00:01 -- info: CONFIG - VM_SNAPSHOT_MEMORY = 0<br>2021-02-13 22:00:01 -- info: CONFIG - VM_SNAPSHOT_QUIESCE = 0<br>2021-02-13 22:00:01 -- info: CONFIG - ALLOW_VMS_WITH_SNAPSHOTS_TO_BE<wbr>_BACKEDUP = 0<br>2021-02-13 22:00:01 -- info: CONFIG - VMDK_FILES_TO_BACKUP = all<br>2021-02-13 22:00:01 -- info: CONFIG - VM_SHUTDOWN_ORDER =<br>2021-02-13 22:00:01 -- info: CONFIG - VM_STARTUP_ORDER =<br>2021-02-13 22:00:01 -- info: CONFIG - RSYNC_LINK = 0<br>2021-02-13 22:00:01 -- info: CONFIG - BACKUP_FILES_CHMOD =<br>2021-02-13 22:00:01 -- info: CONFIG - EMAIL_LOG = 1<br>2021-02-13 22:00:01 -- info: CONFIG - EMAIL_SERVER = <a href=\"http://smtp.k8s.it/\" rel=\"noopener noreferrer\" target=\"_blank\" data-saferedirecturl=\"https://www.google.com/url?q=http://smtp.k8s.it&amp;source=gmail&amp;ust=1613839933510000&amp;usg=AFQjCNFj5McYEepf6qWyQHkVKmgpikm1JQ\">smtp.xxs.it</a><br>2021-02-13 22:00:01 -- info: CONFIG - EMAIL_SERVER_PORT = 25<br>2021-02-13 22:00:01 -- info: CONFIG - EMAIL_DELAY_INTERVAL = 1<br>2021-02-13 22:00:01 -- info: CONFIG - EMAIL_FROM = <a href=\"mailto:ghettoVCB-amaterasu@k8s.it\" target=\"_blank\" rel=\"noopener\">ghettoVCB-amaterasu@xxs.it</a><br>2021-02-13 22:00:01 -- info: CONFIG - EMAIL_TO = <a href=\"mailto:backup@k8s.it\" target=\"_blank\" rel=\"noopener\">backup@xxs.it</a><br>2021-02-13 22:00:01 -- info: CONFIG - WORKDIR_DEBUG = 0<br>2021-02-13 22:00:01 -- info: CONFIG - ENABLE NFS IO HACK = 1<br>2021-02-13 22:00:01 -- info: CONFIG - NFS IO HACK LOOP MAX = 10<br>2021-02-13 22:00:01 -- info: CONFIG - NFS IO HACK SLEEP TIMER = 60<br>2021-02-13 22:00:01 -- info: CONFIG - NFS BACKUP DELAY = 0<br><br>2021-02-13 22:00:06 -- info: Initiate backup for izanami<br>2021-02-13 22:00:06 -- info: Creating Snapshot \"ghettoVCB-snapshot-2021-02-13<wbr>\" for izanami<br>2021-02-13 22:09:55 -- info: Removing snapshot from izanami ...<br>2021-02-13 22:10:56 -- info: Slept 60 seconds to work around NFS I/O error<br>2021-02-13 22:10:56 -- info: Backup Duration: 10.83 Minutes<br>2021-02-13 22:10:56 -- info: Successfully completed backup for izanami!<br><br>2021-02-13 22:11:02 -- info: Initiate backup for izanagi<br>2021-02-13 22:11:02 -- info: Creating Snapshot \"ghettoVCB-snapshot-2021-02-13<wbr>\" for izanagi<br>2021-02-13 22:16:37 -- info: Removing snapshot from izanagi ...<br>2021-02-13 22:17:37 -- info: Slept 60 seconds to work around NFS I/O error<br>2021-02-13 22:17:37 -- info: Backup Duration: 6.58 Minutes<br>2021-02-13 22:17:37 -- info: Successfully completed backup for izanagi!<br><br>2021-02-13 22:17:43 -- info: Initiate backup for hiroito<br>2021-02-13 22:17:43 -- info: Creating Snapshot \"ghettoVCB-snapshot-2021-02-13<wbr>\" for hiroito<br>2021-02-13 22:23:55 -- info: Removing snapshot from hiroito ...<br>2021-02-13 22:24:56 -- info: Slept 60 seconds to work around NFS I/O error<br>2021-02-13 22:24:56 -- info: Backup Duration: 7.22 Minutes<br>2021-02-13 22:24:56 -- info: Successfully completed backup for hiroito!<br><br>2021-02-13 22:25:01 -- info: Initiate backup for raijin<br>2021-02-13 22:25:01 -- info: Creating Snapshot \"ghettoVCB-snapshot-2021-02-13<wbr>\" for raijin<br>2021-02-13 22:26:21 -- info: Removing snapshot from raijin ...<br>2021-02-13 22:27:21 -- info: Slept 60 seconds to work around NFS I/O error<br>2021-02-13 22:27:21 -- info: Backup Duration: 2.33 Minutes<br>2021-02-13 22:27:21 -- info: Successfully completed backup for raijin!<br><br>2021-02-13 22:27:54 -- info: ###### Final status: All VMs backed up OK! ######<br><br>2021-02-13 22:27:54 -- info: ============================== ghettoVCB LOG END ==============================<wbr>==</code><br><br></p>\n<h3>Price </h3>\n<p>nuc7PJYH ~ 160€<br>G.Skill Ripjaws SO-DIMM 16GB DDR4-2400Mhz 2x8GB ~ 60€<br>hard disk ssd 250db ~ 40€<br><br>Is not cheap as a raspberry 4 but it's 10 time more performant and guarantee a full server experience with the possibility to play and grow your skills and challenges</p>\n<p> </p>\n<p> </p>\n<p> </p>",
            "image": "https://www.k8s.it/media/posts/24/Screenshot-2021-02-19-at-18.06.38.png",
            "author": {
                "name": "lgirardi"
            },
            "tags": [
                   "vspehere",
                   "vmware",
                   "microk8s",
                   "kubernetes",
                   "k3s",
                   "homelab",
                   "ghettovcb",
                   "cluster",
                   "backup"
            ],
            "date_published": "2021-02-19T16:33:17+01:00",
            "date_modified": "2021-02-19T18:20:07+01:00"
        },
        {
            "id": "https://www.k8s.it/ambient-sensor-for-mere-mortal.html",
            "url": "https://www.k8s.it/ambient-sensor-for-mere-mortal.html",
            "title": "Ambient sensor for mere mortal",
            "summary": "In the home automation era, I was quite curious to understand how is working a simple thermal sensor I tried this simple experiment following the suggestion of one of my colleagues, i was thinking to start with Arduino , however he suggested to try nodemcu&hellip;",
            "content_html": "<p>In the home automation era, I was quite curious to understand how is working a simple thermal sensor</p>\n<h3>WHAT WE NEED ?</h3>\n<ul>\n<li>ESP8266</li>\n<li>DHT22</li>\n<li>usb power</li>\n<li>Influxdb</li>\n<li>Grafana</li>\n</ul>\n<p>I tried this simple experiment following the suggestion of one of my colleagues, i was thinking to start with Arduino , however he suggested to try nodemcu</p>\n<p>So what is <em>nodemcu?<br></em>It's an open source platform developed for IoT , you can <em>compile</em> the firmware with the most used sensors available , but the main feature is the Lua support<br>When i starts with Arduino i created some C software really horrible 😇<br>with Lua instead it was quite simple create this kind of functionality.</p>\n<p>The hardware platform is really nice and simple </p>\n<h4>ESP8266</h4>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/23/Screenshot-2021-01-24-at-21.39.16.png\" alt=\"\" width=\"640\" height=\"565\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.39.16-xs.webp 640w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.39.16-sm.webp 768w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.39.16-md.webp 1024w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.39.16-lg.webp 1366w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.39.16-xl.webp 1600w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.39.16-2xl.webp 1920w\"></figure>\n<p> </p>\n<p>It's natively support wifi and with the sensor dht22 you are able to have the temperature, humidity ... and well also a dew point since is it a maths of previous values</p>\n<h4>DHT22</h4>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/23/Screenshot-2021-01-24-at-21.42.27.png\" alt=\"\" width=\"640\" height=\"602\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.42.27-xs.webp 640w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.42.27-sm.webp 768w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.42.27-md.webp 1024w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.42.27-lg.webp 1366w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.42.27-xl.webp 1600w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.42.27-2xl.webp 1920w\"></figure>\n<p> </p>\n<p>Price for both is really cheaper (aliexpress)</p>\n<p>esp8266    --&gt; 3$<br>dht22          --&gt; 1$</p>\n<p>Once you receive the hardware you can start to work on it </p>\n<p>With <a href=\"https://nodemcu-build.com/\">https://nodemcu-build.com/</a> you can build the firmware that fit your needs (in the next screen what is needed to interact with the thermal sensor)</p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/23/Screenshot-2021-01-24-at-21.46.37.png\" alt=\"\" width=\"640\" height=\"484\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.46.37-xs.webp 640w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.46.37-sm.webp 768w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.46.37-md.webp 1024w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.46.37-lg.webp 1366w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.46.37-xl.webp 1600w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-21.46.37-2xl.webp 1920w\"></figure>\n<p> </p>\n<p>To load the firmware you should need <a href=\"https://github.com/espressif/esptool\">https://github.com/espressif/esptool</a></p>\n<p>with a command like this<br><code>python esptool.py -b 115200 --port=/dev/cu.<wbr>wchusbserial1410 write_flash  -fm=dio -fs=32m 0x0000 <span class=\"il\">nodemcu</span>-master-12-modules-<wbr>2016-01-09-18-51-26-float.bin</code></p>\n<p>Now.... it's time to create the Lua script</p>\n<h3>Configuration</h3>\n<p>This is working since 2016 so i think we can consider stable 😁</p>\n<pre><code>local SSID = \"name wifi\"\nlocal SSID_PASSWORD = \"password wifi\"\nlocal DEVICE = \"name device\"\nlocal temperature = 20.0\n\nwifi.setmode(wifi.STATION)\nwifi.sta.config(SSID,SSID_PASSWORD)\nwifi.sta.autoconnect(1)\n\nlocal HOST = \"server database\"\nlocal URI = \"/write?db=collectd\"\n\nfunction build_post_request(host, uri, data_table)\n\n     local data = data_table.Data_type .. \",device=\" .. data_table.Device .. \" \" .. \"value=\" .. data_table.Value\n\n     --for param,value in pairs(data_table) do\n    --      data = data .. param..\"=\"..value..\"&amp;\"\n    -- end\n    print(data)\n\n     request = \"POST \"..uri..\" HTTP/1.1\\r\\n\"..\n     \"Host: \"..host..\"\\r\\n\"..\n     \"Connection: close\\r\\n\"..\n     \"Content-Type: application/x-www-form-urlencoded\\r\\n\"..\n     \"Content-Length: \"..string.len(data)..\"\\r\\n\"..\n     \"\\r\\n\"..\n     data\n\n     print(request)\n\n     return request\nend\n\nlocal function display(sck,response)\n     print(response)\nend\n\n-- When using send_sms: the \"from\" number HAS to be your twilio number.\n-- If you have a free twilio account the \"to\" number HAS to be your twilio verified number.\n-- The numbers MUST include the country code.\n-- DO NOT add the \"+\" sign.\nlocal function send_data(data_type,device,value)\n\n     local data = {\n      Data_type = data_type,\n      Device = device,\n      Value = value\n     }\n\n     socket = net.createConnection(net.TCP,0)\n     socket:on(\"receive\",display)\n     socket:connect(8086,HOST)\n\n     socket:on(\"connection\",function(sck)\n\n          local post_request = build_post_request(HOST,URI,data)\n          sck:send(post_request)\n     end)\nend\n\nfunction check_wifi()\n local ip = wifi.sta.getip()\n\n if(ip==nil) then\n   print(\"Connecting...\")\n else\n  tmr.stop(0)\n  print(\"Connected to AP!\")\n  print(ip)\n  --send_data(\"15551234567\",\"12223456789\",\"Hello from your ESP8266\")\n\n  local t, h, d = getTempHumi()\n\n  print(\"Temp:\"..t ..\" C\\n\")\n  print(\"Humi:\"..h ..\" RH\\n\")\n  print(\"Dew:\"..d ..\" DP\\n\")\n\n  send_data(\"temperature\", DEVICE, t)\n  send_data(\"humidity\", DEVICE, h)\n  send_data(\"dew_point\", DEVICE, d)\n\n  tmr.alarm(0,30000,1,check_wifi)\n\n end\n\nend\n\ntmr.alarm(0,5000,1,check_wifi)\n\nfunction getTempHumi()\n    pin = 4\n    local status,temp,humi,temp_decimial,humi_decimial = dht.read(pin)\n    if( status == dht.OK ) then\n    -- Float firmware using this example\n      print(\"DHT Temperature:\"..temp..\";\"..\"Humidity:\"..humi)\n    elseif( status == dht.ERROR_CHECKSUM ) then\n      print( \"DHT Checksum error.\" );\n    elseif( status == dht.ERROR_TIMEOUT ) then\n      print( \"DHT Time out.\" );\n    end\n    local dewpoint= (humi/100)^(1/8) * (112 + (0.9 * temp)) - 112 + (0.1 * temp)\n\n    return temp, humi, (string.format(\"%.1f\", dewpoint))\nend</code></pre>\n<h4>Customizations</h4>\n<p>local SSID = \"wifi name\"  <br>local SSID_PASSWORD = \"wifi password\" <br>local DEVICE = \"name device\"        --&gt; name of you board/room </p>\n<p>local HOST = \"server database\"     --&gt; your influxdb installation<br>local URI = \"/write?db=collectd\"     --&gt; your database name </p>\n<p> </p>\n<p>So we have the hardware , we loaded the firmware, we created the code, but how to interact with the platform... well there are many way however <a href=\"https://esp8266.ru/esplorer/\" target=\"_blank\" rel=\"noopener noreferrer\">ESPlorer</a> has a nice gui even if it's java based ☠️</p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/23/ESPlorer-panels.png\" alt=\"\" width=\"640\" height=\"373\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/23/responsive/ESPlorer-panels-xs.webp 640w ,https://www.k8s.it/media/posts/23/responsive/ESPlorer-panels-sm.webp 768w ,https://www.k8s.it/media/posts/23/responsive/ESPlorer-panels-md.webp 1024w ,https://www.k8s.it/media/posts/23/responsive/ESPlorer-panels-lg.webp 1366w ,https://www.k8s.it/media/posts/23/responsive/ESPlorer-panels-xl.webp 1600w ,https://www.k8s.it/media/posts/23/responsive/ESPlorer-panels-2xl.webp 1920w\"></figure>\n<p> </p>\n<h3>Results</h3>\n<p><a href=\"https://services.k8s.it/grafana/d/000000079/temperature?viewPanel=5&amp;orgId=2&amp;refresh=1m\">https://services.k8s.it/grafana/d/000000079/temperature?viewPanel=5&amp;orgId=2&amp;refresh=1m</a></p>\n<p>above you can see the live results .... and on grafana we can create a graph like this</p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/23/Screenshot-2021-01-24-at-22.11.01.png\" alt=\"\" width=\"1024\" height=\"408\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.11.01-xs.webp 640w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.11.01-sm.webp 768w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.11.01-md.webp 1024w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.11.01-lg.webp 1366w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.11.01-xl.webp 1600w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.11.01-2xl.webp 1920w\"></figure>\n<p>The delta delta in the <em>Humidity is generated by an </em>humidifier</p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/23/Screenshot-2021-01-24-at-22.06.50.png\" alt=\"\" width=\"640\" height=\"738\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.06.50-xs.webp 640w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.06.50-sm.webp 768w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.06.50-md.webp 1024w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.06.50-lg.webp 1366w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.06.50-xl.webp 1600w ,https://www.k8s.it/media/posts/23/responsive/Screenshot-2021-01-24-at-22.06.50-2xl.webp 1920w\"></figure>\n<p> </p>\n<p>I have one sensor for all rooms ... and also external </p>\n<p>The external one should be replaced more or less every year because is not properly water proof and ... day by day the electrical contacts become oxidized </p>\n<p> </p>\n<p> </p>",
            "author": {
                "name": "lgirardi"
            },
            "tags": [
            ],
            "date_published": "2021-01-24T22:10:12+01:00",
            "date_modified": "2021-01-29T12:47:26+01:00"
        },
        {
            "id": "https://www.k8s.it/the-monitoring-paper.html",
            "url": "https://www.k8s.it/the-monitoring-paper.html",
            "title": "The monitoring paper",
            "summary": "Contrary to popular belief, monitoring an infrastructure is the opposite to just have some metrics about applications and network There are many many documents the lead this topic, one of the most interesting it's just few pages from Google around the art of slos or&hellip;",
            "content_html": "<p>Contrary to popular belief, monitoring an infrastructure is the opposite to just have some metrics about applications and network</p>\n<p>There are many many documents the lead this topic,<br>one of the most interesting it's just few pages from Google around <a href=\"https://static.googleusercontent.com/media/sre.google/it//static/pdf/art-of-slos-slides.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">the art of slos</a><br>or the <a href=\"https://www.k8s.it/media/files/The Art of SLOs - Google.pdf\" target=\"_blank\" rel=\"noopener noreferrer\">book</a> version i took from a google onsite deep dive. <a href=\"https://www.k8s.it/media/files/The Art of SLOs - Google.pdf\" target=\"_blank\" rel=\"noopener noreferrer\"></a></p>\n<p>To better details this topic i'd like to use simple statements:</p>\n<ul>\n<li>WHAT</li>\n<li>WHY</li>\n<li>WHO</li>\n<li>HOW</li>\n</ul>\n<p> </p>\n<h3>WHAT </h3>\n<p>This is probably the main argument we will discuss on this thread </p>\n<p>There no magic formulas or tools to use, if you expect to buy a tool that work with metrics out of the box, you're wrong. <br>Tools are the infrastructure to store and visualize data... but first of all you need to collect the right data.</p>\n<p>What is the DATA you need ?<br>Those are you will record moving yourself on the <span style=\"text-decoration: underline;\">customer position</span></p>\n<p><strong>Customer position</strong> : i'm using this term because i suppose you are not an onlus so you have a customer, but customer is a overall word with the meaning of all people are using your product:</p>\n<ul>\n<li>people that buy something e-commerce (Amazon, Bestbuy, Aliexpress)</li>\n<li>people that use website to learn something (Cnn, Bloomberg, Wikipedia)</li>\n<li>people that work on finance and use finance applications (Navision, SAP, JD Edwards)</li>\n<li>people that use energy from nuclear site </li>\n</ul>\n<p>So moving yourself on the customer position you can better understand the definition of data that you need to know to better monitor your application with the righe <strong>customer metrics </strong></p>\n<p>Stupid example ... imagine an automatic gate</p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/20/Screenshot-2021-01-03-at-16.31.43.png\" alt=\"\" width=\"1092\" height=\"522\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-03-at-16.31.43-xs.webp 640w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-03-at-16.31.43-sm.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-03-at-16.31.43-md.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-03-at-16.31.43-lg.webp 1366w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-03-at-16.31.43-xl.webp 1600w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-03-at-16.31.43-2xl.webp 1920w\"></figure>\n<p>What is the definition of \"it's working?\"</p>\n<ul>\n<li>it opens</li>\n</ul>\n<p>Obviously YES , but not only</p>\n<ul>\n<li>what about if it's not closing ? </li>\n<li>what about if it opens in 10 minutes , it's acceptable ?</li>\n<li>what about if after X times the automation is broken ? </li>\n<li>etc etc ...</li>\n</ul>\n<p>As you can imagine we can define not only the objective values (open/close), we can elaborate customer subjective frustration , if i have to buy an automatic gate, i will not choose the one that will take 10 minutes to open... because... because 10 minutes are too much , based on subjective value as a customer.</p>\n<p>In the same way we cannot say that our application is working because it's answers.</p>\n<p>So <span style=\"text-decoration: underline;\">what</span> we have to consider when we start to monitor an application in production?</p>\n<p>Let's start with 3 macro clusters:</p>\n<ul>\n<li style=\"font-weight: 400;\"><span style=\"font-weight: 400;\"><strong>system</strong> resources, so all metrics related to the pod (cpu,network,...)</span></li>\n<li style=\"font-weight: 400;\"><span style=\"font-weight: 400;\"><strong>application</strong> standard metrics (thread, gc, errors per minute, requests per minute, ... )</span></li>\n<li style=\"font-weight: 400;\"><span style=\"font-weight: 400;\"><strong>business</strong> metrics that are inherent from the application scope, if the application provides a checkout for goods, we need to know for example how many transactions were fine and how many rejected</span></li>\n</ul>\n<p> </p>\n<h4><strong>System</strong></h4>\n<p>Those are the most easiest and used metrics since you started to monitor services.<br>On this group we have the basis metrics related to the system usage,<br>considering the evolution of the platform those values are day by day less influential than before.<br>This is because as soon we are increasing the technology level from bare metal, to vm , to docker to serverless ... the evaluation of those numbers could raise some mistake on the interpretation , however we still need to start with the basis in order to have data to define a trend based on specific situations</p>\n<p>Here an example about the bare metal used as vsphere 6.7</p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-15.49.59.png\" alt=\"\" width=\"1024\" height=\"371\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.49.59-xs.webp 640w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.49.59-sm.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.49.59-md.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.49.59-lg.webp 1366w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.49.59-xl.webp 1600w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.49.59-2xl.webp 1920w\"></figure>\n<p>always on the system metrics we can go more in deep checking a virtual machine inside this host, here the one i used to host my kubernetes lab</p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-15.53.29.png\" alt=\"\" width=\"1024\" height=\"371\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.53.29-xs.webp 640w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.53.29-sm.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.53.29-md.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.53.29-lg.webp 1366w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.53.29-xl.webp 1600w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-15.53.29-2xl.webp 1920w\"></figure>\n<p>In the 2 images for example we can assume that we have something that move the cpu close to 100% cyclically (it's a <a href=\"https://www.k8s.it/kubernetes-sitespeedio.html\">crawler</a> to perform check on website pages every hours)</p>\n<p> </p>\n<h4><strong>Application</strong></h4>\n<p>It's time now to move inside the kubernetes cluster and check how is going on the a web application inside the cluster<br>Since this application it is springboot based, we have the opportunity to understand how is going on from a framework side (java) and behavioural interactions.<br>Response time server to server, server errors, client errors, sql interactions, garbage collector, sidecars (is a pod with multiple images) usage, logs creation , metrics creation etc etc</p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/20/app_metrics.png\" alt=\"\" width=\"1024\" height=\"956\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/20/responsive/app_metrics-xs.webp 640w ,https://www.k8s.it/media/posts/20/responsive/app_metrics-sm.webp 768w ,https://www.k8s.it/media/posts/20/responsive/app_metrics-md.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/app_metrics-lg.webp 1366w ,https://www.k8s.it/media/posts/20/responsive/app_metrics-xl.webp 1600w ,https://www.k8s.it/media/posts/20/responsive/app_metrics-2xl.webp 1920w\"></figure>\n<p>Having those in place you can understand from an application point of view how is going on the performances release by release.. what happen in case of bugs and critical condition (unexpected huge traffic) , the area where you can put you effort on improvements.</p>\n<p> </p>\n<h4><span style=\"font-weight: 400;\"><strong>Business</strong></span></h4>\n<p>OK system is covered , application is covered ... what about the customer perception ?</p>\n<p>This is the most critical topic , if your application is part of a microservices funnel or a monolithic application that manage the entire product, it's supposed that in some way you have benefits from its performances</p>\n<p>So move yourself on the customer position monitoring your website from a customer point of view with business metrics , in this simple case i just monitor the cms page on top <br>It's a website:</p>\n<ul>\n<li>so how long does it take have the page ?</li>\n<li>which are the most relevant data you need to know to improve?</li>\n<li>do you have the same trends every time ?</li>\n<li>etc etc</li>\n</ul>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/20/screencapture-services-k8s-it-grafana-d-000000053-pagesummary-influxdb-2021-01-05-17_07_37.png\" alt=\"\" width=\"1024\" height=\"3021\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/20/responsive/screencapture-services-k8s-it-grafana-d-000000053-pagesummary-influxdb-2021-01-05-17_07_37-xs.webp 640w ,https://www.k8s.it/media/posts/20/responsive/screencapture-services-k8s-it-grafana-d-000000053-pagesummary-influxdb-2021-01-05-17_07_37-sm.webp 768w ,https://www.k8s.it/media/posts/20/responsive/screencapture-services-k8s-it-grafana-d-000000053-pagesummary-influxdb-2021-01-05-17_07_37-md.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/screencapture-services-k8s-it-grafana-d-000000053-pagesummary-influxdb-2021-01-05-17_07_37-lg.webp 1366w ,https://www.k8s.it/media/posts/20/responsive/screencapture-services-k8s-it-grafana-d-000000053-pagesummary-influxdb-2021-01-05-17_07_37-xl.webp 1600w ,https://www.k8s.it/media/posts/20/responsive/screencapture-services-k8s-it-grafana-d-000000053-pagesummary-influxdb-2021-01-05-17_07_37-2xl.webp 1920w\"></figure>\n<p> </p>\n<p> </p>\n<h3>WHY</h3>\n<p>With those cluster of metrics we can define and plan the architecture and the forecasting for the company ... remember that when something goes wrong with no metrics you will probably cascade to situation like this</p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-17.41.07.png\" alt=\"\" width=\"1024\" height=\"441\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.41.07-xs.webp 640w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.41.07-sm.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.41.07-md.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.41.07-lg.webp 1366w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.41.07-xl.webp 1600w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.41.07-2xl.webp 1920w\"></figure>\n<p> </p>\n<p><strong>System</strong> metrics can share the usages and the density of you infrastructure creating the basis <span style=\"text-decoration: underline;\">alerts</span> in case of suffering but also plan the evolution of the platform itself  </p>\n<p><span style=\"font-weight: 400;\"><strong>Application </strong>metrics share the framework behaviour and the evolution of your application day by day , <span style=\"text-decoration: underline;\">alerts</span> are defined to monitor the scalability, bugs and application behaviour</span></p>\n<p><strong>Business <span style=\"font-weight: 400;\">metrics share the thresholds to use as alerts but not only... </span><br></strong>In this example we are talking about a web application <br>If you are selling something through it ,conversion is always the most relevant buzzword</p>\n<p>From the 100 visitors , who will continue the navigation till the purchase, the remaining are really a small slice (e-commerce for example)</p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/20/conversion-impact-score-funnel-NEW.png\" alt=\"\" width=\"800\" height=\"647\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/20/responsive/conversion-impact-score-funnel-NEW-xs.webp 640w ,https://www.k8s.it/media/posts/20/responsive/conversion-impact-score-funnel-NEW-sm.webp 768w ,https://www.k8s.it/media/posts/20/responsive/conversion-impact-score-funnel-NEW-md.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/conversion-impact-score-funnel-NEW-lg.webp 1366w ,https://www.k8s.it/media/posts/20/responsive/conversion-impact-score-funnel-NEW-xl.webp 1600w ,https://www.k8s.it/media/posts/20/responsive/conversion-impact-score-funnel-NEW-2xl.webp 1920w\"></figure>\n<p>This images comes from an 2015 <a href=\"https://blogs.akamai.com/2015/07/conversion-impact-score-what-is-it-and-why-do-you-need-to-know-yours.html\" target=\"_blank\" rel=\"noopener noreferrer\">article</a> from Akamai that is really still actual ...<br>Conversion is always impacted by page response time , more close you are in the first navigation phases like searching rather than checkout where you probably have more clear will to purchase<br><br>Now we know the data around the usage of our website and we can create <strong>GOALs</strong> and <strong>KPI</strong> to improve those values in order to better fit with the customer expectation.</p>\n<p> </p>\n<p> </p>\n<h3>WHO</h3>\n<p>Those actors could be different case by case, from a small company to an enterprise, even if you are a full stack whateverops, a developer or part of monitoring team, in this scope you should not be alone. </p>\n<p><strong>System</strong> and <strong>Application</strong> are usually managed by <span style=\"text-decoration: underline;\">sre/devops/sysadmin</span> with the help of architecture/developer to define the best framework metrics to monitor.</p>\n<p>On the opposite side <strong>Business </strong>are more close with the product side, who will be better than the <span style=\"text-decoration: underline;\">product dept</span> (developers) itself defining the kpi and goals used as a metrics with the cooperation of the <span style=\"text-decoration: underline;\">business dept</span> to define the <strong><span style=\"font-weight: 400;\">thresholds.</span></strong></p>\n<p>This cooperation will be useful to define:</p>\n<ul>\n<li style=\"font-weight: 400;\"><span style=\"font-weight: 400;\">Right alerts to right people</span></li>\n<li style=\"font-weight: 400;\"><span style=\"font-weight: 400;\">Support granted by ownership</span></li>\n<li style=\"font-weight: 400;\"><span style=\"font-weight: 400;\">No speculations, real data</span></li>\n</ul>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-17.39.10.png\" alt=\"\" width=\"1024\" height=\"346\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.39.10-xs.webp 640w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.39.10-sm.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.39.10-md.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.39.10-lg.webp 1366w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.39.10-xl.webp 1600w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.39.10-2xl.webp 1920w\"></figure>\n<p> </p>\n<h3><strong>HOW</strong></h3>\n<p> </p>\n<h4>Infrastructure</h4>\n<p>First of all you have to define the monitoring/alerting platform, <br>the suggestion is to have this platform scalable with a good UI (grafana) to work with backend storage (prometheus + cortex/thanos, graphite + carbonzipper, influxdb, etc etc)</p>\n<p>Honestly if you are in a big environment and you make a mistake in metrics configuration with graphite (push model) you can saturate the space since every time you create a new metric you are creating whisper file with the dimension based on the retention schema.<br>I prefer prometheus (pull model) that could prevent those issues and better fit the kubernetes standars , will be also more easy create a /metrics page on your application rather than use sidecar pods to stream metrics with collectd/telegraf/statsd and so on.</p>\n<h4> </h4>\n<h4>Less is more</h4>\n<p><span style=\"font-weight: 400;\">How many metrics are enough to create a valid alert?</span></p>\n<p>The more metrics identify the service behaviour the more we can create a dedicated alert...<br>anyway  ....<br>The anti-pattern model currently applied in some cases: <br>have tons of metrics that generate only <strong>noise</strong> without identifying the healthiness of a service</p>\n<p><em>Keep it simple</em> and define the structure of your <span style=\"text-decoration: underline;\">System,</span> <span style=\"text-decoration: underline;\">Application</span> and <span style=\"text-decoration: underline;\">Business</span> metrics .</p>\n<p> </p>\n<h4>Smart metrics</h4>\n<p><span style=\"font-weight: 400;\">It’s not only ONE value that show off the healthiness, but the combination of multiple metrics that guarantee the status</span></p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-17.46.34.png\" alt=\"\" width=\"1024\" height=\"303\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.34-xs.webp 640w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.34-sm.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.34-md.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.34-lg.webp 1366w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.34-xl.webp 1600w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.34-2xl.webp 1920w\"></figure>\n<p>This concept is really important, imagine a dynamic infrastructure based on kubernetes <a href=\"https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/\" target=\"_blank\" rel=\"noopener noreferrer\">HPA</a> </p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-18.22.01.png\" alt=\"\" width=\"1024\" height=\"632\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-18.22.01-xs.webp 640w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-18.22.01-sm.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-18.22.01-md.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-18.22.01-lg.webp 1366w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-18.22.01-xl.webp 1600w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-18.22.01-2xl.webp 1920w\"></figure>\n<p>where you can probable have some value linear (like thread), mitigated by the horizontal autoscaling, you should combine multiple values to define the application status.</p>\n<p>Create the metrics alert with <strong>trends</strong> not with the pure number <br>Ex. 70 threads value alone make no sense , different applications has different threads value , what is important is the <strong>delta , </strong>the percentage is useful to understand the behaviour, +50% threads make sense in all applications rather than the effective number.<br><br></p>\n<figure class=\"post__image post__image--center\"><img loading=\"lazy\"  src=\"https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-17.46.55.png\" alt=\"\" width=\"1024\" height=\"656\" sizes=\"(max-width: 1920px) 100vw, 1920px\" srcset=\"https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.55-xs.webp 640w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.55-sm.webp 768w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.55-md.webp 1024w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.55-lg.webp 1366w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.55-xl.webp 1600w ,https://www.k8s.it/media/posts/20/responsive/Screenshot-2021-01-05-at-17.46.55-2xl.webp 1920w\"></figure>\n<p> </p>\n<p>Be smart also on the evaluation with standard deviation and <strong>percentile</strong> ... mean is usually dropping the relevant value to evaluate performances under stress</p>\n<p> </p>\n<p> </p>\n<p> </p>\n<p> </p>",
            "image": "https://www.k8s.it/media/posts/20/Screenshot-2021-01-05-at-17.47.24.png",
            "author": {
                "name": "lgirardi"
            },
            "tags": [
                   "system metrics",
                   "slo",
                   "sli",
                   "sla",
                   "observability",
                   "metrics",
                   "customer experience",
                   "conversion ",
                   "business metrics",
                   "application metrics",
                   "alerting"
            ],
            "date_published": "2021-01-05T17:56:00+01:00",
            "date_modified": "2023-09-20T10:01:49+02:00"
        }
    ]
}
