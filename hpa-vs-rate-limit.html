<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>HPA vs Rate-limit - LAB</title><meta name="description" content="Strange ... we are using hpa to increase the availability and we are introducing rate limit to reduce? Well let's create the context... This story is not a true o false sentence, it's a sort of analysis based on a few assumptions: In Kubernetes, a&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://www.k8s.it/hpa-vs-rate-limit.html"><link rel="alternate" type="application/atom+xml" href="https://www.k8s.it/feed.xml"><link rel="alternate" type="application/json" href="https://www.k8s.it/feed.json"><meta property="og:title" content="HPA vs Rate-limit - LAB "><meta property="og:image" content="https://www.k8s.it/media/posts/43/Screenshot_2023-02-14_at_20.15.33-removebg-preview-2.png"><meta property="og:image:width" content="646"><meta property="og:image:height" content="229"><meta property="og:site_name" content="LAB"><meta property="og:description" content="Strange ... we are using hpa to increase the availability and we are introducing rate limit to reduce? Well let's create the context... This story is not a true o false sentence, it's a sort of analysis based on a few assumptions: In Kubernetes, a&hellip;"><meta property="og:url" content="https://www.k8s.it/hpa-vs-rate-limit.html"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://www.k8s.it/media/website/eth0.ico" type="image/x-icon"><link rel="stylesheet" href="https://www.k8s.it/assets/css/style.css?v=21da29f0ae0b3be132c4b37f1ecd6fa6"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.k8s.it/hpa-vs-rate-limit.html"},"headline":"HPA vs Rate-limit","datePublished":"2023-02-14T20:23","dateModified":"2023-02-16T23:07","image":{"@type":"ImageObject","url":"https://www.k8s.it/media/posts/43/Screenshot_2023-02-14_at_20.15.33-removebg-preview-2.png","height":229,"width":646},"description":"Strange ... we are using hpa to increase the availability and we are introducing rate limit to reduce? Well let's create the context... This story is not a true o false sentence, it's a sort of analysis based on a few assumptions: In Kubernetes, a&hellip;","author":{"@type":"Person","name":"lgirardi","url":"https://www.k8s.it/authors/lgirardi/"},"publisher":{"@type":"Organization","name":"lgirardi"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=UA-179496482-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-179496482-1');</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-5Q67F19PK4"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5Q67F19PK4');</script><script async defer="defer" src="https://analytics.umami.is/script.js" data-website-id="94a85eb9-27c5-4917-944e-f18dbec7cc27"></script></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://www.k8s.it/">LAB</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://www.linkedin.com/in/lgirardi/">linkedin</a></li><li><a href="https://services.k8s.it/grafana/?orgId&#x3D;2">live monitoring</a></li><li><a href="https://www.k8s.it/whoami.html">whoami</a></li><li><a href="https://www.k8s.it/hobbies.html" target="_self">hobbies</a></li></ul></nav><div class="search"><div class="search__overlay js-search-overlay"><div class="search__overlay-inner"><form action="https://www.k8s.it/search.html" class="search__form"><input class="search__input" type="search" name="q" placeholder="search..." aria-label="search..."></form><button class="search__close js-search-close" aria-label="Close">Close</button></div></div><button class="search__btn js-search-btn" aria-label="Search"><svg role="presentation" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#search"/></svg></button></div></header><main><article class="post"><div class="hero"><figure class="hero__image hero__image--overlay"><img src="https://www.k8s.it/media/posts/43/Screenshot_2023-02-14_at_20.15.33-removebg-preview-2.png" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot_2023-02-14_at_20.15.33-removebg-preview-2-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot_2023-02-14_at_20.15.33-removebg-preview-2-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot_2023-02-14_at_20.15.33-removebg-preview-2-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot_2023-02-14_at_20.15.33-removebg-preview-2-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot_2023-02-14_at_20.15.33-removebg-preview-2-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot_2023-02-14_at_20.15.33-removebg-preview-2-2xl.webp 1600w" sizes="(max-width: 1600px) 100vw, 1600px" loading="eager" height="229" width="646" alt=""></figure><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2023-02-14T20:23">14 Feb 2023</time></div><h1>HPA vs Rate-limit</h1></div></header></div><div class="wrapper post__entry"><div class="post__toc"><h3>Table of Contents</h3><ul><li><a href="#mcetoc_1gpdt88oks2">INTRO</a><ul><li><a href="#mcetoc_1gpdt88oks3">HPA</a><ul><li><a href="#mcetoc_1gpdt88oks4">Patterns</a></li><li><a href="#mcetoc_1gpdt88oks5">Meaning</a></li><li><a href="#mcetoc_1gpdt88oks6">Ideal Practice</a></li></ul></li><li><a href="#mcetoc_1gpdt88oks7">Rate Limit</a></li></ul></li><li><a href="#mcetoc_1gpdt88oks8">GOALS</a></li><li><a href="#mcetoc_1gpdt88oks9">Limits</a></li><li><a href="#mcetoc_1gpdt88oksa">Hands-on</a><ul><li><a href="#mcetoc_1gpdt88oksb">Simulation</a><ul><li><ul><li><a href="#mcetoc_1gpdu7tqi167">Note</a></li></ul></li><li> </li><li><a href="#mcetoc_1gpdu7tqi169">NO AUTOSCALING</a><ul><li><a href="#mcetoc_1gpdu7tqi16a">First run 40rps max</a></li><li><a href="#mcetoc_1gpdu7tqi16b">Second run 33rps max</a></li></ul></li><li><a href="#mcetoc_1gpduj9db16h">AUTOSCALING</a><ul><li><a href="#mcetoc_1gpduui3818q">1 pod start - hpa 33rps - 15 min - 99 max requests</a></li><li><a href="#mcetoc_1gpdvmntb1ba">2 pod start - hpa 33rps - 15 min - 99 max requests</a></li><li><a href="#mcetoc_1gpdvne631bd">1 pod start - hpa 30rps - 15 min - 99 max requests</a></li><li><a href="#mcetoc_1gpe003lg1ci">1 pod start - hpa 27rps - 15 min - 99 max requests</a></li><li><a href="#mcetoc_1gpe0j6931f3"> [optimal] 1 pod start - hpa 24rps - 15 min - 99 max requests</a></li><li><a href="#mcetoc_1gpe0j6931f4">1 pod start - hpa 25rps - 15 min - 99 max requests</a></li></ul></li><li><a href="#mcetoc_1gpe0j6931f5">AUTOSCALING Internal rate limit</a><ul><li><a href="#mcetoc_1gpe0pd9t1fm">[optimal] 1 pod start - hpa 25rps- 15 min - 99 max requests rate-limit 27</a></li><li><a href="#mcetoc_1gpe1laq11pb">1 pod start - hpa 26rps - 15 min - 99 max requests rate-limit 28</a></li><li><a href="#mcetoc_1gpe1laq11pc">1 pod start - hpa 27rps - 15 min - 99 max requests rate-limit 29</a></li></ul></li><li><a href="#mcetoc_1gpe1laq11pd">AUTOSCALING envoy rate limit</a><ul><li><a href="#mcetoc_1gpe1laq11pe">1 pod start - hpa 27rps - 15 min - 99 max requests rate-limit 29 - envoy</a></li><li><a href="#mcetoc_1gpe1laq11pf">[optimal] 1 pod start - hpa 26rps - 15 min - 99 max requests rate-limit 29 - envoy</a></li></ul></li><li><a href="#mcetoc_1gpe1laq11pg">Unexpected traffic</a><ul><li><a href="#mcetoc_1gpe2t9fu2jk">3 pod start - hpa 26rps - 15 min - 82 avg requests with spikes -  rate-limit 27 internal</a></li><li><a href="#mcetoc_1gpe2t9fu2jl">[optimal] 3 pod start - hpa 26rps - 15 min - 82 avg requests with spikes -  rate-limit 27 - envoy</a></li></ul></li><li><a href="#mcetoc_1gpe2t9fu2jm">Conclusions</a><ul><li><a href="#mcetoc_1gpe2t9fu2jn">HPA</a></li><li><a href="#mcetoc_1gpe2t9fu2jo">Rate Limit</a></li><li><a href="#mcetoc_1gpe2t9fu2jp">Both</a></li><li><a href="#mcetoc_1gpe2t9fu2jq">Costs</a><ul><li><a href="#mcetoc_1gpe2t9fu2jr">Highlights</a></li></ul></li></ul></li></ul></li></ul></li></ul></div><p>Strange ... we are using hpa to increase the availability and we are introducing rate limit to reduce?  </p><p>Well let's create the context...</p><h1 id="mcetoc_1gpdt88oks2">INTRO</h1><p>This <em>story </em>is not a true o false sentence, it's a sort of analysis based on a few assumptions:</p><ul><li>cloud environment</li><li>dynamic infrastructure</li><li>minimum resources available </li></ul><h2 id="mcetoc_1gpdt88oks3">HPA</h2><p><span style="font-weight: 400;">In Kubernetes, a </span><i><span style="font-weight: 400;">HorizontalPodAutoscaler</span></i><span style="font-weight: 400;"> automatically updates a workload resource (such as a </span><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/"><span style="font-weight: 400;">Deployment</span></a><span style="font-weight: 400;"> or </span><a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/"><span style="font-weight: 400;">StatefulSet</span></a><span style="font-weight: 400;">), with the aim of automatically scaling the workload to match demand.</span></p><h3 id="mcetoc_1gpdt88oks4">Patterns</h3><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-20.28.38.png" alt="" width="1174" height="916" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-20.28.38-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-20.28.38-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-20.28.38-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-20.28.38-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-20.28.38-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-20.28.38-2xl.webp 1600w"></figure><h3 id="mcetoc_1gpdt88oks5">Meaning</h3><table style="border-collapse: collapse; width: 100%;" border="1"><tbody><tr><td style="width: 21.2501%;"><strong>Type</strong></td><td style="width: 78.7499%;"><strong>Behaviour</strong></td></tr><tr><td style="width: 21.2501%;">Slow and temporary</td><td style="width: 78.7499%;">it might have daily fluctuations in requests volume, peaking during the day and troughing at night</td></tr><tr><td style="width: 21.2501%;">Rapid and temporary</td><td style="width: 78.7499%;">it might be subject to short bursts of high request volume from poorly-behaved downstream services</td></tr><tr><td style="width: 21.2501%;">Slow and persistent</td><td style="width: 78.7499%;">it might see its request volume slowly increase over rime, as the product sees greater adoption</td></tr><tr><td style="width: 21.2501%;">Rapid and persistent</td><td style="width: 78.7499%;">it might see abrupt shift from low to high volumes, such as if it's called by batch jobs</td></tr></tbody></table><p> </p><h3 id="mcetoc_1gpdt88oks6">Ideal Practice</h3><table style="border-collapse: collapse; width: 100%;" border="1"><tbody><tr><td style="width: 22.7209%;"><strong>Type</strong></td><td style="width: 77.4218%;"><strong>Behaviour</strong></td></tr><tr><td style="width: 22.7209%;">Slow and temporary</td><td style="width: 77.4218%;">The HPA should add and remove pods as necessary</td></tr><tr><td style="width: 22.7209%;">Rapid and temporary</td><td style="width: 77.4218%;">The HPA should not modify the pod count; instead, the service should leave enough headroom to deal with these brief spikes with only existing pods</td></tr><tr><td style="width: 22.7209%;">Slow and persistent </td><td style="width: 77.4218%;">The HPA should add and remove pods as necessary</td></tr><tr><td style="width: 22.7209%;">Rapid and persistent</td><td style="width: 77.4218%;">The service should leave enough headroom to deal with the rapid change, and the HPA should add pods soon after to bring the service back to target utilization</td></tr></tbody></table><h2 id="mcetoc_1gpdt88oks7">Rate Limit</h2><p><span style="font-weight: 400;">A rate limit is the number of API calls an app or user can make within a given time period. If this limit is exceeded or if CPU or total time limits are exceeded, the app or user may be throttled. API requests made by a throttled user or app will fail. All API requests are subject to rate limits.</span></p><p>However, keep the HPA patterns as a reference even for this one.</p><p> </p><h1 id="mcetoc_1gpdt88oks8"><span style="font-weight: 400;">GOALS</span></h1><ul><li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Understand how much we can close with the application enervation during an autoscaling situation using rate limit</span></li><li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Understand how to handle unexpected traffic with rate limit</span></li></ul><p> </p><h1 id="mcetoc_1gpdt88oks9"><span style="font-weight: 400;">Limits</span></h1><p>Sometimes we can have a spike of requests that are legit... for example consider the google crawlers (image from ... somewhere in google image)</p><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/logs-crawl-spikes-three-c-sm-border.png" alt="" width="518" height="277" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/logs-crawl-spikes-three-c-sm-border-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/logs-crawl-spikes-three-c-sm-border-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/logs-crawl-spikes-three-c-sm-border-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/logs-crawl-spikes-three-c-sm-border-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/logs-crawl-spikes-three-c-sm-border-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/logs-crawl-spikes-three-c-sm-border-2xl.webp 1600w"></figure><p> </p><h1 id="mcetoc_1gpdt88oksa"><span style="font-weight: 400;">Hands-on</span></h1><h2 id="mcetoc_1gpdt88oksb"><span style="font-weight: 400;">Simulation</span></h2><ul><li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;"><a href="https://github.com/lorenzogirardi/py-test-backend">python</a> app that generates fibonacci sequence</span></li><li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">fibonacci number 18500</span></li><li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">load test done using gatling</span></li><li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Application capped on cpu (each request is ~10mcpu) with max of 300mcpu for pod (cpu bound)</span></li><li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Hpa based on keda flask_http_request_duration_seconds_count</span></li></ul><p> </p><p><span style="font-weight: 400;">Results Example </span></p><p><span style="font-weight: 400;">$ curl http://xxx/api/fib/18500<br></span><span style="font-family: var(--editor-font-family); font-size: inherit;">8353329688443562486779853158514... etc etc<br></span></p><p><span style="font-weight: 400;">This ensures that it is not just an echo answer and that we have work behind the scenes.</span></p><p> </p><h4 id="mcetoc_1gpdu7tqi167">Note</h4><p>Gatling is using an interesting concept that call "active users"</p><p><span style="font-weight: 400;">“Active users” is neither “concurrent users” or “users arrival rate”. It’s a kind of mixed metric that serves for both open and closed workload models and that represents “users who were active on the system under load at a given second”.</span></p><p><span style="font-weight: 400;">It’s computed as:</span></p><p><span style="font-weight: 400;"> (number of alive users at previous second)<br></span><span style="font-family: var(--editor-font-family); font-size: inherit;">+ (number of users that were started during this second)<br></span><span style="font-weight: 400;">- (number of users that were terminated during previous second)</span></p><h3 id="mcetoc_1gpdu7tqi168"></h3><h3 id="mcetoc_1gpdu7tqi169"><span style="font-weight: 400;">NO AUTOSCALING</span></h3><p> </p><h4 id="mcetoc_1gpdu7tqi16a"><span style="font-weight: 400;">First run 40rps max</span></h4><p class="msg msg--info"><span style="font-weight: 400;">rampUsers(10).during(60.seconds), // increase users to 10 in 60 sec<br></span><span style="font-weight: 400;">constantUsersPerSec(10).during(60.seconds), // keep 10 users for 60 sec<br></span><span style="font-weight: 400;">rampUsersPerSec(10).to(40).during(5.minutes), // increase users to 40 in 5 min</span></p><p> </p><figure class="post__image post__image--center"><span style="font-family: var(--editor-font-family); font-size: inherit;"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.15.19.png" alt="" width="1198" height="468" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.15.19-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.15.19-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.15.19-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.15.19-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.15.19-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.15.19-2xl.webp 1600w"></span></figure><p></p><p><span style="font-family: var(--editor-font-family); font-size: inherit;"> As soon as we reach the limit the pods start to be unresponsive</span></p><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.16.02.png" alt="" width="1200" height="326" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.16.02-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.16.02-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.16.02-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.16.02-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.16.02-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.16.02-2xl.webp 1600w"></figure><br>No metrics after 33 rps, pod crashed<br><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.17.54.png" alt="" width="1194" height="436" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.17.54-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.17.54-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.17.54-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.17.54-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.17.54-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.17.54-2xl.webp 1600w"></figure><br>No metrics after &gt;28% of cpu (consider the max as 30% as the pod limit is 300mcpu)<br><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.19.22.png" alt="" width="1200" height="482" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.19.22-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.19.22-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.19.22-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.19.22-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.19.22-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.19.22-2xl.webp 1600w"></figure><figure class="post__image post__image--center"><span style="font-weight: 400;">Failure rate (low) when rps &gt; 35 and high response time<br><br><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.20.38.png" alt="" width="1182" height="476" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.20.38-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.20.38-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.20.38-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.20.38-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.20.38-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.20.38-2xl.webp 1600w"></span></figure><br><span style="font-weight: 400;">Active users increase dramatically after 33 rps<br><br></span><p></p><h4 id="mcetoc_1gpdu7tqi16b"><span style="font-weight: 400;">Second run 33rps max</span></h4><p class="msg msg--info"><span style="font-weight: 400;">rampUsers(10).during(60.seconds), // increase users to 10 in 60 sec<br>constantUsersPerSec(10).during(60.seconds), // keep 10 users for 60 sec<br>rampUsersPerSec(10).to(30).during(4.minutes), // increase users to 30 in 4 min<br></span></p><figure class="post__image post__image--center"><span style="font-weight: 400;"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.24.14.png" alt="" width="1196" height="470" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.14-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.14-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.14-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.14-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.14-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.14-2xl.webp 1600w"></span></figure><p></p><figure class="post__image post__image--center"><span style="font-weight: 400;"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.24.22.png" alt="" width="1198" height="282" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.22-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.22-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.22-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.22-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.22-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.22-2xl.webp 1600w"></span></figure><p></p><figure class="post__image post__image--center"><span style="font-weight: 400;"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.24.30.png" alt="" width="1162" height="428" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.30-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.30-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.30-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.30-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.30-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.30-2xl.webp 1600w"></span></figure><p></p><figure class="post__image post__image--center"><span style="font-weight: 400;"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.24.39.png" alt="" width="1190" height="480" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.39-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.39-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.39-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.39-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.39-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.39-2xl.webp 1600w"></span></figure><p></p><figure class="post__image post__image--center"><span style="font-weight: 400;"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.24.46.png" alt="" width="1194" height="480" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.46-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.46-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.46-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.46-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.46-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.24.46-2xl.webp 1600w"></span></figure><p></p><p><span style="font-weight: 400;">Really better, we can say that the MAX rps is 33 ... this valid <i>one-shot</i> in a single run</span></p><p> </p><h3 id="mcetoc_1gpduj9db16h"><span style="font-weight: 400;">AUTOSCALING</span></h3><p class="msg msg--info"><span style="font-weight: 400;"> rampUsers(10).during(60.seconds), // increase users to 10 in 60 sec<br></span><span style="font-weight: 400;"> constantUsersPerSec(10).during(60.seconds), // keep 10 users for 60sec<br></span><span style="font-weight: 400;"> rampUsersPerSec(10).to(99).during(15.minutes), // increase users to 99 in 15 min</span></p><p> </p><h4 id="mcetoc_1gpduui3818q"><span style="font-weight: 400;">1 pod start - hpa 33rps - 15 min - 99 max requests</span></h4><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.30.24.png" alt="" width="1194" height="250" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.24-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.24-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.24-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.24-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.24-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.24-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.30.30.png" alt="" width="1192" height="430" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.30-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.30-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.30-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.30-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.30-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.30.30-2xl.webp 1600w"></figure><br>DEAD !!! <br><br>Test stopped as per ...<p></p><p class="msg msg--warning"><span style="font-weight: 400;">================================================================================<br></span><span style="font-weight: 400;">2023-02-09 10:01:38                                         885s elapsed<br></span><span style="font-weight: 400;">---- Requests ------------------------------------------------------------------<br></span><span style="font-weight: 400;">&gt; Global                                                   (OK=17944  KO=18236 )<br></span><span style="font-weight: 400;">&gt; request_1                                                (OK=17944  KO=18236 )<br></span><span style="font-weight: 400;">---- Errors --------------------------------------------------------------------<br></span><span style="font-weight: 400;">&gt; status.find.in(200,201,202,203,204,205,206,207,208,209,304), f   8358 (45.83%)f</span><span style="font-weight: 400;">ound 503<br></span><span style="font-weight: 400;">&gt; status.find.in(200,201,202,203,204,205,206,207,208,209,304), f   5529 (30.32%)f</span><span style="font-weight: 400;">ound 502<br></span><span style="font-weight: 400;">&gt; status.find.in(200,201,202,203,204,205,206,207,208,209,304), f   4273 (23.43%)f</span><span style="font-weight: 400;">ound 504<br></span><span style="font-weight: 400;">&gt; i.g.h.c.i.RequestTimeoutException: Request timeout to oracolo.     73 ( 0.40%)<br></span><span style="font-weight: 400;">&gt; j.i.IOException: Premature close                                    3 ( 0.02%)<br></span><span style="font-weight: 400;">---- BasicSimulation -----------------------------------------------------------<br></span><span style="font-weight: 400;">[#####################################################--                   ] 72%<br></span><span style="font-weight: 400;">waiting: 12549  / active: 932    / done: 36180<br></span><span style="font-weight: 400;">================================================================================</span></p><p> </p><h4 id="mcetoc_1gpdvmntb1ba"><span style="font-weight: 400;">2 pod start - hpa 33rps - 15 min - 99 max requests</span></h4><figure class="post__image post__image--center"><span style="font-weight: 400;">Autoscaler is not able to support the traffic in the picture before , the curve is stressing the namespace in a way to make impossible the scaling and reliability, this can be by a single pod start and ratio of requests absorbed, let’s try starting with 2 , it’s supposed in that way to have half of the requests to absorb each one<br><br><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.41.18.png" alt="" width="1194" height="474" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.18-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.18-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.18-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.18-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.18-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.18-2xl.webp 1600w"></span></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.41.29.png" alt="" width="1196" height="274" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.29-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.29-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.29-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.29-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.29-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.29-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.41.37.png" alt="" width="1182" height="434" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.37-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.37-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.37-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.37-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.37-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.37-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.41.44.png" alt="" width="1194" height="484" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.44-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.44-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.44-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.44-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.44-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.44-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.41.52.png" alt="" width="1194" height="472" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.52-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.52-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.52-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.52-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.52-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.41.52-2xl.webp 1600w"></figure><br>Naaaa... still not able to scale <p></p><p><br><br></p><h4 id="mcetoc_1gpdvne631bd"><span style="font-weight: 400;">1 pod start - hpa 30rps - 15 min - 99 max requests</span></h4><figure class="post__image post__image--center"><span style="font-weight: 400;"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.44.45.png" alt="" width="1198" height="472" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.45-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.45-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.45-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.45-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.45-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.45-2xl.webp 1600w"></span></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.44.57.png" alt="" width="1132" height="318" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.57-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.57-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.57-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.57-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.57-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.44.57-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.45.03.png" alt="" width="1124" height="466" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.03-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.03-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.03-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.03-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.03-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.03-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.45.10.png" alt="" width="1198" height="480" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.10-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.10-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.10-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.10-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.10-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.10-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.45.17.png" alt="" width="1192" height="480" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.17-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.17-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.17-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.17-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.17-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.45.17-2xl.webp 1600w"></figure><br>Ok we are able to scale but at the end we have a complete crash<p></p><h4 id="mcetoc_1gpe003lg1ci"><span style="font-weight: 400;"><br>1 pod start - hpa 27rps - 15 min - 99 max requests</span></h4><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.53.36.png" alt="" width="1194" height="470" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.36-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.36-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.36-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.36-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.36-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.36-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.53.43.png" alt="" width="1198" height="300" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.43-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.43-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.43-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.43-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.43-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.43-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.53.51.png" alt="" width="1122" height="412" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.51-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.51-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.51-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.51-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.51-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.51-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.53.58.png" alt="" width="1202" height="472" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.58-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.58-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.58-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.58-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.58-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.53.58-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.54.07.png" alt="" width="1198" height="476" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.54.07-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.54.07-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.54.07-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.54.07-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.54.07-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.54.07-2xl.webp 1600w"></figure><br>Oh noooo ... worse than before with fewer rps ... since we are over-stressed when start to crash can have weird behaviour  <p></p><p> </p><h4 id="mcetoc_1gpe0j6931f3"><span style="font-weight: 400;"> [optimal] 1 pod start - hpa 24rps - 15 min - 99 max requests</span></h4><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.58.23.png" alt="" width="1196" height="468" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.23-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.23-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.23-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.23-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.23-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.23-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.58.33.png" alt="" width="1198" height="294" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.33-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.33-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.33-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.33-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.33-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.33-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.58.41.png" alt="" width="1194" height="434" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.41-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.41-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.41-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.41-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.41-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.41-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.58.51.png" alt="" width="1196" height="466" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.51-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.51-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.51-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.51-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.51-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.51-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-21.58.58.png" alt="" width="1198" height="472" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.58-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.58-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.58-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.58-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.58-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-21.58.58-2xl.webp 1600w"></figure><br>Here we are !!!<p></p><p> </p><h4 id="mcetoc_1gpe0j6931f4"><span style="font-weight: 400;">1 pod start - hpa 25rps - 15 min - 99 max requests</span></h4><p>let's try with one more</p><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.00.50.png" alt="" width="1194" height="464" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.50-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.50-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.50-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.50-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.50-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.50-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.00.59.png" alt="" width="1196" height="310" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.59-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.59-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.59-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.59-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.59-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.00.59-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.01.06.png" alt="" width="1188" height="422" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.06-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.06-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.06-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.06-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.06-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.06-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.01.15.png" alt="" width="1192" height="486" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.15-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.15-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.15-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.15-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.15-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.15-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.01.22.png" alt="" width="1202" height="478" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.22-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.22-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.22-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.22-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.22-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.01.22-2xl.webp 1600w"></figure><br>Naaaa .... no more than 24 rps<p></p><p> </p><h3 id="mcetoc_1gpe0j6931f5"><span style="font-weight: 400;">AUTOSCALING Internal rate limit</span></h3><p><a href="https://www.k8s.it/application-rate-limiting.html" target="_blank" rel="noopener noreferrer">Here how to</a></p><h4 id="mcetoc_1gpe0pd9t1fm"><span style="font-weight: 400;">[optimal] 1 pod start - hpa 25rps</span><span style="font-weight: 400;">- 15 min - 99 max requests rate-limit 27</span></h4><p><span style="font-weight: 400;">I suppose that the </span><em><span style="font-weight: 400;">optimal</span></em><span style="font-weight: 400;">  before (24rps) is working good also with RL so let’s start with 25</span></p><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.08.07.png" alt="" width="1198" height="622" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.07-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.07-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.07-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.07-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.07-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.07-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.08.14.png" alt="" width="1194" height="334" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.14-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.14-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.14-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.14-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.14-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.14-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.08.20.png" alt="" width="1130" height="448" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.20-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.20-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.20-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.20-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.20-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.20-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.08.29.png" alt="" width="1192" height="468" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.29-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.29-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.29-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.29-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.29-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.29-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.08.34.png" alt="" width="1200" height="472" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.34-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.34-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.34-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.34-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.34-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.08.34-2xl.webp 1600w"></figure><p><span style="font-weight: 400;">Better than the same rps with no ratelimit<br></span></p><p><span style="font-weight: 400;">The errors are just the 429 triggered by rate limit … so the good answer are ok and no issue or restart on the application during the autoscaling… a bit of queue</span></p><p><span style="font-weight: 400;">No so bad considering the errors in red as just rate limited calls</span></p><p> </p><h4 id="mcetoc_1gpe1laq11pb"><span style="font-weight: 400;">1 pod start - hpa 26rps - 15 min - 99 max requests rate-limit 28</span></h4><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.11.25.png" alt="" width="1200" height="650" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.25-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.25-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.25-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.25-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.25-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.25-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.11.33.png" alt="" width="1198" height="294" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.33-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.33-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.33-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.33-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.33-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.33-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.11.41.png" alt="" width="1114" height="418" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.41-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.41-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.41-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.41-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.41-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.41-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.11.49.png" alt="" width="1194" height="474" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.49-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.49-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.49-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.49-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.49-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.49-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.11.56.png" alt="" width="1196" height="472" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.56-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.56-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.56-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.56-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.56-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.11.56-2xl.webp 1600w"></figure><p><span style="font-weight: 400;">Just one error for pod unresponsive</span></p><p> </p><h4 id="mcetoc_1gpe1laq11pc"><span style="font-weight: 400;">1 pod start - hpa 27rps - 15 min - 99 max requests rate-limit 29</span></h4><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.13.57.png" alt="" width="1196" height="770" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.13.57-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.13.57-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.13.57-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.13.57-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.13.57-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.13.57-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.14.08.png" alt="" width="1112" height="266" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.08-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.08-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.08-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.08-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.08-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.08-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.14.14.png" alt="" width="1094" height="422" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.14-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.14-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.14-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.14-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.14-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.14-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.14.21.png" alt="" width="1192" height="478" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.21-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.21-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.21-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.21-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.21-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.21-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.14.28.png" alt="" width="1198" height="458" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.28-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.28-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.28-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.28-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.28-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.14.28-2xl.webp 1600w"></figure><br>Broken!!!<p></p><p> </p><h3 id="mcetoc_1gpe1laq11pd"><span style="font-weight: 400;">AUTOSCALING envoy rate limit</span></h3><h4 id="mcetoc_1gpe1laq11pe"><span style="font-weight: 400;">1 pod start - hpa 27rps - 15 min - 99 max requests rate-limit 29 - envoy</span></h4><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.17.26.png" alt="" width="1190" height="706" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.26-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.26-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.26-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.26-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.26-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.26-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.17.33.png" alt="" width="1122" height="258" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.33-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.33-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.33-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.33-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.33-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.33-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.17.39.png" alt="" width="1098" height="412" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.39-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.39-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.39-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.39-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.39-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.39-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.17.46.png" alt="" width="1196" height="472" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.46-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.46-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.46-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.46-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.46-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.46-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.17.53.png" alt="" width="1196" height="474" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.53-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.53-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.53-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.53-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.53-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.17.53-2xl.webp 1600w"></figure><br>Broken!!!<p></p><p> </p><h4 id="mcetoc_1gpe1laq11pf"><span style="font-weight: 400;">[optimal] 1 pod start - hpa 26rps - 15 min - 99 max requests rate-limit 29 - envoy</span></h4><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.19.24.png" alt="" width="1188" height="602" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.24-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.24-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.24-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.24-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.24-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.24-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.19.30.png" alt="" width="1194" height="300" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.30-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.30-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.30-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.30-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.30-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.30-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.19.38.png" alt="" width="1176" height="428" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.38-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.38-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.38-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.38-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.38-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.38-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.19.46.png" alt="" width="1176" height="472" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.46-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.46-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.46-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.46-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.46-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.46-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.19.52.png" alt="" width="1182" height="478" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.52-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.52-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.52-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.52-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.52-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.19.52-2xl.webp 1600w"></figure><p><span style="font-weight: 400;">Better than expected compared to the solution with rate limit embedded </span></p><p> </p><h3 id="mcetoc_1gpe1laq11pg"><span style="font-weight: 400;">Unexpected traffic</span></h3><p class="msg msg--info"><span style="font-weight: 400;">rampUsers(30).during(60.seconds),<br></span><span style="font-weight: 400;">constantUsersPerSec(30).during(60.seconds).randomized, <br></span><span style="font-weight: 400;">rampUsersPerSec(30).to(82).during(4.minutes), <br></span><span style="font-weight: 400;">constantUsersPerSec(82).during(120.seconds).randomized,<br></span><span style="font-weight: 400;">rampUsersPerSec(82).to(170).during(10.seconds),<br></span><span style="font-weight: 400;">constantUsersPerSec(82).during(120.seconds).randomized,<br></span><span style="font-weight: 400;">rampUsersPerSec(82).to(130).during(20.seconds),<br></span><span style="font-weight: 400;">constantUsersPerSec(82).during(120.seconds).randomized,<br></span><span style="font-weight: 400;">rampUsersPerSec(82).to(210).during(30.seconds),<br></span><span style="font-weight: 400;">constantUsersPerSec(82).during(120.seconds).randomized,<br></span><span style="font-weight: 400;">constantUsersPerSec(333).during(2.seconds),<br></span><span style="font-weight: 400;">constantUsersPerSec(82).during(120.seconds).randomized,<br></span><span style="font-weight: 400;">constantUsersPerSec(333).during(10.seconds),<br></span><span style="font-weight: 400;">constantUsersPerSec(82).during(80.seconds)</span></p><p><span style="font-weight: 400;"> </span></p><h4 id="mcetoc_1gpe2t9fu2jk"><span style="font-weight: 400;">3 pod start - hpa 26rps - 15 min - 82 avg requests with spikes -  rate-limit 27 internal</span></h4><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.25.08.png" alt="" width="1194" height="714" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.08-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.08-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.08-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.08-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.08-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.08-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.25.15.png" alt="" width="1192" height="238" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.15-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.15-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.15-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.15-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.15-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.15-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.25.22.png" alt="" width="1148" height="462" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.22-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.22-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.22-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.22-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.22-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.22-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.25.29.png" alt="" width="1194" height="482" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.29-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.29-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.29-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.29-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.29-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.29-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.25.36.png" alt="" width="1200" height="484" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.36-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.36-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.36-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.36-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.36-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.25.36-2xl.webp 1600w"></figure><p>Since the incoming requests are absorbed from the app we reach the limit<br>Errors are not only 429 as rate but 5xx</p><p>Broken!!!</p><p> </p><h4 id="mcetoc_1gpe2t9fu2jl"><span style="font-weight: 400;">[optimal] 3 pod start - hpa 26rps - 15 min - 82 avg requests with spikes -  rate-limit 27 - envoy</span></h4><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.27.32.png" alt="" width="1192" height="594" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.32-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.32-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.32-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.32-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.32-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.32-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.27.40.png" alt="" width="1196" height="234" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.40-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.40-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.40-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.40-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.40-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.40-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.27.46.png" alt="" width="1200" height="422" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.46-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.46-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.46-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.46-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.46-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.46-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.27.54.png" alt="" width="1202" height="472" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.54-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.54-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.54-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.54-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.54-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.27.54-2xl.webp 1600w"></figure><br><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.28.01.png" alt="" width="1204" height="478" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.28.01-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.28.01-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.28.01-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.28.01-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.28.01-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.28.01-2xl.webp 1600w"></figure><p><span style="font-weight: 400;">No issue at all , since the rl is performed by envoy the python app has no “spikes”</span></p><p> </p><p> </p><h3 id="mcetoc_1gpe2t9fu2jm"><span style="font-weight: 400;">Conclusions</span></h3><h4 id="mcetoc_1gpe2t9fu2jn"><span style="font-weight: 400;">HPA</span></h4><p><span style="font-weight: 400;">This application is cpu bound … so I used req/s even if the right autoscaling metric is the cpu usage, however, I would say that each application has the intent to serve requests.</span><span style="font-weight: 400;"><br></span><span style="font-weight: 400;"><span style="text-decoration: underline;">Create a dedicated configuration, application per application, for the hpa is the best option</span> but it requires <strong>HUGE</strong> know-how and time …</span><span style="font-weight: 400;"><br></span><span style="font-weight: 400;">Considering the sentence before, I was impressed about </span><a href="https://gatling.io/docs/gatling/reference/current/stats/reports/#:~:text=%E2%80%9CActive%20users%E2%80%9D%20is%20neither%20%E2%80%9C,load%20at%20a%20given%20second%E2%80%9D."><span style="font-weight: 400;">Active users</span></a><span style="font-weight: 400;">  since share the correct clue at high levels about the status of the application, it’s really really close to measuring the enervation of the app</span></p><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/43/Screenshot-2023-02-16-at-22.30.45.png" alt="" width="1200" height="474" sizes="100vw" srcset="https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.30.45-xs.webp 300w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.30.45-sm.webp 480w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.30.45-md.webp 768w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.30.45-lg.webp 1024w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.30.45-xl.webp 1360w, https://www.k8s.it/media/posts/43/responsive/Screenshot-2023-02-16-at-22.30.45-2xl.webp 1600w"></figure><p>I would say that the concept of active users as a HPA metric is better than <span style="font-weight: 400;">flask_http_request_duration_seconds_count</span></p><p><span style="font-weight: 400;">Even if we can reach 33rps in a single pod , we should consider that in an autoscaling scenario this will be reduced to </span><strong>less, </strong><span style="font-weight: 400;">cause for a certain amount of time we have more requests till we are waiting for new pods/node etc etc </span></p><p>I would say that is better to have an application running at 65% of max capacity before scale</p><p> </p><h4 id="mcetoc_1gpe2t9fu2jo"><span style="font-weight: 400;">Rate Limit</span></h4><p><br><i></i></p><ul><li style="font-weight: 400;" aria-level="1"><i><span style="font-weight: 400;">Understand how much we can close with the application enervation during an autoscaling situation using rate limit</span></i></li></ul><p><strong>No</strong><span style="font-weight: 400;"> … or better … we can increase a bit the limit to exploit the app at max possible, however, it’s just a risk for 5% more in rps.</span><span style="font-weight: 400;"><br></span><span style="font-weight: 400;">The application will be more sensible and the rl is really close to the hpa</span></p><p> </p><ul><li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Understand how to handle unexpected traffic with a rate limit</span></li></ul><p><strong>Yes </strong><span style="font-weight: 400;">… this pattern is the right one for the rate limit</span><span style="font-weight: 400;"><br></span><span style="font-weight: 400;">Better is to perform this action outside the application container since will impact unfortunately the incoming requests, the saturation etc etc and you have rl and hpa that can fight each other </span></p><p> </p><h4 id="mcetoc_1gpe2t9fu2jp"><span style="font-weight: 400;">Both</span></h4><ul><li style="font-weight: 400;" aria-level="1"><span style="font-weight: 400;">Do not force hpa to collaborate with rl … should be 2 different parameters</span></li></ul><p>In this scenario are both rps ... but are profiled in a different way , so do not consider as the same metric or meaning</p><p> </p><h4 id="mcetoc_1gpe2t9fu2jq"><span style="font-weight: 400;">Costs</span></h4><p> </p><p><span style="font-weight: 400;">In some way trying to save money by increasing to the possible max rps is risky, we should leverage the kubernetes pod scheduling more than try to reach 100% of the application</span></p><h5 id="mcetoc_1gpe2t9fu2jr"><span style="font-weight: 400;">Highlights</span></h5><p><span style="font-weight: 400;">Unexpected traffic can be something that is generated for a wrong deployment/batch 5% of cases or by external calls 95%</span></p><p><span style="font-weight: 400;">The external calls come from public or private endpoints can be managed by<br></span></p><ul><li>waf rate limit</li><li>api gateway rate limit</li></ul><p><span style="font-weight: 400;">Those two solutions are better, cause they can keep the infrastructure safe as a first point of contact but ... </span><span style="font-weight: 400;">A big </span><strong>BUT</strong></p><p><span style="font-weight: 400;">In a dynamic infrastructure where we have autoscaling and downscaling,  a legit peak like </span><span style="font-weight: 400;">google scrape </span><span style="font-weight: 400;">is not possible to handle, cause the RL is service level <br></span><strong>AND…</strong><span style="font-weight: 400;"> <br></span><span style="font-weight: 400;">during the night, it's supposed to have the minimum pods available as there is less user traffic for example.</span></p><p> </p><p><span style="font-weight: 400;">So … <span style="text-decoration: underline;">I’ll remark on the drawback of cost savings</span> following the </span><span style="font-weight: 400;">matrix based on hpa patterns</span><span style="font-weight: 400;"> (cit </span><a href="https://www.imdb.com/title/tt0088850/"><span style="font-weight: 400;">brewster's millions</span></a><span style="font-weight: 400;">)<br></span>As much as we are close to using fewer resources as possible, as much we are increasing corner cases and unexpected situations.<br><br>Be careful to evaluate the rate limit concept </p><p>Cheers :-) </p><p> </p><p> </p><p> </p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on 16 Feb 2023</p><ul class="post__tag"><li><a href="https://www.k8s.it/cost-saving/">cost saving</a></li><li><a href="https://www.k8s.it/dynamic-infrastructure/">dynamic infrastructure</a></li><li><a href="https://www.k8s.it/envoy/">envoy</a></li><li><a href="https://www.k8s.it/hpa/">hpa</a></li><li><a href="https://www.k8s.it/rate-limit-vs-hpa/">rate limit vs hpa</a></li><li><a href="https://www.k8s.it/rate-limiting/">rate-limiting</a></li></ul><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.k8s.it%2Fhpa-vs-rate-limit.html" class="js-share facebook" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fwww.k8s.it%2Fhpa-vs-rate-limit.html&amp;via=LAB&amp;text=HPA%20vs%20Rate-limit" class="js-share twitter" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.k8s.it%2Fhpa-vs-rate-limit.html" class="js-share linkedin" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span> </a><a href="https://buffer.com/add?text=HPA%20vs%20Rate-limit&amp;url=https%3A%2F%2Fwww.k8s.it%2Fhpa-vs-rate-limit.html" class="js-share buffer" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#buffer"/></svg> <span>Buffer</span> </a><a href="https://api.whatsapp.com/send?text=HPA%20vs%20Rate-limit https%3A%2F%2Fwww.k8s.it%2Fhpa-vs-rate-limit.html" class="js-share whatsapp" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#whatsapp"/></svg> <span>WhatsApp</span></a></div><div class="post__bio bio"><div><h3 class="bio__name"><a href="https://www.k8s.it/authors/lgirardi/" rel="author">lgirardi</a></h3><div class="bio__desc">If it isn't there, it can't break.</div></div></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://www.k8s.it/application-rate-limiting.html" class="post__nav-link" rel="prev"><span>Previous</span> application rate limit </a></div></div></nav><div class="post__comments"><div class="wrapper"></div></div></main><footer class="footer"><div class="footer__social"><a href="https://www.linkedin.com/in/lgirardi/" aria-label="LinkedIn"><svg><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#linkedin"/></svg></a></div><div class="footer__copyright"><p>.</p></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script defer="defer" src="https://www.k8s.it/assets/js/scripts.min.js?v=f47c11534595205f20935f0db2a62a85"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site, for marketing, and to provide social media functionality. <a href="#not-specified">More details...</a></div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--link pcb__btn--configure" aria-haspopup="dialog">Manage preferences</button> <button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Save</button></div></div></div><div class="pcb__popup" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-popup-title"><div class="pcb__popup__wrapper"><div class="pcb__inner pcb__popup__inner"><div class="pcb__popup__heading"><div id="pcb-popup-title" role="heading" aria-level="2" class="pcb__title">Cookie settings</div><button class="pcb__popup__close" aria-label="Close"></button></div><div class="pcb__popup__content"><div class="pcb__txt pcb__popup__txt">We use cookies to enhance your browsing experience, serve personalized ads or content, and analyze our traffic. By clicking "Accept All", you consent to our use of cookies. <a href="#not-specified">More details...</a></div><ul class="pcb__groups"><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Required</summary></details><div class="pcb__popup__switch is-checked"><input type="checkbox" data-group-name="" id="pcb-group-0" checked="checked"> <label for="pcb-group-0">Required</label></div></li><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Functionality</summary></details><div class="pcb__popup__switch"><input type="checkbox" data-group-name="functions" id="functions-cookies"> <label for="functions-cookies">Functionality</label></div></li><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Analytical</summary></details><div class="pcb__popup__switch"><input type="checkbox" data-group-name="analytics" id="analytics-cookies"> <label for="analytics-cookies">Analytical</label></div></li><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Marketing</summary></details><div class="pcb__popup__switch"><input type="checkbox" data-group-name="marketing" id="marketing-cookies"> <label for="marketing-cookies">Marketing</label></div></li></ul></div><div class="pcb__buttons pcb__popup__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button> <button type="button" class="pcb__btn pcb__btn--reject">Reject all</button> <button type="button" class="pcb__btn pcb__btn--save">Save settings</button></div></div></div></div><div class="pcb__overlay" aria-hidden="true"></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('🍪 Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('🍪 Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('🍪 Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && cbConfig.initialLsState.indexOf(allowedGroup) === -1) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('🍪 GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('🍪 Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('🍪 Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>