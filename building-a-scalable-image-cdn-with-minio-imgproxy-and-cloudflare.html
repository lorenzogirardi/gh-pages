<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Building a Scalable Image CDN with MinIO, imgproxy, and Cloudflare - LAB</title><meta name="description" content="Intro In today's digital landscape, efficiently serving images is critical for website performance. Users expect fast-loading, responsive websites, and images often account for the majority of a page's weight. In this article, I'll walk you through building a powerful, scalable image CDN using open-source tools&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://www.k8s.it/building-a-scalable-image-cdn-with-minio-imgproxy-and-cloudflare.html"><link rel="alternate" type="application/atom+xml" href="https://www.k8s.it/feed.xml" title="LAB - RSS"><link rel="alternate" type="application/json" href="https://www.k8s.it/feed.json" title="LAB - JSON"><meta property="og:title" content="Building a Scalable Image CDN with MinIO, imgproxy, and Cloudflare - LAB "><meta property="og:image" content="https://www.k8s.it/media/posts/45/Screenshot-2025-04-26-at-00.36.24.png"><meta property="og:image:width" content="2204"><meta property="og:image:height" content="1094"><meta property="og:site_name" content="LAB"><meta property="og:description" content="Intro In today's digital landscape, efficiently serving images is critical for website performance. Users expect fast-loading, responsive websites, and images often account for the majority of a page's weight. In this article, I'll walk you through building a powerful, scalable image CDN using open-source tools&hellip;"><meta property="og:url" content="https://www.k8s.it/building-a-scalable-image-cdn-with-minio-imgproxy-and-cloudflare.html"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://www.k8s.it/media/website/eth0.ico" type="image/x-icon"><link rel="stylesheet" href="https://www.k8s.it/assets/css/style.css?v=2e68e69045021c18195a04b11567bdb4"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.k8s.it/building-a-scalable-image-cdn-with-minio-imgproxy-and-cloudflare.html"},"headline":"Building a Scalable Image CDN with MinIO, imgproxy, and Cloudflare","datePublished":"2025-04-24T19:50+02:00","dateModified":"2025-04-26T00:36+02:00","image":{"@type":"ImageObject","url":"https://www.k8s.it/media/posts/45/Screenshot-2025-04-26-at-00.36.24.png","height":1094,"width":2204},"description":"Intro In today's digital landscape, efficiently serving images is critical for website performance. Users expect fast-loading, responsive websites, and images often account for the majority of a page's weight. In this article, I'll walk you through building a powerful, scalable image CDN using open-source tools&hellip;","author":{"@type":"Person","name":"lgirardi","url":"https://www.k8s.it/authors/lgirardi/"},"publisher":{"@type":"Organization","name":"lgirardi"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=UA-179496482-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-179496482-1');</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-5Q67F19PK4"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5Q67F19PK4');</script><script async defer="defer" src="https://analytics.umami.is/script.js" data-website-id="94a85eb9-27c5-4917-944e-f18dbec7cc27"></script></head><body class="post-template"><header class="top js-header"><a class="logo" href="https://www.k8s.it/">LAB</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://www.linkedin.com/in/lgirardi/">linkedin</a></li><li><a href="https://services.k8s.it/grafana/?orgId&#x3D;2">live monitoring</a></li><li><a href="https://www.k8s.it/whoami.html">whoami</a></li><li><a href="https://www.k8s.it/hobbies.html" target="_self">hobbies</a></li></ul></nav><div class="search"><div class="search__overlay js-search-overlay"><div class="wrapper search__overlay-inner"><form action="https://www.k8s.it/search.html" class="search__form"><input class="search__input" type="search" name="q" placeholder="search..." aria-label="search..."></form></div></div><button class="search__btn btn--icon js-search-btn" aria-label="Search"><svg height="18" width="18" role="presentation" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#search"/></svg></button></div></header><main class="post"><article class="content"><div class="hero"><header class="hero__content hero__content--centered"><div class="wrapper"><h1>Building a Scalable Image CDN with MinIO, imgproxy, and Cloudflare</h1><div class="feed__meta content__meta content__meta--centered"><time datetime="2025-04-24T19:50" class="feed__date">24 Apr 2025</time></div></div></header><figure class="hero__image"><div class="hero__image-wrapper"><img src="https://www.k8s.it/media/posts/45/Screenshot-2025-04-26-at-00.36.24.png" srcset="https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-26-at-00.36.24-xs.webp 640w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-26-at-00.36.24-sm.webp 768w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-26-at-00.36.24-md.webp 1024w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-26-at-00.36.24-lg.webp 1366w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-26-at-00.36.24-xl.webp 1600w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-26-at-00.36.24-2xl.webp 1920w" sizes="88vw" loading="eager" height="1094" width="2204" alt=""></div></figure></div><div class="entry-wrapper content__entry"><div tabindex="0"><div class="grid-cols-1 grid gap-2.5 [&amp;_&gt;_*]:min-w-0 !gap-3.5"><h1 id="mcetoc_1ipkej97e16a"></h1><h1 id="mcetoc_1ipkej97e16b"></h1><div class="post__toc"><h3>Table of Contents</h3><ul><li><a href="#mcetoc_1ipkej97e16c">Intro</a></li><li><a href="#mcetoc_1ipkej97e16d">The Architecture</a></li><li><a href="#mcetoc_1ipkej97e16e">How It Works</a></li><li><a href="#mcetoc_1ipkej97e16f">Setting Up MinIO</a></li><li><a href="#mcetoc_1ipkej97e16g">Setting Up imgproxy</a></li><li><a href="#mcetoc_1ipkej97e16h">Setting Up Cloudflare as CDN</a></li><li><a href="#mcetoc_1ipkej97e16i">Usage Examples</a></li><li><a href="#mcetoc_1ipkej97e16j">Security Considerations</a></li><li><a href="#mcetoc_1ipkej97e16k">Performance Optimization</a></li><li><a href="#mcetoc_1ipkej97e16l">Monitoring and Maintenance</a></li><li><a href="#mcetoc_1ipkej97e16m">Conclusion</a></li></ul></div><h2 id="mcetoc_1ipkej97e16c" class="text-2xl font-bold mt-1 text-text-100"><br>Intro</h2><p class="whitespace-pre-wrap break-words">In today's digital landscape, efficiently serving images is critical for website performance. Users expect fast-loading, responsive websites, and images often account for the majority of a page's weight. In this article, I'll walk you through building a powerful, scalable image CDN using open-source tools that you can deploy in your own infrastructure.</p><h2 id="mcetoc_1ipkej97e16d" class="text-xl font-bold text-text-100 mt-1 -mb-0.5">The Architecture</h2><p class="whitespace-pre-wrap break-words">Our image CDN consists of three main components:</p><ol class="[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7"><li class="whitespace-normal break-words"><strong>MinIO</strong>: An S3-compatible object storage backend that stores our original images</li><li class="whitespace-normal break-words"><strong>imgproxy</strong>: A fast and secure image processing service that resizes and optimizes images on-the-fly</li><li class="whitespace-normal break-words"><strong>Cloudflare</strong>: Providing CDN capabilities through Cloudflare Tunnel</li></ol><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/45/Screenshot-2025-04-24-at-19.42.20.png" alt="" width="1718" height="670" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.20-xs.webp 640w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.20-sm.webp 768w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.20-md.webp 1024w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.20-lg.webp 1366w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.20-xl.webp 1600w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.20-2xl.webp 1920w"></figure><p class="whitespace-pre-wrap break-words">This architecture gives us several advantages:</p><ul class="[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-disc space-y-1.5 pl-7"><li class="whitespace-normal break-words">On-demand image resizing and optimization</li><li class="whitespace-normal break-words">Edge caching for faster global delivery</li><li class="whitespace-normal break-words">Secure, private storage of original assets</li><li class="whitespace-normal break-words">High scalability and cost-effectiveness</li></ul><h2 id="mcetoc_1ipkej97e16e" class="text-xl font-bold text-text-100 mt-1 -mb-0.5">How It Works</h2><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/45/Screenshot-2025-04-24-at-19.42.47.png" alt="" width="1712" height="996" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.47-xs.webp 640w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.47-sm.webp 768w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.47-md.webp 1024w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.47-lg.webp 1366w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.47-xl.webp 1600w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.47-2xl.webp 1920w"></figure><p class="whitespace-pre-wrap break-words">The process flow works like this:</p><ol class="[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7"><li class="whitespace-normal break-words">Users request an image through our CDN URL</li><li class="whitespace-normal break-words">If Cloudflare has the image cached at the edge, it returns it immediately</li><li class="whitespace-normal break-words">If not cached, the request goes to imgproxy</li><li class="whitespace-normal break-words">imgproxy fetches the original image from MinIO</li><li class="whitespace-normal break-words">imgproxy processes the image according to URL parameters (resize, crop, etc.)</li><li class="whitespace-normal break-words">The processed image is returned through Cloudflare and cached at the edge</li></ol><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/45/Screenshot-2025-04-24-at-19.42.31.png" alt="" width="1638" height="1274" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.31-xs.webp 640w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.31-sm.webp 768w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.31-md.webp 1024w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.31-lg.webp 1366w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.31-xl.webp 1600w, https://www.k8s.it/media/posts/45/responsive/Screenshot-2025-04-24-at-19.42.31-2xl.webp 1920w"></figure><h2 id="mcetoc_1ipkej97e16f" class="text-xl font-bold text-text-100 mt-1 -mb-0.5">Setting Up MinIO</h2><p class="whitespace-pre-wrap break-words">MinIO is an open-source, S3-compatible object storage server that we'll use to store our original images. Let's deploy it on Kubernetes:</p><div class="relative group/copy rounded-lg"><div class="sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right"><div class="absolute right-0 h-8 px-2 items-center inline-flex"><div class="relative">Â </div></div></div><div><pre class="code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed"><code class="language-yaml"><span class="token key">apiVersion</span><span class="token">:</span> apps/v1
<span class="token key">kind</span><span class="token">:</span> Deployment
<span class="token key">metadata</span><span class="token">:</span>
  <span class="token key">name</span><span class="token">:</span> minio<span class="token">-</span>deployment
  <span class="token key">namespace</span><span class="token">:</span> minio
<span class="token key">spec</span><span class="token">:</span>
  <span class="token key">replicas</span><span class="token">:</span> <span class="token">1</span>
  <span class="token key">selector</span><span class="token">:</span>
    <span class="token key">matchLabels</span><span class="token">:</span>
      <span class="token key">app</span><span class="token">:</span> minio
  <span class="token key">strategy</span><span class="token">:</span>
    <span class="token key">type</span><span class="token">:</span> Recreate
  <span class="token key">template</span><span class="token">:</span>
    <span class="token key">metadata</span><span class="token">:</span>
      <span class="token key">labels</span><span class="token">:</span>
        <span class="token key">app</span><span class="token">:</span> minio
    <span class="token key">spec</span><span class="token">:</span>
      <span class="token key">volumes</span><span class="token">:</span>
      <span class="token">-</span> <span class="token key">name</span><span class="token">:</span> storage
        <span class="token key">persistentVolumeClaim</span><span class="token">:</span>
          <span class="token key">claimName</span><span class="token">:</span> minio<span class="token">-</span>pv<span class="token">-</span>claim
      <span class="token key">containers</span><span class="token">:</span>
      <span class="token">-</span> <span class="token key">name</span><span class="token">:</span> minio
        <span class="token key">image</span><span class="token">:</span> minio/minio<span class="token">:</span>latest
        <span class="token key">args</span><span class="token">:</span>
        <span class="token">-</span> server
        <span class="token">-</span> /storage
        <span class="token key">env</span><span class="token">:</span>
        <span class="token">-</span> <span class="token key">name</span><span class="token">:</span> MINIO_ACCESS_KEY
          <span class="token key">value</span><span class="token">:</span> <span class="token">"PLACEHOLDER"</span>
        <span class="token">-</span> <span class="token key">name</span><span class="token">:</span> MINIO_SECRET_KEY
          <span class="token key">value</span><span class="token">:</span> <span class="token">"PLACEHOLDER"</span>
        <span class="token">-</span> <span class="token key">name</span><span class="token">:</span> MINIO_DOMAIN
          <span class="token key">value</span><span class="token">:</span> minio-ingress
        <span class="token key">ports</span><span class="token">:</span>
        <span class="token">-</span> <span class="token key">containerPort</span><span class="token">:</span> <span class="token">9000</span>
          <span class="token key">hostPort</span><span class="token">:</span> <span class="token">9000</span>
        <span class="token key">volumeMounts</span><span class="token">:</span>
        <span class="token">-</span> <span class="token key">name</span><span class="token">:</span> storage
          <span class="token key">mountPath</span><span class="token">:</span> <span class="token">"/storage"</span></code></pre></div></div><p class="whitespace-pre-wrap break-words">We also need a persistent volume claim to store our data:</p><div class="relative group/copy rounded-lg"><div><pre class="code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed"><code class="language-yaml"><span class="token key">apiVersion</span><span class="token">:</span> v1
<span class="token key">kind</span><span class="token">:</span> PersistentVolumeClaim
<span class="token key">metadata</span><span class="token">:</span>
  <span class="token key">namespace</span><span class="token">:</span> minio
  <span class="token key">name</span><span class="token">:</span> minio<span class="token">-</span>pv<span class="token">-</span>claim
  <span class="token key">labels</span><span class="token">:</span>
    <span class="token key">app</span><span class="token">:</span> minio<span class="token">-</span>storage<span class="token">-</span>claim
<span class="token key">spec</span><span class="token">:</span>
  <span class="token key">storageClassName</span><span class="token">:</span> microk8s<span class="token">-</span>hostpath
  <span class="token key">accessModes</span><span class="token">:</span>
    <span class="token">-</span> ReadWriteOnce
  <span class="token key">resources</span><span class="token">:</span>
    <span class="token key">requests</span><span class="token">:</span>
      <span class="token key">storage</span><span class="token">:</span> 1Gi</code></pre></div></div><p class="whitespace-pre-wrap break-words">And a service to expose MinIO:</p><div class="relative group/copy rounded-lg"><div><pre class="code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed"><code class="language-yaml"><span class="token key">apiVersion</span><span class="token">:</span> v1
<span class="token key">kind</span><span class="token">:</span> Service
<span class="token key">metadata</span><span class="token">:</span>
  <span class="token key">name</span><span class="token">:</span> minio<span class="token">-</span>svc
  <span class="token key">namespace</span><span class="token">:</span> minio
  <span class="token key">labels</span><span class="token">:</span>
    <span class="token key">app</span><span class="token">:</span> minio
<span class="token key">spec</span><span class="token">:</span>
  <span class="token key">ports</span><span class="token">:</span>
  <span class="token">-</span> <span class="token key">name</span><span class="token">:</span> http
    <span class="token key">port</span><span class="token">:</span> <span class="token">9000</span>
    <span class="token key">targetPort</span><span class="token">:</span> <span class="token">9000</span>
  <span class="token">-</span> <span class="token key">name</span><span class="token">:</span> console
    <span class="token key">port</span><span class="token">:</span> <span class="token">9001</span>
    <span class="token key">targetPort</span><span class="token">:</span> <span class="token">9001</span>
  <span class="token key">selector</span><span class="token">:</span>
    <span class="token key">app</span><span class="token">:</span> minio
  <span class="token key">type</span><span class="token">:</span> ClusterIP</code></pre></div></div><h2 id="mcetoc_1ipkej97e16g" class="text-xl font-bold text-text-100 mt-1 -mb-0.5">Setting Up imgproxy</h2><p class="whitespace-pre-wrap break-words">imgproxy is a fast and secure standalone server for resizing and processing images. We'll install it using Helm:</p><div class="relative group/copy rounded-lg"><div><pre class="code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed"><code class="language-bash">helm repo <span class="token">add</span> imgproxy https://imgproxy.github.io/imgproxy-helm
helm <span class="token">install</span> imgproxy imgproxy/imgproxy -n imgproxy</code></pre></div></div><p class="whitespace-pre-wrap break-words">Then we need to configure it to connect to our MinIO backend through environment variables. These are the critical settings:</p><div class="relative group/copy rounded-lg"><div class="sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right"><div class="absolute right-0 h-8 px-2 items-center inline-flex"><div class="relative">Â </div></div></div><div><pre class="code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed"><code>IMGPROXY_USE_S3: true
IMGPROXY_S3_ENDPOINT: http://minio-service:9000/
IMGPROXY_S3_BUCKET: images
IMGPROXY_S3_REGION: local
AWS_ACCESS_KEY_ID: PLACEHOLDER
AWS_SECRET_ACCESS_KEY: PLACEHOLDER
IMGPROXY_USE_S3_FORCE_PATH_STYLE: true
IMGPROXY_ALLOW_UNSAFE_URLS: true</code></pre></div></div><p class="whitespace-pre-wrap break-words">Other important imgproxy settings include:</p><div class="relative group/copy rounded-lg"><div class="sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right"><div class="absolute right-0 h-8 px-2 items-center inline-flex"><div class="relative">Â </div></div></div><div><pre class="code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed"><code>IMGPROXY_QUALITY: 80
IMGPROXY_MAX_SRC_RESOLUTION: 16.8 (controls max source image size in megapixels)
IMGPROXY_STRIP_METADATA: true
IMGPROXY_STRIP_COLOR_PROFILE: true</code></pre></div></div><h2 id="mcetoc_1ipkej97e16h" class="text-xl font-bold text-text-100 mt-1 -mb-0.5">Setting Up Cloudflare as CDN</h2><p class="whitespace-pre-wrap break-words">To expose our image processing service to the internet securely, we'll use Cloudflare Tunnels, which provides a secure way to connect your resources to Cloudflare without a public IP.</p><ol class="[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7"><li class="whitespace-normal break-words">Install the cloudflared daemon in your cluster</li><li class="whitespace-normal break-words">Configure a Cloudflare Tunnel to point to your imgproxy service</li><li class="whitespace-normal break-words">Create a DNS record in Cloudflare pointing to your tunnel</li></ol><h2 id="mcetoc_1ipkej97e16i" class="text-xl font-bold text-text-100 mt-1 -mb-0.5">Usage Examples</h2><p class="whitespace-pre-wrap break-words">Once everything is set up, you can start serving images with transformations. Here are some example URLs:</p><div class="relative group/copy rounded-lg"><div class="sticky opacity-0 group-hover/copy:opacity-100 top-2 py-2 h-12 w-0 float-right"><div class="absolute right-0 h-8 px-2 items-center inline-flex"><div class="relative">Â </div></div></div><div><pre class="code-block__code !my-0 !rounded-lg !text-sm !leading-relaxed"><code># Resize to 300x200
https://images.yourdomain.com/unsafe/resize:300:200/plain/s3://bucket/image.jpg

# Resize and crop to 300x300
https://images.yourdomain.com/unsafe/resize:300:300:fill/plain/s3://bucket/image.jpg

# Convert to WebP format
https://images.yourdomain.com/unsafe/format:webp/plain/s3://bucket/image.jpg</code></pre></div></div><h2 id="mcetoc_1ipkej97e16j" class="text-xl font-bold text-text-100 mt-1 -mb-0.5">Security Considerations</h2><ol class="[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7"><li class="whitespace-normal break-words">Always use proper authentication for MinIO</li><li class="whitespace-normal break-words">Consider setting up signing keys for imgproxy to prevent URL tampering</li><li class="whitespace-normal break-words">Use Cloudflare security features like WAF and Rate Limiting</li><li class="whitespace-normal break-words">Implement proper CORS settings if serving images to websites on different domains</li></ol><h2 id="mcetoc_1ipkej97e16k" class="text-xl font-bold text-text-100 mt-1 -mb-0.5">Performance Optimization</h2><ol class="[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7"><li class="whitespace-normal break-words">Configure appropriate cache TTLs in Cloudflare</li><li class="whitespace-normal break-words">Use Cloudflare's Polish feature in addition to imgproxy's optimizations</li><li class="whitespace-normal break-words">Consider Browser Cache TTL settings</li><li class="whitespace-normal break-words">Enable Brotli compression in Cloudflare</li></ol><h2 id="mcetoc_1ipkej97e16l" class="text-xl font-bold text-text-100 mt-1 -mb-0.5">Monitoring and Maintenance</h2><ol class="[&amp;:not(:last-child)_ul]:pb-1 [&amp;:not(:last-child)_ol]:pb-1 list-decimal space-y-1.5 pl-7"><li class="whitespace-normal break-words">Set up monitoring for your MinIO and imgproxy services</li><li class="whitespace-normal break-words">Monitor disk usage on your MinIO server</li><li class="whitespace-normal break-words">Track image processing time and resource usage</li><li class="whitespace-normal break-words">Set up alerts for errors or performance degradation</li></ol><h2 id="mcetoc_1ipkej97e16m" class="text-xl font-bold text-text-100 mt-1 -mb-0.5">Conclusion</h2><p class="whitespace-pre-wrap break-words">Building your own image CDN provides flexibility, cost efficiency, and control over your image assets. By combining MinIO for storage, imgproxy for processing, and Cloudflare for edge delivery, you get a powerful solution that can handle high traffic loads while optimizing images for different devices and connection speeds.</p><p class="whitespace-pre-wrap break-words">This setup is particularly useful for sites with user-generated content, e-commerce platforms, or any website with a large number of images that need to be served in various sizes and formats.</p><p class="whitespace-pre-wrap break-words">The best part is that you maintain complete control over your infrastructure and can scale individual components as needed, while benefiting from the global reach of Cloudflare's CDN network.</p></div></div><div class="h-8">Â </div></div><footer class="content__footer"><div class="entry-wrapper"><p class="content__updated">This article was updated on 26 Apr 2025</p><div class="content__actions"><ul class="content__tag"><li><a href="https://www.k8s.it/cache/">cache</a></li><li><a href="https://www.k8s.it/cloudflare/">cloudflare</a></li><li><a href="https://www.k8s.it/images/">images</a></li><li><a href="https://www.k8s.it/imgproxy/">imgproxy</a></li><li><a href="https://www.k8s.it/kubernetes/">kubernetes</a></li><li><a href="https://www.k8s.it/minio/">minio</a></li></ul><div class="content__share"><button class="btn--icon content__share-button js-content__share-button"><svg width="20" height="20" aria-hidden="true"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#share"></use></svg> <span>Share It</span></button><div class="content__share-popup js-content__share-popup"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.k8s.it%2Fbuilding-a-scalable-image-cdn-with-minio-imgproxy-and-cloudflare.html" class="js-share facebook" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fwww.k8s.it%2Fbuilding-a-scalable-image-cdn-with-minio-imgproxy-and-cloudflare.html&amp;via=LAB&amp;text=Building%20a%20Scalable%20Image%20CDN%20with%20MinIO%2C%20imgproxy%2C%20and%20Cloudflare" class="js-share twitter" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.k8s.it%2Fbuilding-a-scalable-image-cdn-with-minio-imgproxy-and-cloudflare.html" class="js-share linkedin" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span> </a><a href="https://buffer.com/add?text=Building%20a%20Scalable%20Image%20CDN%20with%20MinIO%2C%20imgproxy%2C%20and%20Cloudflare&amp;url=https%3A%2F%2Fwww.k8s.it%2Fbuilding-a-scalable-image-cdn-with-minio-imgproxy-and-cloudflare.html" class="js-share buffer" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#buffer"/></svg> <span>Buffer</span> </a><a href="https://api.whatsapp.com/send?text=Building%20a%20Scalable%20Image%20CDN%20with%20MinIO%2C%20imgproxy%2C%20and%20Cloudflare https%3A%2F%2Fwww.k8s.it%2Fbuilding-a-scalable-image-cdn-with-minio-imgproxy-and-cloudflare.html" class="js-share whatsapp" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#whatsapp"/></svg> <span>WhatsApp</span></a></div></div></div><div class="content__bio bio"><div><h3 class="h4 bio__name"><a href="https://www.k8s.it/authors/lgirardi/" rel="author">lgirardi</a></h3><div class="bio__desc">If it isn't there, it can't break.</div></div></div></div><nav class="content__nav"><div class="wrapper"><div class="content__nav-inner"><div class="content__nav-prev"><a href="https://www.k8s.it/websocket-cloudflare-tunnel-apache-and-irritation.html" class="content__nav-link" rel="prev"><figure class="content__nav-image"><img src="https://www.k8s.it/media/posts/44/responsive/Screenshot-2025-04-26-at-00.35.02-xs.webp" class="lazyload" loading="lazy" alt="" height="1232" width="1232"></figure><div><span>Previous</span> Websocket, Cloudflare tunnel, apache httpd and a bit of security</div></a></div><div class="content__nav-next"><a href="https://www.k8s.it/migrating-homelab-from-vmware-esxi-to-proxmox-a-new-era.html" class="content__nav-link" rel="next"><div><span>Next</span> Migrating Homelab from VMware ESXi to Proxmox: A New Era</div><figure class="content__nav-image"><img src="https://www.k8s.it/media/posts/46/responsive/proxmox-import-vmware-vms-01-xs.webp" class="lazyload" loading="lazy" alt="" height="202" width="202"></figure></a></div></div></div></nav></footer></article><div class="content__comments"><div class="entry-wrapper"></div></div><div class="content__related related"><div class="wrapper"><h2 class="h4 related__title">You should also read:</h2><article class="feed__item feed__item--centered"><div class="feed__content"><header><div class="feed__meta"><a href="https://www.k8s.it/authors/lgirardi/" class="feed__author">lgirardi</a> <time datetime="2023-08-03T21:56" class="feed__date">3 Aug 2023</time></div><h3 class="feed__title"><a href="https://www.k8s.it/websocket-cloudflare-tunnel-apache-and-irritation.html">Websocket, Cloudflare tunnel, apache httpd and a bit of security</a></h3></header><p>Here we are In today's interconnected world, exposing your home lab or self-hosted services to the internet can be both necessary and risky. Traditional methods like port forwarding or VPNs come with their own set of challenges and security concerns. This is where Cloudflare Tunnel&hellip;</p><a href="https://www.k8s.it/websocket-cloudflare-tunnel-apache-and-irritation.html" class="readmore feed__readmore">Continue reading...</a></div></article><article class="feed__item feed__item--centered"><div class="feed__content"><header><div class="feed__meta"><a href="https://www.k8s.it/authors/lgirardi/" class="feed__author">lgirardi</a> <time datetime="2020-12-24T20:53" class="feed__date">24 Dec 2020</time></div><h3 class="feed__title"><a href="https://www.k8s.it/maximum-yield-with-minimum-expense.html">Maximum yield with minimum expense for a static website</a></h3></header><p>Great marketing quote, however i think we can better share a value that is always true... keep it simple, keep it safe. I would structure this article in few relevant topics Each of the above could be a specific topic that will fit others use&hellip;</p><a href="https://www.k8s.it/maximum-yield-with-minimum-expense.html" class="readmore feed__readmore">Continue reading...</a></div></article></div></div></main><footer class="footer footer--glued"><div class="wrapper"><div class="footer__copyright"><p>.</p></div><div class="footer__social"><a href="https://www.linkedin.com/in/lgirardi/" aria-label="LinkedIn"><svg><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#linkedin"/></svg></a></div><button id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg width="20" height="20"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#toparrow"/></svg></button></div></footer><script defer="defer" src="https://www.k8s.it/assets/js/scripts.min.js?v=ffcbea6c02c8178d10092962b235a5b0"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site, for marketing, and to provide social media functionality. <a href="#not-specified">More details...</a></div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--link pcb__btn--configure" aria-haspopup="dialog">Manage preferences</button> <button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Save</button></div></div></div><div class="pcb__popup" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-popup-title"><div class="pcb__popup__wrapper"><div class="pcb__inner pcb__popup__inner"><div class="pcb__popup__heading"><div id="pcb-popup-title" role="heading" aria-level="2" class="pcb__title">Cookie settings</div><button class="pcb__popup__close" aria-label="Close"></button></div><div class="pcb__popup__content"><div class="pcb__txt pcb__popup__txt">We use cookies to enhance your browsing experience, serve personalized ads or content, and analyze our traffic. By clicking "Accept All", you consent to our use of cookies. <a href="#not-specified">More details...</a></div><ul class="pcb__groups"><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Required</summary></details><div class="pcb__popup__switch is-checked"><input type="checkbox" data-group-name="" id="pcb-group-0" checked="checked"> <label for="pcb-group-0">Required</label></div></li><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Functionality</summary></details><div class="pcb__popup__switch"><input type="checkbox" data-group-name="functions" id="functions-cookies"> <label for="functions-cookies">Functionality</label></div></li><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Analytical</summary></details><div class="pcb__popup__switch"><input type="checkbox" data-group-name="analytics" id="analytics-cookies"> <label for="analytics-cookies">Analytical</label></div></li><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Marketing</summary></details><div class="pcb__popup__switch"><input type="checkbox" data-group-name="marketing" id="marketing-cookies"> <label for="marketing-cookies">Marketing</label></div></li></ul></div><div class="pcb__buttons pcb__popup__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button> <button type="button" class="pcb__btn pcb__btn--reject">Reject all</button> <button type="button" class="pcb__btn pcb__btn--save">Save settings</button></div></div></div></div><div class="pcb__overlay" aria-hidden="true"></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('ðŸª Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('ðŸª GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('ðŸª Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('ðŸª GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('ðŸª Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && (!cbConfig.initialLsState || cbConfig.initialLsState.indexOf(allowedGroup) === -1)) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('ðŸª GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('ðŸª Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('ðŸª Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('ðŸª Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('ðŸª Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>