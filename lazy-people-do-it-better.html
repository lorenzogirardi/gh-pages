<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Lazy people do it better - LAB</title><meta name="description" content="We are usually habit, sometimes, to react to some events with predefined actions If we increase the traffic then we increase the resources That is true and in some scenario is still the procedure , however i think we need to better understand what we have&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://www.k8s.it/lazy-people-do-it-better.html"><link rel="amphtml" href="https://www.k8s.it/amp/lazy-people-do-it-better.html"><link rel="alternate" type="application/atom+xml" href="https://www.k8s.it/feed.xml"><link rel="alternate" type="application/json" href="https://www.k8s.it/feed.json"><meta property="og:title" content="Lazy people do it better - LAB "><meta property="og:image" content="https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-16.32.46.png"><meta property="og:site_name" content="LAB"><meta property="og:description" content="We are usually habit, sometimes, to react to some events with predefined actions If we increase the traffic then we increase the resources That is true and in some scenario is still the procedure , however i think we need to better understand what we have&hellip;"><meta property="og:url" content="https://www.k8s.it/lazy-people-do-it-better.html"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://www.k8s.it/media/website/eth0.ico" type="image/x-icon"><link rel="stylesheet" href="https://www.k8s.it/assets/css/style.css?v=920879b0f1002b3aff920384a6c12dc7"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.k8s.it/lazy-people-do-it-better.html"},"headline":"Lazy people do it better","datePublished":"2022-02-20T12:47","dateModified":"2022-03-05T12:56","image":{"@type":"ImageObject","url":"https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-16.32.46.png","height":232,"width":834},"description":"We are usually habit, sometimes, to react to some events with predefined actions If we increase the traffic then we increase the resources That is true and in some scenario is still the procedure , however i think we need to better understand what we have&hellip;","author":{"@type":"Person","name":"lgirardi","url":"https://www.k8s.it/authors/lgirardi/"},"publisher":{"@type":"Organization","name":"lgirardi"}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-179496482-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-179496482-1');</script></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://www.k8s.it/">LAB</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://www.linkedin.com/in/lgirardi/">linkedin</a></li><li><a href="https://services.k8s.it/grafana/?orgId&#x3D;2">live monitoring</a></li><li><a href="https://www.k8s.it/whoami.html">whoami</a></li><li><a href="https://www.k8s.it/hobbies.html" target="_self">hobbies</a></li></ul></nav></header><main><article class="post"><div class="hero"><figure class="hero__image hero__image--overlay"><img src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-16.32.46.png" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.32.46-xs.png 300w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.32.46-sm.png 480w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.32.46-md.png 768w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.32.46-lg.png 1024w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.32.46-xl.png 1360w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.32.46-2xl.png 1600w" sizes="(max-width: 1600px) 100vw, 1600px" loading="eager" height="232" width="834" alt=""></figure><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2022-02-20T12:47">20 Feb 2022</time></div><h1>Lazy people do it better</h1></div></header></div><div class="wrapper post__entry"><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/35/lazy.gif" alt="" width="480" height="270"></figure><p> </p><p>We are usually habit, sometimes, to react to some events with predefined actions </p><p><strong>If</strong> we increase the traffic <strong>then </strong>we increase the resources <br>That is true and in some scenario is still the procedure , however i think we need to better understand what we have behind and the goal that we want to reach.<br><br>Since <span style="text-decoration: underline;">I'm lazy</span> i prefer to work one time , rather than be event driven </p><p>First of all the <strong>KPI </strong><br>This is not only related if the service is up and down , or if it's degraded or not ... is mostly focused on the service expectation <br><br>Answer in 3ms ?<br>Answer in 30ms ?<br>Answer in 300ms ?<br>Answer in 3000ms ?</p><p>In all the above question the service is running but the impact can be really different</p><p>So let's talk a bit about <strong>ONE </strong>of the possible infrastructure helpful trick ... the autoscaling.<br>This concept is already present since some years , aws has embraced it as first with the autoscaling solution for ec2 instances , now (since few years) kubernetes as introduced the HPA<br><br>How can help ?<br>There are many answer , but it's better to test with a lab some of those<br><br></p><h4>Environment settings</h4><p>Imagine an application that is managing a service<br>In this example is a <a href="https://github.com/lorenzogirardi/py-test-backend">python api</a> that answer for a fibonacci serie</p><p><code>$ curl -i https://oracolo.k8s.it/api/fiHTTP/1.1 200 OK</code><br><code>Date: Mon, 21 Feb 2022 15:18:50 GMT</code><br><code>Content-Type: text/html; charset=utf-8</code><br><code>Content-Length: 21</code><br><code>Connection: keep-alive</code><br><br><code>354224848179261915075</code></p><p>The idea was to have a function to slowdown the requests with the increase of cpu usage but to have a response time within 300ms (the <strong>KPI</strong>)</p><p>The application is installed on kubernetes with the following deployment</p><p><code>apiVersion: apps/v1</code><br><code>kind: Deployment</code><br><code>metadata:</code><br><code>  labels:</code><br><code>    app: pytbak</code><br><code>    track: pytbak-stable</code><br><code>  name: pytbak-stable</code><br><code>  namespace: pytbak</code><br><code>spec:</code><br><code>  minReadySeconds: 10</code><br><code>  replicas: 3</code><br><code>  revisionHistoryLimit: 5</code><br><code>  selector:</code><br><code>    matchLabels:</code><br><code>      app: pytbak</code><br><code>      track: pytbak-stable</code><br><code>  strategy:</code><br><code>    rollingUpdate:</code><br><code>      maxSurge: 50%</code><br><code>      maxUnavailable: 0</code><br><code>    type: RollingUpdate</code><br><code>  template:</code><br><code>    metadata:</code><br><code>      annotations:</code><br><code>        prometheus.io/scrape: "true"</code><br><code>        prometheus.io/path: "/metrics"</code><br><code>        prometheus.io/port: "5000"</code><br><code>      labels:</code><br><code>        app: pytbak</code><br><code>        track: pytbak-stable</code><br><code>    spec:</code><br><code>      containers:</code><br><code>      - name: pytbak</code><br><code>        image: lgirardi/rest-test-multip:0.3</code><br><code>        resources:</code><br><code>          limits:</code><br><code>            cpu: 300m</code><br><code>            memory: 250Mi</code><br><code>          requests:</code><br><code>            cpu: 30m</code><br><code>            memory: 125Mi</code><br><code>        ports:</code><br><code>        - name: http</code><br><code>          containerPort: 5000</code><br><code>        livenessProbe:</code><br><code>          httpGet:</code><br><code>            path: /api/</code><br><code>            port: 5000</code><br><code>          initialDelaySeconds: 40</code><br><code>          timeoutSeconds: 10</code><br><code>        readinessProbe:</code><br><code>          httpGet:</code><br><code>            path: /api/</code><br><code>            port: 5000</code><br><code>          initialDelaySeconds: 5</code><br><code>          timeoutSeconds: 15</code></p><p>Now we have how 3 pods ready to handle requests</p><p>In an unrealistic use cases we have a constant usage, instead in the real world, the usage is impacted by peak of traffic, scrapes , new feature , promotion , regional distribution etc etc </p><p>I know , it's a stretch using this gatling configuration but it's useful to share the idea<br><code>  setUp(</code><br><code>      scn.inject(</code><br><code>    nothingFor(1.seconds), // do nothing for 1 sec</code><br><code>    atOnceUsers(1), // have 1 call for 1 sec</code><br><code>    rampUsers(10).during(20.seconds), // increase users to 10 in 20 sec</code><br><code>    constantUsersPerSec(10).during(15.seconds), // keep 10 users for 15 sec</code><br><code>    rampUsersPerSec(10).to(100).during(3.minutes), // increase users to 100 in 3 min</code><br><code>    constantUsersPerSec(100).during(60.seconds), // keep 100 users for 1 min</code><br><code>    rampUsersPerSec(100).to(10).during(3.minutes).randomized, // decrease users to 10 in 3 min</code><br><code>    constantUsersPerSec(10).during(30.seconds), // keep 10 users for 30 sec</code><br><code>    rampUsersPerSec(10).to(1).during(10.seconds).randomized, // decrease users to 1 in 10 sec</code><br><code>  ).protocols(httpProtocol)</code><br><code>)</code></p><p> </p><p>and the url tested was</p><p><code>$ curl -i https://oracolo.k8s.it/api/fib/18500<br>HTTP/1.1 200 OK<br>Date: Mon, 21 Feb 2022 15:46:02 GMT<br>Content-Type: text/html; charset=utf-8<br>Content-Length: 3866<br>Connection: keep-alive<br>Vary: Accept-Encoding</code></p><p><code>83533296884435624867798531585140565339442079861725087204086868538470047335735<br>43822749284012562109156072993926836560850582712240843325537682043365082110610<br>74026311291800113704704348249392230730803891751617970900168446982968243007736<br>51197815341736702893065750384164322487072420946350671608236528336490734320752<br>15766217894062662319153446190938791478882600888720832141034382665639025753273<br>30750839228343101989644891936468903562404233796143208624300662188211844387971<br>12866863645098425877607285194374927111578752851305578221078133055618856142572<br>55524813028556809618441843877627693663784558866751538817238272015121741425393<br>99049964805007884503362484550579798684692431918631521197439158243117538949606<br>37155643851292040158395873383975165892212817619455430033494636143410239812404<br>80529547905260319321739870888187908535609149526797446231747889061304445725815<br>63419312476001987112390317255585462630499726624943926108760315984710835726791<br>64604969656765499209392211865567181332414241748115992393468455078857640503788<br>18491664670055330318299320987588212834680593778419314796246160245694639311623<br>45963069508719454819599551852953998681323163667721305365938646262462463653426<br>03120490907728272394316733945290936238595191234306195169403527451189150944412<br>55734943613733388177050741716869683215360508942821849631632473401081464418614<br>88129911023030514034348960453039999292198017445266482693060747698164480133895<br>42107812053775651030682262614149238225324860891787622323532546655762387576106<br>16744230275914963410655344193109686235699009316258222627309839038398946965798<br>93288112545157969932414111834814316569339369657297666636164718674805983154767<br>82716375582052616490320939205226143196168442740492338964903461454065891061788<br>24914385318462704330186677169214346572575320087900214462474550701206183564981<br>67940149169727266071833671192220852019181820327868422609361307508447137372952<br>70741193765954124906216947802897539084895498757041969867186546875822187085826<br>51268178561205184593600199506688874949513005414185093510082888499893907289670<br>60694081358868925846231023994576416351401218579760341994807107707262673164628<br>93989847554183605689726587752375584972993275839904589589079161246680599376961<br>46522822317563050982509757869699803683290147662057482039180565933217050406411<br>63613334575670225316495894808773628497941926683531555239853003061300649659051<br>80663038779126115354211249859182852080094185399771594786495630198172605116654<br>36484876158120241561970086240965134946001448112627411711997627120355963199768<br>37453968472163446367339200530252903452374910026941922776248397460043788137117<br>03792457930019057411962758264853807991677322585740303176087173311737493675814<br>97785846553584211669490948369627378763409533632607628189347167959335358534179<br>14936021275618379596024302703059923780925579890415606776752696469049010540674<br>16762272554571834669670185083416940001269702457012387259986804993721400659735<br>98402981836433913009273334871164379864504944274151763420867965690836123620164<br>71052527907012070090155568723470808988725230762895495242080853258248938503812<br>92377624996414841905746084025711457998759036082766019389458672225594149040894<br>25339957409692717694606288768279530280880496597818894383696651292555863738105<br>42519877809534106427059668587274469061728503718737115492047330320710617418343<br>36509845478020766819148991938613184822854393146963871218131954000091828603844<br>30710696936075943284582450858926759953941330918016364297470882233548644972398<br>02671169604082172661201779291650562320255581897779891571992387794168420428875<br>01665380594740126434308738080451514239759906771130514871814286159379595046723<br>96787175930658277115296525324844486906484486308261475140105238542837827794788<br>42270482292915032600476652997028797988664978676168344677300636439380532376130<br>50531301554510586963399762243280359072814214224506146343965459717217720978975<br>50897175029897270621313926837122497590225684346650930922871186632985491270868<br>6598493717570125</code></p><p> </p><h4>Results </h4><p> </p><h5>fixed pods number</h5><p>... what happened ?</p><p>Gatling results: <a href="https://lorenzogirardi.github.io/gatling-k8s-fixed-3-pods/">https://lorenzogirardi.github.io/gatling-k8s-fixed-3-pods/</a></p><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-16.48.10.png" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-xs.png 300w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-sm.png 480w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-md.png 768w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-lg.png 1024w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-xl.png 1360w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-16.48.10-2xl.png 1600w" alt="" width="1024" height="409"></figure><p><span style="color: #236fa1;">Big cluster of huge response time <br><span style="color: #e03e2d;">Closing to 100 rps , service unavailable</span><br></span></p><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-17.18.34.png" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-xs.png 300w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-sm.png 480w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-md.png 768w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-lg.png 1024w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-xl.png 1360w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.18.34-2xl.png 1600w" alt="" width="1024" height="408"></figure><p><span style="color: #000000;">huge active users ... more than the requests (slowdown ... queue.... failures)</span></p><p><span style="color: #000000;">And the application status ?</span></p><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/35/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02.png" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-xs.png 300w, https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-sm.png 480w, https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-md.png 768w, https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-lg.png 1024w, https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-xl.png 1360w, https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-14_44_02-2xl.png 1600w" alt="" width="2880" height="3340"></figure><p> </p><p>Well now we know we know a bit our application ... we know the critical point but also that the <strong>KPI </strong>went to hell , high cpu and some pod crash</p><p class="align-center"> </p><p> </p><h5>dynamic pods number</h5><p>... what happened ?</p><p>Gatling results: <a href="https://lorenzogirardi.github.io/gatling-k8s-hpa/">https://lorenzogirardi.github.io/gatling-k8s-hpa/</a></p><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-17.11.09.png" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-xs.png 300w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-sm.png 480w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-md.png 768w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-lg.png 1024w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-xl.png 1360w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.11.09-2xl.png 1600w" alt="" width="1024" height="404"></figure><p>Some sporadic request over 300ms but 99% below</p><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-17.19.57.png" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-xs.png 300w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-sm.png 480w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-md.png 768w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-lg.png 1024w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-xl.png 1360w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.19.57-2xl.png 1600w" alt="" width="1024" height="412"></figure><p><span style="color: #000000;">active users inline with the requests</span></p><p><span style="color: #000000;">And the application status ?<br></span></p><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/35/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02.png" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-xs.png 300w, https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-sm.png 480w, https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-md.png 768w, https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-lg.png 1024w, https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-xl.png 1360w, https://www.k8s.it/media/posts/35/responsive/screencapture-services-k8s-it-grafana-d-u-DVKhQiz-flask-transaction-2022-02-20-16_46_02-2xl.png 1600w" alt="" width="2880" height="3340"></figure><p><span style="color: #000000;">cpu under control , response time ok , no crash and autoscaled from 3 to 10 pods<br></span></p><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-21-at-17.16.38.png" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-xs.png 300w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-sm.png 480w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-md.png 768w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-lg.png 1024w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-xl.png 1360w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-21-at-17.16.38-2xl.png 1600w" alt="" width="2192" height="1096"></figure><p><span style="color: #000000;"> </span></p><h4>HPA in pills</h4><figure class="post__image post__image--center"><img loading="lazy" src="https://www.k8s.it/media/posts/35/cn-dyn-img-4.gif" alt="" width="480" height="336"></figure><p> </p><p>There are many how to and suggestions that explain this topic,</p><p>however what you need is: </p><ul><li>prometheus</li><li>kpi and application tolerance knowhow</li><li>keda.sh (i really hate the <em>prometheus adapter</em>)</li></ul><p>Let's skip prometheus and go directly to kpi, application tolerance and keda.sh<br><br>When i create the fibonacci code , i was able to test the impact on cpu and response time , having the fibonacci as 18500</p><ul><li>the max pod tolerance to be running without error was 30rps</li><li>to be within 300ms 15rps</li></ul><p>I know, is not real life scenario but the concept is the same ... just identify the correct rps in a case where this value can be a trigger for the autoscaling</p><p>In the python app is <code>flask_http_request_duration_seconds_count</code></p><p>the following configuration for keda use this value as a trigger</p><p><code>apiVersion: keda.sh/v1alpha1<br>kind: ScaledObject<br>metadata:<br>  name: rps-scaledobject<br>  namespace: pytbak<br>spec:<br>  minReplicaCount: 3<br>  maxReplicaCount: 10<br>  pollingInterval: 10  # Optional. Default: 30 seconds<br>  scaleTargetRef:<br>    name: pytbak-stable<br>  advanced:                                          # Optional. Section to specify advanced options<br>    horizontalPodAutoscalerConfig:                   # Optional. Section to specify HPA related options<br>      behavior:                                      # Optional. Use to modify HPA's scaling behavior<br>        scaleDown:<br>          stabilizationWindowSeconds: 45 #option from kubernetes hpa to force pod shutdown in 45 dec , default 5 min<br>  triggers:<br>  - type: prometheus<br>    metadata:<br>    # Required fields:<br>      serverAddress: <a href="http://10.152.183.99:9090">http://10.152.183.99:9090</a> # prometheus server<br>      metricName: flask_http_request_duration_seconds_count # Note: name to identify the metric<br>      query: sum(rate(flask_http_request_duration_seconds_count{status="200"}[60s])) # Note: query must return a vector/scalar single element response<br>      threshold: '10'<br></code></p><p> </p><p>An this is what happened during the gatling test with hpa</p><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-20-at-14.47.57.png" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-xs.png 300w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-sm.png 480w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-md.png 768w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-lg.png 1024w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-xl.png 1360w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.47.57-2xl.png 1600w" alt="" width="720" height="104"></figure><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-20-at-14.48.36.png" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-xs.png 300w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-sm.png 480w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-md.png 768w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-lg.png 1024w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-xl.png 1360w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.48.36-2xl.png 1600w" alt="" width="720" height="81"></figure><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-20-at-14.49.07.png" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-xs.png 300w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-sm.png 480w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-md.png 768w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-lg.png 1024w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-xl.png 1360w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.07-2xl.png 1600w" alt="" width="720" height="94"></figure><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-20-at-14.49.22.png" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-xs.png 300w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-sm.png 480w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-md.png 768w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-lg.png 1024w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-xl.png 1360w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.49.22-2xl.png 1600w" alt="" width="720" height="79"></figure><figure class="post__image"><img loading="lazy" src="https://www.k8s.it/media/posts/35/Screenshot-2022-02-20-at-14.50.36.png" sizes="100vw" srcset="https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-xs.png 300w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-sm.png 480w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-md.png 768w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-lg.png 1024w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-xl.png 1360w, https://www.k8s.it/media/posts/35/responsive/Screenshot-2022-02-20-at-14.50.36-2xl.png 1600w" alt="" width="720" height="79"></figure><p> </p><h4>Conclusions</h4><p>HPA is an amazing solution not only in cloud there this feature is mandatory if you want to use the cloud in the right way and if you would like to remove overspending </p><p>but anyway...</p><p>It's the right model for lazy people in order to have a dynamic infrastructure to support the traffic, to reduce the monitoring and alerting alarms and be ready to scale :) </p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on 5 Mar 2022</p><ul class="post__tag"><li><a href="https://www.k8s.it/application-metrics/">application metrics</a></li><li><a href="https://www.k8s.it/autoscaling/">autoscaling</a></li><li><a href="https://www.k8s.it/dynamic-infrastructure/">dynamic infrastructure</a></li><li><a href="https://www.k8s.it/hpa/">hpa</a></li><li><a href="https://www.k8s.it/kpi/">kpi</a></li><li><a href="https://www.k8s.it/kubernetes/">kubernetes</a></li><li><a href="https://www.k8s.it/metrics/">metrics</a></li><li><a href="https://www.k8s.it/performances/">performances</a></li></ul><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.k8s.it%2Flazy-people-do-it-better.html" class="js-share facebook" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://twitter.com/share?url=https%3A%2F%2Fwww.k8s.it%2Flazy-people-do-it-better.html&amp;via=LAB&amp;text=Lazy%20people%20do%20it%20better" class="js-share twitter" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.k8s.it%2Flazy-people-do-it-better.html" class="js-share linkedin" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span> </a><a href="https://buffer.com/add?text=Lazy%20people%20do%20it%20better&amp;url=https%3A%2F%2Fwww.k8s.it%2Flazy-people-do-it-better.html" class="js-share buffer" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#buffer"/></svg> <span>Buffer</span> </a><a href="https://api.whatsapp.com/send?text=Lazy%20people%20do%20it%20better https%3A%2F%2Fwww.k8s.it%2Flazy-people-do-it-better.html" class="js-share whatsapp" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#whatsapp"/></svg> <span>WhatsApp</span></a></div><div class="post__bio bio"><div class="bio__info"><h3 class="bio__name"><a href="https://www.k8s.it/authors/lgirardi/" rel="author">lgirardi</a></h3><p>If it isn&#x27;t there, it can&#x27;t break.</p></div></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://www.k8s.it/kubernetes-nstats.html" class="post__nav-link" rel="prev"><span>Previous</span> Kubernetes-nstats</a></div><div class="post__nav-next"><a href="https://www.k8s.it/etcshadow.html" class="post__nav-link" rel="next"><span>Next</span> /etc/shadow </a><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#arrow-next"/></svg></div></div></nav><div class="post__comments"><div class="wrapper"></div></div></main><footer class="footer"><div class="footer__social"><a href="https://www.linkedin.com/in/lgirardi/" aria-label="LinkedIn"><svg><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#linkedin"/></svg></a></div><div class="footer__copyright"><p>.</p></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg><use xlink:href="https://www.k8s.it/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://www.k8s.it/assets/js/scripts.min.js?v=6ca8b60e6534a3888de1205e82df8528"></script><script>var images = document.querySelectorAll('img[loading]');

        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><div class="cookie-popup js-cookie-popup cookie-popup--uses-badge"><h2>This website uses cookies</h2><p>Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site, for marketing, and to provide social media functionality. <a href="#not-specified"></a></p><form><input id="gdpr-necessary" name="gdpr-necessary" checked="checked" disabled="disabled" type="checkbox"> <label for="gdpr-necessary">Required</label> <input id="gdpr-functions" name="gdpr-functions" type="checkbox"> <label for="gdpr-functions">Functionality</label> <input id="gdpr-analytics" name="gdpr-analytics" type="checkbox"> <label for="gdpr-analytics">Analytical</label> <input id="gdpr-marketing" name="gdpr-marketing" type="checkbox"> <label for="gdpr-marketing">Marketing</label><p class="cookie-popup__save-wrapper"><button type="submit" class="cookie-popup__save">Save</button></p></form><span class="cookie-popup-label">Cookie Policy</span></div><script>(function() {
                function addScript (src, inline) {
                    var newScript = document.createElement('script');

                    if (src) {
                        newScript.setAttribute('src', src);
                    }

                    if (inline) {
                        newScript.text = inline;
                    }

                    document.body.appendChild(newScript);
                }

                var popup = document.querySelector('.js-cookie-popup');
                var checkboxes = popup.querySelectorAll('input[type="checkbox"]');
                var save = popup.querySelector('button');
                var currentConfig = localStorage.getItem('publii-gdpr-allowed-cookies');
                var blockedScripts = document.querySelectorAll('script[type^="gdpr-blocker/"]');
                

                popup.addEventListener('click', function() {
                    if (!popup.classList.contains('cookie-popup--is-sticky')) {
                        popup.classList.add('cookie-popup--is-sticky');
                    }
                });

                save.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    popup.classList.remove('cookie-popup--is-sticky');
                    var allowedGroups = [];

                    for (var i = 0; i < checkboxes.length; i++) {
                        if (checkboxes[i].checked) {
                            var groupName = checkboxes[i].getAttribute('name').replace('gdpr-', '');
                            var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + groupName + '"]');

                            for (var j = 0; j < scripts.length; j++) {
                                addScript(scripts[j].src, scripts[j].text);
                            }
                            
                            var groupEvent = new Event('publii-cookie-banner-unblock-' + groupName);
                            document.body.dispatchEvent(groupEvent);
                            allowedGroups.push(groupName);
                        }
                    }

                    localStorage.setItem('publii-gdpr-allowed-cookies', allowedGroups.join(','));
                    popup.classList.remove('cookie-popup--is-sticky');

                    setTimeout(function () {
                        if (currentConfig !== null) {
                            window.location.reload();
                        }
                    }, 250);
                });

                if (currentConfig === null) {
                    popup.classList.add('cookie-popup--is-sticky');
                    var checkedGroups = popup.querySelectorAll('input[type="checkbox"]:checked');

                    for (var i = 0; i < checkedGroups.length; i++) {
                        var allowedGroup = checkedGroups[i].name.replace('gdpr-', '');

                        if (allowedGroup !== '-' && allowedGroup !== '') {
                            var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');

                            for (var j = 0; j < scripts.length; j++) {
                                addScript(scripts[j].src, scripts[j].text);
                            }

                            var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
                            document.body.dispatchEvent(groupEvent);
                        }
                    }
                } else {
                    if (currentConfig !== '') {
                        var allowedGroups = currentConfig.split(',');
                        var checkedCheckboxes = popup.querySelectorAll('input[type="checkbox"]:checked');

                        for (var j = 0; j < checkedCheckboxes.length; j++) {
                            var name = checkedCheckboxes[j].name.replace('gdpr-', '');

                            if (allowedGroups.indexOf(name) === -1) {
                                checkedCheckboxes[j].checked = false;
                            }
                        }

                        for (var i = 0; i < allowedGroups.length; i++) {
                            var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroups[i] + '"]');
                            var checkbox = popup.querySelector('input[type="checkbox"][name="gdpr-' + allowedGroups[i] + '"]');

                            if (checkbox) {
                                checkbox.checked = true;
                            }

                            for (var j = 0; j < scripts.length; j++) {
                                addScript(scripts[j].src, scripts[j].text);
                            }

                            var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroups[i]);
                            document.body.dispatchEvent(groupEvent);
                        }
                    }
                }
            })();</script></body></html>